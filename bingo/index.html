<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Bingo Maker</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito:wght@400..800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        e1dark: '#1e293b',
                        e1chalk: '#f8fafc',
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Graph Paper Background */
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(#e2e8f0 1px, transparent 1px),
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .dark body {
            background-color: #0f172a;
            background-image: 
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
        }

        /* Hide scrollbar for cleaner UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Print Styling */
        @media print {
            @page { margin: 0.5cm; size: landscape; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .card-container { break-inside: avoid; page-break-inside: avoid; }
        }
    </style>
</head>
<body class="font-body text-e1dark min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-e1chalk/90 backdrop-blur border-b-4 border-e1dark px-4 py-3 no-print">
        <div class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-e1pink rounded-lg border-2 border-e1dark flex items-center justify-center shadow-neo">
                    <i data-lucide="grid-3x3" class="text-e1dark"></i>
                </div>
                <h1 class="font-heading text-2xl font-bold text-e1dark tracking-wide">Bingo Maker</h1>
            </div>
            
            <div class="flex gap-2 bg-white border-2 border-e1dark rounded-xl p-1 shadow-neo overflow-x-auto">
                <button onclick="switchTab('setup')" id="tab-setup" class="tab-btn px-4 py-2 rounded-lg font-heading font-bold transition-all border-2 border-transparent hover:bg-slate-100">
                    Setup
                </button>
                <button onclick="switchTab('print')" id="tab-print" class="tab-btn px-4 py-2 rounded-lg font-heading font-bold transition-all border-2 border-transparent hover:bg-slate-100">
                    Print Cards
                </button>
                <button onclick="switchTab('caller')" id="tab-caller" class="tab-btn px-4 py-2 rounded-lg font-heading font-bold transition-all border-2 border-transparent hover:bg-slate-100">
                    Caller Mode
                </button>
                <button onclick="switchTab('play')" id="tab-play" class="tab-btn px-4 py-2 rounded-lg font-heading font-bold transition-all border-2 border-transparent hover:bg-slate-100">
                    Digital Play
                </button>
            </div>

            <button onclick="toggleTheme()" class="p-2 rounded-lg bg-e1dark text-white border-2 border-e1dark shadow-neo hover:-translate-y-0.5 transition-transform active:translate-y-0 active:shadow-none">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8 max-w-6xl mx-auto w-full">

        <!-- SETUP VIEW -->
        <section id="view-setup" class="view-section animate-fade-in block">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Inputs -->
                <div class="space-y-6">
                    <div class="bg-white border-4 border-e1dark rounded-2xl shadow-neo p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-e1orange text-e1dark font-heading font-bold px-4 py-1 rounded-bl-xl border-b-2 border-l-2 border-e1dark">
                            Step 1: Content
                        </div>
                        <h2 class="font-heading text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="pencil" class="text-e1blue"></i> Words / Terms
                        </h2>
                        <label class="block text-sm font-bold mb-2">Bingo Title</label>
                        <input type="text" id="bingoTitle" value="English Vocab Bingo" class="w-full mb-4 px-4 py-3 bg-slate-50 border-2 border-e1dark rounded-xl font-heading focus:outline-none focus:ring-4 focus:ring-e1blue/20">
                        
                        <label class="block text-sm font-bold mb-2">Word List (Separate by comma or new line)</label>
                        <textarea id="wordInput" class="w-full h-48 px-4 py-3 bg-slate-50 border-2 border-e1dark rounded-xl font-body resize-none focus:outline-none focus:ring-4 focus:ring-e1blue/20" placeholder="Apple, Banana, Cat, Dog...">Apple, Banana, Cherry, Date, Elderberry, Fig, Grape, Honeydew, Kiwi, Lemon, Mango, Nectarine, Orange, Papaya, Quince, Raspberry, Strawberry, Tangerine, Ugli Fruit, Vanilla, Watermelon, Xigua, Yam, Zucchini</textarea>
                        <p class="text-xs text-slate-500 mt-2 font-bold flex justify-between">
                            <span>Separate words with commas or new lines.</span>
                            <span id="wordCount" class="text-e1pink">24 words</span>
                        </p>
                    </div>

                    <div class="bg-white border-4 border-e1dark rounded-2xl shadow-neo p-6 relative overflow-hidden">
                         <div class="absolute top-0 right-0 bg-e1green text-e1dark font-heading font-bold px-4 py-1 rounded-bl-xl border-b-2 border-l-2 border-e1dark">
                            Step 2: Settings
                        </div>
                        <h2 class="font-heading text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="settings" class="text-e1green"></i> Grid Settings
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold mb-2">Grid Size</label>
                                <select id="gridSize" class="w-full px-4 py-3 bg-slate-50 border-2 border-e1dark rounded-xl font-heading focus:outline-none">
                                    <option value="3">3 x 3 (9 items)</option>
                                    <option value="4">4 x 4 (16 items)</option>
                                    <option value="5" selected>5 x 5 (25 items)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Free Space?</label>
                                <select id="freeSpace" class="w-full px-4 py-3 bg-slate-50 border-2 border-e1dark rounded-xl font-heading focus:outline-none">
                                    <option value="center">Center (Text)</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                        </div>
                        <label class="block text-sm font-bold mb-2">Theme Color</label>
                        <div class="flex gap-3">
                            <button onclick="setTheme('pink')" class="w-10 h-10 rounded-lg bg-e1pink border-2 border-e1dark shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] hover:scale-110 transition-transform"></button>
                            <button onclick="setTheme('orange')" class="w-10 h-10 rounded-lg bg-e1orange border-2 border-e1dark shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] hover:scale-110 transition-transform"></button>
                            <button onclick="setTheme('green')" class="w-10 h-10 rounded-lg bg-e1green border-2 border-e1dark shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] hover:scale-110 transition-transform"></button>
                            <button onclick="setTheme('blue')" class="w-10 h-10 rounded-lg bg-e1blue border-2 border-e1dark shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] hover:scale-110 transition-transform"></button>
                        </div>
                    </div>
                </div>

                <!-- Preview Card -->
                <div class="flex flex-col items-center justify-center">
                    <div class="mb-4 font-heading font-bold text-xl text-slate-500">Live Preview</div>
                    <div id="previewCard" class="w-full max-w-sm transition-all duration-300">
                        <!-- Card generates here -->
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button onclick="updatePreview()" class="px-6 py-3 bg-white border-2 border-e1dark rounded-xl font-heading font-bold shadow-neo hover:-translate-y-1 transition-transform flex items-center gap-2">
                            <i data-lucide="refresh-cw"></i> Refresh Preview
                        </button>
                        <button onclick="switchTab('print')" class="px-6 py-3 bg-e1blue text-white border-2 border-e1dark rounded-xl font-heading font-bold shadow-neo hover:-translate-y-1 transition-transform flex items-center gap-2">
                            Go to Print <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRINT VIEW -->
        <section id="view-print" class="view-section hidden">
            <div class="bg-white border-4 border-e1dark rounded-2xl shadow-neo p-6 mb-8 no-print">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 class="font-heading text-2xl font-bold mb-1">Print Center</h2>
                        <p class="text-slate-500">Generate cards for the whole class.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                         <div class="flex items-center gap-2">
                            <label class="font-bold">Quantity:</label>
                            <input type="number" id="printCount" value="20" min="1" max="100" class="w-20 px-2 py-2 border-2 border-e1dark rounded-lg font-heading text-center">
                        </div>
                        <button onclick="generatePrintCards()" class="px-6 py-3 bg-e1green border-2 border-e1dark rounded-xl font-heading font-bold shadow-neo hover:-translate-y-1 transition-transform flex items-center gap-2 text-e1dark">
                            <i data-lucide="layers"></i> Generate Cards
                        </button>
                        <button onclick="window.print()" class="px-6 py-3 bg-e1dark text-white border-2 border-e1dark rounded-xl font-heading font-bold shadow-neo hover:-translate-y-1 transition-transform flex items-center gap-2">
                            <i data-lucide="printer"></i> Print Now
                        </button>
                    </div>
                </div>
            </div>

            <div id="printGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 print:grid-cols-2 print:gap-4 w-full">
                <!-- Generated cards go here -->
                <div class="flex items-center justify-center p-12 text-slate-400 font-heading text-xl border-2 border-dashed border-slate-300 rounded-xl">
                    Click "Generate Cards" to see layout
                </div>
            </div>
        </section>

        <!-- CALLER MODE -->
        <section id="view-caller" class="view-section hidden">
            <div class="grid lg:grid-cols-3 gap-8 h-[calc(100vh-140px)]">
                <!-- Main Caller Area -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div class="flex-grow bg-white border-4 border-e1dark rounded-2xl shadow-neo flex flex-col items-center justify-center p-8 relative overflow-hidden group">
                        <!-- Decorative bg circles -->
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-e1pink rounded-full opacity-20 group-hover:scale-110 transition-transform duration-700"></div>
                        <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-e1blue rounded-full opacity-20 group-hover:scale-110 transition-transform duration-700"></div>

                        <div class="font-heading text-2xl text-slate-400 mb-4 uppercase tracking-widest">Current Word</div>
                        <div id="currentCall" class="font-heading text-5xl md:text-7xl lg:text-8xl font-black text-center text-e1dark break-words max-w-full z-10 animate-bounce-short">
                            Ready?
                        </div>
                         <div id="itemsRemaining" class="mt-4 px-3 py-1 bg-slate-100 rounded-full text-sm font-bold border border-slate-300">
                            0 / 0 Called
                        </div>
                    </div>

                    <div class="flex gap-4 h-24">
                        <button onclick="callNext()" id="btnCallNext" class="flex-grow bg-e1green border-4 border-e1dark rounded-2xl shadow-neo flex items-center justify-center gap-3 font-heading text-2xl font-bold hover:-translate-y-1 active:translate-y-1 active:shadow-none transition-all">
                            <i data-lucide="play" class="w-8 h-8"></i> Next Word
                        </button>
                        <button onclick="resetCaller()" class="w-24 bg-e1orange border-4 border-e1dark rounded-2xl shadow-neo flex items-center justify-center font-heading font-bold hover:-translate-y-1 active:translate-y-1 active:shadow-none transition-all" title="Reset Game">
                            <i data-lucide="rotate-ccw" class="w-8 h-8 text-e1dark"></i>
                        </button>
                    </div>
                </div>

                <!-- History -->
                <div class="bg-e1chalk border-4 border-e1dark rounded-2xl shadow-neo flex flex-col overflow-hidden max-h-[600px]">
                    <div class="p-4 bg-e1dark text-white font-heading font-bold text-lg flex justify-between items-center">
                        <span>Call History</span>
                        <i data-lucide="history" class="w-5 h-5"></i>
                    </div>
                    <div id="callHistory" class="flex-grow overflow-y-auto p-4 space-y-2">
                        <div class="text-center text-slate-400 italic mt-4">No words called yet.</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DIGITAL PLAY -->
        <section id="view-play" class="view-section hidden">
            <div class="max-w-md mx-auto">
                <div class="bg-white border-4 border-e1dark rounded-2xl shadow-neo p-4 mb-6 text-center">
                    <h2 class="font-heading text-xl font-bold text-e1dark">Interactive Card</h2>
                    <p class="text-sm text-slate-500 mb-4">Click cells to mark them.</p>
                    <button onclick="generateDigitalCard()" class="px-4 py-2 bg-e1pink border-2 border-e1dark rounded-lg font-bold shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all text-sm">
                        Get New Card
                    </button>
                </div>
                
                <div id="digitalCardContainer">
                    <!-- Digital card renders here -->
                </div>

                <div class="mt-8 text-center">
                    <button onclick="checkBingo()" class="px-8 py-4 bg-e1blue text-white text-xl border-4 border-e1dark rounded-2xl font-heading font-black shadow-neo hover:-translate-y-1 active:translate-y-1 active:shadow-none transition-all animate-pulse">
                        BINGO!
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal for Winner/Alert -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white border-4 border-e1dark rounded-2xl shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] p-8 max-w-sm w-full text-center transform scale-95 transition-transform duration-200" id="modalContent">
            <div class="w-20 h-20 bg-e1green rounded-full border-4 border-e1dark mx-auto mb-4 flex items-center justify-center">
                <i data-lucide="trophy" class="w-10 h-10 text-e1dark"></i>
            </div>
            <h3 id="modalTitle" class="font-heading text-3xl font-black mb-2 text-e1dark">Winner!</h3>
            <p id="modalMsg" class="font-body text-slate-600 mb-6 text-lg">You have a valid Bingo!</p>
            <button onclick="closeModal()" class="w-full py-3 bg-e1dark text-white rounded-xl font-heading font-bold border-2 border-e1dark hover:bg-slate-800 transition-colors">
                Awesome!
            </button>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            words: [],
            title: "Bingo",
            gridSize: 5,
            freeSpace: 'center',
            theme: 'pink',
            callerQueue: [],
            calledHistory: [],
            digitalCardValues: [],
            digitalCardMarks: [] // Boolean array
        };

        const themeColors = {
            pink: 'bg-e1pink',
            orange: 'bg-e1orange',
            green: 'bg-e1green',
            blue: 'bg-e1blue'
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Listeners
            document.getElementById('wordInput').addEventListener('input', updateStateFromInputs);
            document.getElementById('bingoTitle').addEventListener('input', updateStateFromInputs);
            document.getElementById('gridSize').addEventListener('change', updateStateFromInputs);
            document.getElementById('freeSpace').addEventListener('change', updateStateFromInputs);

            updateStateFromInputs(); // Initial load
            switchTab('setup');
        });

        function updateStateFromInputs() {
            const rawText = document.getElementById('wordInput').value;
            // Split by comma or new line, filter empty
            state.words = rawText.split(/[\n,]+/).map(w => w.trim()).filter(w => w.length > 0);
            state.title = document.getElementById('bingoTitle').value || "Bingo";
            state.gridSize = parseInt(document.getElementById('gridSize').value);
            state.freeSpace = document.getElementById('freeSpace').value;
            
            // Update word count UI
            const countEl = document.getElementById('wordCount');
            const minWords = state.gridSize * state.gridSize - (state.freeSpace === 'center' && state.gridSize % 2 !== 0 ? 1 : 0);
            countEl.textContent = `${state.words.length} words (Need ${minWords})`;
            countEl.className = state.words.length >= minWords ? 'text-e1green font-bold' : 'text-e1pink font-bold';

            updatePreview();
        }

        function setTheme(color) {
            state.theme = color;
            updatePreview();
        }

        function switchTab(tabId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`view-${tabId}`).classList.add('animate-fade-in');
            
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-e1pink', 'bg-e1orange', 'bg-e1green', 'bg-e1blue', 'text-e1dark', 'border-e1dark', 'shadow-neo');
                btn.classList.add('border-transparent');
            });

            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.remove('border-transparent');
            activeBtn.classList.add(themeColors[state.theme], 'border-e1dark', 'shadow-neo');

            if(tabId === 'caller') {
                resetCaller();
            } else if (tabId === 'play') {
                generateDigitalCard();
            }
        }

        // --- CARD GENERATION LOGIC ---

        function generateCardHTML(isInteractive = false) {
            const size = state.gridSize;
            const totalCells = size * size;
            
            // Deep copy and shuffle words
            let pool = [...state.words];

            // FIX: If input is empty, provide placeholder to prevent infinite loop
            if (pool.length === 0) {
                pool = ["Add Words"];
            }

            if (pool.length < totalCells) {
                // Not enough words? Repeat them to fill. 
                // We use a safe source to ensure the pool actually grows.
                const source = state.words.length > 0 ? state.words : ["Add Words"];
                
                while(pool.length < totalCells) {
                    pool = pool.concat(source);
                }
            }
            pool = pool.sort(() => 0.5 - Math.random()).slice(0, totalCells);

            const centerIndex = Math.floor(totalCells / 2);
            const hasFreeSpace = state.freeSpace === 'center' && size % 2 !== 0;

            let gridHTML = `
                <div class="card-container bg-white border-4 border-e1dark rounded-xl overflow-hidden shadow-neo aspect-[4/5] flex flex-col w-full max-w-[400px] mx-auto break-inside-avoid">
                    <div class="${themeColors[state.theme]} border-b-4 border-e1dark p-3 text-center">
                        <h1 class="font-heading font-black text-4xl tracking-[0.2em] text-e1dark uppercase drop-shadow-sm">BINGO</h1>
                    </div>
                    <div class="grid grid-cols-${size} grid-rows-${size} flex-grow bg-e1dark gap-0.5 border-b-2 border-e1dark">
            `;

            // Logic for keeping track of values for validation
            const currentCardValues = [];

            for (let i = 0; i < totalCells; i++) {
                let content = pool[i];
                let isFree = false;

                if (hasFreeSpace && i === centerIndex) {
                    content = "FREE";
                    isFree = true;
                }

                currentCardValues.push(content);

                if (isInteractive) {
                    gridHTML += `
                        <div onclick="toggleCell(${i})" id="cell-${i}" class="bg-white flex items-center justify-center p-1 text-center font-bold text-xs md:text-sm select-none cursor-pointer hover:bg-slate-100 transition-colors aspect-square break-words overflow-hidden border border-slate-200">
                            <span class="${isFree ? 'text-e1pink font-black text-lg' : ''}">${content}</span>
                        </div>
                    `;
                } else {
                    gridHTML += `
                        <div class="bg-white flex items-center justify-center p-2 text-center font-body font-bold text-xs md:text-sm leading-tight border border-slate-200 aspect-square">
                            <span class="${isFree ? 'font-black' : ''}">${content}</span>
                        </div>
                    `;
                }
            }

            gridHTML += `
                    </div>
                    <div class="p-2 bg-e1chalk text-center text-xs font-bold text-slate-400 border-t-2 border-slate-200">
                        ${state.title}
                    </div>
                </div>
            `;
            
            if(isInteractive) {
                state.digitalCardValues = currentCardValues;
                state.digitalCardMarks = new Array(totalCells).fill(false);
                // Mark free space automatically
                if(hasFreeSpace) state.digitalCardMarks[centerIndex] = true;
            }

            return gridHTML;
        }

        function updatePreview() {
            document.getElementById('previewCard').innerHTML = generateCardHTML(false);
        }

        function generatePrintCards() {
            const count = parseInt(document.getElementById('printCount').value);
            const container = document.getElementById('printGrid');
            container.innerHTML = '';

            for(let i=0; i<count; i++) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = generateCardHTML(false);
                container.appendChild(wrapper.firstElementChild);
            }
        }

        // --- CALLER LOGIC ---

        function resetCaller() {
            state.callerQueue = [...state.words].sort(() => 0.5 - Math.random());
            state.calledHistory = [];
            document.getElementById('currentCall').textContent = "Ready?";
            document.getElementById('callHistory').innerHTML = '<div class="text-center text-slate-400 italic mt-4">No words called yet.</div>';
            document.getElementById('btnCallNext').disabled = false;
            document.getElementById('itemsRemaining').textContent = `0 / ${state.words.length} Called`;
        }

        function callNext() {
            if (state.callerQueue.length === 0) {
                document.getElementById('currentCall').textContent = "All Done!";
                document.getElementById('btnCallNext').disabled = true;
                return;
            }

            const word = state.callerQueue.pop();
            state.calledHistory.unshift(word);

            // Update Main Display
            const display = document.getElementById('currentCall');
            // Reset animation
            display.classList.remove('animate-bounce-short');
            void display.offsetWidth; // trigger reflow
            display.textContent = word;
            display.classList.add('animate-bounce-short');

            // Update Counts
            const total = state.words.length;
            const called = state.calledHistory.length;
            document.getElementById('itemsRemaining').textContent = `${called} / ${total} Called`;

            // Update History
            const historyEl = document.getElementById('callHistory');
            const newEntry = document.createElement('div');
            newEntry.className = "p-3 bg-white border-2 border-e1dark rounded-xl shadow-sm font-bold text-e1dark animate-fade-in flex items-center justify-between";
            newEntry.innerHTML = `<span>${word}</span> <span class="text-xs text-slate-400">#${called}</span>`;
            
            if(called === 1) historyEl.innerHTML = ''; // Clear placeholder
            historyEl.prepend(newEntry);
        }

        // --- INTERACTIVE CARD LOGIC ---

        function generateDigitalCard() {
            const container = document.getElementById('digitalCardContainer');
            container.innerHTML = generateCardHTML(true);
            
            // Re-apply free space visual if needed
            const centerIndex = Math.floor((state.gridSize * state.gridSize) / 2);
            if (state.freeSpace === 'center' && state.gridSize % 2 !== 0) {
                toggleCell(centerIndex, true); // Force mark visually without toggling off
            }
        }

        function toggleCell(index, forceMark = false) {
            const cell = document.getElementById(`cell-${index}`);
            
            if (!forceMark) {
                state.digitalCardMarks[index] = !state.digitalCardMarks[index];
            } else {
                 state.digitalCardMarks[index] = true;
            }

            const isMarked = state.digitalCardMarks[index];

            if (isMarked) {
                cell.classList.remove('bg-white');
                cell.classList.add('bg-e1pink', 'text-e1dark');
                // Add marker icon
                if(!cell.querySelector('.marker')) {
                    const marker = document.createElement('div');
                    marker.className = "marker absolute inset-0 flex items-center justify-center pointer-events-none opacity-20";
                    marker.innerHTML = `<i data-lucide="circle" class="w-full h-full p-1"></i>`;
                    cell.style.position = 'relative';
                    cell.appendChild(marker);
                    lucide.createIcons();
                }
            } else {
                cell.classList.add('bg-white');
                cell.classList.remove('bg-e1pink', 'text-e1dark');
                const marker = cell.querySelector('.marker');
                if(marker) marker.remove();
            }
        }

        function checkBingo() {
            const size = state.gridSize;
            const marks = state.digitalCardMarks;
            let isBingo = false;

            // Check Rows
            for (let r = 0; r < size; r++) {
                let rowFull = true;
                for (let c = 0; c < size; c++) {
                    if (!marks[r * size + c]) rowFull = false;
                }
                if (rowFull) isBingo = true;
            }

            // Check Cols
            for (let c = 0; c < size; c++) {
                let colFull = true;
                for (let r = 0; r < size; r++) {
                    if (!marks[r * size + c]) colFull = false;
                }
                if (colFull) isBingo = true;
            }

            // Check Diagonals
            let d1Full = true;
            let d2Full = true;
            for (let i = 0; i < size; i++) {
                if (!marks[i * size + i]) d1Full = false;
                if (!marks[i * size + (size - 1 - i)]) d2Full = false;
            }
            if (d1Full || d2Full) isBingo = true;

            if (isBingo) {
                showModal("BINGO!", "Congratulations! You completed a line.");
            } else {
                // Shake button or show small msg
                const btn = document.querySelector('#view-play button[onclick="checkBingo()"]');
                btn.classList.add('animate-wiggle'); // Custom class needed or simple transform
                btn.innerText = "Not yet!";
                setTimeout(() => {
                    btn.innerText = "BINGO!";
                    btn.classList.remove('animate-wiggle');
                }, 1000);
            }
        }

        // --- UTILS ---
        function showModal(title, msg) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMsg').textContent = msg;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modalContent').classList.add('scale-100');
            document.getElementById('modalContent').classList.remove('scale-95');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modalContent').classList.remove('scale-100');
            document.getElementById('modalContent').classList.add('scale-95');
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        // Custom animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce-short {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }
            .animate-bounce-short { animation: bounce-short 0.3s ease-in-out; }
            
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>