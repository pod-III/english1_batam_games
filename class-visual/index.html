<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom Visualizer - English 1 Batam</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                        }
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            overscroll-behavior: none;
        }
        
        .bg-grid {
            background-color: #f8fafc;
            background-image: linear-gradient(#cbd5e1 1px, transparent 1px),
            linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .dark .bg-grid {
            background-color: #0f172a;
            background-image: linear-gradient(#334155 1px, transparent 1px),
            linear-gradient(90deg, #334155 1px, transparent 1px);
            background-size: 40px 40px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        canvas { touch-action: none; }
    </style>
</head>
<body class="bg-grid text-brand-dark min-h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- Header -->
    <header class="bg-brand-pink border-b-4 border-brand-dark p-3 md:p-4 flex justify-between items-center z-20 shadow-hard relative">
        <div class="flex items-center gap-3">
            <div class="bg-white p-2 rounded-xl border-2 border-brand-dark shadow-hard-sm hidden md:block">
                <i data-lucide="layout-grid" class="w-6 h-6 text-brand-dark"></i>
            </div>
            <h1 class="font-heading text-xl md:text-2xl font-bold text-white text-shadow-sm" style="text-shadow: 2px 2px 0 #1e293b;">
                Classroom Visualizer
            </h1>
        </div>
        <div class="flex gap-2">
            <button onclick="app.toggleDarkMode()" class="bg-brand-dark text-white p-2 rounded-xl border-2 border-white/50 hover:bg-slate-700 transition-all">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
            <button onclick="app.toggleHelp()" class="bg-brand-blue text-white font-heading font-bold py-2 px-4 rounded-xl border-2 border-brand-dark shadow-hard hover:-translate-y-1 active:translate-y-0 transition-all flex items-center gap-2">
                <span class="hidden md:inline">Help</span>
                <i data-lucide="help-circle" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 h-full relative overflow-hidden">
        <!-- Sidebar Controls -->
        <aside class="w-24 md:w-72 bg-white dark:bg-slate-800 border-r-4 border-brand-dark flex flex-col shadow-hard z-10 transition-colors duration-300">
            <div class="p-2 md:p-6 flex flex-col gap-6 overflow-y-auto h-full">
                
                <!-- Tools -->
                <div class="flex flex-col gap-2">
                    <h2 class="hidden md:flex font-heading text-xl font-bold mb-2 items-center gap-2 dark:text-white">
                        <i data-lucide="users" class="w-5 h-5 text-brand-green"></i> People
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3">
                        <button onclick="app.addItem('student')" class="bg-brand-green text-brand-dark font-heading font-bold py-3 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:-translate-y-0.5 active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1 text-xs md:text-sm">
                            <i data-lucide="user" class="w-5 h-5"></i> <span class="hidden md:inline">Student</span>
                        </button>
                        <button onclick="app.addItem('teacher')" class="bg-brand-orange text-brand-dark font-heading font-bold py-3 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:-translate-y-0.5 active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1 text-xs md:text-sm">
                            <i data-lucide="monitor" class="w-5 h-5"></i> <span class="hidden md:inline">Teacher</span>
                        </button>
                    </div>
                </div>

                <hr class="border-2 border-brand-dark border-dashed opacity-50">

                <!-- Presets -->
                <div class="flex flex-col gap-2">
                    <h2 class="hidden md:flex font-heading text-xl font-bold mb-2 items-center gap-2 dark:text-white">
                        <i data-lucide="layout" class="w-5 h-5 text-brand-pink"></i> Presets
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3">
                        <button onclick="app.applyPreset('rows')" class="bg-brand-chalk text-brand-dark font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-white active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="align-justify" class="w-4 h-4"></i> <span class="hidden md:inline">Rows</span>
                        </button>
                        <button onclick="app.applyPreset('groups')" class="bg-brand-chalk text-brand-dark font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-white active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="grid" class="w-4 h-4"></i> <span class="hidden md:inline">Groups</span>
                        </button>
                        <button onclick="app.applyPreset('ushape')" class="bg-brand-chalk text-brand-dark font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-white active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="u-turn-down" class="w-4 h-4"></i> <span class="hidden md:inline">U-Shape</span>
                        </button>
                        <button onclick="app.applyPreset('circle')" class="bg-brand-chalk text-brand-dark font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-white active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="circle" class="w-4 h-4"></i> <span class="hidden md:inline">Circle</span>
                        </button>
                    </div>
                </div>

                <hr class="border-2 border-brand-dark border-dashed opacity-50">

                <!-- Furniture -->
                <div class="flex flex-col gap-2">
                    <h2 class="hidden md:flex font-heading text-xl font-bold mb-2 items-center gap-2 dark:text-white">
                        <i data-lucide="armchair" class="w-5 h-5 text-brand-blue"></i> Furniture
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3">
                        <button onclick="app.addItem('table_rect')" class="bg-brand-blue/20 text-brand-dark dark:text-brand-blue font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-brand-blue/30 active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-xs md:text-sm">
                            <i data-lucide="square" class="w-4 h-4"></i> <span class="hidden md:inline">Table</span>
                        </button>
                        <button onclick="app.addItem('table_round')" class="bg-brand-blue/20 text-brand-dark dark:text-brand-blue font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-brand-blue/30 active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-xs md:text-sm">
                            <i data-lucide="circle" class="w-4 h-4"></i> <span class="hidden md:inline">Round</span>
                        </button>
                        <button onclick="app.addItem('bookshelf')" class="bg-brand-blue/20 text-brand-dark dark:text-brand-blue font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-brand-blue/30 active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-xs md:text-sm">
                            <i data-lucide="library" class="w-4 h-4"></i> <span class="hidden md:inline">Shelf</span>
                        </button>
                        <button onclick="app.addItem('whiteboard')" class="bg-brand-blue/20 text-brand-dark dark:text-brand-blue font-heading font-bold py-2 px-2 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-brand-blue/30 active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-xs md:text-sm">
                            <i data-lucide="presentation" class="w-4 h-4"></i> <span class="hidden md:inline">Board</span>
                        </button>
                    </div>
                </div>

                <hr class="border-2 border-brand-dark border-dashed opacity-50">

                <!-- Actions -->
                <div class="flex flex-col gap-2">
                    <h2 class="hidden md:flex font-heading text-xl font-bold mb-2 items-center gap-2 dark:text-white">
                        <i data-lucide="settings-2" class="w-5 h-5 text-brand-pink"></i> Actions
                    </h2>
                    <div class="flex flex-col gap-2 md:gap-3">
                         <button onclick="app.editTitle()" class="bg-white text-brand-dark font-heading font-bold py-2 px-2 md:px-4 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-slate-50 transition-all flex items-center justify-center md:justify-start gap-2">
                            <i data-lucide="type" class="w-4 h-4"></i> <span class="hidden md:inline">Edit Title</span>
                        </button>
                        
                        <button onclick="app.deleteSelected()" class="bg-orange-100 text-brand-dark font-heading font-bold py-2 px-2 md:px-4 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-orange-200 transition-all flex items-center justify-center md:justify-start gap-2">
                            <i data-lucide="eraser" class="w-4 h-4"></i> <span class="hidden md:inline">Remove Selected</span>
                        </button>

                        <button onclick="app.clearCanvas()" class="bg-red-400 text-brand-dark font-heading font-bold py-2 px-2 md:px-4 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-red-500 transition-all flex items-center justify-center md:justify-start gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> <span class="hidden md:inline">Reset Room</span>
                        </button>
                        <button onclick="app.exportImage()" class="bg-brand-chalk text-brand-dark font-heading font-bold py-2 px-2 md:px-4 rounded-xl border-2 border-brand-dark shadow-hard hover:bg-slate-100 transition-all flex items-center justify-center md:justify-start gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i> <span class="hidden md:inline">Snap</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas -->
        <main class="flex-1 relative overflow-hidden bg-transparent" id="canvas-container">
            <canvas id="classCanvas" class="block"></canvas>
            
            <div class="absolute top-4 right-4 pointer-events-none opacity-60">
                <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-3 rounded-xl border-2 border-brand-dark text-xs font-bold font-heading">
                    Drag empty space to Select â€¢ Press Delete to Remove
                </div>
            </div>
            
            <div class="absolute bottom-6 right-6 bg-white dark:bg-slate-800 border-2 border-brand-dark rounded-xl px-4 py-2 shadow-hard pointer-events-none opacity-90 z-0">
                <p class="font-heading font-bold text-sm dark:text-white">Fahrul's Class Visualizer</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="customModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] p-6 transform transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modalTitle" class="font-heading text-2xl font-bold text-brand-dark dark:text-white">Edit Name</h3>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-brand-pink transition-colors">
                    <i data-lucide="x-circle" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modalContent">
                <input type="text" id="modalInput" class="w-full font-body text-lg p-3 rounded-xl border-2 border-brand-dark focus:outline-none focus:ring-4 focus:ring-brand-blue/30 mb-6 bg-brand-chalk dark:bg-slate-700 dark:text-white" placeholder="Enter name..." autocomplete="off">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="app.closeModal()" class="font-heading font-bold text-slate-500 dark:text-slate-400 hover:text-slate-700 px-4 py-2">Cancel</button>
                <button id="modalActionBtn" class="bg-brand-green text-brand-dark font-heading font-bold py-2 px-6 rounded-xl border-2 border-brand-dark shadow-hard active:translate-y-1 active:shadow-none transition-all">Save</button>
            </div>
        </div>
    </div>
    
    <div id="notifyModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] p-6 text-center">
            <div class="mb-4 flex justify-center">
                <div class="bg-brand-pink/20 p-3 rounded-full border-2 border-brand-pink">
                    <i data-lucide="info" class="w-8 h-8 text-brand-pink"></i>
                </div>
            </div>
            <h3 id="notifyTitle" class="font-heading text-xl font-bold mb-2 dark:text-white">Notice</h3>
            <p id="notifyMessage" class="font-body text-slate-600 dark:text-slate-300 mb-6">Message goes here.</p>
            <button onclick="app.closeNotify()" class="w-full bg-brand-blue text-white font-heading font-bold py-2 rounded-xl border-2 border-brand-dark shadow-hard active:translate-y-0.5 active:shadow-sm">Got it</button>
        </div>
    </div>

    <script>
        /**
         * CLASSROOM VISUALIZER V9 - REFACTORED
         * Features: High DPI support, Grid Snapping, Unified Input, Modular Class Structure
         */

        const CONFIG = {
            gridSize: 10,
            zoneY: 190,
            dims: {
                student: { w: 60, h: 60, r: 35 },
                teacher: { w: 160, h: 90 },
                table_rect: { w: 200, h: 100 },
                table_round: { w: 140, h: 140, r: 70 },
                whiteboard: { w: 300, h: 20 },
                bookshelf: { w: 120, h: 60 }
            },
            themes: {
                light: {
                    student: '#FF6B95', teacher: '#FF8C42', furniture: '#e2e8f0', chair: '#cbd5e1',
                    border: '#1e293b', text: '#1e293b', titleText: '#1e293b', gridLine: '#cbd5e1',
                    selection: 'rgba(41, 121, 255, 0.2)', selectionBorder: '#2979FF', deskStrip: '#ea580c'
                },
                dark: {
                    student: '#be185d', teacher: '#c2410c', furniture: '#334155', chair: '#475569',
                    border: '#e2e8f0', text: '#e2e8f0', titleText: '#f8fafc', gridLine: '#334155',
                    selection: 'rgba(41, 121, 255, 0.3)', selectionBorder: '#60a5fa', deskStrip: '#9a3412'
                }
            }
        };

        class Item {
            constructor(x, y, type, name = '') {
                this.id = Date.now() + Math.random();
                this.x = x;
                this.y = y;
                this.type = type;
                this.name = name;
                this.initDims();
            }

            initDims() {
                const d = CONFIG.dims[this.type];
                if (!d) return;
                this.w = d.w;
                this.h = d.h;
                this.radius = d.r;
                if (!this.name) {
                    const names = { student: 'Student', teacher: 'Teacher', table_rect: 'Table', table_round: 'Round Table', whiteboard: 'Board', bookshelf: 'Shelf' };
                    this.name = names[this.type] || 'Item';
                }
            }

            // Snap to grid helper
            snap() {
                this.x = Math.round(this.x / CONFIG.gridSize) * CONFIG.gridSize;
                this.y = Math.round(this.y / CONFIG.gridSize) * CONFIG.gridSize;
            }

            isHit(mx, my) {
                if (this.radius) {
                    const cx = this.x + this.radius;
                    const cy = this.y + this.radius;
                    // Add extra hit area for chairs (students)
                    const extra = this.type === 'student' ? 10 : 0;
                    return Math.sqrt((mx - cx) ** 2 + (my - cy) ** 2) <= (this.radius + extra);
                } else {
                    return mx >= this.x && mx <= this.x + this.w && my >= this.y && my <= this.y + this.h;
                }
            }

            isInsideRect(rX, rY, rW, rH) {
                const rx = rW < 0 ? rX + rW : rX;
                const ry = rH < 0 ? rY + rH : rY;
                const rw = Math.abs(rW);
                const rh = Math.abs(rH);
                const cx = this.x + (this.w ? this.w / 2 : this.radius);
                const cy = this.y + (this.h ? this.h / 2 : this.radius);
                return cx >= rx && cx <= rx + rw && cy >= ry && cy <= ry + rh;
            }

            draw(ctx, theme, isSelected, isDarkMode) {
                if (isSelected) this.drawSelection(ctx, theme);
                
                if (this.type === 'student') this.drawStudent(ctx, theme, isDarkMode);
                else if (this.type === 'teacher') this.drawTeacher(ctx, theme, isDarkMode);
                else if (this.type === 'table_round') this.drawRoundTable(ctx, theme, isDarkMode);
                else this.drawRectFurniture(ctx, theme, isDarkMode);
            }

            drawSelection(ctx, theme) {
                ctx.save();
                ctx.strokeStyle = theme.selectionBorder;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                const p = 8; // padding
                if (this.radius) {
                    const cx = this.x + this.radius;
                    const cy = this.y + this.radius;
                    let r = this.radius + p;
                    if(this.type === 'student') r += 5; 
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                } else {
                    ctx.strokeRect(this.x - p, this.y - p, this.w + p * 2, this.h + p * 2);
                }
                ctx.restore();
            }

            drawText(ctx, theme, x, y, base = 'top') {
                ctx.fillStyle = theme.text;
                ctx.font = "bold 14px 'Fredoka'";
                ctx.textAlign = "center";
                ctx.textBaseline = base;
                let t = this.name;
                if (t.length > 12) t = t.slice(0, 10) + '..';
                ctx.fillText(t, x, y);
            }

            // --- Specialized Drawers ---
            drawStudent(ctx, theme, isDark) {
                const cx = this.x + this.radius, cy = this.y + this.radius;
                // Chair
                const cw = this.radius * 2.2, ch = this.radius * 2;
                this.drawRounded(ctx, cx - cw/2, cy - this.radius - 5, cw, ch, 15, theme.chair, theme.border);
                
                // Body & Shadow
                this.drawCircle(ctx, cx + 3, cy + 3, this.radius, isDark ? 'rgba(0,0,0,0.5)' : 'rgba(30,41,59,1)');
                this.drawCircle(ctx, cx, cy, this.radius, theme.student, theme.border);
                
                // Silhouette
                ctx.fillStyle = isDark ? 'rgba(255,255,255,0.8)' : 'rgba(255,255,255,0.9)';
                ctx.beginPath(); ctx.arc(cx, cy - 8, 12, 0, Math.PI * 2); ctx.fill();
                ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, this.radius - 3, 0, Math.PI*2); ctx.clip();
                ctx.beginPath(); ctx.ellipse(cx, cy + 25, 20, 18, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
                
                this.drawText(ctx, theme, cx, cy + this.radius + 15);
            }

            drawTeacher(ctx, theme, isDark) {
                this.drawRectBase(ctx, theme.teacher, theme.border, isDark);
                // Desk Strip
                ctx.fillStyle = theme.deskStrip;
                ctx.fillRect(this.x + 10, this.y + this.h - 25, this.w - 20, 15);
                // Papers
                ctx.fillStyle = '#f1f5f9';
                ctx.fillRect(this.x + 20, this.y + 20, 25, 30);
                ctx.strokeRect(this.x + 20, this.y + 20, 25, 30);
                // Text Lines
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fillRect(this.x + 24, this.y + 26, 17, 2);
                ctx.fillRect(this.x + 24, this.y + 32, 17, 2);
                
                this.drawText(ctx, theme, this.x + this.w/2, this.y + this.h/2 + 5, 'middle');
            }

            drawRoundTable(ctx, theme, isDark) {
                const cx = this.x + this.radius, cy = this.y + this.radius;
                this.drawCircle(ctx, cx + 4, cy + 4, this.radius, isDark ? 'rgba(0,0,0,0.5)' : 'rgba(30,41,59,1)'); // Shadow
                this.drawCircle(ctx, cx, cy, this.radius, theme.furniture, theme.border);
                // Highlight
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.beginPath(); ctx.arc(cx, cy, this.radius - 5, 0, Math.PI*2); ctx.fill();
                this.drawText(ctx, theme, cx, cy, 'top'); // Changed text base for round table
            }

            drawRectFurniture(ctx, theme, isDark) {
                let color = theme.furniture;
                if(this.type === 'whiteboard') color = '#f1f5f9';
                this.drawRectBase(ctx, color, theme.border, isDark);
                
                if(this.type === 'bookshelf') {
                    ctx.beginPath();
                    ctx.moveTo(this.x + 10, this.y + 10); ctx.lineTo(this.x + this.w - 10, this.y + 10);
                    ctx.moveTo(this.x + 10, this.y + 30); ctx.lineTo(this.x + this.w - 10, this.y + 30);
                    ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.stroke();
                }
                this.drawText(ctx, theme, this.x + this.w/2, this.y + this.h/2, 'middle');
            }

            // Primitive Helpers
            drawRectBase(ctx, fill, border, isDark) {
                // Shadow
                ctx.fillStyle = isDark ? 'rgba(0,0,0,0.5)' : 'rgba(30,41,59,1)';
                ctx.fillRect(this.x + 4, this.y + 4, this.w, this.h);
                this.drawRounded(ctx, this.x, this.y, this.w, this.h, 8, fill, border);
            }
            
            drawRounded(ctx, x, y, w, h, r, fill, stroke) {
                ctx.fillStyle = fill; ctx.strokeStyle = stroke; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.roundRect(x, y, w, h, r);
                ctx.fill(); ctx.stroke();
            }

            drawCircle(ctx, x, y, r, fill, stroke = null) {
                ctx.fillStyle = fill;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                if(stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = 3; ctx.stroke(); }
            }
        }

        class App {
            constructor() {
                this.canvas = document.getElementById('classCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.container = document.getElementById('canvas-container');
                
                this.items = [];
                this.moduleName = "English Class: Module 1";
                this.themeMode = 'light';
                
                // Interaction State
                this.selectedIds = new Set();
                this.dragOffsets = [];
                this.isDragging = false;
                this.isSelecting = false;
                this.selStart = {x: 0, y: 0};
                this.selEnd = {x: 0, y: 0};
                this.lastTap = 0;

                // Modals
                this.modal = {
                    el: document.getElementById('customModal'),
                    input: document.getElementById('modalInput'),
                    title: document.getElementById('modalTitle'),
                    btn: document.getElementById('modalActionBtn'),
                    target: null,
                    isTitle: false
                };
                this.notify = {
                    el: document.getElementById('notifyModal'),
                    title: document.getElementById('notifyTitle'),
                    msg: document.getElementById('notifyMessage')
                };

                this.initListeners();
                this.resize();
                
                // Initial Data
                setTimeout(() => {
                    this.addItem('teacher');
                    for(let i=0; i<6; i++) this.addItem('student');
                    const b = new Item(0,0,'whiteboard');
                    b.x = this.canvas.width/this.dpr/2 - 150; b.y = 90;
                    this.items.push(b);
                    this.applyPreset('groups');
                }, 100);
            }

            get theme() { return CONFIG.themes[this.themeMode]; }
            get isDark() { return this.themeMode === 'dark'; }

            initListeners() {
                window.addEventListener('resize', () => this.resize());
                
                // Unified Input Handler
                const handleStart = (e) => {
                    if(e.type === 'touchstart') e.preventDefault();
                    const pos = this.getPos(e);
                    
                    // Double Tap
                    const now = Date.now();
                    if(now - this.lastTap < 300) { this.handleDoubleTap(pos); return; }
                    this.lastTap = now;

                    // Hit Test
                    // Sort items by visual order (topmost first for hit testing)
                    // The drawing order is Y-sorted, so top is end of array
                    let hitItem = null;
                    const sorted = [...this.items].sort((a,b) => a.y - b.y);
                    for(let i=sorted.length-1; i>=0; i--) {
                        if(sorted[i].isHit(pos.x, pos.y)) { hitItem = sorted[i]; break; }
                    }

                    if(hitItem) {
                        this.isDragging = true;
                        this.isSelecting = false;
                        if(!this.selectedIds.has(hitItem.id)) {
                            this.selectedIds.clear();
                            this.selectedIds.add(hitItem.id);
                        }
                        // Calculate offsets
                        this.dragOffsets = this.items
                            .filter(it => this.selectedIds.has(it.id))
                            .map(it => ({ id: it.id, dx: pos.x - it.x, dy: pos.y - it.y }));
                    } else {
                        this.isDragging = false;
                        this.isSelecting = true;
                        this.selectedIds.clear();
                        this.selStart = { ...pos };
                        this.selEnd = { ...pos };
                    }
                    this.draw();
                };

                const handleMove = (e) => {
                    if(e.type === 'touchmove') e.preventDefault();
                    const pos = this.getPos(e);
                    
                    if(this.isDragging) {
                        this.items.forEach(it => {
                            if(this.selectedIds.has(it.id)) {
                                const off = this.dragOffsets.find(d => d.id === it.id);
                                if(off) {
                                    it.x = pos.x - off.dx;
                                    it.y = pos.y - off.dy;
                                    // Snap to Grid (10px)
                                    it.snap();
                                }
                            }
                        });
                        this.draw();
                    } else if (this.isSelecting) {
                        this.selEnd = { ...pos };
                        this.draw();
                    } else {
                        // Hover cursor logic
                        let hover = this.isMouseOverTitle(pos.x, pos.y) || this.items.some(it => it.isHit(pos.x, pos.y));
                        this.canvas.style.cursor = hover ? 'pointer' : 'default';
                    }
                };

                const handleEnd = () => {
                    if(this.isSelecting) {
                        const w = this.selEnd.x - this.selStart.x;
                        const h = this.selEnd.y - this.selStart.y;
                        this.items.forEach(it => {
                            if(it.isInsideRect(this.selStart.x, this.selStart.y, w, h)) {
                                this.selectedIds.add(it.id);
                            }
                        });
                    }
                    this.isDragging = false;
                    this.isSelecting = false;
                    this.draw();
                };

                ['mousedown', 'touchstart'].forEach(ev => this.canvas.addEventListener(ev, handleStart, {passive:false}));
                ['mousemove', 'touchmove'].forEach(ev => this.canvas.addEventListener(ev, handleMove, {passive:false}));
                ['mouseup', 'touchend'].forEach(ev => this.canvas.addEventListener(ev, handleEnd));
                
                // Keyboard
                window.addEventListener('keydown', (e) => {
                    if((e.key === 'Delete' || e.key === 'Backspace') && document.activeElement.tagName !== 'INPUT') {
                        this.deleteSelected();
                    }
                });

                // Modal
                this.modal.input.addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') { e.preventDefault(); this.modal.btn.click(); }
                });
                this.modal.btn.onclick = () => this.saveEdit();
            }

            // --- Rendering ---
            resize() {
                // High DPI Support
                this.dpr = window.devicePixelRatio || 1;
                const rect = this.container.getBoundingClientRect();
                this.canvas.width = rect.width * this.dpr;
                this.canvas.height = rect.height * this.dpr;
                this.ctx.scale(this.dpr, this.dpr);
                this.canvas.style.width = `${rect.width}px`;
                this.canvas.style.height = `${rect.height}px`;
                this.draw();
            }

            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            draw() {
                const w = this.canvas.width / this.dpr;
                const h = this.canvas.height / this.dpr;
                
                this.ctx.clearRect(0, 0, w, h);
                
                // Title
                this.ctx.fillStyle = this.theme.titleText;
                this.ctx.font = "bold 28px 'Fredoka'";
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "top";
                if(!this.isDark) {
                    this.ctx.fillStyle = 'rgba(30,41,59,0.1)';
                    this.ctx.fillText(this.moduleName, w/2 + 2, 42);
                }
                this.ctx.fillStyle = this.theme.titleText;
                this.ctx.fillText(this.moduleName, w/2, 40);

                // Teacher Zone
                this.ctx.strokeStyle = this.theme.gridLine;
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([10, 10]);
                this.ctx.beginPath();
                this.ctx.moveTo(40, CONFIG.zoneY);
                this.ctx.lineTo(w - 40, CONFIG.zoneY);
                this.ctx.stroke();
                this.ctx.setLineDash([]);
                this.ctx.fillStyle = this.isDark ? '#475569' : '#94a3b8';
                this.ctx.font = "bold 12px 'Nunito'";
                this.ctx.textAlign = "left";
                this.ctx.fillText("TEACHER ZONE", 80, CONFIG.zoneY - 15);

                // Draw Items (Y-sorted for pseudo depth)
                const sorted = [...this.items].sort((a,b) => a.y - b.y);
                sorted.forEach(it => {
                    it.draw(this.ctx, this.theme, this.selectedIds.has(it.id), this.isDark);
                });

                // Selection Box
                if(this.isSelecting) {
                    this.ctx.save();
                    this.ctx.strokeStyle = this.theme.selectionBorder;
                    this.ctx.fillStyle = this.theme.selection;
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    const sw = this.selEnd.x - this.selStart.x;
                    const sh = this.selEnd.y - this.selStart.y;
                    this.ctx.fillRect(this.selStart.x, this.selStart.y, sw, sh);
                    this.ctx.strokeRect(this.selStart.x, this.selStart.y, sw, sh);
                    // Dimensions Label
                    this.ctx.fillStyle = this.theme.selectionBorder;
                    this.ctx.font = "10px monospace";
                    this.ctx.setLineDash([]);
                    this.ctx.fillText(`${Math.abs(Math.round(sw))}x${Math.abs(Math.round(sh))}`, this.selStart.x, this.selStart.y - 5);
                    this.ctx.restore();
                }
            }

            // --- Logic Helpers ---
            isMouseOverTitle(mx, my) {
                const cx = (this.canvas.width / this.dpr) / 2;
                return mx > cx - 200 && mx < cx + 200 && my > 20 && my < 80;
            }

            handleDoubleTap(pos) {
                if(this.isMouseOverTitle(pos.x, pos.y)) {
                    this.editTitle();
                    return;
                }
                // Check topmost item
                const sorted = [...this.items].sort((a,b) => a.y - b.y);
                for(let i=sorted.length-1; i>=0; i--) {
                    if(sorted[i].isHit(pos.x, pos.y)) {
                        this.openModal(sorted[i]);
                        return;
                    }
                }
            }

            // --- Public Actions (UI) ---
            toggleDarkMode() {
                this.themeMode = this.isDark ? 'light' : 'dark';
                document.documentElement.classList.toggle('dark');
                this.draw();
            }

            addItem(type) {
                const item = new Item(50 + Math.random()*100, 280 + Math.random()*100, type);
                if(type === 'student') item.name = `Student ${this.items.filter(i=>i.type==='student').length + 1}`;
                item.snap();
                this.items.push(item);
                this.draw();
            }

            deleteSelected() {
                if(this.selectedIds.size === 0) {
                    this.showNotify("No Selection", "Select items to remove.");
                    return;
                }
                this.items = this.items.filter(it => !this.selectedIds.has(it.id));
                this.selectedIds.clear();
                this.isDragging = false;
                this.draw();
                this.showNotify("Removed", "Selected items deleted.");
            }

            clearCanvas() {
                this.items = [];
                this.draw();
                this.showNotify("Cleared", "Room reset.");
            }

            applyPreset(type) {
                // Logic: Keep Teacher/Furniture, rebuild students
                const keep = this.items.filter(i => i.type !== 'student');
                let count = this.items.filter(i => i.type === 'student').length;
                count = Math.max(8, count);

                // Teacher Check
                let teacher = keep.find(i => i.type === 'teacher');
                const cx = (this.canvas.width/this.dpr) / 2;
                if(!teacher) { teacher = new Item(cx - 80, 120, 'teacher'); keep.push(teacher); }
                else { teacher.x = cx - 80; teacher.y = 120; }

                const students = [];
                for(let i=0; i<count; i++) students.push(new Item(0,0,'student', `Student ${i+1}`));

                // Arrangement
                const startY = 280;
                const w = this.canvas.width / this.dpr;
                
                if(type === 'rows') {
                    const unit = 100; // 80 size + 20 gap
                    const cols = Math.max(3, Math.min(8, Math.floor((w-50)/unit)));
                    const startX = cx - ((cols-1)*unit)/2;
                    students.forEach((s, i) => {
                        s.x = startX + (i%cols)*unit - s.radius;
                        s.y = startY + Math.floor(i/cols)*110 - s.radius;
                    });
                } else if (type === 'circle') {
                    const r = Math.min(w/2, (window.innerHeight - startY)/2) - 50;
                    const cy = startY + r + 10;
                    students.forEach((s, i) => {
                        const a = (i/count)*Math.PI*2 - Math.PI/2;
                        s.x = cx + Math.cos(a)*r - s.radius;
                        s.y = cy + Math.sin(a)*r - s.radius;
                    });
                } else if (type === 'groups') { // Groups of 4
                    const gSize = 160, gGap = 70;
                    const gPerRow = Math.max(2, Math.floor(w/(gSize+gGap)));
                    const gW = gPerRow*gSize + (gPerRow-1)*gGap;
                    const startX = (w-gW)/2 + gSize/2;
                    students.forEach((s, i) => {
                        const gIdx = Math.floor(i/4), pos = i%4;
                        const gr = Math.floor(gIdx/gPerRow), gc = gIdx%gPerRow;
                        const gcx = startX + gc*(gSize+gGap), gcy = startY + 60 + gr*(gSize+80);
                        const ox = (pos%2 ? 40 : -40), oy = (pos<2 ? -40 : 40);
                        s.x = gcx + ox - s.radius; s.y = gcy + oy - s.radius;
                    });
                } else { // U Shape
                    const side = Math.ceil(count/3);
                    const pad = Math.max(40, w*0.1);
                    const rx = w - pad;
                    const sy = 80;
                    let idx = 0;
                    // Left & Right
                    for(let i=0; i<side && idx<count; i++) {
                        students[idx].x = pad - students[idx].radius; students[idx].y = startY + i*sy; idx++;
                    }
                    for(let i=0; i<side && idx<count; i++) {
                        students[idx].x = rx - students[idx].radius; students[idx].y = startY + i*sy; idx++;
                    }
                    // Bottom
                    const rem = count - idx;
                    if(rem > 0) {
                        const by = startY + (side-1)*sy + 80;
                        const sp = (rx - pad)/(rem+1);
                        for(let i=0; i<rem; i++) {
                            students[idx].x = pad + (i+1)*sp - students[idx].radius; students[idx].y = by; idx++;
                        }
                    }
                }

                this.items = [...keep, ...students];
                this.draw();
                this.showNotify("Applied", `${type} layout applied.`);
            }

            // --- Modal/Notify ---
            openModal(item, isTitle = false) {
                this.modal.target = item;
                this.modal.isTitle = isTitle;
                this.modal.title.innerText = isTitle ? "Edit Title" : "Edit Name";
                this.modal.input.value = isTitle ? this.moduleName : item.name;
                this.modal.el.classList.remove('hidden');
                this.modal.el.classList.add('flex');
                setTimeout(() => this.modal.input.focus(), 50);
            }
            saveEdit() {
                if(this.modal.isTitle) this.moduleName = this.modal.input.value;
                else if(this.modal.target) this.modal.target.name = this.modal.input.value;
                this.closeModal();
                this.draw();
            }
            closeModal() {
                this.modal.el.classList.add('hidden');
                this.modal.el.classList.remove('flex');
                this.modal.target = null;
            }
            editTitle() { this.openModal(null, true); }
            showNotify(t, m) {
                this.notify.title.innerText = t;
                this.notify.msg.innerText = m;
                this.notify.el.classList.remove('hidden');
                this.notify.el.classList.add('flex');
            }
            closeNotify() { this.notify.el.classList.add('hidden'); this.notify.el.classList.remove('flex'); }
            toggleHelp() { this.showNotify("Help", "Drag to move/select. Double-tap to rename. Items snap to grid."); }
            exportImage() {
                const link = document.createElement('a');
                link.download = 'classroom.png';
                link.href = this.canvas.toDataURL();
                link.click();
                this.showNotify("Saved", "Screenshot downloaded.");
            }
        }

        // Init App
        lucide.createIcons();
        const app = new App();

    </script>
</body>
</html>