<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 | Rapid Presenter</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            bg: '#F8FAFC',
                        }
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #1e293b',
                        'hard-sm': '2px 2px 0px 0px #1e293b',
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-out': 'fadeOut 2s forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'slide-out': 'slideOut 0.3s ease-in forwards',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-20px)' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .btn-chunky { transition: all 0.1s ease; }
        .btn-chunky:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px 0px #1e293b; }

        .slide-card { transition: all 0.2s ease; }
        .slide-card:hover { transform: translateY(-2px); }

        /* Locked Field Styling */
        .input-locked {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(1);
        }
        .input-locked::after {
            content: "Hidden in this layout";
            position: absolute;
            inset: 0;
            background: rgba(241, 245, 249, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
            border-radius: 0.5rem;
            border: 2px dashed #cbd5e1;
            z-index: 10;
        }

        /* Presentation CSS */
        .layout-hero #display-word { font-size: clamp(4rem, 15vw, 15rem); text-align: center; }
        .layout-hero #display-image { display: none; }

        .layout-split { flex-direction: row; gap: 4rem; }
        .layout-split #display-word { font-size: clamp(2rem, 5vw, 5rem); width: 50%; text-align: left; }
        .layout-split #display-image { width: 50%; max-height: 80vh; }
        @media (max-width: 768px) {
            .layout-split { flex-direction: column; }
            .layout-split #display-word, .layout-split #display-image { width: 100%; text-align: center; }
        }

        .layout-caption { flex-direction: column; justify-content: center; gap: 2rem; }
        .layout-caption #display-image { max-height: 60vh; }
        .layout-caption #display-word { font-size: clamp(1.5rem, 4vw, 3rem); }

        .layout-full #display-image { width: 95vw; height: 90vh; object-fit: contain; max-width: none; border: none; box-shadow: none; }
        .layout-full #display-word { display: none; }
        
        /* Grid Styles */
        .grid-card.dragging { opacity: 0.4; border-style: dashed; }
        .grid-card.drag-over { border-color: #2979FF; transform: scale(1.05); }

        /* Toast */
        .toast-enter { animation: pop 0.3s forwards; }

        /* Library Drawer */
        #library-drawer { z-index: 60; }
        .library-item:hover { border-color: #2979FF; background-color: #F8FAFC; }
    </style>
</head>
<body class="font-body text-brand-dark min-h-screen flex flex-col overflow-hidden">

    <div id="toast-container" class="fixed bottom-6 right-6 z-[80] flex flex-col gap-2 pointer-events-none"></div>

    <input type="file" id="importInput" accept=".json" class="hidden" onchange="app.processImport(this)">

    <nav class="w-full bg-white border-b-4 border-brand-dark px-6 py-4 sticky top-0 z-40 flex-none">
        <div class="max-w-6xl mx-auto flex justify-between items-center w-full">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-brand-pink border-2 border-brand-dark rounded-lg flex items-center justify-center shadow-hard-sm">
                    <i data-lucide="monitor-play" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-heading font-bold text-2xl tracking-wide leading-none">Rapid<span class="text-brand-blue">Presenter</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="current-deck-name" class="text-xs font-bold text-gray-400 uppercase tracking-widest">Unsaved Session</span>
                        <span id="save-status-indicator" class="w-2 h-2 rounded-full bg-brand-orange"></span>
                    </div>
                </div>
            </div>
            <button onclick="document.getElementById('help-modal').classList.remove('hidden')" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Keyboard Shortcuts">
                <i data-lucide="keyboard" class="w-6 h-6"></i>
            </button>
        </div>
    </nav>

    <main class="flex-grow flex items-stretch justify-center p-4 sm:p-6 h-[calc(100vh-80px)]">
        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            
            <div class="lg:col-span-3 flex flex-col gap-4 h-full overflow-y-auto pr-2 custom-scroll pb-20">
                
                <button onclick="app.toggleLibrary()" class="btn-chunky w-full py-3 bg-brand-dark border-4 border-brand-dark rounded-xl text-white font-heading font-bold text-lg shadow-hard flex items-center justify-center gap-2 hover:bg-slate-700">
                    <i data-lucide="library" class="w-5 h-5"></i> MY LIBRARY
                </button>

                <div class="bg-white border-4 border-brand-dark rounded-2xl p-5 shadow-hard flex flex-col gap-4">
                    <h2 class="font-heading font-bold text-lg border-b-2 border-gray-100 pb-2">Session Info</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-brand-bg border-2 border-brand-dark rounded-xl p-2 text-center">
                            <span class="block text-gray-500 text-[10px] font-bold uppercase">Slides</span>
                            <span id="stat-count" class="font-heading text-xl font-bold text-brand-blue">0</span>
                        </div>
                        <div class="bg-brand-bg border-2 border-brand-dark rounded-xl p-2 text-center">
                            <span class="block text-gray-500 text-[10px] font-bold uppercase">Est. Time</span>
                            <span id="stat-time" class="font-heading text-xl font-bold text-brand-orange">0m</span>
                        </div>
                    </div>
                </div>

                <button onclick="app.addSlide()" class="btn-chunky w-full py-3 bg-brand-blue border-4 border-brand-dark rounded-xl text-white font-heading font-bold text-lg shadow-hard flex items-center justify-center gap-2 hover:brightness-105" title="Ctrl + Enter">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> ADD SLIDE
                </button>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.manualSave()" class="btn-chunky w-full py-2 bg-white border-4 border-brand-dark rounded-xl text-brand-dark font-heading font-bold text-sm shadow-hard flex items-center justify-center gap-2 hover:bg-gray-50" title="Save to Library (Ctrl+S)">
                        <i data-lucide="save" class="w-4 h-4 text-brand-green"></i> Save
                    </button>
                    <button onclick="app.exportJSON()" class="btn-chunky w-full py-2 bg-white border-4 border-brand-dark rounded-xl text-brand-dark font-heading font-bold text-sm shadow-hard flex items-center justify-center gap-2 hover:bg-gray-50" title="Export File">
                        <i data-lucide="download" class="w-4 h-4 text-brand-orange"></i> Export
                    </button>
                </div>

                <button onclick="app.startPresentation()" class="btn-chunky w-full py-4 bg-brand-green border-4 border-brand-dark rounded-xl text-white font-heading font-bold text-xl shadow-hard flex items-center justify-center gap-3 hover:brightness-105 mt-auto" title="Ctrl + P">
                    <i data-lucide="play" class="w-6 h-6 fill-current"></i> START
                </button>
                
                <button onclick="app.clear()" class="btn-chunky w-full py-3 bg-white border-4 border-brand-dark rounded-xl text-brand-dark font-heading font-bold text-lg shadow-hard flex items-center justify-center gap-2 hover:bg-gray-50">
                    <i data-lucide="trash-2" class="w-5 h-5"></i> CLEAR ALL
                </button>
            </div>

            <div class="lg:col-span-9 bg-brand-bg border-4 border-brand-dark rounded-2xl shadow-hard flex flex-col overflow-hidden h-full relative">
                <div class="bg-white border-b-4 border-brand-dark px-6 py-4 flex justify-between items-center flex-none z-10">
                    <span class="font-heading font-bold text-lg text-brand-dark">Slide Deck</span>
                    
                    <div class="flex items-center gap-2">
                        <div class="flex bg-brand-bg rounded-lg border-2 border-brand-dark p-1">
                            <button id="btn-view-list" onclick="app.switchView('list')" class="p-1.5 rounded bg-brand-blue text-white transition-all shadow-sm">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </button>
                            <button id="btn-view-grid" onclick="app.switchView('grid')" class="p-1.5 rounded text-gray-500 hover:text-brand-dark transition-all">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="deck-viewport" class="flex-grow overflow-y-auto p-6 custom-scroll relative">
                    
                    <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400 opacity-60 z-0">
                        <i data-lucide="layers" class="w-16 h-16 mb-4"></i>
                        <p class="font-heading text-xl">No slides yet</p>
                        <p class="text-sm">Click "Add Slide" to begin</p>
                    </div>

                    <div id="slides-list-container" class="space-y-6 relative z-10 min-h-full"></div>

                    <div id="slides-grid-container" class="hidden grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 relative z-10"></div>

                </div>
            </div>
        </div>
    </main>

    <aside id="library-drawer" class="fixed inset-y-0 left-0 w-80 bg-white border-r-4 border-brand-dark shadow-[10px_0_30px_rgba(0,0,0,0.1)] transform -translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-5 border-b-4 border-brand-dark bg-brand-bg flex justify-between items-center">
            <h2 class="font-heading font-bold text-xl text-brand-dark flex items-center gap-2">
                <i data-lucide="library" class="w-5 h-5 text-brand-blue"></i> Library
            </h2>
            <button onclick="app.toggleLibrary()" class="text-gray-400 hover:text-brand-dark">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="p-4 border-b-2 border-gray-100">
            <button onclick="app.createNewDeck()" class="btn-chunky w-full py-2 bg-brand-green border-2 border-brand-dark rounded-xl text-white font-heading font-bold shadow-hard-sm flex items-center justify-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Create New Deck
            </button>
            <button onclick="app.triggerImport()" class="mt-3 w-full py-2 text-xs font-bold text-gray-500 hover:text-brand-blue flex items-center justify-center gap-1 border-2 border-dashed border-gray-300 rounded-lg hover:border-brand-blue">
                <i data-lucide="upload" class="w-3 h-3"></i> Import File
            </button>
        </div>

        <div id="library-list" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scroll bg-gray-50">
            </div>
    </aside>

    <div id="presentation-mode" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center cursor-pointer transition-colors duration-500 ease-in-out select-none overflow-hidden bg-brand-dark">
        <div class="absolute top-6 right-6 flex gap-3 z-50 opacity-50 hover:opacity-100 transition-opacity">
            <div class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full border-2 border-white/40 text-white font-heading font-bold">
                <span id="slide-number">1</span> / <span id="total-slides">10</span>
            </div>
            <button onclick="app.exitPresentation(event)" class="bg-white text-brand-dark p-2 rounded-full border-2 border-brand-dark hover:bg-gray-100 shadow-hard-sm">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div id="slide-display-container" class="w-full h-full flex items-center justify-center px-8 relative z-10 gap-8 max-w-[90vw] mx-auto transition-all">
            <h1 id="display-word" class="font-heading font-bold text-white leading-tight drop-shadow-md break-words transition-all duration-300">Word</h1>
            <img id="display-image" src="" alt="Slide Image" class="hidden rounded-2xl border-4 border-white shadow-2xl object-contain">
        </div>

        <div class="absolute bottom-0 left-0 w-full h-3 bg-black/10">
            <div id="progress-bar" class="h-full bg-white/80 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <div id="help-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
        <div class="bg-white border-4 border-brand-dark rounded-2xl p-6 shadow-hard max-w-md w-full relative">
            <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-brand-dark">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 class="font-heading font-bold text-2xl mb-4 text-brand-blue">Shortcuts</h3>
            <div class="grid grid-cols-1 gap-2 text-sm">
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="font-bold text-gray-600">Add Slide</span>
                    <span class="key-badge">Ctrl + Enter</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="font-bold text-gray-600">Quick Save</span>
                    <span class="key-badge">Ctrl + S</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="font-bold text-gray-600">Start Presentation</span>
                    <span class="key-badge">Ctrl + P</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="font-bold text-gray-600">Reorder Slide</span>
                    <span class="key-badge">Alt + Up/Down</span>
                </div>
            </div>
            <style>.key-badge { background: white; border: 2px solid #e2e8f0; padding: 2px 6px; border-radius: 4px; font-weight: 700; color: #64748b; }</style>
        </div>
    </div>

    <div id="name-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-pop">
        <div class="bg-white border-4 border-brand-dark rounded-2xl p-8 flex flex-col items-center shadow-hard max-w-sm w-full">
            <h3 class="text-2xl font-heading font-bold text-brand-dark mb-4">Save Deck</h3>
            <input type="text" id="deck-name-input" placeholder="e.g. Phonics Unit 1" class="w-full p-3 border-2 border-brand-dark rounded-xl font-bold mb-4 focus:outline-none focus:shadow-hard-sm">
            <div class="flex gap-3 w-full">
                <button onclick="document.getElementById('name-modal').classList.add('hidden')" class="flex-1 btn-chunky bg-white border-2 border-brand-dark text-brand-dark py-2 rounded-xl font-bold">Cancel</button>
                <button id="confirm-save-btn" class="flex-1 btn-chunky bg-brand-green border-2 border-brand-dark text-white py-2 rounded-xl font-bold shadow-hard-sm">Save</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-pop">
        <div class="bg-white border-4 border-brand-dark rounded-2xl p-8 flex flex-col items-center text-center shadow-hard max-w-sm w-full">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mb-4 bg-brand-bg border-4 border-brand-dark text-brand-dark">
                <i id="modal-icon" data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 id="modal-title" class="text-2xl font-heading font-bold text-brand-dark mb-2">Are you sure?</h3>
            <p id="modal-desc" class="text-gray-600 font-bold text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3 w-full">
                <button id="modal-cancel" class="flex-1 btn-chunky bg-white border-2 border-brand-dark text-brand-dark py-2 rounded-xl font-bold">Cancel</button>
                <button id="modal-confirm" class="flex-1 btn-chunky bg-brand-pink border-2 border-brand-dark text-white py-2 rounded-xl font-bold shadow-hard-sm">Yes, Do it</button>
            </div>
        </div>
    </div>

    <canvas id="compression-canvas" class="hidden"></canvas>

    <script>
        lucide.createIcons();

        const app = {
            slides: [], 
            library: [],
            currentDeckId: null, // If null, it's unsaved/scratchpad
            viewMode: 'list', 
            dragSrcIndex: null,
            colors: ['#FF6B95', '#FF8C42', '#00E676', '#2979FF'], 
            
            init() {
                // Load Library
                const libSaved = localStorage.getItem('e1_rapid_library_v1');
                if (libSaved) { try { this.library = JSON.parse(libSaved); } catch(e) { this.library = []; } }

                // Load Active Workspace (Scratchpad)
                const saved = localStorage.getItem('e1_rapid_slides_v4');
                const metaSaved = localStorage.getItem('e1_rapid_meta_v1');
                
                if (saved) {
                    try { 
                        this.slides = JSON.parse(saved); 
                        this.slides = this.slides.map(s => ({...s, layout: s.layout || 'split'}));
                    } catch (e) { this.slides = []; }
                }

                if (metaSaved) {
                    try {
                        const meta = JSON.parse(metaSaved);
                        this.currentDeckId = meta.id;
                        this.updateDeckNameDisplay(meta.title);
                    } catch(e) {}
                }

                if (this.slides.length === 0) this.addSlide();
                else this.render();

                this.bindGlobalKeys();
                this.bindPresentationKeys();

                document.getElementById('presentation-mode').addEventListener('click', (e) => {
                    if (!e.target.closest('button')) this.nextSlide();
                });
            },

            // --- LIBRARY LOGIC ---

            toggleLibrary() {
                const drawer = document.getElementById('library-drawer');
                const isOpen = !drawer.classList.contains('-translate-x-full');
                if(isOpen) {
                    drawer.classList.add('-translate-x-full');
                } else {
                    this.renderLibrary();
                    drawer.classList.remove('-translate-x-full');
                }
            },

            renderLibrary() {
                const list = document.getElementById('library-list');
                list.innerHTML = '';
                
                if(this.library.length === 0) {
                    list.innerHTML = `<div class="text-center py-8 text-gray-400 font-bold text-sm">Library is empty.</div>`;
                    return;
                }

                this.library.sort((a,b) => b.updatedAt - a.updatedAt).forEach(deck => {
                    const el = document.createElement('div');
                    el.className = `library-item p-3 bg-white border-2 border-gray-200 rounded-xl cursor-pointer transition-all mb-2 flex justify-between items-center group ${deck.id === this.currentDeckId ? 'border-brand-blue ring-1 ring-brand-blue' : ''}`;
                    
                    const date = new Date(deck.updatedAt).toLocaleDateString();
                    
                    el.onclick = () => this.loadDeck(deck.id);

                    el.innerHTML = `
                        <div>
                            <h4 class="font-heading font-bold text-brand-dark group-hover:text-brand-blue">${deck.title}</h4>
                            <p class="text-xs text-gray-400 font-bold">${deck.count} slides â€¢ ${date}</p>
                        </div>
                        <button onclick="app.deleteDeck(event, '${deck.id}')" class="p-2 text-gray-300 hover:text-brand-pink hover:bg-red-50 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
                lucide.createIcons();
            },

            async createNewDeck() {
                if (this.slides.length > 0 && this.slides.some(s => s.text || s.image)) {
                     const c = await this.showModal('Create New?', 'This will clear your current workspace. Unsaved changes will be lost.', 'Create New', 'plus');
                     if(!c) return;
                }
                
                this.slides = [];
                this.addSlide();
                this.currentDeckId = null;
                this.updateDeckNameDisplay("Unsaved Session");
                this.saveWorkspace(); // Clear storage
                this.render();
                this.toggleLibrary(); // Close drawer
                this.showToast('New Deck Created', 'file-plus');
            },

            async loadDeck(id) {
                // If loading the one we are already on, just close drawer
                if(this.currentDeckId === id) {
                    this.toggleLibrary();
                    return;
                }

                // Check unsaved changes if needed... (Simplification: Auto-switch assuming workspace is scratchpad)
                const deck = this.library.find(d => d.id === id);
                if(deck) {
                    this.slides = JSON.parse(JSON.stringify(deck.slides)); // Deep copy
                    this.currentDeckId = deck.id;
                    this.updateDeckNameDisplay(deck.title);
                    this.saveWorkspace(); // Save to active workspace
                    this.render();
                    this.toggleLibrary();
                    this.showToast(`Loaded "${deck.title}"`, 'folder-open');
                }
            },

            async deleteDeck(e, id) {
                e.stopPropagation();
                const c = await this.showModal('Delete Deck?', 'This will permanently remove this deck from your library.', 'Delete', 'trash-2');
                if(c) {
                    this.library = this.library.filter(d => d.id !== id);
                    localStorage.setItem('e1_rapid_library_v1', JSON.stringify(this.library));
                    
                    if(this.currentDeckId === id) {
                        this.currentDeckId = null;
                        this.updateDeckNameDisplay("Unsaved Session (Deleted)");
                    }
                    this.renderLibrary();
                }
            },

            manualSave() {
                if(this.currentDeckId) {
                    // Update existing
                    const deckIdx = this.library.findIndex(d => d.id === this.currentDeckId);
                    if(deckIdx > -1) {
                        this.library[deckIdx].slides = this.slides;
                        this.library[deckIdx].count = this.slides.length;
                        this.library[deckIdx].updatedAt = Date.now();
                        localStorage.setItem('e1_rapid_library_v1', JSON.stringify(this.library));
                        this.showToast('Deck Updated', 'check');
                    } else {
                        // Id exists but not in lib? Treat as new
                        this.currentDeckId = null;
                        this.manualSave();
                    }
                } else {
                    // Save As New
                    const modal = document.getElementById('name-modal');
                    const input = document.getElementById('deck-name-input');
                    const btn = document.getElementById('confirm-save-btn');
                    
                    input.value = '';
                    modal.classList.remove('hidden');
                    input.focus();
                    
                    btn.onclick = () => {
                        const name = input.value.trim() || 'Untitled Deck';
                        const newId = Date.now().toString();
                        
                        const newDeck = {
                            id: newId,
                            title: name,
                            slides: JSON.parse(JSON.stringify(this.slides)),
                            count: this.slides.length,
                            updatedAt: Date.now()
                        };
                        
                        this.library.push(newDeck);
                        this.currentDeckId = newId;
                        localStorage.setItem('e1_rapid_library_v1', JSON.stringify(this.library));
                        
                        this.updateDeckNameDisplay(name);
                        this.saveWorkspace(); // Update meta
                        
                        modal.classList.add('hidden');
                        this.showToast('Saved to Library', 'save');
                    }
                }
            },

            updateDeckNameDisplay(name) {
                const label = document.getElementById('current-deck-name');
                const indicator = document.getElementById('save-status-indicator');
                label.innerText = name;
                if(this.currentDeckId) {
                    label.className = "text-xs font-bold text-brand-blue uppercase tracking-widest";
                    indicator.className = "w-2 h-2 rounded-full bg-brand-green";
                } else {
                    label.className = "text-xs font-bold text-gray-400 uppercase tracking-widest";
                    indicator.className = "w-2 h-2 rounded-full bg-brand-orange";
                }
            },

            // --- EXISTING LOGIC ---

            bindGlobalKeys() {
                document.addEventListener('keydown', (e) => {
                    const isPres = document.getElementById('presentation-mode').style.display === 'flex';
                    const isCtrl = e.ctrlKey || e.metaKey;

                    if (isCtrl && e.key === 'Enter' && !isPres) {
                        e.preventDefault();
                        this.addSlide();
                        this.showToast('New Slide Added', 'plus-circle');
                    }

                    if (isCtrl && (e.key === 'p' || e.key === 'P')) {
                        e.preventDefault();
                        if (!isPres) this.startPresentation();
                    }

                    if (isCtrl && (e.key === 's' || e.key === 'S')) {
                        e.preventDefault();
                        this.manualSave();
                    }

                    if (e.altKey && !isPres && document.activeElement.tagName === 'TEXTAREA') {
                        const wrapper = document.activeElement.closest('.slide-card');
                        if (wrapper) {
                            const idParts = wrapper.id.split('-');
                            const idx = parseInt(idParts[idParts.length-1]);
                            if (e.key === 'ArrowUp' && idx > 0) {
                                e.preventDefault();
                                this.reorderSlides(idx, idx - 1);
                                setTimeout(() => this.focusSlide(idx - 1), 50);
                            } else if (e.key === 'ArrowDown' && idx < this.slides.length - 1) {
                                e.preventDefault();
                                this.reorderSlides(idx, idx + 1);
                                setTimeout(() => this.focusSlide(idx + 1), 50);
                            }
                        }
                    }
                });
            },

            bindPresentationKeys() {
                document.addEventListener('keydown', (e) => {
                    if (document.getElementById('presentation-mode').style.display === 'flex') {
                        if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') { e.preventDefault(); this.nextSlide(); }
                        else if (e.key === 'ArrowLeft') this.prevSlide();
                        else if (e.key === 'Escape') this.exitPresentation();
                    }
                });
            },

            focusSlide(index) {
                const el = document.getElementById(`slide-item-${index}`);
                if (el) { const ta = el.querySelector('textarea'); if (ta) ta.focus(); }
            },

            showToast(msg, icon) {
                const c = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = "bg-brand-dark text-white px-4 py-3 rounded-xl shadow-hard-sm flex items-center gap-3 toast-enter font-heading font-bold";
                el.innerHTML = `<i data-lucide="${icon || 'info'}" class="w-5 h-5 text-brand-green"></i> ${msg}`;
                c.appendChild(el);
                lucide.createIcons();
                setTimeout(() => { el.style.animation = "fadeOut 0.5s forwards"; setTimeout(() => el.remove(), 500); }, 2000);
            },

            saveWorkspace() {
                // Saves the current working state (scratchpad)
                localStorage.setItem('e1_rapid_slides_v4', JSON.stringify(this.slides));
                // Also save meta about which deck is active
                if(this.currentDeckId) {
                    const deck = this.library.find(d => d.id === this.currentDeckId);
                    localStorage.setItem('e1_rapid_meta_v1', JSON.stringify({ id: this.currentDeckId, title: deck ? deck.title : 'Unsaved' }));
                } else {
                    localStorage.removeItem('e1_rapid_meta_v1');
                }
                this.updateStats();
            },

            switchView(mode) {
                this.viewMode = mode;
                const btnList = document.getElementById('btn-view-list');
                const btnGrid = document.getElementById('btn-view-grid');
                const listContainer = document.getElementById('slides-list-container');
                const gridContainer = document.getElementById('slides-grid-container');

                if (mode === 'list') {
                    btnList.classList.add('bg-brand-blue', 'text-white', 'shadow-sm');
                    btnList.classList.remove('text-gray-500');
                    btnGrid.classList.remove('bg-brand-blue', 'text-white', 'shadow-sm');
                    btnGrid.classList.add('text-gray-500');
                    listContainer.classList.remove('hidden');
                    gridContainer.classList.add('hidden');
                    gridContainer.classList.remove('grid');
                } else {
                    btnGrid.classList.add('bg-brand-blue', 'text-white', 'shadow-sm');
                    btnGrid.classList.remove('text-gray-500');
                    btnList.classList.remove('bg-brand-blue', 'text-white', 'shadow-sm');
                    btnList.classList.add('text-gray-500');
                    listContainer.classList.add('hidden');
                    gridContainer.classList.remove('hidden');
                    gridContainer.classList.add('grid');
                }
                this.render();
            },

            render() {
                this.updateStats();
                const emptyState = document.getElementById('empty-state');
                
                if (this.slides.length === 0) {
                    emptyState.classList.remove('hidden');
                    document.getElementById('slides-list-container').innerHTML = '';
                    document.getElementById('slides-grid-container').innerHTML = '';
                    return;
                }
                emptyState.classList.add('hidden');

                if (this.viewMode === 'list') this.renderList();
                else this.renderGrid();
                
                lucide.createIcons();
            },

            renderList() {
                const container = document.getElementById('slides-list-container');
                container.innerHTML = '';

                this.slides.forEach((slide, index) => {
                    const slideEl = document.createElement('div');
                    slideEl.id = `slide-item-${index}`;
                    slideEl.className = 'slide-card bg-white border-2 border-brand-dark rounded-xl p-5 shadow-sm hover:shadow-md flex flex-col md:flex-row gap-5 items-start relative';
                    
                    const layouts = [
                        { id: 'hero', icon: 'type', label: 'Hero' },
                        { id: 'split', icon: 'columns-2', label: 'Split' },
                        { id: 'caption', icon: 'panel-bottom', label: 'Caption' },
                        { id: 'full', icon: 'image', label: 'Image' },
                    ];

                    const layoutButtons = layouts.map(l => {
                        const active = slide.layout === l.id;
                        return `<button onclick="app.updateSlideLayout(${index}, '${l.id}')" 
                            class="flex-1 py-1.5 px-2 rounded-lg border-2 text-xs font-bold flex items-center justify-center gap-1 transition-all ${active ? 'bg-brand-blue text-white border-brand-dark shadow-hard-sm' : 'bg-white text-gray-500 border-gray-200 hover:border-brand-blue hover:text-brand-blue'}" 
                            title="${l.label}">
                            <i data-lucide="${l.icon}" class="w-3 h-3"></i> ${l.label}
                        </button>`;
                    }).join('');

                    const isTextHidden = slide.layout === 'full';
                    const isImageHidden = slide.layout === 'hero';

                    slideEl.innerHTML = `
                        <div class="hidden md:flex flex-col items-center gap-1 pt-1 text-gray-400 w-8">
                            <span class="font-heading font-bold text-xl text-brand-dark">${index + 1}</span>
                        </div>
                        <div class="flex-grow w-full">
                            <div class="mb-4 bg-brand-bg border-2 border-brand-dark rounded-xl p-2 flex gap-2">
                                ${layoutButtons}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="relative ${isTextHidden ? 'input-locked' : ''}">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">
                                        <i data-lucide="type" class="inline w-3 h-3 mr-1"></i> Text
                                    </label>
                                    <textarea oninput="app.updateSlideText(${index}, this.value)" 
                                        class="w-full h-32 p-3 rounded-xl border-2 border-gray-200 focus:border-brand-blue focus:shadow-hard-sm focus:outline-none resize-none font-medium text-lg transition-all" 
                                        placeholder="Enter your text here...">${slide.text}</textarea>
                                </div>
                                <div class="relative ${isImageHidden ? 'input-locked' : ''}">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">
                                        <i data-lucide="image" class="inline w-3 h-3 mr-1"></i> Visual
                                    </label>
                                    ${slide.image ? `
                                        <div class="relative group h-32 w-full rounded-xl border-2 border-gray-200 overflow-hidden bg-gray-50 flex items-center justify-center">
                                            <img src="${slide.image}" class="h-full w-full object-contain p-2">
                                            <div class="absolute inset-0 bg-brand-dark/80 hidden group-hover:flex items-center justify-center gap-2 transition-opacity cursor-pointer" onclick="app.removeImage(${index})">
                                                <div class="text-white font-bold text-sm flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Remove</div>
                                            </div>
                                        </div>` : `
                                        <button onclick="app.triggerImageUpload(${index})" class="w-full h-32 rounded-xl border-2 border-dashed border-gray-300 hover:border-brand-blue hover:bg-blue-50 flex flex-col items-center justify-center gap-2 text-gray-400 hover:text-brand-blue transition-all group">
                                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                                                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                            </div>
                                            <span class="text-xs font-bold">Upload Image</span>
                                        </button>`}
                                </div>
                            </div>
                        </div>
                        <button onclick="app.deleteSlide(${index})" class="absolute top-4 right-4 text-gray-300 hover:text-brand-pink transition-colors p-1" title="Delete Slide">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    `;
                    container.appendChild(slideEl);
                });
            },

            renderGrid() {
                const container = document.getElementById('slides-grid-container');
                container.innerHTML = '';

                this.slides.forEach((slide, index) => {
                    const el = document.createElement('div');
                    el.className = 'grid-card bg-white border-2 border-brand-dark rounded-xl p-2 shadow-sm hover:shadow-hard-sm cursor-grab active:cursor-grabbing relative flex flex-col h-32 transition-transform';
                    el.draggable = true;
                    
                    el.addEventListener('dragstart', (e) => { this.dragSrcIndex = index; el.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
                    el.addEventListener('dragend', () => { el.classList.remove('dragging'); document.querySelectorAll('.grid-card').forEach(card => card.classList.remove('drag-over')); });
                    el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drag-over'); return false; });
                    el.addEventListener('dragleave', () => { el.classList.remove('drag-over'); });
                    el.addEventListener('drop', (e) => { e.stopPropagation(); if (this.dragSrcIndex !== index) app.reorderSlides(this.dragSrcIndex, index); return false; });
                    el.onclick = () => { if (!el.classList.contains('dragging')) app.jumptoSlide(index); };

                    let contentHTML = '';
                    if (slide.layout === 'full' && slide.image) contentHTML = `<img src="${slide.image}" class="w-full h-full object-cover rounded-lg opacity-80">`;
                    else if (slide.layout === 'hero') contentHTML = `<div class="w-full h-full flex items-center justify-center text-center p-1 bg-brand-bg"><span class="text-lg font-heading font-bold text-brand-blue truncate">${slide.text || '...'}</span></div>`;
                    else if (slide.image) contentHTML = `<div class="flex h-full"><div class="w-1/2 flex items-center justify-center p-1"><span class="text-[8px] font-bold truncate">${slide.text}</span></div><div class="w-1/2 h-full"><img src="${slide.image}" class="w-full h-full object-cover rounded-r-lg"></div></div>`;
                    else contentHTML = `<div class="w-full h-full flex items-center justify-center text-center p-1"><span class="text-xs font-bold text-gray-600 truncate line-clamp-3">${slide.text || 'Empty'}</span></div>`;

                    el.innerHTML = `
                        <div class="absolute top-1 left-1 bg-brand-dark text-white text-[10px] font-bold px-1.5 rounded z-10">${index + 1}</div>
                        <div class="flex-grow overflow-hidden rounded-lg border border-gray-100 pointer-events-none">
                            ${contentHTML}
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            jumptoSlide(index) {
                this.switchView('list');
                setTimeout(() => {
                    const el = document.getElementById(`slide-item-${index}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    this.focusSlide(index);
                }, 100);
            },

            reorderSlides(fromIndex, toIndex) {
                const item = this.slides.splice(fromIndex, 1)[0];
                this.slides.splice(toIndex, 0, item);
                this.saveWorkspace(); this.render();
            },

            addSlide() {
                this.slides.push({ id: Date.now(), text: '', image: null, layout: 'split' });
                this.saveWorkspace();
                if (this.viewMode === 'list') {
                    this.renderList();
                    setTimeout(() => document.getElementById('deck-viewport').scrollTop = document.getElementById('deck-viewport').scrollHeight, 50);
                    setTimeout(() => this.focusSlide(this.slides.length - 1), 100);
                } else this.renderGrid();
            },

            deleteSlide(index) {
                if (this.slides.length <= 1) {
                    this.slides[0].text = ''; this.slides[0].image = null;
                } else { this.slides.splice(index, 1); }
                this.saveWorkspace(); this.render();
            },

            updateSlideText(index, value) { this.slides[index].text = value; this.saveWorkspace(); },
            updateSlideLayout(index, value) { this.slides[index].layout = value; this.saveWorkspace(); this.render(); },
            
            triggerImageUpload(index) {
                const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const img = new Image();
                            img.onload = () => { this.slides[index].image = this.compressImage(img); this.saveWorkspace(); this.render(); };
                            img.src = evt.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },

            removeImage(index) { this.slides[index].image = null; this.saveWorkspace(); this.render(); },

            compressImage(img) {
                const canvas = document.getElementById('compression-canvas'); const ctx = canvas.getContext('2d');
                const MAX_SZ = 800; 
                let w = img.width; let h = img.height;
                if (w > h) { if (w > MAX_SZ) { h *= MAX_SZ/w; w = MAX_SZ; } } 
                else { if (h > MAX_SZ) { w *= MAX_SZ/h; h = MAX_SZ; } }
                canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                return canvas.toDataURL('image/jpeg', 0.6);
            },

            updateStats() {
                const sc = document.getElementById('stat-count'); const st = document.getElementById('stat-time');
                if (sc) sc.innerText = this.slides.length;
                if (st) st.innerText = Math.ceil((this.slides.length * 3) / 60) + "m";
            },

            startPresentation() {
                const valid = this.slides.filter(s => s.text.trim() !== "" || s.image !== null);
                if (valid.length === 0) { this.showModal('Empty Deck', 'Add content before starting.', 'Okay', 'info'); return; }
                this.presentationSlides = valid; 
                this.currentIndex = 0;
                const ov = document.getElementById('presentation-mode');
                ov.classList.remove('hidden'); ov.style.display = 'flex';
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e => {});
                this.renderShowSlide();
            },

            exitPresentation(e) {
                if(e) e.stopPropagation();
                const ov = document.getElementById('presentation-mode');
                ov.classList.add('hidden'); ov.style.display = 'none';
                if (document.exitFullscreen) document.exitFullscreen().catch(e => {});
            },

            nextSlide() {
                this.currentIndex++;
                if (this.currentIndex >= this.presentationSlides.length) this.currentIndex = 0;
                this.renderShowSlide();
            },

            prevSlide() {
                this.currentIndex--;
                if (this.currentIndex < 0) this.currentIndex = this.presentationSlides.length - 1;
                this.renderShowSlide();
            },

            renderShowSlide() {
                const s = this.presentationSlides[this.currentIndex];
                const container = document.getElementById('slide-display-container');
                const txt = document.getElementById('display-word');
                const img = document.getElementById('display-image');
                const ov = document.getElementById('presentation-mode');

                container.className = "w-full h-full flex items-center justify-center px-8 relative z-10 gap-8 max-w-[90vw] mx-auto transition-all";
                const layout = s.layout || 'split';
                container.classList.add(`layout-${layout}`);

                txt.classList.remove('hidden');
                img.classList.remove('hidden');

                txt.innerText = s.text;
                if(s.image) img.src = s.image; else img.src = "";

                if (layout === 'hero' || (layout === 'split' && !s.image)) img.classList.add('hidden');
                
                container.classList.remove('slide-enter');
                void container.offsetWidth; 
                container.classList.add('slide-enter');

                ov.style.backgroundColor = this.colors[this.currentIndex % this.colors.length];
                document.getElementById('slide-number').innerText = this.currentIndex + 1;
                document.getElementById('total-slides').innerText = this.presentationSlides.length;
                document.getElementById('progress-bar').style.width = `${((this.currentIndex + 1) / this.presentationSlides.length) * 100}%`;
            },

            exportJSON() {
                const d = JSON.stringify(this.slides, null, 2);
                const a = document.createElement('a');
                a.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(d);
                a.download = `english1_presenter_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            triggerImport() { document.getElementById('importInput').click(); },

            async processImport(el) {
                const f = el.files[0]; if (!f) return;
                const c = await this.showModal('Restore?', 'This will replace current slides.', 'Yes, Replace', 'upload');
                if (!c) { el.value = ''; return; }
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        const d = JSON.parse(e.target.result);
                        if (Array.isArray(d)) { this.slides = d; this.saveWorkspace(); this.render(); }
                    } catch (err) {}
                };
                r.readAsText(f); el.value = '';
            },

            async clear() {
                if (await this.showModal('Clear All?', 'Delete all slides?', 'Yes, Clear All')) {
                    this.slides = []; this.addSlide(); this.saveWorkspace(); this.render();
                }
            },

            showModal(t, d, cText, icon) {
                return new Promise((res) => {
                    const m = document.getElementById('custom-modal');
                    document.getElementById('modal-title').innerText = t;
                    document.getElementById('modal-desc').innerText = d;
                    const cb = document.getElementById('modal-confirm');
                    cb.innerText = cText;
                    document.getElementById('modal-icon').setAttribute('data-lucide', icon || 'alert-triangle');
                    lucide.createIcons();
                    m.classList.remove('hidden');
                    const cleanup = (v) => { m.classList.add('hidden'); cb.onclick = null; document.getElementById('modal-cancel').onclick = null; res(v); };
                    cb.onclick = () => cleanup(true);
                    document.getElementById('modal-cancel').onclick = () => cleanup(false);
                });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>