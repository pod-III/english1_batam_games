<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Cups - Find the Ball</title>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Theme Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#0f172a',
                        panel: '#1e293b',
                        surface: '#334155'
                    },
                    fontFamily: {
                        heading: ['Bebas Neue', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Nunito', sans-serif;
            background-color: #050b14;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* --- 3D ENVIRONMENT --- */
        .scene {
            position: absolute;
            inset: 0;
            z-index: 0;
            perspective: 1200px;
            pointer-events: none;
            overflow: hidden;
        }

        .floor {
            position: absolute;
            bottom: -20%;
            left: -10%;
            width: 120%;
            height: 80%;
            background: radial-gradient(ellipse at center top, rgba(41, 121, 255, 0.1) 0%, transparent 60%),
                        linear-gradient(to bottom, #1e293b 0%, #020617 100%);
            transform: rotateX(25deg);
            border-top: 2px solid rgba(255,255,255,0.05);
        }

        .spotlight {
            position: absolute;
            top: -30%; left: 20%;
            width: 60%; height: 130%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.04) 0%, transparent 70%);
            filter: blur(50px);
            transform: rotate(5deg);
        }

        /* --- GAME CONTAINER --- */
        #game-stage {
            position: relative;
            width: 100%;
            max-width: 1100px;
            height: 450px;
            margin: 0 auto;
            z-index: 10;
        }

        /* --- CUP COMPONENTS --- */
        .cup-wrapper {
            position: absolute;
            bottom: 15%; /* Position from bottom of stage */
            width: 140px;
            height: 200px; 
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Align bottom */
            will-change: left, transform;
            /* Transition is handled by JS for speed control */
        }
        
        .cup-wrapper.small { width: 100px; height: 160px; }

        /* The actual cup visual */
        .cup-body {
            position: relative;
            width: 100%;
            height: 140px; /* Fixed height for the cup image part */
            z-index: 5;
            transform-origin: bottom center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cup-wrapper.small .cup-body { height: 100px; }

        .cup-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 20px 20px rgba(0,0,0,0.6));
            pointer-events: none;
            position: relative;
            z-index: 2;
        }

        /* Labels - Now static relative to the wrapper, positioned below the ball/cup area */
        .cup-label {
            position: absolute; /* Static relative to wrapper */
            bottom: 0px; 
            background: #f8fafc;
            color: #0f172a;
            padding: 4px 16px;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem; /* Bigger font */
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 2px solid #2979FF;
            white-space: nowrap;
            text-align: center;
            min-width: 60px;
            z-index: 15; /* Ensure it is above the floor */
        }

        .show-labels .cup-label {
            opacity: 1;
        }

        /* The Ball - Sits on the table */
        .ball {
            position: absolute;
            bottom: 70px; /* Positioned relative to wrapper bottom, higher than the label */
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 35% 35%, #86efac, #22c55e, #14532d);
            border-radius: 50%;
            box-shadow: 0 0 15px #22c55e;
            z-index: 1; 
            opacity: 0; 
            transition: opacity 0.2s;
        }
        
        .cup-wrapper.small .ball { bottom: 60px; width: 30px; height: 30px; }

        /* Lift Logic */
        .cup-wrapper.lifted .cup-body {
            transform: translateY(-120px) rotateX(10deg);
        }

        /* Show ball only when lifted AND has ball */
        .cup-wrapper.lifted.has-ball .ball {
            opacity: 1;
        }

        /* Debug/Peek mode (show all balls) */
        .cup-wrapper.reveal-all.has-ball .ball {
            opacity: 1;
        }
        .cup-wrapper.reveal-all .cup-body {
            transform: translateY(-120px) rotateX(10deg);
        }


        /* --- UI ELEMENTS --- */
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-push {
            transition: all 0.1s;
            border-bottom: 4px solid rgba(0,0,0,0.3);
            transform: translateY(0);
        }
        .btn-push:active {
            border-bottom-width: 0px;
            transform: translateY(4px);
        }
        .btn-push.disabled {
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #2979FF;
            margin-top: -8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(41,121,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        #start-overlay {
            background: rgba(5, 11, 20, 0.95);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-dark overflow-hidden">

    <!-- START OVERLAY (For Audio Context) -->
    <div id="start-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center text-center p-4">
        <h1 class="text-6xl font-heading text-transparent bg-clip-text bg-gradient-to-r from-pink to-blue mb-4 tracking-wide">Magic Cups</h1>
        <p class="text-gray-400 mb-8 max-w-md font-body">Test your focus. Follow the ball. Find the prize.</p>
        <button id="init-btn" class="btn-push px-10 py-4 bg-green text-dark font-heading text-2xl rounded-xl shadow-lg shadow-green/20">
            START GAME
        </button>
    </div>

    <!-- HEADER -->
    <header class="h-20 flex items-center justify-between px-6 z-50 border-b border-white/5 bg-dark/90 backdrop-blur">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink to-orange flex items-center justify-center shadow-lg shadow-orange/20">
                <i data-lucide="trophy" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-heading text-3xl text-white tracking-wide leading-none">Magic Cups</h1>
                <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">English 1 Batam</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button id="mute-btn" class="w-10 h-10 rounded-lg bg-surface hover:bg-white/10 text-gray-400 transition flex items-center justify-center border border-white/5">
                <i data-lucide="volume-2" class="w-5 h-5"></i>
            </button>
            <button id="setup-btn" class="btn-push bg-blue hover:brightness-110 text-white px-6 py-2 rounded-lg font-bold text-sm tracking-wide shadow-lg shadow-blue/20">
                SETUP
            </button>
        </div>
    </header>

    <!-- MAIN STAGE -->
    <main class="flex-grow relative flex flex-col justify-center">
        
        <!-- Decoration -->
        <div class="scene">
            <div class="floor"></div>
            <div class="spotlight"></div>
        </div>

        <!-- Dynamic Status Text -->
        <div class="absolute top-10 w-full text-center z-20 pointer-events-none">
            <h2 id="status-display" class="text-6xl font-heading text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-400 drop-shadow-2xl tracking-widest animate-float opacity-90">
                FIND THE BALL
            </h2>
        </div>

        <!-- Game Area (Cups go here) -->
        <div id="game-stage"></div>

        <!-- Bottom Controls -->
        <div class="absolute bottom-10 z-40 w-full max-w-md left-1/2 -translate-x-1/2 px-6 flex flex-col gap-4">
            
            <!-- Speed Control -->
            <div class="glass p-3 rounded-xl flex flex-col gap-2">
                <div class="flex justify-between text-[10px] font-bold uppercase text-gray-400">
                    <span>Slow</span>
                    <span id="speed-label" class="text-blue">Medium</span>
                    <span>Fast</span>
                </div>
                <input type="range" id="speed-slider" min="0" max="100" value="50">
            </div>

            <!-- Main Button -->
            <button id="action-btn" class="btn-push w-full bg-green text-dark py-4 rounded-xl font-heading text-3xl tracking-widest shadow-xl shadow-green/20">
                SHUFFLE
            </button>
        </div>

    </main>

    <!-- SETUP MODAL -->
    <div id="setup-modal" class="fixed inset-0 z-[90] bg-black/90 backdrop-blur hidden flex items-center justify-center transition-opacity opacity-0">
        <div id="setup-panel" class="glass w-full max-w-lg rounded-2xl p-6 transform scale-95 transition-all duration-300 border border-white/10">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h3 class="text-2xl font-heading text-white tracking-wide">Game Setup</h3>
                <button id="close-setup" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>

            <div class="space-y-6">
                <!-- Cup Count -->
                <div class="bg-surface/50 p-4 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-400 uppercase">Cups</label>
                        <span id="cup-count-val" class="font-bold text-pink text-lg">3</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 bg-dark hover:border-pink border border-white/10 text-white py-2 rounded font-bold" onclick="Game.updateSettings('cups', -1)">-</button>
                        <button class="flex-1 bg-dark hover:border-green border border-white/10 text-white py-2 rounded font-bold" onclick="Game.updateSettings('cups', 1)">+</button>
                    </div>
                </div>

                <!-- Ball Count -->
                <div class="bg-surface/50 p-4 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-400 uppercase">Balls</label>
                        <span id="ball-count-val" class="font-bold text-blue text-lg">1</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 bg-dark hover:border-pink border border-white/10 text-white py-2 rounded font-bold" onclick="Game.updateSettings('balls', -1)">-</button>
                        <button class="flex-1 bg-dark hover:border-green border border-white/10 text-white py-2 rounded font-bold" onclick="Game.updateSettings('balls', 1)">+</button>
                    </div>
                </div>

                <!-- Custom Labels -->
                <div class="max-h-[200px] overflow-y-auto pr-2">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Cup Labels</label>
                    <div id="label-container" class="grid grid-cols-2 gap-2">
                        <!-- Inputs generated by JS -->
                    </div>
                </div>

                <button id="save-settings" class="w-full btn-push bg-gradient-to-r from-blue to-pink text-white py-3 rounded-xl font-heading text-xl mt-2">
                    APPLY & RESTART
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO SYSTEM ---
        const Sound = {
            enabled: true,
            ctx: null,
            fx: {},
            init: async () => {
                if(Sound.ctx) return;
                await Tone.start();
                Sound.ctx = true;
                
                // Shuffle sound (Wood/Table thud)
                Sound.fx.shuffle = new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 4, oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.5 }
                }).toDestination();
                Sound.fx.shuffle.volume.value = -10;

                // Win sound (Chime)
                Sound.fx.win = new Tone.PolySynth(Tone.Synth, {
                    volume: -5, oscillator: { type: "triangle" },
                    envelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 1 }
                }).toDestination();

                // Fail sound (Dull metal)
                Sound.fx.fail = new Tone.MetalSynth({
                    frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                    harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5, volume: -10
                }).toDestination();
            },
            play: (type) => {
                if(!Sound.enabled || !Sound.ctx) return;
                try {
                    if(type === 'shuffle') Sound.fx.shuffle.triggerAttackRelease("C1", "32n");
                    if(type === 'lift') Sound.fx.shuffle.triggerAttackRelease("F2", "16n");
                    if(type === 'win') Sound.fx.win.triggerAttackRelease(["C5", "E5", "G5", "C6"], "16n");
                    if(type === 'fail') Sound.fx.fail.triggerAttackRelease("32n");
                } catch(e) { console.log('Audio error', e); }
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            // State
            cups: [],
            isShuffling: false,
            canGuess: false,
            
            // Config
            cupCount: 3,
            ballCount: 1,
            shuffleSpeed: 500, // ms
            shuffleMoves: 10,
            
            init: () => {
                // Initialize default cups
                Game.generateCups(3);
                Game.renderCups();
                lucide.createIcons();

                // Listeners
                document.getElementById('init-btn').addEventListener('click', () => {
                    Sound.init();
                    document.getElementById('start-overlay').classList.add('hidden');
                });

                document.getElementById('action-btn').addEventListener('click', Game.handleAction);
                document.getElementById('setup-btn').addEventListener('click', UI.openSetup);
                document.getElementById('close-setup').addEventListener('click', UI.closeSetup);
                document.getElementById('save-settings').addEventListener('click', Game.saveSettings);
                document.getElementById('mute-btn').addEventListener('click', UI.toggleMute);
                
                // Slider
                const slider = document.getElementById('speed-slider');
                slider.addEventListener('input', (e) => {
                    // Invert: 100 value = 150ms (Fast), 0 value = 1000ms (Slow)
                    const val = parseInt(e.target.value);
                    const speed = 1000 - (val * 8.5);
                    Game.shuffleSpeed = Math.max(150, speed);
                    UI.updateSpeedLabel(val);
                });
            },

            generateCups: (n) => {
                Game.cups = [];
                for(let i=0; i<n; i++) {
                    Game.cups.push({
                        id: i,
                        label: `${i+1}`,
                        hasBall: false,
                        pos: i // Logical position 0, 1, 2...
                    });
                }
                Game.cupCount = n;
            },

            renderCups: () => {
                const stage = document.getElementById('game-stage');
                stage.innerHTML = '';
                
                const widthPct = 100 / Game.cupCount;
                const isSmall = Game.cupCount > 4;

                Game.cups.forEach(cup => {
                    const el = document.createElement('div');
                    el.className = `cup-wrapper ${isSmall ? 'small' : ''}`;
                    el.id = `cup-${cup.id}`;
                    el.style.left = `${(cup.pos * widthPct) + (widthPct/2)}%`; // Center in slot
                    el.style.transform = 'translateX(-50%)'; // Center pivot
                    
                    // Click Handler
                    el.onclick = () => Game.clickCup(cup.id);

                    el.innerHTML = `
                        <div class="ball"></div>
                        <div class="cup-body">
                            <img src="./cup.png" class="cup-img" alt="Cup" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTE3IDhoLTcuMkw3IDE4aDEybDIuOC0xMHoiLz48cGF0aCBkPSJNNiA4di0yYTIgMiAwIDAgMSAyLTJoOGEyIDIgMCAwIDEgMiAydjIiLz48L3N2Zz4';this.style.background='#334155';this.style.padding='20px';this.style.borderRadius='10px'">
                        </div>
                        <span class="cup-label">${cup.label}</span>
                    `;
                    stage.appendChild(el);
                });
            },

            handleAction: async () => {
                const btn = document.getElementById('action-btn');
                
                // If button is in "RESET" mode (after a game)
                if(btn.innerText === "RESET") {
                    Game.resetRound();
                    return;
                }

                // Start Shuffle Sequence
                if(Game.isShuffling) return;
                Game.isShuffling = true;
                Game.canGuess = false;
                
                UI.setButtonState('loading');
                UI.setStatus("WATCH CLOSELY...", "text-orange");
                document.body.classList.remove('show-labels');

                // 1. Assign Balls
                Game.assignBalls();
                
                // 2. Reveal All (Lift)
                document.querySelectorAll('.cup-wrapper').forEach(el => {
                    el.classList.add('reveal-all');
                    // Ensure visual ball is there if data says so
                    const id = parseInt(el.id.split('-')[1]);
                    const cup = Game.cups.find(c => c.id === id);
                    if(cup.hasBall) el.classList.add('has-ball');
                    else el.classList.remove('has-ball');
                });
                Sound.play('lift');
                
                await Game.wait(1500);

                // 3. Hide (Drop)
                document.querySelectorAll('.cup-wrapper').forEach(el => el.classList.remove('reveal-all'));
                Sound.play('lift'); // Sound for drop
                await Game.wait(800);

                // 4. Shuffle Loop
                const totalMoves = Game.shuffleMoves + (Game.cupCount * 2);
                for(let i=0; i<totalMoves; i++) {
                    await Game.performSwap();
                }

                // 5. Ready to Guess
                Game.isShuffling = false;
                Game.canGuess = true;
                
                document.body.classList.add('show-labels');
                UI.setStatus("WHICH ONE?", "text-green");
                UI.setButtonState('guessing'); // Enable Reset immediately for multiple selection
            },

            assignBalls: () => {
                // Reset
                Game.cups.forEach(c => c.hasBall = false);
                // Random indices based on current positions
                const currentPositions = Game.cups.map(c => c.pos);
                // Shuffle positions array
                const shuffledPos = [...currentPositions].sort(() => Math.random() - 0.5);
                const targetPositions = shuffledPos.slice(0, Game.ballCount);
                
                Game.cups.forEach(c => {
                    if(targetPositions.includes(c.pos)) c.hasBall = true;
                });
            },

            performSwap: () => {
                return new Promise(resolve => {
                    // Select two random distinct positions
                    const p1 = Math.floor(Math.random() * Game.cupCount);
                    let p2 = Math.floor(Math.random() * Game.cupCount);
                    while(p1 === p2) p2 = Math.floor(Math.random() * Game.cupCount);

                    // Find Cups at these positions
                    const cupA = Game.cups.find(c => c.pos === p1);
                    const cupB = Game.cups.find(c => c.pos === p2);
                    
                    const elA = document.getElementById(`cup-${cupA.id}`);
                    const elB = document.getElementById(`cup-${cupB.id}`);

                    // Calculation for positions
                    const wPct = 100 / Game.cupCount;
                    const leftA_End = (p2 * wPct) + (wPct/2);
                    const leftB_End = (p1 * wPct) + (wPct/2);

                    // Z-Index logic: Randomly pick who is "front"
                    const aFront = Math.random() > 0.5;
                    
                    // Apply Transition Speed
                    const ease = "cubic-bezier(0.45, 0, 0.55, 1)";
                    elA.style.transition = `left ${Game.shuffleSpeed}ms ${ease}, transform ${Game.shuffleSpeed}ms ${ease}`;
                    elB.style.transition = `left ${Game.shuffleSpeed}ms ${ease}, transform ${Game.shuffleSpeed}ms ${ease}`;

                    // START ANIMATION
                    // Move Z-Index immediately? No, wait for midpoint to swap
                    // Initial Z
                    elA.style.zIndex = 10;
                    elB.style.zIndex = 10;
                    
                    // Depth Scale effect
                    const scaleFront = "translateX(-50%) scale(1.15)";
                    const scaleBack = "translateX(-50%) scale(0.9)";
                    
                    // Start movement
                    requestAnimationFrame(() => {
                        elA.style.left = `${leftA_End}%`;
                        elB.style.left = `${leftB_End}%`;
                        
                        // Apply depth visual
                        elA.style.transform = aFront ? scaleFront : scaleBack;
                        elB.style.transform = aFront ? scaleBack : scaleFront;
                        
                        // Z-Index Swap at midpoint (halfway through transition)
                        setTimeout(() => {
                            elA.style.zIndex = aFront ? 20 : 5;
                            elB.style.zIndex = aFront ? 5 : 20;
                        }, Game.shuffleSpeed / 4); // Do it early in the move
                    });

                    Sound.play('shuffle');

                    // Cleanup after move
                    setTimeout(() => {
                        elA.style.zIndex = 10;
                        elB.style.zIndex = 10;
                        elA.style.transform = 'translateX(-50%) scale(1)';
                        elB.style.transform = 'translateX(-50%) scale(1)';
                        
                        // Update Logic
                        cupA.pos = p2;
                        cupB.pos = p1;
                        resolve();
                    }, Game.shuffleSpeed);
                });
            },

            clickCup: (id) => {
                if(!Game.canGuess) return;
                
                const cup = Game.cups.find(c => c.id === id);
                const el = document.getElementById(`cup-${id}`);
                
                if(el.classList.contains('lifted')) return; // Already clicked

                el.classList.add('lifted');
                Sound.play('lift');
                UI.setButtonState('reset'); // Switch button to RESET immediately upon interaction

                if(cup.hasBall) {
                    // WIN
                    Sound.play('win');
                    UI.setStatus("FOUND IT!", "text-green");
                    
                    // Confetti
                    const rect = el.getBoundingClientRect();
                    const x = (rect.left + rect.width/2) / window.innerWidth;
                    const y = (rect.top + rect.height/2) / window.innerHeight;
                    confetti({ particleCount: 100, spread: 70, origin: { x, y } });

                    // NOTE: Multiple selections are now allowed.
                    
                } else {
                    // FAIL
                    Sound.play('fail');
                    UI.setStatus("NOPE!", "text-pink");
                    // Keep guessing - multiple options allowed
                }
            },

            resetRound: () => {
                Game.canGuess = false;
                document.querySelectorAll('.cup-wrapper').forEach(el => {
                    el.classList.remove('lifted', 'has-ball', 'reveal-all');
                });
                UI.setStatus("FIND THE BALL", "text-white");
                UI.setButtonState('idle');
            },

            // --- SETTINGS LOGIC ---
            updateSettings: (type, dir) => {
                if(type === 'cups') {
                    let n = Game.cupCount + dir;
                    if(n < 2) n = 2; if(n > 6) n = 6;
                    Game.cupCount = n;
                    // Reset ball count if it exceeds cups
                    if(Game.ballCount >= n) Game.ballCount = n - 1;
                    // Regenerate data structure internally so UI can map it
                    // but don't render yet
                    const oldLabels = Game.cups.map(c => c.label);
                    Game.generateCups(n);
                    // Try to preserve labels
                    Game.cups.forEach((c, i) => {
                        if(oldLabels[i]) c.label = oldLabels[i];
                    });
                }
                if(type === 'balls') {
                    let n = Game.ballCount + dir;
                    if(n < 1) n = 1; if(n >= Game.cupCount) n = Game.cupCount - 1;
                    Game.ballCount = n;
                }
                UI.refreshSetup();
            },

            saveSettings: () => {
                // Save inputs
                const inputs = document.querySelectorAll('.label-input');
                inputs.forEach(input => {
                    const id = parseInt(input.dataset.id);
                    const cup = Game.cups.find(c => c.id === id);
                    if(cup) cup.label = input.value || `${id+1}`;
                });
                
                Game.renderCups();
                Game.resetRound();
                UI.closeSetup();
            },

            wait: (ms) => new Promise(r => setTimeout(r, ms))
        };

        // --- UI MANAGER ---
        const UI = {
            openSetup: () => {
                const modal = document.getElementById('setup-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                document.getElementById('setup-panel').classList.remove('scale-95');
                UI.refreshSetup();
            },
            closeSetup: () => {
                const modal = document.getElementById('setup-modal');
                modal.classList.add('opacity-0');
                document.getElementById('setup-panel').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            },
            refreshSetup: () => {
                document.getElementById('cup-count-val').innerText = Game.cupCount;
                document.getElementById('ball-count-val').innerText = Game.ballCount;
                
                const container = document.getElementById('label-container');
                container.innerHTML = '';
                Game.cups.forEach(c => {
                    container.innerHTML += `
                        <input type="text" class="label-input bg-dark border border-white/20 rounded p-2 text-white text-sm text-center focus:border-blue outline-none" 
                        data-id="${c.id}" value="${c.label}" placeholder="Cup ${c.id+1}">
                    `;
                });
            },
            toggleMute: () => {
                Sound.enabled = !Sound.enabled;
                const btn = document.getElementById('mute-btn');
                btn.innerHTML = `<i data-lucide="${Sound.enabled ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i>`;
                lucide.createIcons();
            },
            setStatus: (text, colorClass) => {
                const el = document.getElementById('status-display');
                el.innerText = text;
                // clear old colors
                el.className = `text-6xl font-heading text-transparent bg-clip-text bg-gradient-to-br drop-shadow-2xl tracking-widest animate-float opacity-90 transition-all duration-300`;
                
                if(colorClass === 'text-white') el.classList.add('from-white', 'to-gray-400');
                else if(colorClass === 'text-orange') el.classList.add('from-orange', 'to-pink');
                else if(colorClass === 'text-green') el.classList.add('from-green', 'to-blue');
                else if(colorClass === 'text-pink') el.classList.add('from-pink', 'to-red-500');
            },
            setButtonState: (state) => {
                const btn = document.getElementById('action-btn');
                btn.classList.remove('disabled', 'bg-green', 'bg-pink', 'bg-gray-600');
                
                if(state === 'idle') {
                    btn.innerText = "SHUFFLE";
                    btn.classList.add('bg-green');
                } else if(state === 'loading') {
                    btn.innerText = "SHUFFLING...";
                    btn.classList.add('disabled', 'bg-gray-600');
                } else if(state === 'guessing') {
                    btn.innerText = "RESET";
                    btn.classList.add('bg-pink'); // Allows immediate reset
                } else if(state === 'reset') {
                    btn.innerText = "RESET";
                    btn.classList.add('bg-pink');
                }
            },
            updateSpeedLabel: (val) => {
                let text = "Medium";
                if(val < 25) text = "Slow";
                if(val > 75) text = "Fast";
                document.getElementById('speed-label').innerText = text;
            }
        };

        window.onload = Game.init;
    </script>
</body>
</html>