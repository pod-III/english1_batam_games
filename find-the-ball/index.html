<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Cups - English 1 Batam</title>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Theme Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#0f172a', 
                        surface: '#FFFFFF',
                        border: '#cbd5e1',
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'], 
                        body: ['Nunito', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(15, 23, 42, 1)',
                        'hard-lg': '8px 8px 0px 0px rgba(15, 23, 42, 1)',
                        'hard-sm': '2px 2px 0px 0px rgba(15, 23, 42, 1)',
                        'inner-hard': 'inset 2px 2px 0px 0px rgba(30, 41, 59, 0.1)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL BACKGROUND --- */
        body { 
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            background-color: #F8FAFC; 
            /* Subtle Grid/Vignette on the outside container */
            background-image: 
                radial-gradient(circle at center, transparent 0%, rgba(15,23,42,0.03) 100%),
                linear-gradient(#E2E8F0 1px, transparent 1px),
                linear-gradient(90deg, #E2E8F0 1px, transparent 1px);
            background-size: 100% 100%, 24px 24px, 24px 24px;
            background-repeat: repeat, repeat;
            color: #0f172a;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- GAME AREA IMAGE BACKGROUND (NEW) --- */
        #game-area {
            background-image: url('./bg/bg-1.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* --- LAYOUT & CONTAINERS --- */
        .game-console {
            background: #FFFFFF;
            border: 4px solid #0f172a;
            border-radius: 2rem;
            box-shadow: 12px 12px 0px rgba(15, 23, 42, 0.15);
            display: flex;
            overflow: hidden;
        }

        /* --- BUTTONS --- */
        .btn-chunky {
            transition: all 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateY(0);
            position: relative;
            border: 3px solid #0f172a;
            box-shadow: 0 4px 0 #0f172a;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-chunky:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #0f172a !important;
        }
        .btn-chunky:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(80%);
            transform: translateY(4px);
            box-shadow: 0 0 0 #0f172a !important;
        }

        /* Stepper Buttons (Square) */
        .btn-stepper {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #0f172a; border-radius: 10px;
            background: white; box-shadow: 0 3px 0 #0f172a;
            transition: all 0.1s; color: #0f172a;
        }
        .btn-stepper:active:not(:disabled) {
            transform: translateY(3px); box-shadow: none;
        }
        .btn-stepper:disabled {
            opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: translateY(3px); background: #f1f5f9;
        }

        /* --- SLIDERS --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 12px; cursor: pointer;
            background: #e2e8f0; border: 2px solid #0f172a; border-radius: 99px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #FFFFFF; border: 3px solid #0f172a; margin-top: -8px; 
            cursor: grab; box-shadow: 1px 1px 0px rgba(15,23,42,1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.1); cursor: grabbing; }
        
        #speed-slider::-webkit-slider-thumb { background: #00E676; }

        /* --- SCROLLBAR --- */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* --- GAME OBJECTS --- */
        .cup-container {
            position: absolute;
            width: 180px; height: 240px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end; 
            cursor: pointer; z-index: 10;
            transform-origin: bottom center; 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
        }

        .cup-label {
            background: #FFFFFF; border: 2px solid #0f172a;
            padding: 4px 14px; border-radius: 12px;
            font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 0.9rem;
            color: #0f172a; box-shadow: 0 4px 0 rgba(15,23,42,0.1);
            margin-bottom: 12px; pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }

        .cup-img {
            width: 100%; height: auto; object-fit: contain;
            filter: drop-shadow(0 10px 10px rgba(15, 23, 42, 0.15)); 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative; z-index: 2;
        }

        /* Hover: Float effect */
        .cup-container:not(.lifted):hover .cup-img {
            transform: translateY(-12px) scale(1.02);
        }

        /* Click Squish */
        @keyframes squish {
            0% { transform: scale(1, 1); }
            40% { transform: scale(1.15, 0.85); }
            100% { transform: scale(1, 1); }
        }
        .cup-container.clicked .cup-img { animation: squish 0.2s ease-out; }

        .cup-container.lifted .cup-img { transform: translateY(-130px); }

        /* 3D Ball */
        .ball {
            width: 54px; height: 54px;
            background: radial-gradient(circle at 30% 30%, #FFB74D, #FF8C42, #E65100);
            border: 3px solid #0f172a; border-radius: 50%;
            position: absolute; bottom: 35px; left: 50%;
            transform: translateX(-50%); z-index: 1; 
            box-shadow: inset -4px -6px 0 rgba(0,0,0,0.15), 0 4px 0 rgba(0,0,0,0.1);
            display: none; 
        }
        .ball.visible { display: block; }

        /* --- PANELS --- */
        .hidden-panel-mobile { transform: translateY(100%); }
        .hidden-panel-desktop { margin-left: -24rem; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center p-2 md:p-6 overflow-hidden">

    <!-- MAIN CONSOLE -->
    <div class="game-console w-full h-full relative flex-col md:flex-row bg-white">
        
        <!-- SIDEBAR (Setup) -->
        <aside id="controls" class="w-full md:w-96 bg-white border-b-4 md:border-b-0 md:border-r-4 border-dark flex flex-col z-50 transition-all duration-300 shadow-xl md:shadow-none h-[50%] md:h-full relative">
            
            <!-- Header -->
            <div class="p-5 border-b-4 border-dark bg-yellow-50/50 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                <div>
                    <h1 class="text-2xl font-heading text-dark tracking-wide leading-none">
                        MAGIC<span class="text-pink">CUPS</span>
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-green animate-pulse"></span>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">English 1 Batam</p>
                    </div>
                </div>
                <button onclick="toggleControlPanel(true)" class="md:hidden p-2 bg-white text-pink border-2 border-dark rounded-xl shadow-hard-sm active:translate-y-1 active:shadow-none transition-all">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-8 bg-white pb-24">
                
                <!-- DESIGN PICKER -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="palette" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase tracking-widest">Cup Style</span>
                    </div>
                    <div id="cup-design-selector" class="grid grid-cols-3 gap-3">
                        <!-- JS Injected -->
                    </div>
                </div>
                
                <!-- DIFFICULTY SETTINGS -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-slate-400 mb-1">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase tracking-widest">Configuration</span>
                    </div>

                    <!-- Cup Stepper -->
                    <div class="bg-slate-50 p-4 rounded-2xl border-2 border-dark shadow-sm flex items-center justify-between group hover:border-blue transition-colors">
                        <div class="flex flex-col">
                            <span class="font-bold text-dark text-sm">Total Cups</span>
                            <span class="text-[10px] text-slate-400 font-bold uppercase">On Stage</span>
                        </div>
                        <div class="flex items-center gap-3 bg-white p-1 rounded-xl border border-slate-200">
                            <button onclick="changeCups(-1)" id="btn-cup-minus" class="btn-stepper hover:bg-slate-50"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span id="cup-count-display" class="font-heading text-blue text-2xl w-8 text-center">3</span>
                            <button onclick="changeCups(1)" id="btn-cup-plus" class="btn-stepper hover:bg-slate-50"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <!-- Ball Stepper -->
                    <div class="bg-slate-50 p-4 rounded-2xl border-2 border-dark shadow-sm flex items-center justify-between group hover:border-orange transition-colors">
                        <div class="flex flex-col">
                            <span class="font-bold text-dark text-sm">Hidden Balls</span>
                            <span class="text-[10px] text-slate-400 font-bold uppercase">To Find</span>
                        </div>
                        <div class="flex items-center gap-3 bg-white p-1 rounded-xl border border-slate-200">
                            <button onclick="changeBalls(-1)" id="btn-ball-minus" class="btn-stepper hover:bg-slate-50"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span id="ball-count-display" class="font-heading text-orange text-2xl w-8 text-center">1</span>
                            <button onclick="changeBalls(1)" id="btn-ball-plus" class="btn-stepper hover:bg-slate-50"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- GAME AREA -->
        <!-- Removed bg-slate-50 class to let the CSS background rule apply -->
        <main id="game-area" class="flex-1 relative overflow-hidden group transition-colors duration-300 flex flex-col">
            
            <!-- Floating Settings Toggle -->
            <div class="absolute top-4 left-4 z-30">
                <button onclick="toggleControlPanel(false)" class="p-3 bg-white border-2 border-dark rounded-xl shadow-hard-sm hover:-translate-y-1 hover:shadow-hard transition-all text-slate-500 hover:text-dark group">
                    <i data-lucide="settings-2" class="w-6 h-6 group-hover:rotate-45 transition-transform duration-500"></i>
                </button>
            </div>

            <!-- Version Tag -->
            <div class="absolute bottom-3 right-4 text-[10px] font-mono font-bold text-slate-300 select-none">v3.0 FINAL</div>

            <!-- STAGE -->
            <div id="game-stage" class="flex-1 w-full relative flex items-center justify-center pb-24 md:pb-32">
                <!-- Cups Rendered Here -->
            </div>
            
            <!-- COMMAND CENTER (Bottom Bar) -->
            <div class="absolute bottom-6 left-0 right-0 px-4 md:px-0 flex justify-center z-40 pointer-events-none">
                <div class="w-full max-w-lg bg-white/90 backdrop-blur-xl border-4 border-dark rounded-3xl p-2 md:p-3 shadow-hard-lg pointer-events-auto flex flex-col gap-2 transition-transform duration-300">
                    
                    <!-- Top Row: Status & Speed -->
                    <div class="flex items-center justify-between px-2 gap-4">
                        <!-- Status Pill -->
                        <div id="status-badge" class="px-4 py-1.5 rounded-full bg-slate-100 border-2 border-slate-200 text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all shadow-sm">
                            <span class="w-2 h-2 rounded-full bg-slate-400 transition-colors" id="status-dot"></span>
                            <span id="status-text">READY</span>
                        </div>

                        <!-- Speed Slider (Compact) -->
                        <div class="flex items-center gap-3 flex-1 justify-end">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Speed</span>
                            <div class="w-32 md:w-40 relative flex items-center">
                                <span id="speed-display" class="absolute -top-5 right-0 text-[10px] font-bold text-green">1.0X</span>
                                <input type="range" id="speed-slider" min="1" max="20" step="1" value="10" oninput="updateSpeedSetting()">
                            </div>
                        </div>
                    </div>

                    <!-- Main Button -->
                    <button id="start-btn" onclick="startGame()" 
                        class="w-full btn-chunky bg-green text-dark py-3.5 rounded-2xl text-xl tracking-widest flex items-center justify-center gap-3 hover:brightness-105 animate-pulse-slow">
                        <i data-lucide="play" class="w-6 h-6 fill-dark"></i>
                        <span>START GAME</span>
                    </button>

                </div>
            </div>

        </main>
    </div>

    <script>
        // --- GAME STATE ---
        let gameState = {
            cupCount: 3,
            ballCount: 1, 
            shuffleSpeed: 1.0, 
            isShuffling: false,
            isPlaying: false,
            ballPositions: [], 
            cupPositions: [],
            selectedCupIndex: 1,
            foundBallsCount: 0 
        };

        // --- DOM REFERENCES ---
        const stage = document.getElementById('game-stage');
        
        // --- INITIALIZATION ---
        function init() {
            lucide.createIcons();
            updateStepperUI();
            updateSpeedSetting();
            renderDesignSelector(); 
            renderCups();
            updateStatus('ready');
            
            if(window.innerWidth < 768) {
                toggleControlPanel(true);
            }
        }

        // --- LOGIC: SETTINGS ---
        function changeCups(delta) {
            if(gameState.isPlaying) return;
            const newVal = gameState.cupCount + delta;
            if (newVal >= 2 && newVal <= 6) {
                gameState.cupCount = newVal;
                if(gameState.ballCount >= gameState.cupCount) gameState.ballCount = gameState.cupCount - 1;
                updateStepperUI();
                renderCups();
            }
        }

        function changeBalls(delta) {
            if(gameState.isPlaying) return;
            const newVal = gameState.ballCount + delta;
            if (newVal >= 1 && newVal < gameState.cupCount) {
                gameState.ballCount = newVal;
                updateStepperUI();
            }
        }

        function updateStepperUI() {
            document.getElementById('cup-count-display').innerText = gameState.cupCount;
            document.getElementById('ball-count-display').innerText = gameState.ballCount;
            document.getElementById('btn-cup-minus').disabled = (gameState.cupCount <= 2);
            document.getElementById('btn-cup-plus').disabled = (gameState.cupCount >= 6);
            document.getElementById('btn-ball-minus').disabled = (gameState.ballCount <= 1);
            document.getElementById('btn-ball-plus').disabled = (gameState.ballCount >= gameState.cupCount - 1);
        }

        function updateSpeedSetting() {
            const sliderVal = parseInt(document.getElementById('speed-slider').value);
            const speedFactor = sliderVal / 10;
            gameState.shuffleSpeed = speedFactor;
            document.getElementById('speed-display').innerText = `${speedFactor.toFixed(1)}X`;
        }

        // --- LOGIC: RENDER ---
        function renderDesignSelector() {
            const selector = document.getElementById('cup-design-selector');
            selector.innerHTML = ''; 
            for (let i = 1; i <= 6; i++) {
                const button = document.createElement('button');
                button.type = 'button';
                button.id = `cup-select-${i}`;
                button.className = 'p-1 bg-white rounded-xl border-2 border-dark shadow-hard-sm hover:-translate-y-0.5 hover:shadow-hard active:translate-y-0 transition-all duration-200 group overflow-hidden';
                button.innerHTML = `
                    <div class="w-full aspect-[4/5] bg-slate-50 rounded-lg flex items-center justify-center relative">
                        <img src="./cups/cup-${i}.png" class="w-3/4 h-3/4 object-contain transition-transform group-hover:scale-110 duration-300" alt="Design ${i}" draggable="false">
                        <div class="absolute inset-0 bg-blue/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                `;
                button.onclick = () => selectCupDesign(i);
                selector.appendChild(button);
            }
            highlightSelectedDesign(gameState.selectedCupIndex);
        }

        function highlightSelectedDesign(index) {
            document.querySelectorAll('#cup-design-selector button').forEach(btn => {
                btn.classList.remove('border-blue', 'ring-2', 'ring-blue/30');
                btn.classList.add('border-dark');
            });
            const selectedBtn = document.getElementById(`cup-select-${index}`);
            if(selectedBtn) {
                selectedBtn.classList.remove('border-dark');
                selectedBtn.classList.add('border-blue', 'ring-2', 'ring-blue/30');
            }
        }

        function selectCupDesign(index) {
            if(gameState.isPlaying) return; 
            gameState.selectedCupIndex = index;
            highlightSelectedDesign(index);
            renderCups(); 
        }

        function renderCups() {
            stage.innerHTML = '';
            gameState.cupPositions = [];
            
            const stageWidth = stage.clientWidth;
            const cupBaseWidth = 180; 
            const gap = 30; 
            const totalRequiredWidth = (gameState.cupCount * cupBaseWidth) + ((gameState.cupCount - 1) * gap);
            
            let scale = 1;
            if (totalRequiredWidth > (stageWidth - 20)) {
                scale = (stageWidth - 40) / totalRequiredWidth;
            }
            
            const actualTotalWidth = totalRequiredWidth * scale;
            const startX = (stageWidth - actualTotalWidth) / 2;

            for (let i = 0; i < gameState.cupCount; i++) {
                const cup = document.createElement('div');
                cup.className = 'cup-container';
                cup.id = `cup-${i}`;
                
                const visualIndexOffset = i * (cupBaseWidth + gap);
                const xPos = startX + (visualIndexOffset * scale);
                gameState.cupPositions.push(xPos); 
                
                const imageIndex = gameState.selectedCupIndex; 
                
                cup.style.transform = `translate(${xPos}px, 0) scale(${scale})`;
                cup.style.width = `${cupBaseWidth}px`; 

                cup.innerHTML = `
                    <div class="cup-label text-xl transition-opacity duration-300 opacity-0" data-original-id="${i}">Cup ${i + 1}</div>
                    <img src="./cups/cup-${imageIndex}.png" class="cup-img" alt="Cup ${i+1}" draggable="false">
                    <div class="ball" id="ball-${i}"></div>
                `;
                
                cup.style.left = '0px'; 
                cup.dataset.scale = scale; 
                cup.onclick = () => handleCupClick(i);
                stage.appendChild(cup);
            }
        }
        
        function getTranslateX(el) {
            const style = window.getComputedStyle(el);
            const transform = style.transform;
            if (transform === 'none') return 0;
            if (transform.startsWith('matrix3d')) {
                const values = transform.match(/matrix3d\((.+)\)/);
                return values ? parseFloat(values[1].split(', ')[12]) : 0; 
            }
            if (transform.startsWith('matrix')) {
                const values = transform.match(/matrix\((.+)\)/);
                return values ? parseFloat(values[1].split(', ')[4]) : 0;
            }
            return 0;
        }

        function updateLabelsByPosition() {
            const cups = Array.from(document.querySelectorAll('.cup-container'));
            const sortedCups = cups
                .map(cup => ({ element: cup, x: getTranslateX(cup) }))
                .sort((a, b) => a.x - b.x);

            sortedCups.forEach((item, index) => {
                const label = item.element.querySelector('.cup-label');
                if (label) label.textContent = `Cup ${index + 1}`; 
            });
        }

        // --- STATUS & UI UPDATE ---
        function updateStatus(state, msg = "") {
            const badge = document.getElementById('status-badge');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');

            // Reset classes
            badge.className = "px-4 py-1.5 rounded-full border-2 text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all shadow-sm";
            dot.className = "w-2 h-2 rounded-full transition-colors";

            if (state === 'ready') {
                badge.classList.add('bg-slate-100', 'border-slate-200', 'text-slate-500');
                dot.classList.add('bg-slate-400');
                text.innerText = "READY";
            } else if (state === 'shuffling') {
                badge.classList.add('bg-blue/10', 'border-blue/20', 'text-blue');
                dot.classList.add('bg-blue', 'animate-ping');
                text.innerText = "SHUFFLING...";
            } else if (state === 'guessing') {
                badge.classList.add('bg-orange/10', 'border-orange/20', 'text-orange');
                dot.classList.add('bg-orange', 'animate-pulse');
                text.innerText = "GUESS NOW!";
            } else if (state === 'win') {
                badge.classList.add('bg-green/10', 'border-green/20', 'text-green');
                dot.classList.add('bg-green');
                text.innerText = "ALL FOUND!";
            } else if (state === 'progress') {
                badge.classList.add('bg-green/10', 'border-green/20', 'text-green');
                dot.classList.add('bg-green');
                text.innerText = msg;
            } else if (state === 'empty') {
                badge.classList.add('bg-pink/10', 'border-pink/20', 'text-pink');
                dot.classList.add('bg-pink');
                text.innerText = "EMPTY";
            }
        }

        // --- GAMEFLOW ---

        async function startGame() {
            if (gameState.isShuffling || gameState.isPlaying) return;
            
            gameState.isPlaying = true;
            gameState.foundBallsCount = 0; 
            toggleControls(false);
            
            const startBtn = document.getElementById('start-btn');
            startBtn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i><span>PREPARING...</span>';
            startBtn.classList.replace('bg-green', 'bg-slate-200');
            startBtn.classList.replace('text-dark', 'text-slate-400');
            startBtn.classList.remove('animate-pulse-slow');
            
            updateStatus('shuffling'); 
            
            if(window.innerWidth < 768) toggleControlPanel(true);

            // 1. Setup Balls
            gameState.ballPositions = [];
            let availableIndices = Array.from({length: gameState.cupCount}, (_, i) => i);
            for(let i = 0; i < gameState.ballCount; i++) {
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                gameState.ballPositions.push(availableIndices.splice(randomIndex, 1)[0]);
            }
            
            // 2. Reveal
            for (const ballIndex of gameState.ballPositions) {
                const winningCup = document.getElementById(`cup-${ballIndex}`);
                winningCup.classList.add('lifted');
                winningCup.querySelector('.ball').classList.add('visible');
            }
            await wait(1000);
            
            // 3. Hide
            for (const ballIndex of gameState.ballPositions) {
                document.getElementById(`cup-${ballIndex}`).classList.remove('lifted');
            }
            await wait(500);
            
            // 4. Shuffle
            gameState.isShuffling = true;
            await performShuffle();
            
            // 5. Ready
            gameState.isShuffling = false;
            updateLabelsByPosition(); 
            document.querySelectorAll('.cup-label').forEach(label => {
                label.classList.remove('opacity-0');
                label.classList.add('opacity-100');
            });
            
            updateStatus('guessing');
            
            // Button to Reset State
            startBtn.innerHTML = '<i data-lucide="rotate-ccw" class="w-6 h-6"></i><span>RESET</span>';
            startBtn.classList.replace('bg-slate-200', 'bg-pink');
            startBtn.classList.replace('text-slate-400', 'text-white');
            startBtn.onclick = resetGame; 
            startBtn.disabled = false;
            
            lucide.createIcons();
        }

        async function performShuffle() {
            const swaps = 10;
            const baseTimeMs = 350; 
            const speedMs = baseTimeMs / gameState.shuffleSpeed; 
            let currentOrder = Array.from({length: gameState.cupCount}, (_, i) => i);

            for(let n=0; n<swaps; n++) {
                let slotA = Math.floor(Math.random() * gameState.cupCount);
                let slotB = Math.floor(Math.random() * gameState.cupCount);
                while(slotA === slotB) slotB = Math.floor(Math.random() * gameState.cupCount);

                const cupIdA = currentOrder[slotA];
                const cupIdB = currentOrder[slotB];
                const elA = document.getElementById(`cup-${cupIdA}`);
                const elB = document.getElementById(`cup-${cupIdB}`);

                elA.style.zIndex = 20; elB.style.zIndex = 10;

                const scale = elA.dataset.scale || 1;
                elA.style.transition = `transform ${speedMs/1000}s ease-in-out`;
                elB.style.transition = `transform ${speedMs/1000}s ease-in-out`;
                
                elA.style.transform = `translate(${gameState.cupPositions[slotB]}px, 0) scale(${scale})`;
                elB.style.transform = `translate(${gameState.cupPositions[slotA]}px, 0) scale(${scale})`;

                await wait(speedMs);

                currentOrder[slotA] = cupIdB;
                currentOrder[slotB] = cupIdA;
                elA.style.zIndex = 10;
            }
        }

        function feedbackFlash(type) {
            const area = document.getElementById('game-area');
            const colorClass = type === 'good' ? 'bg-green/10' : 'bg-pink/10';
            area.classList.add(colorClass);
            setTimeout(() => area.classList.remove(colorClass), 300);
        }

        function handleCupClick(idIndex) {
            if (!gameState.isPlaying || gameState.isShuffling) return;

            const selectedCup = document.getElementById(`cup-${idIndex}`);
            if(selectedCup.classList.contains('lifted')) return;

            selectedCup.classList.add('clicked');
            
            setTimeout(() => {
                selectedCup.classList.remove('clicked');
                selectedCup.classList.add('lifted');
                
                const isBall = gameState.ballPositions.includes(idIndex);
                feedbackFlash(isBall ? 'good' : 'bad');

                if (isBall) {
                    gameState.foundBallsCount++;
                    selectedCup.querySelector('.ball').classList.add('visible');
                    
                    if(gameState.foundBallsCount >= gameState.ballCount) {
                         updateStatus('win');
                    } else {
                        const remaining = gameState.ballCount - gameState.foundBallsCount;
                        updateStatus('progress', `${gameState.foundBallsCount} FOUND / ${remaining} LEFT`);
                    }
                } else {
                    updateStatus('empty');
                    setTimeout(() => {
                        if(gameState.foundBallsCount < gameState.ballCount) updateStatus('guessing');
                    }, 1500);
                }
            }, 150);
        }

        function resetGame() {
            gameState.isPlaying = false;
            gameState.isShuffling = false;
            gameState.ballPositions = [];
            gameState.foundBallsCount = 0;
            
            toggleControls(true);
            
            const startBtn = document.getElementById('start-btn');
            startBtn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-dark"></i><span>START GAME</span>';
            startBtn.className = "w-full btn-chunky bg-green text-dark py-3.5 rounded-2xl text-xl tracking-widest flex items-center justify-center gap-3 hover:brightness-105 animate-pulse-slow";
            startBtn.onclick = startGame; 
            
            updateStatus('ready');
            lucide.createIcons();
            renderCups(); 
        }

        function toggleControls(enable) {
            document.getElementById('start-btn').disabled = !enable;
            
            const steppers = document.querySelectorAll('.btn-stepper');
            steppers.forEach(btn => btn.disabled = !enable);
            if(enable) updateStepperUI();

            document.getElementById('speed-slider').disabled = !enable;
            document.getElementById('speed-slider').style.opacity = enable ? '1' : '0.5';

            const designBtns = document.querySelectorAll('#cup-design-selector button');
            designBtns.forEach(btn => {
                btn.disabled = !enable;
                if(!enable) btn.classList.add('opacity-50');
                else btn.classList.remove('opacity-50');
            });
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function toggleControlPanel(forceHide = false) {
            const controls = document.getElementById('controls');
            const isCurrentlyHidden = window.innerWidth >= 768 
                ? controls.classList.contains('hidden-panel-desktop')
                : controls.classList.contains('hidden-panel-mobile');

            if(forceHide || !isCurrentlyHidden) {
                controls.classList.add('hidden-panel-mobile', 'hidden-panel-desktop');
            } else {
                controls.classList.remove('hidden-panel-mobile', 'hidden-panel-desktop');
            }
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                renderCups(); 
            }, 350);
        }

        window.addEventListener('resize', () => {
             const controls = document.getElementById('controls');
             if(window.innerWidth >= 768) {
                 controls.classList.remove('hidden-panel-mobile');
             } else {
                 controls.classList.remove('hidden-panel-desktop');
             }
             renderCups();
        });

        init();
    </script>
</body>
</html>