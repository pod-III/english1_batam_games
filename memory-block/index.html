<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Memory Game - English 1 Batam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --pink: #FF6B95;
            --orange: #FF8C42;
            --green: #00E676;
            --blue: #2979FF;
            --dark: #1e293b;
            --chalk: #f8fafc;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--chalk);
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
        }

        h1, h2, h3, button {
            font-family: 'Fredoka', sans-serif;
        }

        .neo-shadow {
            box-shadow: 8px 8px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-shadow-sm {
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        .active-btn {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1) !important;
            filter: brightness(1.1) !important;
        }

        .flash {
            filter: brightness(1.4) contrast(1.1);
            transform: scale(0.96);
        }

        .pad-pink { background-color: var(--pink); border-color: var(--dark); }
        .pad-orange { background-color: var(--orange); border-color: var(--dark); }
        .pad-green { background-color: var(--green); border-color: var(--dark); }
        .pad-blue { background-color: var(--blue); border-color: var(--dark); }

        .game-card {
            max-width: 550px;
            width: 95%;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .pad-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 10px;
            pointer-events: none;
        }

        .pad-img {
            max-width: 70%;
            max-height: 60%;
            object-fit: contain;
            border-radius: 12px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Game Container -->
    <div id="game-container" class="game-card bg-white border-4 border-slate-900 rounded-[2.5rem] p-6 sm:p-8 neo-shadow relative z-10 hidden">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-900" id="level-title">Level 1</h1>
                <p class="text-slate-500 font-bold uppercase tracking-wider text-xs">Memory Challenge</p>
            </div>
            <div class="bg-slate-900 text-white px-5 py-2 rounded-xl border-2 border-slate-900 neo-shadow-sm flex flex-col items-center">
                <span class="text-[10px] font-bold uppercase opacity-70">Score</span>
                <span id="score" class="font-bold text-2xl leading-none">0</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 sm:gap-6 aspect-square mb-6" id="pad-grid">
            <button id="pink" class="pad-pink border-4 rounded-[2rem] neo-shadow transition-all duration-100 hover:-translate-y-1 active:active-btn h-full w-full overflow-hidden relative">
                <div class="pad-content">
                    <img id="img-pink" src="" class="pad-img hidden mb-2">
                    <span id="text-pink" class="text-white font-bold text-lg sm:text-2xl drop-shadow-md"></span>
                </div>
            </button>
            <button id="orange" class="pad-orange border-4 rounded-[2rem] neo-shadow transition-all duration-100 hover:-translate-y-1 active:active-btn h-full w-full overflow-hidden relative">
                <div class="pad-content">
                    <img id="img-orange" src="" class="pad-img hidden mb-2">
                    <span id="text-orange" class="text-white font-bold text-lg sm:text-2xl drop-shadow-md"></span>
                </div>
            </button>
            <button id="green" class="pad-green border-4 rounded-[2rem] neo-shadow transition-all duration-100 hover:-translate-y-1 active:active-btn h-full w-full overflow-hidden relative">
                <div class="pad-content">
                    <img id="img-green" src="" class="pad-img hidden mb-2">
                    <span id="text-green" class="text-white font-bold text-lg sm:text-2xl drop-shadow-md"></span>
                </div>
            </button>
            <button id="blue" class="pad-blue border-4 rounded-[2rem] neo-shadow transition-all duration-100 hover:-translate-y-1 active:active-btn h-full w-full overflow-hidden relative">
                <div class="pad-content">
                    <img id="img-blue" src="" class="pad-img hidden mb-2">
                    <span id="text-blue" class="text-white font-bold text-lg sm:text-2xl drop-shadow-md"></span>
                </div>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex-1 text-center italic text-slate-600 font-bold py-3 bg-slate-100 rounded-xl border-2 border-slate-900" id="status-text">
                Watch the sequence...
            </div>
            <button onclick="showSetup()" class="p-3 bg-white border-2 border-slate-900 rounded-xl neo-shadow-sm hover:-translate-y-1 transition-all">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Start/Intro Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-50">
        <div class="bg-white border-4 border-slate-900 rounded-[2.5rem] p-8 neo-shadow max-w-sm w-full mx-4 text-center">
            <div class="inline-flex p-4 bg-blue-100 rounded-3xl border-2 border-slate-900 mb-6">
                <i data-lucide="brain" class="w-10 h-10 text-slate-900"></i>
            </div>
            
            <h2 id="modal-title" class="text-3xl font-bold text-slate-900 mb-2">Memory Master</h2>
            <p id="modal-desc" class="text-slate-600 font-medium mb-8">Can you remember the pattern? Customize the blocks first or jump right in!</p>

            <div class="flex flex-col gap-3">
                <button id="start-btn" class="w-full bg-[#00E676] hover:bg-[#00d66c] text-slate-900 border-4 border-slate-900 rounded-2xl py-4 font-bold text-2xl neo-shadow-sm transition-all hover:-translate-y-1 active:active-btn">
                    PLAY NOW
                </button>
                <button onclick="showSetup()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 border-4 border-slate-900 rounded-2xl py-3 font-bold text-lg neo-shadow-sm transition-all hover:-translate-y-1 active:active-btn flex items-center justify-center gap-2">
                    <i data-lucide="settings-2" class="w-5 h-5"></i> SETUP BLOCKS
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[60] hidden">
        <div class="bg-white border-4 border-slate-900 rounded-[2.5rem] p-6 sm:p-8 neo-shadow max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Customize Game Blocks</h2>
                <button onclick="hideSetup()" class="text-slate-500 hover:text-slate-900"><i data-lucide="x"></i></button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <!-- Pink Block Config -->
                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-pink-50">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full bg-[#FF6B95]"></div>
                        <span class="font-bold">Pink Block</span>
                    </div>
                    <input type="text" id="input-text-pink" placeholder="Label text..." class="w-full border-2 border-slate-900 rounded-lg p-2 mb-2 text-sm focus:outline-none">
                    <input type="file" id="input-img-pink" accept="image/*" class="w-full text-xs">
                </div>

                <!-- Orange Block Config -->
                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-orange-50">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full bg-[#FF8C42]"></div>
                        <span class="font-bold">Orange Block</span>
                    </div>
                    <input type="text" id="input-text-orange" placeholder="Label text..." class="w-full border-2 border-slate-900 rounded-lg p-2 mb-2 text-sm focus:outline-none">
                    <input type="file" id="input-img-orange" accept="image/*" class="w-full text-xs">
                </div>

                <!-- Green Block Config -->
                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-green-50">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full bg-[#00E676]"></div>
                        <span class="font-bold">Green Block</span>
                    </div>
                    <input type="text" id="input-text-green" placeholder="Label text..." class="w-full border-2 border-slate-900 rounded-lg p-2 mb-2 text-sm focus:outline-none">
                    <input type="file" id="input-img-green" accept="image/*" class="w-full text-xs">
                </div>

                <!-- Blue Block Config -->
                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-blue-50">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full bg-[#2979FF]"></div>
                        <span class="font-bold">Blue Block</span>
                    </div>
                    <input type="text" id="input-text-blue" placeholder="Label text..." class="w-full border-2 border-slate-900 rounded-lg p-2 mb-2 text-sm focus:outline-none">
                    <input type="file" id="input-img-blue" accept="image/*" class="w-full text-xs">
                </div>
            </div>

            <button onclick="saveSetup()" id="save-btn" class="w-full bg-[#2979FF] text-white border-4 border-slate-900 rounded-2xl py-4 font-bold text-xl neo-shadow-sm hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                <span>SAVE & APPLY</span>
            </button>
        </div>
    </div>

    <!-- Audio Synthesis -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const frequencies = { pink: 415.30, orange: 311.13, green: 247.94, blue: 207.65 };

        function playNote(color) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(frequencies[color], audioCtx.currentTime);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playGameOverSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 1);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 1);
        }
    </script>

    <!-- IndexedDB Logic -->
    <script>
        const DB_NAME = 'SimonGameBatamDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'settings';
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const saveSettings = (settings) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(settings, 'current_config');
        };

        const loadSettings = () => {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('current_config');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        };
    </script>

    <script>
        lucide.createIcons();

        const buttonColors = ["pink", "orange", "green", "blue"];
        let gameSequence = [];
        let userClickedPattern = [];
        let started = false;
        let level = 0;

        let customData = {
            pink: { text: "", img: "" },
            orange: { text: "", img: "" },
            green: { text: "", img: "" },
            blue: { text: "", img: "" }
        };

        const modal = document.getElementById('modal-overlay');
        const setupModal = document.getElementById('setup-modal');
        const startBtn = document.getElementById('start-btn');
        const gameContainer = document.getElementById('game-container');
        const levelTitle = document.getElementById('level-title');
        const scoreDisplay = document.getElementById('score');
        const statusText = document.getElementById('status-text');

        // Persistence Initialization
        window.onload = async () => {
            try {
                await initDB();
                const savedData = await loadSettings();
                if (savedData) {
                    customData = savedData;
                    applyCustomDataToUI();
                }
            } catch (err) {
                console.error("Failed to load settings from DB", err);
            }
        };

        function applyCustomDataToUI() {
            buttonColors.forEach(color => {
                const data = customData[color];
                // Update text inputs in setup
                document.getElementById(`input-text-${color}`).value = data.text;
                // Update pad text
                document.getElementById(`text-${color}`).innerText = data.text;
                // Update pad images
                const imgEl = document.getElementById(`img-${color}`);
                if (data.img) {
                    imgEl.src = data.img;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }
            });
        }

        function showSetup() {
            setupModal.classList.remove('hidden');
        }

        function hideSetup() {
            setupModal.classList.add('hidden');
        }

        async function saveSetup() {
            const saveBtn = document.getElementById('save-btn');
            const originalHtml = saveBtn.innerHTML;
            saveBtn.innerHTML = "SAVING...";

            const promises = buttonColors.map(color => {
                return new Promise((resolve) => {
                    const textVal = document.getElementById(`input-text-${color}`).value;
                    const fileInput = document.getElementById(`input-img-${color}`);
                    
                    customData[color].text = textVal;

                    if (fileInput.files && fileInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            customData[color].img = e.target.result;
                            resolve();
                        }
                        reader.readAsDataURL(fileInput.files[0]);
                    } else {
                        // If no new file selected, we keep existing image or stay empty
                        resolve();
                    }
                });
            });

            await Promise.all(promises);
            saveSettings(customData);
            applyCustomDataToUI();
            
            setTimeout(() => {
                saveBtn.innerHTML = originalHtml;
                hideSetup();
            }, 300);
        }

        startBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            if (!started) {
                started = true;
                nextSequence();
            } else {
                resetGame();
                nextSequence();
            }
        });

        document.querySelectorAll('button[id="pink"], button[id="orange"], button[id="green"], button[id="blue"]').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!started || statusText.innerText.includes("Watch")) return;
                const userChosenColor = this.id;
                userClickedPattern.push(userChosenColor);
                animatePress(userChosenColor);
                playNote(userChosenColor);
                checkAnswer(userClickedPattern.length - 1);
            });
        });

        function checkAnswer(currentLevel) {
            if (gameSequence[currentLevel] === userClickedPattern[currentLevel]) {
                if (userClickedPattern.length === gameSequence.length) {
                    statusText.innerText = "Level Up! +1";
                    setTimeout(nextSequence, 1000);
                }
            } else {
                handleGameOver();
            }
        }

        function nextSequence() {
            userClickedPattern = [];
            level++;
            levelTitle.innerText = "Level " + level;
            scoreDisplay.innerText = level - 1;
            statusText.innerText = "Watch carefully...";

            const randomNumber = Math.floor(Math.random() * 4);
            const randomChosenColor = buttonColors[randomNumber];
            gameSequence.push(randomChosenColor);

            let i = 0;
            const interval = setInterval(() => {
                flashButton(gameSequence[i]);
                playNote(gameSequence[i]);
                i++;
                if (i >= gameSequence.length) {
                    clearInterval(interval);
                    setTimeout(() => statusText.innerText = "Your turn! Repeat it.", 500);
                }
            }, Math.max(250, 700 - (level * 25)));
        }

        function flashButton(color) {
            const btn = document.getElementById(color);
            btn.classList.add("flash");
            setTimeout(() => btn.classList.remove("flash"), 300);
        }

        function animatePress(currentColor) {
            const btn = document.getElementById(currentColor);
            btn.classList.add("active-btn");
            setTimeout(() => btn.classList.remove("active-btn"), 100);
        }

        function handleGameOver() {
            playGameOverSound();
            gameContainer.classList.add("shake");
            document.body.style.backgroundColor = "#fee2e2";
            
            setTimeout(() => {
                gameContainer.classList.remove("shake");
                document.body.style.backgroundColor = "var(--chalk)";
                document.getElementById('modal-title').innerText = "Game Over!";
                document.getElementById('modal-desc').innerText = `You made it to Level ${level}. Score: ${level - 1}`;
                startBtn.innerText = "RESTART GAME";
                modal.classList.remove('hidden');
            }, 500);
            started = false;
        }

        function resetGame() {
            level = 0;
            gameSequence = [];
            started = true;
        }
    </script>
</body>
</html>