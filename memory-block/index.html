<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Memory Game - English 1 Batam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --pink: #FF6B95;
            --orange: #FF8C42;
            --green: #00E676;
            --blue: #2979FF;
            --dark: #1e293b;
            --chalk: #f8fafc;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--chalk);
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.07) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, button, .font-display {
            font-family: 'Fredoka', sans-serif;
        }

        /* Neo-Brutalism Utilities */
        .neo-border {
            border: 3px solid var(--dark);
        }
        
        .neo-shadow {
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-shadow-sm {
            box-shadow: 3px 3px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-btn {
            transition: all 0.15s ease;
        }
        
        .neo-btn:active {
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
        }

        /* Game Pad Specifics */
        .active-pad {
            transform: translate(4px, 4px) !important;
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1) !important;
            filter: brightness(1.1) saturate(1.2);
        }

        .flash {
            filter: brightness(1.4) saturate(1.2);
            transform: scale(0.98);
        }

        .pad-pink { background-color: var(--pink); border-color: var(--dark); }
        .pad-orange { background-color: var(--orange); border-color: var(--dark); }
        .pad-green { background-color: var(--green); border-color: var(--dark); }
        .pad-blue { background-color: var(--blue); border-color: var(--dark); }

        .game-card {
            max-width: 600px;
            width: 95%;
        }

        /* Animations */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .level-up-anim {
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .pad-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 10px;
            pointer-events: none;
            user-select: none;
        }

        .pad-img {
            max-width: 80%;
            max-height: 60%;
            object-fit: contain;
            border-radius: 8px;
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2));
        }

        /* Custom File Input Styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Game Container -->
    <div id="game-container" class="game-card bg-white neo-border rounded-[2.5rem] p-6 sm:p-10 neo-shadow relative z-10 hidden">
        
        <!-- Header -->
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 leading-none mb-1" id="level-title">Level 1</h1>
                <div class="flex items-center gap-2">
                    <div id="turn-indicator" class="w-3 h-3 rounded-full bg-red-500 border-2 border-slate-900"></div>
                    <p class="text-slate-500 font-bold uppercase tracking-wider text-xs" id="turn-text">Wait</p>
                </div>
            </div>
            
            <div class="bg-slate-900 text-white px-5 py-3 rounded-xl border-2 border-slate-900 neo-shadow-sm flex flex-col items-center min-w-[80px]">
                <span class="text-[10px] font-bold uppercase opacity-80 tracking-widest">Score</span>
                <span id="score" class="font-display font-bold text-3xl leading-none mt-1">0</span>
            </div>
        </div>

        <!-- The Simon Pad Grid -->
        <div class="grid grid-cols-2 gap-4 sm:gap-6 aspect-square mb-8" id="pad-grid">
            <!-- Buttons generated dynamically or static but cleaner HTML -->
            <button id="pink" class="pad-pink border-[3px] rounded-[2rem] neo-shadow transition-transform hover:-translate-y-1 active:active-pad h-full w-full overflow-hidden relative group">
                <div class="pad-content">
                    <img id="img-pink" src="" class="pad-img hidden mb-2 transition-transform group-hover:scale-105">
                    <span id="text-pink" class="text-white font-display font-bold text-lg sm:text-2xl drop-shadow-md tracking-wide uppercase"></span>
                </div>
            </button>
            <button id="orange" class="pad-orange border-[3px] rounded-[2rem] neo-shadow transition-transform hover:-translate-y-1 active:active-pad h-full w-full overflow-hidden relative group">
                <div class="pad-content">
                    <img id="img-orange" src="" class="pad-img hidden mb-2 transition-transform group-hover:scale-105">
                    <span id="text-orange" class="text-white font-display font-bold text-lg sm:text-2xl drop-shadow-md tracking-wide uppercase"></span>
                </div>
            </button>
            <button id="green" class="pad-green border-[3px] rounded-[2rem] neo-shadow transition-transform hover:-translate-y-1 active:active-pad h-full w-full overflow-hidden relative group">
                <div class="pad-content">
                    <img id="img-green" src="" class="pad-img hidden mb-2 transition-transform group-hover:scale-105">
                    <span id="text-green" class="text-white font-display font-bold text-lg sm:text-2xl drop-shadow-md tracking-wide uppercase"></span>
                </div>
            </button>
            <button id="blue" class="pad-blue border-[3px] rounded-[2rem] neo-shadow transition-transform hover:-translate-y-1 active:active-pad h-full w-full overflow-hidden relative group">
                <div class="pad-content">
                    <img id="img-blue" src="" class="pad-img hidden mb-2 transition-transform group-hover:scale-105">
                    <span id="text-blue" class="text-white font-display font-bold text-lg sm:text-2xl drop-shadow-md tracking-wide uppercase"></span>
                </div>
            </button>
        </div>

        <!-- Footer / Controls -->
        <div class="flex items-center gap-3">
            <div class="flex-1 flex items-center justify-center gap-2 text-center text-slate-700 font-bold py-3 bg-slate-100 rounded-xl border-2 border-slate-900 min-h-[56px]" id="status-bar">
                <span id="status-text">Watch the pattern...</span>
            </div>
            <button onclick="showSetup()" class="p-3 bg-white border-2 border-slate-900 rounded-xl neo-shadow-sm hover:-translate-y-1 transition-transform neo-btn" aria-label="Settings">
                <i data-lucide="settings-2" class="w-6 h-6 text-slate-900"></i>
            </button>
        </div>
        
        <div class="text-center mt-4">
             <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">English 1 Batam â€¢ Learning Tool</p>
        </div>
    </div>

    <!-- Start/Intro Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white border-[3px] border-slate-900 rounded-[2.5rem] p-8 neo-shadow max-w-sm w-full text-center transform transition-all scale-100">
            <div class="inline-flex p-5 bg-blue-100 rounded-full border-2 border-slate-900 mb-6 relative">
                <i data-lucide="brain-circuit" class="w-12 h-12 text-slate-900 relative z-10"></i>
                <div class="absolute inset-0 bg-blue-200 rounded-full blur opacity-50"></div>
            </div>
            
            <h2 id="modal-title" class="text-3xl font-display font-bold text-slate-900 mb-2">Memory Master</h2>
            <p id="modal-desc" class="text-slate-600 font-medium mb-8 leading-relaxed">Challenge your memory! Follow the pattern of lights and sounds.</p>

            <div class="flex flex-col gap-4">
                <button id="start-btn" class="w-full bg-[#00E676] hover:bg-[#00d66c] text-slate-900 neo-border rounded-2xl py-4 font-display font-bold text-xl neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-6 h-6 fill-slate-900"></i> START GAME
                </button>
                <button onclick="showSetup()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 neo-border rounded-2xl py-3 font-display font-bold text-lg neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="pencil" class="w-5 h-5"></i> CUSTOMIZE BLOCKS
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden transition-opacity duration-300">
        <div class="bg-white border-[3px] border-slate-900 rounded-[2.5rem] p-6 sm:p-8 neo-shadow max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b-2 border-slate-100 pb-4">
                <div>
                    <h2 class="text-2xl font-display font-bold text-slate-900">Classroom Setup</h2>
                    <p class="text-sm text-slate-500 font-bold">Customize words & images for the lesson</p>
                </div>
                <button onclick="hideSetup()" class="p-2 rounded-xl hover:bg-slate-100 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8 overflow-y-auto pr-2">
                <!-- Template for setup cards to ensure consistency -->
                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-pink-50 relative group">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full border border-slate-900 bg-[#FF6B95]"></div>
                        <span class="font-bold text-slate-900">Pink Block</span>
                    </div>
                    <input type="text" id="input-text-pink" placeholder="e.g. Apple" class="w-full border-2 border-slate-200 focus:border-slate-900 rounded-xl p-2 mb-3 text-sm font-bold text-slate-700 focus:outline-none transition-colors bg-white">
                    
                    <div class="flex gap-2">
                         <div class="file-input-wrapper w-full">
                            <button class="w-full bg-white border-2 border-slate-200 hover:border-slate-900 text-slate-600 rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="image-plus" class="w-4 h-4"></i> <span id="label-pink">Upload Image</span>
                            </button>
                            <input type="file" id="input-img-pink" accept="image/*" onchange="updateFileLabel('pink')">
                        </div>
                    </div>
                </div>

                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-orange-50 relative group">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full border border-slate-900 bg-[#FF8C42]"></div>
                        <span class="font-bold text-slate-900">Orange Block</span>
                    </div>
                    <input type="text" id="input-text-orange" placeholder="e.g. Orange" class="w-full border-2 border-slate-200 focus:border-slate-900 rounded-xl p-2 mb-3 text-sm font-bold text-slate-700 focus:outline-none transition-colors bg-white">
                     <div class="flex gap-2">
                         <div class="file-input-wrapper w-full">
                            <button class="w-full bg-white border-2 border-slate-200 hover:border-slate-900 text-slate-600 rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="image-plus" class="w-4 h-4"></i> <span id="label-orange">Upload Image</span>
                            </button>
                            <input type="file" id="input-img-orange" accept="image/*" onchange="updateFileLabel('orange')">
                        </div>
                    </div>
                </div>

                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-green-50 relative group">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full border border-slate-900 bg-[#00E676]"></div>
                        <span class="font-bold text-slate-900">Green Block</span>
                    </div>
                    <input type="text" id="input-text-green" placeholder="e.g. Melon" class="w-full border-2 border-slate-200 focus:border-slate-900 rounded-xl p-2 mb-3 text-sm font-bold text-slate-700 focus:outline-none transition-colors bg-white">
                     <div class="flex gap-2">
                         <div class="file-input-wrapper w-full">
                            <button class="w-full bg-white border-2 border-slate-200 hover:border-slate-900 text-slate-600 rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="image-plus" class="w-4 h-4"></i> <span id="label-green">Upload Image</span>
                            </button>
                            <input type="file" id="input-img-green" accept="image/*" onchange="updateFileLabel('green')">
                        </div>
                    </div>
                </div>

                <div class="p-4 rounded-2xl border-2 border-slate-900 bg-blue-50 relative group">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full border border-slate-900 bg-[#2979FF]"></div>
                        <span class="font-bold text-slate-900">Blue Block</span>
                    </div>
                    <input type="text" id="input-text-blue" placeholder="e.g. Berry" class="w-full border-2 border-slate-200 focus:border-slate-900 rounded-xl p-2 mb-3 text-sm font-bold text-slate-700 focus:outline-none transition-colors bg-white">
                     <div class="flex gap-2">
                         <div class="file-input-wrapper w-full">
                            <button class="w-full bg-white border-2 border-slate-200 hover:border-slate-900 text-slate-600 rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="image-plus" class="w-4 h-4"></i> <span id="label-blue">Upload Image</span>
                            </button>
                            <input type="file" id="input-img-blue" accept="image/*" onchange="updateFileLabel('blue')">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-auto">
                <button onclick="clearData()" class="px-6 py-4 bg-red-100 text-red-600 border-2 border-red-200 hover:border-red-600 rounded-2xl font-bold text-sm transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Reset
                </button>
                <button onclick="saveSetup()" id="save-btn" class="flex-1 bg-[#2979FF] text-white neo-border rounded-2xl py-4 font-display font-bold text-xl neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-5 h-5"></i> SAVE CHANGES
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Synthesis -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        // Slightly detuned pleasant sine waves
        const frequencies = { 
            pink: 329.63,   // E4
            orange: 261.63, // C4
            green: 392.00,  // G4
            blue: 523.25    // C5
        };

        function playNote(color) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine'; // Sine is smoother
            osc.frequency.setValueAtTime(frequencies[color], audioCtx.currentTime);
            
            // ADSR Envelope for smoother sound (prevents clicking)
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4); // Release

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.45);
        }

        function playGameOverSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.8);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.8);
        }

        function playLevelUpSound() {
            const now = audioCtx.currentTime;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = 'triangle';
            // Simple Arpeggio C Major
            oscillator.frequency.setValueAtTime(523.25, now); // C5
            oscillator.frequency.setValueAtTime(659.25, now + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, now + 0.2); // G5
            
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();
            oscillator.stop(now + 0.4);
        }
    </script>

    <!-- IndexedDB Logic -->
    <script>
        const DB_NAME = 'SimonGameBatamDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'settings';
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const saveSettings = (settings) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(settings, 'current_config');
        };

        const loadSettings = () => {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('current_config');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        };

        const clearSettings = () => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.clear();
        };
    </script>

    <script>
        lucide.createIcons();

        const buttonColors = ["pink", "orange", "green", "blue"];
        let gameSequence = [];
        let userClickedPattern = [];
        let started = false;
        let canClick = false; // Strict input locking
        let level = 0;

        let customData = {
            pink: { text: "", img: "" },
            orange: { text: "", img: "" },
            green: { text: "", img: "" },
            blue: { text: "", img: "" }
        };

        // DOM Elements
        const modal = document.getElementById('modal-overlay');
        const setupModal = document.getElementById('setup-modal');
        const startBtn = document.getElementById('start-btn');
        const gameContainer = document.getElementById('game-container');
        const levelTitle = document.getElementById('level-title');
        const scoreDisplay = document.getElementById('score');
        const statusText = document.getElementById('status-text');
        const turnIndicator = document.getElementById('turn-indicator');
        const turnText = document.getElementById('turn-text');
        const statusBar = document.getElementById('status-bar');

        // Initial Load
        window.onload = async () => {
            try {
                await initDB();
                const savedData = await loadSettings();
                if (savedData) {
                    customData = savedData;
                    applyCustomDataToUI();
                }
            } catch (err) {
                console.error("DB Error", err);
            }
        };

        // --- Helper Functions for UI ---
        function setTurn(isPlayer) {
            canClick = isPlayer;
            if (isPlayer) {
                turnIndicator.className = "w-3 h-3 rounded-full bg-[#00E676] border-2 border-slate-900 animate-pulse";
                turnText.innerText = "YOUR TURN";
                turnText.className = "text-[#00E676] font-bold uppercase tracking-wider text-xs";
                statusText.innerText = "Repeat the pattern!";
                statusBar.className = "flex-1 flex items-center justify-center gap-2 text-center text-slate-900 font-bold py-3 bg-white rounded-xl border-2 border-slate-900 min-h-[56px] neo-shadow-sm";
                gameContainer.classList.add('cursor-pointer');
            } else {
                turnIndicator.className = "w-3 h-3 rounded-full bg-red-500 border-2 border-slate-900";
                turnText.innerText = "WAIT";
                turnText.className = "text-red-500 font-bold uppercase tracking-wider text-xs";
                statusText.innerText = "Watch carefully...";
                statusBar.className = "flex-1 flex items-center justify-center gap-2 text-center text-slate-500 font-bold py-3 bg-slate-100 rounded-xl border-2 border-slate-900 min-h-[56px]";
                gameContainer.classList.remove('cursor-pointer');
            }
        }

        function updateFileLabel(color) {
            const input = document.getElementById(`input-img-${color}`);
            const label = document.getElementById(`label-${color}`);
            if(input.files && input.files[0]) {
                label.innerText = "Image Selected";
                label.parentElement.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
            }
        }

        // --- Setup Logic ---
        function showSetup() { setupModal.classList.remove('hidden'); }
        function hideSetup() { setupModal.classList.add('hidden'); }
        
        function applyCustomDataToUI() {
            buttonColors.forEach(color => {
                const data = customData[color];
                document.getElementById(`input-text-${color}`).value = data.text;
                document.getElementById(`text-${color}`).innerText = data.text;
                const imgEl = document.getElementById(`img-${color}`);
                if (data.img) {
                    imgEl.src = data.img;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }
            });
        }

        function clearData() {
            if(confirm("Reset all customizations?")) {
                customData = {
                    pink: { text: "", img: "" },
                    orange: { text: "", img: "" },
                    green: { text: "", img: "" },
                    blue: { text: "", img: "" }
                };
                clearSettings();
                applyCustomDataToUI();
                hideSetup();
            }
        }

        async function saveSetup() {
            const saveBtn = document.getElementById('save-btn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Saving...`;
            lucide.createIcons();

            const promises = buttonColors.map(color => {
                return new Promise((resolve) => {
                    const textVal = document.getElementById(`input-text-${color}`).value;
                    const fileInput = document.getElementById(`input-img-${color}`);
                    customData[color].text = textVal;

                    if (fileInput.files && fileInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            customData[color].img = e.target.result;
                            resolve();
                        }
                        reader.readAsDataURL(fileInput.files[0]);
                    } else {
                        resolve();
                    }
                });
            });

            await Promise.all(promises);
            saveSettings(customData);
            applyCustomDataToUI();
            
            setTimeout(() => {
                saveBtn.innerHTML = originalContent;
                lucide.createIcons();
                hideSetup();
            }, 500);
        }

        // --- Game Logic ---
        startBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resetGame();
            nextSequence();
        });

        // Add Listeners to Pads
        document.querySelectorAll('button[id="pink"], button[id="orange"], button[id="green"], button[id="blue"]').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!started || !canClick) return; // Strict lock
                
                const userChosenColor = this.id;
                userClickedPattern.push(userChosenColor);
                
                animatePress(userChosenColor);
                playNote(userChosenColor);
                
                checkAnswer(userClickedPattern.length - 1);
            });
        });

        function checkAnswer(currentLevel) {
            if (gameSequence[currentLevel] === userClickedPattern[currentLevel]) {
                if (userClickedPattern.length === gameSequence.length) {
                    // Success for this round
                    canClick = false; // Lock immediately
                    playLevelUpSound();
                    statusBar.innerHTML = `<span class="text-[#00E676] flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Great Job!</span>`;
                    lucide.createIcons();
                    
                    setTimeout(function() {
                        nextSequence();
                    }, 1200);
                }
            } else {
                handleGameOver();
            }
        }

        function nextSequence() {
            userClickedPattern = [];
            level++;
            levelTitle.innerText = "Level " + level;
            scoreDisplay.innerText = level - 1;
            
            setTurn(false); // CPU Turn

            const randomNumber = Math.floor(Math.random() * 4);
            const randomChosenColor = buttonColors[randomNumber];
            gameSequence.push(randomChosenColor);

            let i = 0;
            // Adaptive speed: gets faster as you go
            const speed = Math.max(300, 800 - (level * 40)); 

            setTimeout(() => {
                const interval = setInterval(() => {
                    flashButton(gameSequence[i]);
                    playNote(gameSequence[i]);
                    i++;
                    if (i >= gameSequence.length) {
                        clearInterval(interval);
                        // Handover to player
                        setTimeout(() => setTurn(true), speed);
                    }
                }, speed);
            }, 800); // Initial delay before sequence starts
        }

        function flashButton(color) {
            const btn = document.getElementById(color);
            btn.classList.add("flash");
            setTimeout(() => btn.classList.remove("flash"), 250);
        }

        function animatePress(currentColor) {
            const btn = document.getElementById(currentColor);
            btn.classList.add("active-pad");
            setTimeout(() => btn.classList.remove("active-pad"), 100);
        }

        function handleGameOver() {
            canClick = false;
            playGameOverSound();
            gameContainer.classList.add("shake");
            document.body.style.backgroundColor = "#fee2e2";
            
            setTimeout(() => {
                gameContainer.classList.remove("shake");
                document.body.style.backgroundColor = "var(--chalk)";
                document.getElementById('modal-title').innerText = "Game Over!";
                document.getElementById('modal-desc').innerHTML = `You reached <b>Level ${level}</b>.<br>Your final score is <b>${level - 1}</b>.`;
                startBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-6 h-6"></i> PLAY AGAIN`;
                lucide.createIcons();
                modal.classList.remove('hidden');
            }, 600);
            started = false;
        }

        function resetGame() {
            level = 0;
            gameSequence = [];
            started = true;
            userClickedPattern = [];
        }
    </script>
</body>
</html>