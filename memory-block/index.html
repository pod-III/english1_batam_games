<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Memory Game - English 1 Batam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --pink: #FF6B95;
            --orange: #FF8C42;
            --green: #00E676;
            --blue: #2979FF;
            --purple: #d946ef;
            --yellow: #facc15;
            --red: #ef4444;
            --teal: #14b8a6;
            --indigo: #6366f1;
            --dark: #1e293b;
            --chalk: #f8fafc;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--chalk);
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.07) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, button, .font-display { font-family: 'Fredoka', sans-serif; }

        /* Neo-Brutalism Utilities */
        .neo-border { border: 3px solid var(--dark); }
        
        .neo-shadow { box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1); }
        .neo-shadow-sm { box-shadow: 3px 3px 0px 0px rgba(30, 41, 59, 1); }
        
        .neo-btn { transition: all 0.15s ease; }
        .neo-btn:active { transform: translate(3px, 3px); box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1); }

        /* Game Pad Specifics */
        .active-pad {
            transform: translate(4px, 4px) !important;
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1) !important;
            filter: brightness(1.1) saturate(1.2);
        }

        .flash {
            filter: brightness(1.4) saturate(1.2);
            transform: scale(0.98);
        }

        /* Color Classes */
        .pad-pink { background-color: var(--pink); border-color: var(--dark); }
        .pad-orange { background-color: var(--orange); border-color: var(--dark); }
        .pad-green { background-color: var(--green); border-color: var(--dark); }
        .pad-blue { background-color: var(--blue); border-color: var(--dark); }
        .pad-purple { background-color: var(--purple); border-color: var(--dark); }
        .pad-yellow { background-color: var(--yellow); border-color: var(--dark); }
        .pad-red { background-color: var(--red); border-color: var(--dark); }
        .pad-teal { background-color: var(--teal); border-color: var(--dark); }
        .pad-indigo { background-color: var(--indigo); border-color: var(--dark); }

        .game-card { max-width: 600px; width: 95%; }

        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .pad-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 10px;
            pointer-events: none;
            user-select: none;
        }

        .pad-img {
            max-width: 80%;
            max-height: 60%;
            object-fit: contain;
            border-radius: 8px;
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2));
        }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #00E676; }
        .toggle-checkbox:checked + .toggle-label { background-color: #00E676; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="game-card bg-white neo-border rounded-[2.5rem] p-6 sm:p-10 neo-shadow relative z-10 hidden">
        
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 leading-none mb-1" id="level-title">Level 1</h1>
                <div class="flex items-center gap-2">
                    <div id="turn-indicator" class="w-3 h-3 rounded-full bg-red-500 border-2 border-slate-900"></div>
                    <p class="text-slate-500 font-bold uppercase tracking-wider text-xs" id="turn-text">Wait</p>
                </div>
            </div>
            
            <div class="bg-slate-900 text-white px-5 py-3 rounded-xl border-2 border-slate-900 neo-shadow-sm flex flex-col items-center min-w-[80px]">
                <span class="text-[10px] font-bold uppercase opacity-80 tracking-widest">Score</span>
                <span id="score" class="font-display font-bold text-3xl leading-none mt-1">0</span>
            </div>
        </div>

        <div id="pad-grid" class="grid gap-4 sm:gap-5 aspect-square mb-8 transition-all duration-300">
            </div>

        <div class="flex items-center gap-3">
            <div class="flex-1 flex items-center justify-center gap-2 text-center text-slate-700 font-bold py-3 bg-slate-100 rounded-xl border-2 border-slate-900 min-h-[56px]" id="status-bar">
                <span id="status-text">Watch the pattern...</span>
            </div>
            <button onclick="openSetup()" class="p-3 bg-white border-2 border-slate-900 rounded-xl neo-shadow-sm hover:-translate-y-1 transition-transform neo-btn" aria-label="Settings">
                <i data-lucide="settings-2" class="w-6 h-6 text-slate-900"></i>
            </button>
        </div>
        
        <div class="text-center mt-4">
             <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">English 1 Batam â€¢ Learning Tool</p>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white border-[3px] border-slate-900 rounded-[2.5rem] p-8 neo-shadow max-w-sm w-full text-center transform transition-all scale-100">
            <div class="inline-flex p-5 bg-blue-100 rounded-full border-2 border-slate-900 mb-6 relative">
                <i data-lucide="brain-circuit" class="w-12 h-12 text-slate-900 relative z-10"></i>
                <div class="absolute inset-0 bg-blue-200 rounded-full blur opacity-50"></div>
            </div>
            
            <h2 id="modal-title" class="text-3xl font-display font-bold text-slate-900 mb-2">Memory Master</h2>
            <p id="modal-desc" class="text-slate-600 font-medium mb-6 leading-relaxed">Challenge your memory! Follow the pattern.</p>

            <div class="bg-slate-50 border-2 border-slate-200 rounded-xl p-3 mb-6">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Difficulty</p>
                <div class="flex gap-2">
                    <button id="mode-2x2" onclick="setMode(2)" class="flex-1 py-2 rounded-lg font-bold text-sm border-2 border-slate-900 bg-[#2979FF] text-white shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] transition-transform active:translate-y-1 active:shadow-none">
                        2x2 (Easy)
                    </button>
                    <button id="mode-3x3" onclick="setMode(3)" class="flex-1 py-2 rounded-lg font-bold text-sm border-2 border-slate-200 bg-white text-slate-500 hover:border-slate-400 transition-colors">
                        3x3 (Hard)
                    </button>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button id="start-btn" class="w-full bg-[#00E676] hover:bg-[#00d66c] text-slate-900 neo-border rounded-2xl py-4 font-display font-bold text-xl neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-6 h-6 fill-slate-900"></i> START GAME
                </button>
                <button onclick="openSetup()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 neo-border rounded-2xl py-3 font-display font-bold text-lg neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="pencil" class="w-5 h-5"></i> CUSTOMIZE BLOCKS
                </button>
            </div>
        </div>
    </div>

    <div id="setup-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden transition-opacity duration-300">
        <div class="bg-white border-[3px] border-slate-900 rounded-[2.5rem] p-6 sm:p-8 neo-shadow max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b-2 border-slate-100 pb-4">
                <div>
                    <h2 class="text-2xl font-display font-bold text-slate-900">Classroom Setup</h2>
                    <p class="text-sm text-slate-500 font-bold">Editing for: <span id="setup-mode-text" class="text-blue-600">2x2 Grid</span></p>
                </div>
                <button onclick="hideSetup()" class="p-2 rounded-xl hover:bg-slate-100 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div id="setup-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8 overflow-y-auto pr-2 max-h-[60vh]">
                </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-auto pt-4 border-t-2 border-slate-100">
                <button onclick="clearData()" class="px-6 py-4 bg-red-100 text-red-600 border-2 border-red-200 hover:border-red-600 rounded-2xl font-bold text-sm transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Reset
                </button>
                <button onclick="saveSetup()" id="save-btn" class="flex-1 bg-[#2979FF] text-white neo-border rounded-2xl py-4 font-display font-bold text-xl neo-shadow-sm neo-btn flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-5 h-5"></i> SAVE CHANGES
                </button>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type = 'sine', duration = 0.4) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration + 0.05);
        }

        function playGameOverSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.8);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.8);
        }

        function playLevelUpSound() {
            const now = audioCtx.currentTime;
            playTone(523.25, 'triangle', 0.2); // C5
            setTimeout(() => playTone(659.25, 'triangle', 0.2), 100); // E5
            setTimeout(() => playTone(783.99, 'triangle', 0.4), 200); // G5
        }
    </script>

    <script>
        const DB_NAME = 'SimonGameBatamDB_V2'; // Version 2 for expanded data
        const DB_VERSION = 1;
        const STORE_NAME = 'settings';
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const saveSettings = async (settings) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(settings, 'current_config');
        };

        const loadSettings = () => {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('current_config');
                request.onsuccess = () => resolve(request.result || {});
                request.onerror = () => resolve({});
            });
        };

        const clearSettings = () => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.clear();
        };
    </script>

    <script>
        lucide.createIcons();

        // --- Configuration ---
        // Expanded Palette for 3x3 Grid
        const ALL_COLORS = {
            pink:   { id: 'pink',   hex: '#FF6B95', freq: 329.63, label: 'Pink',   cls: 'pad-pink' },
            orange: { id: 'orange', hex: '#FF8C42', freq: 261.63, label: 'Orange', cls: 'pad-orange' },
            green:  { id: 'green',  hex: '#00E676', freq: 392.00, label: 'Green',  cls: 'pad-green' },
            blue:   { id: 'blue',   hex: '#2979FF', freq: 523.25, label: 'Blue',   cls: 'pad-blue' },
            purple: { id: 'purple', hex: '#d946ef', freq: 587.33, label: 'Purple', cls: 'pad-purple' }, // D5
            yellow: { id: 'yellow', hex: '#facc15', freq: 659.25, label: 'Yellow', cls: 'pad-yellow' }, // E5
            red:    { id: 'red',    hex: '#ef4444', freq: 440.00, label: 'Red',    cls: 'pad-red' },    // A4
            teal:   { id: 'teal',   hex: '#14b8a6', freq: 493.88, label: 'Teal',   cls: 'pad-teal' },   // B4
            indigo: { id: 'indigo', hex: '#6366f1', freq: 698.46, label: 'Indigo', cls: 'pad-indigo' }  // F5
        };

        // Define Grid Layouts
        const GRIDS = {
            2: ['pink', 'orange', 'green', 'blue'],
            3: ['pink', 'orange', 'green', 'blue', 'purple', 'yellow', 'red', 'teal', 'indigo']
        };

        let gridSize = 2; // Default 2x2
        let currentColors = GRIDS[2];
        let gameSequence = [];
        let userClickedPattern = [];
        let started = false;
        let canClick = false;
        let level = 0;

        // Stores text/images. Keys match IDs in ALL_COLORS
        let customData = {}; 

        // --- DOM Elements ---
        const modal = document.getElementById('modal-overlay');
        const setupModal = document.getElementById('setup-modal');
        const startBtn = document.getElementById('start-btn');
        const gameContainer = document.getElementById('game-container');
        const padGrid = document.getElementById('pad-grid');
        const levelTitle = document.getElementById('level-title');
        const scoreDisplay = document.getElementById('score');
        const statusText = document.getElementById('status-text');
        const turnIndicator = document.getElementById('turn-indicator');
        const turnText = document.getElementById('turn-text');
        const statusBar = document.getElementById('status-bar');
        const setupGrid = document.getElementById('setup-grid');

        // --- Initialization ---
        window.onload = async () => {
            try {
                await initDB();
                const saved = await loadSettings();
                // Initialize customData with defaults if not present
                Object.keys(ALL_COLORS).forEach(k => {
                    if (!saved[k]) saved[k] = { text: "", img: "" };
                });
                customData = saved;
            } catch (err) {
                console.error("DB Error", err);
            }
        };

        // --- Mode Switching ---
        function setMode(size) {
            gridSize = size;
            currentColors = GRIDS[size];
            
            // Update Toggle UI
            const btn2 = document.getElementById('mode-2x2');
            const btn3 = document.getElementById('mode-3x3');
            const activeClass = "border-slate-900 bg-[#2979FF] text-white shadow-[2px_2px_0px_0px_rgba(30,41,59,1)]";
            const inactiveClass = "border-slate-200 bg-white text-slate-500 hover:border-slate-400";
            
            if(size === 2) {
                btn2.className = `flex-1 py-2 rounded-lg font-bold text-sm border-2 transition-all ${activeClass}`;
                btn3.className = `flex-1 py-2 rounded-lg font-bold text-sm border-2 transition-all ${inactiveClass}`;
            } else {
                btn2.className = `flex-1 py-2 rounded-lg font-bold text-sm border-2 transition-all ${inactiveClass}`;
                btn3.className = `flex-1 py-2 rounded-lg font-bold text-sm border-2 transition-all ${activeClass}`;
            }
        }

        // --- Rendering ---
        function renderGameGrid() {
            padGrid.innerHTML = '';
            
            if (gridSize === 2) {
                padGrid.className = "grid grid-cols-2 gap-4 sm:gap-6 aspect-square mb-8";
            } else {
                padGrid.className = "grid grid-cols-3 gap-3 sm:gap-4 aspect-square mb-8";
            }

            currentColors.forEach(colorKey => {
                const config = ALL_COLORS[colorKey];
                const data = customData[colorKey] || { text: "", img: "" };
                
                const btn = document.createElement('button');
                btn.id = colorKey;
                btn.className = `${config.cls} border-[3px] rounded-[1.5rem] sm:rounded-[2rem] neo-shadow transition-transform hover:-translate-y-1 active:active-pad h-full w-full overflow-hidden relative group`;
                
                // Add click handler specifically
                btn.onclick = () => handlePadClick(colorKey);

                const contentDiv = document.createElement('div');
                contentDiv.className = "pad-content";
                
                // Image
                const img = document.createElement('img');
                img.id = `img-display-${colorKey}`;
                img.className = "pad-img mb-2 transition-transform group-hover:scale-105 " + (data.img ? "" : "hidden");
                img.src = data.img || "";

                // Text
                const span = document.createElement('span');
                span.id = `text-display-${colorKey}`;
                span.className = "text-white font-display font-bold text-md sm:text-xl drop-shadow-md tracking-wide uppercase";
                span.innerText = data.text;

                contentDiv.appendChild(img);
                contentDiv.appendChild(span);
                btn.appendChild(contentDiv);
                padGrid.appendChild(btn);
            });
        }

        // --- Game Logic ---
        startBtn.addEventListener('click', () => {
            renderGameGrid(); // Build grid based on selected mode
            modal.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resetGame();
            nextSequence();
        });

        function handlePadClick(colorKey) {
            if (!started || !canClick) return;
            
            userClickedPattern.push(colorKey);
            animatePress(colorKey);
            playTone(ALL_COLORS[colorKey].freq);
            
            checkAnswer(userClickedPattern.length - 1);
        }

        function checkAnswer(currentLevel) {
            if (gameSequence[currentLevel] === userClickedPattern[currentLevel]) {
                if (userClickedPattern.length === gameSequence.length) {
                    canClick = false;
                    playLevelUpSound();
                    statusBar.innerHTML = `<span class="text-[#00E676] flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Great Job!</span>`;
                    lucide.createIcons();
                    setTimeout(nextSequence, 1200);
                }
            } else {
                handleGameOver();
            }
        }

        function nextSequence() {
            userClickedPattern = [];
            level++;
            levelTitle.innerText = "Level " + level;
            scoreDisplay.innerText = level - 1;
            setTurn(false);

            const randomIdx = Math.floor(Math.random() * currentColors.length);
            const randomColor = currentColors[randomIdx];
            gameSequence.push(randomColor);

            const speed = Math.max(300, 800 - (level * 40)); 

            setTimeout(() => {
                let i = 0;
                const interval = setInterval(() => {
                    flashButton(gameSequence[i]);
                    playTone(ALL_COLORS[gameSequence[i]].freq);
                    i++;
                    if (i >= gameSequence.length) {
                        clearInterval(interval);
                        setTimeout(() => setTurn(true), speed);
                    }
                }, speed);
            }, 800);
        }

        // --- Setup Logic ---
        function openSetup() {
            // Render setup inputs based on CURRENT mode
            renderSetupInputs();
            document.getElementById('setup-mode-text').innerText = gridSize === 2 ? "2x2 Grid (Easy)" : "3x3 Grid (Hard)";
            setupModal.classList.remove('hidden');
        }

        function hideSetup() { setupModal.classList.add('hidden'); }

        function renderSetupInputs() {
            setupGrid.innerHTML = '';
            // Only show inputs for the colors used in the current difficulty
            currentColors.forEach(key => {
                const config = ALL_COLORS[key];
                const data = customData[key] || { text: "", img: "" };
                
                // Card HTML
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border-2 border-slate-900 bg-slate-50 relative group`;
                // Add slight tint based on color
                div.style.backgroundColor = config.hex + '15'; // 15 = low opacity hex

                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-4 h-4 rounded-full border border-slate-900" style="background-color: ${config.hex}"></div>
                        <span class="font-bold text-slate-900">${config.label} Block</span>
                    </div>
                    <input type="text" id="input-text-${key}" value="${data.text}" placeholder="e.g. Word" class="w-full border-2 border-slate-200 focus:border-slate-900 rounded-xl p-2 mb-3 text-sm font-bold text-slate-700 focus:outline-none transition-colors bg-white">
                    <div class="file-input-wrapper w-full">
                        <button class="w-full bg-white border-2 border-slate-200 hover:border-slate-900 text-slate-600 rounded-xl py-2 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="image-plus" class="w-4 h-4"></i> <span id="label-${key}">${data.img ? 'Image Set' : 'Upload Image'}</span>
                        </button>
                        <input type="file" id="input-img-${key}" accept="image/*" onchange="updateFileLabel('${key}')">
                    </div>
                `;
                setupGrid.appendChild(div);
            });
            lucide.createIcons();
        }

        function updateFileLabel(key) {
            const input = document.getElementById(`input-img-${key}`);
            const label = document.getElementById(`label-${key}`);
            if(input.files && input.files[0]) {
                label.innerText = "New Image Selected";
                label.parentElement.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
            }
        }

        async function saveSetup() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Saving...`;
            lucide.createIcons();

            const promises = currentColors.map(key => {
                return new Promise((resolve) => {
                    const textVal = document.getElementById(`input-text-${key}`).value;
                    const fileInput = document.getElementById(`input-img-${key}`);
                    
                    if(!customData[key]) customData[key] = {};
                    customData[key].text = textVal;

                    if (fileInput.files && fileInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            customData[key].img = e.target.result;
                            resolve();
                        }
                        reader.readAsDataURL(fileInput.files[0]);
                    } else {
                        resolve();
                    }
                });
            });

            await Promise.all(promises);
            await saveSettings(customData);
            
            // If inside game, refresh grid immediately
            if(!gameContainer.classList.contains('hidden')) {
                renderGameGrid(); 
            }

            setTimeout(() => {
                saveBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE CHANGES`;
                lucide.createIcons();
                hideSetup();
            }, 500);
        }

        function clearData() {
            if(confirm("Reset customizations for these blocks?")) {
                currentColors.forEach(k => {
                    customData[k] = { text: "", img: "" };
                });
                clearSettings();
                renderSetupInputs();
            }
        }

        // --- Visual Helpers ---
        function setTurn(isPlayer) {
            canClick = isPlayer;
            if (isPlayer) {
                turnIndicator.className = "w-3 h-3 rounded-full bg-[#00E676] border-2 border-slate-900 animate-pulse";
                turnText.innerText = "YOUR TURN";
                turnText.className = "text-[#00E676] font-bold uppercase tracking-wider text-xs";
                statusText.innerText = "Repeat the pattern!";
                statusBar.className = "flex-1 flex items-center justify-center gap-2 text-center text-slate-900 font-bold py-3 bg-white rounded-xl border-2 border-slate-900 min-h-[56px] neo-shadow-sm";
                gameContainer.classList.add('cursor-pointer');
            } else {
                turnIndicator.className = "w-3 h-3 rounded-full bg-red-500 border-2 border-slate-900";
                turnText.innerText = "WAIT";
                turnText.className = "text-red-500 font-bold uppercase tracking-wider text-xs";
                statusText.innerText = "Watch carefully...";
                statusBar.className = "flex-1 flex items-center justify-center gap-2 text-center text-slate-500 font-bold py-3 bg-slate-100 rounded-xl border-2 border-slate-900 min-h-[56px]";
                gameContainer.classList.remove('cursor-pointer');
            }
        }

        function flashButton(id) {
            const btn = document.getElementById(id);
            if(btn) {
                btn.classList.add("flash");
                setTimeout(() => btn.classList.remove("flash"), 250);
            }
        }

        function animatePress(id) {
            const btn = document.getElementById(id);
            if(btn) {
                btn.classList.add("active-pad");
                setTimeout(() => btn.classList.remove("active-pad"), 100);
            }
        }

        function handleGameOver() {
            canClick = false;
            playGameOverSound();
            gameContainer.classList.add("shake");
            document.body.style.backgroundColor = "#fee2e2";
            
            setTimeout(() => {
                gameContainer.classList.remove("shake");
                gameContainer.classList.add('hidden'); // Hide game
                document.body.style.backgroundColor = "var(--chalk)";
                
                document.getElementById('modal-title').innerText = "Game Over!";
                document.getElementById('modal-desc').innerHTML = `Mode: <b>${gridSize}x${gridSize}</b><br>Score: <b>${level - 1}</b>`;
                startBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-6 h-6"></i> PLAY AGAIN`;
                lucide.createIcons();
                modal.classList.remove('hidden');
            }, 1000);
            started = false;
        }

        function resetGame() {
            level = 0;
            gameSequence = [];
            started = true;
            userClickedPattern = [];
        }
    </script>
</body>
</html>