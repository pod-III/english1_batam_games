<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Arcade Editor | English 1 Batam</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        heading: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                        }
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-lg': '8px 8px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pop-spring': 'popSpring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        popSpring: {
                            '0%': { transform: 'scale(0.5) translateY(40px)', opacity: '0' },
                            '100%': { transform: 'scale(1) translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Graph Paper Background */
        body {
            background-color: #f8fafc;
            background-image: linear-gradient(#cbd5e1 1px, transparent 1px), linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* --- NEO BRUTALISM INPUT SYSTEM --- */
        
        /* The Container for Input + Icon */
        .neo-field {
            display: flex;
            align-items: stretch;
            background: white;
            border: 4px solid #1e293b;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 2px 0px 0px rgba(30,41,59,0.1);
        }

        /* Interaction State */
        .neo-field:focus-within {
            transform: translate(-4px, -4px);
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }

        /* The Icon Box (Left Side) */
        .neo-icon-box {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3.5rem;
            flex-shrink: 0;
            border-right: 4px solid #1e293b;
            font-weight: 800;
        }

        /* The Input Itself (Right Side) */
        .neo-input-text {
            width: 100%;
            padding: 12px 16px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            color: #1e293b;
            border: none;
            outline: none;
            background: transparent;
        }
        .neo-input-text::placeholder {
            color: #94a3b8;
            font-weight: 600;
        }

        /* Variants */
        .variant-blue .neo-icon-box { background-color: #dbeafe; color: #2563eb; } /* Blue-100/600 */
        .variant-orange .neo-icon-box { background-color: #ffedd5; color: #ea580c; } /* Orange-100/600 */
        .variant-gray .neo-icon-box { background-color: #f1f5f9; color: #64748b; } /* Slate-100/500 */

        /* Buttons */
        .neo-btn {
            @apply transition-all active:translate-x-[2px] active:translate-y-[2px] active:shadow-none hover:-translate-x-[2px] hover:-translate-y-[2px] hover:shadow-hard;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .set-item.active {
            @apply bg-brand-blue text-white translate-x-1 translate-y-1 shadow-none border-brand-dark ring-2 ring-offset-2 ring-brand-blue;
        }
        
        /* Question Card Transition */
        .question-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .question-card.collapsed .card-body {
            display: none;
        }
        .question-card.collapsed {
            @apply py-4 bg-white hover:bg-slate-50;
        }
    </style>
</head>
<body class="min-h-screen text-brand-dark flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white border-b-4 border-brand-dark sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-3 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3 md:gap-4">
                <div class="w-10 h-10 md:w-12 md:h-12 bg-brand-pink border-4 border-brand-dark rounded-xl flex items-center justify-center shadow-hard hover:animate-spin">
                    <i data-lucide="edit-3" class="text-white w-6 h-6 md:w-7 md:h-7"></i>
                </div>
                <div>
                    <h1 class="font-heading font-bold text-2xl md:text-3xl tracking-tight leading-none">Arcade Editor</h1>
                    <p class="text-[10px] md:text-xs font-black text-slate-500 uppercase tracking-widest mt-0.5">English 1 Batam</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3">
                <input type="file" id="import-json" accept=".json" class="hidden">
                <button onclick="document.getElementById('import-json').click()" class="neo-btn bg-white border-4 border-brand-dark px-3 md:px-5 py-2 rounded-xl font-heading font-bold text-sm md:text-base shadow-hard-sm flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i> <span class="hidden sm:inline">Import</span>
                </button>
                <button onclick="exportJSON()" class="neo-btn bg-brand-green border-4 border-brand-dark px-3 md:px-5 py-2 rounded-xl font-heading font-bold text-sm md:text-base shadow-hard-sm flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden sm:inline">Export</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-4 md:p-6 flex flex-col lg:flex-row gap-8 items-start">
        
        <!-- Sidebar: List of Sets -->
        <aside class="w-full lg:w-80 flex flex-col gap-6 shrink-0 lg:sticky lg:top-28 h-auto lg:h-[calc(100vh-8rem)]">
            <div class="bg-white border-4 border-brand-dark rounded-2xl p-4 md:p-6 shadow-hard flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-heading text-xl md:text-2xl font-bold">Quiz Sets</h2>
                    <button onclick="addNewSet()" class="w-10 h-10 bg-brand-orange text-white border-4 border-brand-dark rounded-xl shadow-hard-sm hover:rotate-90 transition-transform flex items-center justify-center neo-btn">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="set-list" class="flex flex-col gap-3 overflow-y-auto pr-2 custom-scroll flex-grow">
                    <!-- Set items injected here -->
                    <div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-300 rounded-xl">
                        <p class="font-bold text-sm">No sets created.</p>
                        <p class="text-xs">Click + to start.</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t-2 border-slate-100">
                    <div class="flex items-start gap-2 text-xs text-slate-400 font-bold">
                        <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                        <p>Select a set to edit details and manage questions.</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Editor Section -->
        <section class="flex-grow w-full flex flex-col gap-8 min-h-[500px]">
            
            <!-- EMPTY STATE -->
            <div id="editor-placeholder" class="bg-white border-4 border-brand-dark border-dashed rounded-[2rem] p-10 md:p-20 text-center shadow-hard opacity-100 flex flex-col items-center justify-center h-full animate-fade-in">
                <div class="w-32 h-32 bg-slate-50 rounded-full border-4 border-brand-dark flex items-center justify-center mb-6 animate-float relative">
                    <div class="absolute inset-0 bg-brand-blue/10 rounded-full animate-pulse"></div>
                    <i data-lucide="ghost" class="w-16 h-16 text-slate-400"></i>
                </div>
                <h3 class="font-heading text-3xl md:text-4xl font-bold text-brand-dark mb-2">No Set Selected</h3>
                <p class="text-slate-500 font-bold text-lg max-w-md">Select a quiz set from the sidebar or create a new one to start building your arcade.</p>
            </div>

            <!-- EDITOR CONTENT -->
            <div id="editor-content" class="hidden space-y-8 animate-slide-up">
                
                <!-- 1. Metadata Panel -->
                <div class="relative group">
                    <div class="absolute -top-3 -left-2 bg-brand-blue text-white border-2 border-brand-dark px-3 py-1 rounded-lg font-heading font-bold text-sm z-10 shadow-hard-sm group-hover:-translate-y-1 transition-transform">
                        GLOBAL SETTINGS
                    </div>
                    <div class="bg-white border-4 border-brand-dark rounded-2xl p-6 md:p-8 pt-10 shadow-hard transition-shadow hover:shadow-hard-lg space-y-6">
                        
                        <!-- Top Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            
                            <!-- ID -->
                            <div class="flex flex-col gap-1.5">
                                <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Set ID</label>
                                <div class="neo-field variant-blue">
                                    <div class="neo-icon-box"><i data-lucide="hash" class="w-5 h-5"></i></div>
                                    <input type="text" id="edit-id" class="neo-input-text" oninput="updateActiveSet('id', this.value)">
                                </div>
                            </div>

                            <!-- Title -->
                            <div class="flex flex-col gap-1.5 md:col-span-2">
                                <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Title</label>
                                <div class="neo-field variant-blue">
                                    <div class="neo-icon-box"><i data-lucide="type" class="w-5 h-5"></i></div>
                                    <input type="text" id="edit-title" class="neo-input-text text-lg" oninput="updateActiveSet('title', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Middle Row -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <!-- Topic -->
                            <div class="flex flex-col gap-1.5">
                                <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Topic Tag</label>
                                <div class="neo-field variant-blue">
                                    <div class="neo-icon-box"><i data-lucide="tag" class="w-5 h-5"></i></div>
                                    <input type="text" id="edit-topic" class="neo-input-text" oninput="updateActiveSet('topic', this.value)">
                                </div>
                            </div>

                            <!-- Icon -->
                            <div class="flex flex-col gap-1.5">
                                <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Lucide Icon</label>
                                <div class="neo-field variant-blue">
                                    <div class="neo-icon-box"><i data-lucide="image" class="w-5 h-5"></i></div>
                                    <input type="text" id="edit-icon" class="neo-input-text" oninput="updateActiveSet('icon', this.value)">
                                </div>
                            </div>

                            <!-- Color -->
                            <div class="flex flex-col gap-1.5">
                                <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Theme Color</label>
                                <div class="neo-field variant-blue relative">
                                    <div class="neo-icon-box"><i data-lucide="palette" class="w-5 h-5"></i></div>
                                    <select id="edit-color" class="neo-input-text cursor-pointer appearance-none bg-transparent" onchange="updateActiveSet('color', this.value)">
                                        <option value="bg-brand-pink">Hot Pink</option>
                                        <option value="bg-brand-orange">Energetic Orange</option>
                                        <option value="bg-brand-blue">Logic Blue</option>
                                        <option value="bg-brand-green">Success Green</option>
                                        <option value="bg-brand-dark">Midnight Dark</option>
                                    </select>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-brand-dark">
                                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Row: Description -->
                        <div class="flex flex-col gap-1.5">
                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Description</label>
                            <div class="neo-field variant-blue">
                                <div class="neo-icon-box"><i data-lucide="align-left" class="w-5 h-5"></i></div>
                                <textarea id="edit-desc" class="neo-input-text h-24 resize-none" oninput="updateActiveSet('desc', this.value)"></textarea>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 2. Questions Panel -->
                <div class="relative group">
                    <div class="absolute -top-3 -left-2 bg-brand-orange text-white border-2 border-brand-dark px-3 py-1 rounded-lg font-heading font-bold text-sm z-10 shadow-hard-sm group-hover:-translate-y-1 transition-transform">
                        CONTENT MANAGER
                    </div>
                    <div class="bg-white border-4 border-brand-dark rounded-2xl p-6 md:p-8 pt-12 shadow-hard transition-shadow hover:shadow-hard-lg space-y-8">
                        <div class="flex flex-wrap justify-between items-center border-b-4 border-brand-chalk pb-4 gap-4">
                            <h3 class="font-heading text-2xl font-bold flex items-center gap-2">
                                Questions <span id="q-count" class="bg-brand-dark text-white text-sm px-2 py-0.5 rounded-md">0</span>
                            </h3>
                            <button onclick="addQuestion()" class="neo-btn bg-brand-orange text-white border-4 border-brand-dark px-5 py-2.5 rounded-xl font-heading font-bold shadow-hard flex items-center gap-2 text-sm md:text-base">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Question
                            </button>
                        </div>

                        <div id="questions-list" class="space-y-6">
                            <!-- Question blocks injected here -->
                        </div>

                        <!-- Bottom Add Button -->
                        <div onclick="addQuestion()" class="border-4 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 hover:border-brand-orange hover:text-brand-orange transition-all group">
                            <i data-lucide="plus" class="w-8 h-8 mx-auto mb-2 text-slate-400 group-hover:text-brand-orange transition-colors"></i>
                            <p class="font-bold text-slate-400 group-hover:text-brand-orange">Add Another Question</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- CUSTOM MODAL POPUP -->
    <div id="custom-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 animate-fade-in">
        <div class="absolute inset-0 bg-brand-dark/50 backdrop-blur-md transition-opacity" onclick="closeModal(false)"></div>
        <div class="relative bg-white border-4 border-brand-dark rounded-[2rem] shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] w-full max-w-md p-8 md:p-10 animate-pop-spring transform origin-center">
            
            <div class="absolute -top-10 left-1/2 -translate-x-1/2">
                <div id="modal-icon-box" class="w-20 h-20 rounded-2xl border-4 border-brand-dark flex items-center justify-center shadow-hard animate-float bg-brand-blue">
                    <i id="modal-icon" class="text-white w-10 h-10" data-lucide="info"></i>
                </div>
            </div>

            <div class="mt-8 text-center">
                <h3 id="modal-title" class="font-heading text-3xl font-bold text-brand-dark mb-3 tracking-tight"></h3>
                <p id="modal-body" class="font-sans text-base md:text-lg text-slate-600 font-bold mb-8 leading-relaxed"></p>
                
                <div id="modal-footer" class="flex flex-col sm:flex-row gap-3">
                    <!-- Buttons injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let appData = [];
        let activeSetIndex = -1;
        let collapsedQuestions = {}; 

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('import-json').addEventListener('change', handleImport);
        });

        // --- MODAL SYSTEM ---
        let modalResolve = null;

        function showModal({ title, body, icon, type = 'info', confirmText = 'OK', cancelText = null }) {
            const modal = document.getElementById('custom-modal');
            const iconBox = document.getElementById('modal-icon-box');
            const iconEl = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const bodyEl = document.getElementById('modal-body');
            const footer = document.getElementById('modal-footer');

            titleEl.innerText = title;
            bodyEl.innerText = body;
            iconEl.setAttribute('data-lucide', icon || 'info');

            const colors = {
                info: 'bg-brand-blue',
                success: 'bg-brand-green',
                warning: 'bg-brand-pink',
                danger: 'bg-brand-pink',
                question: 'bg-brand-orange'
            };
            
            iconBox.className = `w-20 h-20 rounded-2xl border-4 border-brand-dark flex items-center justify-center shadow-hard animate-float ${colors[type] || colors.info}`;

            footer.innerHTML = '';
            
            if (cancelText) {
                const btnCancel = document.createElement('button');
                btnCancel.className = "neo-btn flex-1 bg-white border-4 border-brand-dark py-3 rounded-xl font-heading font-bold text-lg shadow-hard hover:bg-slate-50";
                btnCancel.innerText = cancelText;
                btnCancel.onclick = () => closeModal(false);
                footer.appendChild(btnCancel);
            }

            const btnConfirm = document.createElement('button');
            const confirmColor = type === 'danger' ? 'bg-brand-pink' : (type === 'success' ? 'bg-brand-green' : 'bg-brand-blue');
            btnConfirm.className = `neo-btn flex-1 ${confirmColor} text-white border-4 border-brand-dark py-3 rounded-xl font-heading font-bold text-lg shadow-hard`;
            btnConfirm.innerText = confirmText;
            btnConfirm.onclick = () => closeModal(true);
            footer.appendChild(btnConfirm);

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            lucide.createIcons();

            return new Promise(resolve => {
                modalResolve = resolve;
            });
        }

        function closeModal(result) {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            if (modalResolve) modalResolve(result);
        }

        // --- CORE FUNCTIONS ---

        function renderSetList() {
            const list = document.getElementById('set-list');
            list.innerHTML = '';
            
            if (appData.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-300 rounded-xl">
                        <i data-lucide="layers" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="font-bold text-sm">No sets created.</p>
                        <p class="text-xs">Click + to start.</p>
                    </div>`;
                return;
            }

            appData.forEach((set, idx) => {
                const item = document.createElement('div');
                const isActive = activeSetIndex === idx;
                
                item.className = `set-item p-4 border-4 rounded-2xl cursor-pointer transition-all flex justify-between items-center group mb-3 relative overflow-hidden ${isActive ? 'active' : 'bg-white border-brand-dark shadow-hard-sm hover:shadow-hard hover:-translate-y-1'}`;
                
                if(isActive) {
                    const indicator = document.createElement('div');
                    indicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-brand-orange";
                    item.appendChild(indicator);
                }

                item.innerHTML += `
                    <div class="flex-grow pl-2 overflow-hidden" onclick="selectSet(${idx})">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-black uppercase tracking-tighter opacity-70 border border-current px-1 rounded">${set.topic || 'No Topic'}</span>
                        </div>
                        <h4 class="font-heading font-bold truncate pr-2 text-lg leading-tight">${set.title || 'Untitled Quiz'}</h4>
                        <p class="text-xs font-bold opacity-60 mt-1">${set.questions.length} Questions</p>
                    </div>
                    <button onclick="event.stopPropagation(); deleteSet(${idx})" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-brand-pink hover:text-white transition-colors z-10 ${isActive ? 'text-white hover:bg-white/20' : 'text-slate-400'}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function selectSet(index) {
            activeSetIndex = index;
            const set = appData[index];
            collapsedQuestions = {}; 
            
            document.getElementById('editor-placeholder').classList.add('hidden');
            document.getElementById('editor-content').classList.remove('hidden');
            
            document.getElementById('edit-id').value = set.id || '';
            document.getElementById('edit-title').value = set.title || '';
            document.getElementById('edit-desc').value = set.desc || '';
            document.getElementById('edit-topic').value = set.topic || '';
            document.getElementById('edit-icon').value = set.icon || 'book';
            document.getElementById('edit-color').value = set.color || 'bg-brand-pink';
            
            renderSetList();
            renderQuestions();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleQuestion(qIdx) {
            collapsedQuestions[qIdx] = !collapsedQuestions[qIdx];
            renderQuestions();
        }

        function renderQuestions() {
            const set = appData[activeSetIndex];
            const container = document.getElementById('questions-list');
            container.innerHTML = '';
            document.getElementById('q-count').innerText = set.questions.length;

            set.questions.forEach((q, qIdx) => {
                const isCollapsed = collapsedQuestions[qIdx];
                const block = document.createElement('div');
                block.className = `question-card group border-4 border-brand-dark rounded-2xl shadow-hard relative transition-all ${isCollapsed ? 'collapsed' : 'bg-brand-chalk p-6 md:p-8'}`;
                block.id = `q-card-${qIdx}`;

                const headerHtml = `
                    <div class="flex justify-between items-center ${isCollapsed ? 'px-6' : 'mb-6'}">
                        <div class="flex items-center gap-3 cursor-pointer select-none" onclick="toggleQuestion(${qIdx})">
                            <span class="w-8 h-8 md:w-10 md:h-10 bg-brand-dark text-white rounded-xl flex items-center justify-center font-heading font-bold border-2 border-brand-dark shadow-hard-sm text-sm md:text-base">
                                ${qIdx + 1}
                            </span>
                            <div class="flex flex-col">
                                <h4 class="font-heading font-bold text-lg md:text-xl text-brand-dark ${isCollapsed ? '' : 'text-brand-orange'}">
                                    ${q.q ? (q.q.length > 30 ? q.q.substring(0,30)+'...' : q.q) : 'New Question'}
                                </h4>
                                ${isCollapsed ? '<span class="text-xs text-slate-400 font-bold">Click to expand</span>' : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="toggleQuestion(${qIdx})" class="p-2 hover:bg-slate-200 rounded-lg transition-colors text-slate-500">
                                <i data-lucide="${isCollapsed ? 'chevron-down' : 'minus'}" class="w-5 h-5"></i>
                            </button>
                            <button onclick="deleteQuestion(${qIdx})" class="p-2 hover:bg-brand-pink hover:text-white rounded-lg transition-colors text-slate-400">
                                <i data-lucide="trash" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;

                const bodyHtml = `
                    <div class="card-body space-y-6 animate-fade-in">
                        <div class="flex flex-col gap-1.5">
                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Question Text</label>
                            <div class="neo-field variant-orange">
                                <div class="neo-icon-box"><i data-lucide="help-circle" class="w-5 h-5"></i></div>
                                <input type="text" class="neo-input-text" value="${escapeHtml(q.q)}" oninput="updateQuestion(${qIdx}, 'q', this.value)" placeholder="Enter question...">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${q.opts.map((opt, oIdx) => `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-3">
                                        <div class="relative cursor-pointer group/radio" title="Mark as Correct Answer">
                                            <input type="radio" name="correct-${qIdx}" class="peer hidden" ${q.a === oIdx ? 'checked' : ''} onchange="updateQuestion(${qIdx}, 'a', ${oIdx})">
                                            <div class="w-10 h-10 bg-white border-4 border-brand-dark rounded-xl peer-checked:bg-brand-green flex items-center justify-center transition-all shadow-sm group-hover/radio:scale-105">
                                                <i data-lucide="check" class="w-6 h-6 text-white opacity-0 peer-checked:opacity-100 font-bold stroke-[4]"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow">
                                            <div class="neo-field variant-gray">
                                                <div class="neo-icon-box" style="width: 2.5rem;">${String.fromCharCode(65+oIdx)}</div>
                                                <input type="text" class="neo-input-text py-2" placeholder="Option ${oIdx+1}" value="${escapeHtml(opt)}" oninput="updateOption(${qIdx}, ${oIdx}, this.value)">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="flex flex-col gap-1.5 pt-2">
                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2 ml-1">
                                <i data-lucide="lightbulb" class="w-3 h-3 text-brand-orange"></i> Explanation
                            </label>
                            <div class="neo-field variant-orange">
                                <div class="neo-icon-box"><i data-lucide="message-square" class="w-5 h-5"></i></div>
                                <textarea class="neo-input-text h-20 resize-none" placeholder="Explain why this answer is correct..." oninput="updateQuestion(${qIdx}, 'exp', this.value)">${escapeHtml(q.exp || '')}</textarea>
                            </div>
                        </div>
                    </div>
                `;

                block.innerHTML = headerHtml + bodyHtml;
                container.appendChild(block);
            });
            lucide.createIcons();
        }

        // --- LOGIC HELPERS ---

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateActiveSet(key, value) {
            if (activeSetIndex === -1) return;
            appData[activeSetIndex][key] = value;
            if (key === 'title' || key === 'topic') renderSetList();
        }

        function updateQuestion(qIdx, key, value) {
            appData[activeSetIndex].questions[qIdx][key] = value;
            if(key === 'q') {
                 const headerTitle = document.querySelector(`#q-card-${qIdx} h4`);
                 if(headerTitle) headerTitle.innerText = value.length > 30 ? value.substring(0,30)+'...' : (value || 'New Question');
            }
        }

        function updateOption(qIdx, oIdx, value) {
            appData[activeSetIndex].questions[qIdx].opts[oIdx] = value;
        }

        function addNewSet() {
            const newSet = {
                id: "set_" + Date.now(),
                title: "New Quiz Set",
                desc: "",
                topic: "General",
                icon: "sparkles",
                color: "bg-brand-pink",
                questions: []
            };
            appData.push(newSet);
            selectSet(appData.length - 1);
        }

        async function deleteSet(index) {
            const confirm = await showModal({
                title: "Delete Set?",
                body: `Are you sure you want to remove "${appData[index].title || 'Untitled'}"?`,
                icon: 'trash-2',
                type: 'danger',
                confirmText: 'Yes, Delete',
                cancelText: 'Cancel'
            });

            if (!confirm) return;

            appData.splice(index, 1);
            if (activeSetIndex === index) {
                activeSetIndex = -1;
                document.getElementById('editor-content').classList.add('hidden');
                document.getElementById('editor-placeholder').classList.remove('hidden');
            } else if (activeSetIndex > index) {
                activeSetIndex--;
            }
            renderSetList();
        }

        function addQuestion() {
            Object.keys(collapsedQuestions).forEach(k => collapsedQuestions[k] = true);
            const newIdx = appData[activeSetIndex].questions.length;
            appData[activeSetIndex].questions.push({
                q: "",
                opts: ["", "", "", ""],
                a: 0,
                exp: ""
            });
            collapsedQuestions[newIdx] = false; 
            renderQuestions();
            setTimeout(() => {
                const newCard = document.getElementById(`q-card-${newIdx}`);
                if(newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const input = newCard.querySelector('input');
                    if(input) input.focus();
                }
            }, 100);
        }

        async function deleteQuestion(qIdx) {
            const confirm = await showModal({
                title: "Delete Question?",
                body: "This cannot be undone.",
                icon: 'file-x',
                type: 'danger',
                confirmText: 'Delete',
                cancelText: 'Cancel'
            });
            if (confirm) {
                appData[activeSetIndex].questions.splice(qIdx, 1);
                collapsedQuestions = {};
                renderQuestions();
            }
        }

        // --- IMPORT / EXPORT ---

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (Array.isArray(imported)) {
                        appData = imported;
                        renderSetList();
                        showModal({
                            title: "Import Successful",
                            body: `${appData.length} quiz sets loaded successfully.`,
                            icon: 'check-circle',
                            type: 'success'
                        });
                    } else {
                        throw new Error();
                    }
                } catch (err) {
                    showModal({
                        title: "Import Failed",
                        body: "Invalid JSON format. Please upload a valid questions.json file.",
                        icon: 'alert-triangle',
                        type: 'warning'
                    });
                }
            };
            reader.readAsText(file);
        }

        async function exportJSON() {
            if (appData.length === 0) {
                showModal({
                    title: "Empty List",
                    body: "Create some quiz sets before exporting.",
                    icon: 'file-warning',
                    type: 'warning'
                });
                return;
            }
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "questions.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showModal({
                title: "Export Ready",
                body: "Your file has been downloaded.",
                icon: 'download-cloud',
                type: 'success'
            });
        }
    </script>
</body>
</html>