<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Notes - English 1</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('english1_theme');
            const html = document.documentElement;
            if (savedTheme === 'light') {
                html.classList.remove('dark');
            } else {
                html.classList.add('dark');
            }
        })();
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#0f172a',
                        panel: '#1e293b',
                        surface: '#334155',
                        'light-bg': '#f8fafc',
                    },
                    fontFamily: {
                        heading: ['Bebas Neue', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                        mono: ['monospace'],
                    },
                    boxShadow: {
                        'paper': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'glow': '0 0 15px rgba(255, 107, 149, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; overflow: hidden; }
        .editor-input { background: transparent; border: none; outline: none; width: 100%; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 99px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #334155; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background-color: #475569; }

        /* QUILL EDITOR CUSTOMIZATION */
        .ql-toolbar.ql-snow {
            border: none !important;
            /* Frosted Glass Effect for Toolbar */
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05) !important;
            padding: 12px 20px !important;
            z-index: 20;
            position: sticky;
            top: 0;
        }
        .dark .ql-toolbar.ql-snow {
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(255,255,255,0.05) !important;
        }

        .ql-container.ql-snow {
            border: none !important;
            font-family: 'Nunito', sans-serif !important;
            font-size: 1.05rem !important;
        }
        
        /* The "Paper" Container inside Editor */
        .ql-editor {
            padding: 3rem 4rem !important; /* Wider margins like paper */
            color: #334155;
            line-height: 1.8;
            min-height: 100%;
        }
        .dark .ql-editor { color: #cbd5e1; }
        
        /* BRANDED HEADINGS INSIDE EDITOR */
        .ql-editor h1 {
            color: #FF6B95; /* Pink */
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .ql-editor h2 {
            color: #FF8C42; /* Orange */
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid rgba(255, 140, 66, 0.2);
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }
        .ql-editor h3 {
            color: #2979FF; /* Blue */
            font-weight: 700;
            margin-top: 1rem;
        }

        /* Placeholder */
        .ql-editor.ql-blank::before { color: #94a3b8 !important; font-style: italic; left: 4rem !important; }
        .dark .ql-editor.ql-blank::before { color: #475569 !important; }

        /* Toolbar Icons */
        .ql-snow .ql-stroke { stroke: #64748b !important; }
        .dark .ql-snow .ql-stroke { stroke: #94a3b8 !important; }
        .ql-snow .ql-fill { fill: #64748b !important; }
        .dark .ql-snow .ql-fill { fill: #94a3b8 !important; }
        
        /* Active/Hover states */
        .ql-snow .ql-button:hover .ql-stroke, .ql-snow .ql-button.ql-active .ql-stroke { stroke: #2979FF !important; }
        .ql-snow .ql-button:hover .ql-fill, .ql-snow .ql-button.ql-active .ql-fill { fill: #2979FF !important; }

        /* Gradient Text Helper */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #FF6B95, #FF8C42);
        }
        
        /* Loading Overlay */
        #loading-overlay.active { display: flex; }
    </style>
</head>
<body class="h-screen flex flex-col bg-light-bg dark:bg-dark text-slate-800 dark:text-slate-200 transition-colors duration-300 selection:bg-pink/30 selection:text-pink-900 dark:selection:text-white">

    <header class="h-16 flex items-center justify-between px-6 shrink-0 z-30 relative bg-white/80 dark:bg-panel/80 backdrop-blur-md border-b border-slate-200 dark:border-white/5 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-pink to-orange flex items-center justify-center shadow-lg shadow-orange/20">
                <i data-lucide="notebook-pen" class="w-5 h-5 text-white"></i>
            </div>
            <div class="flex flex-col">
                <h1 class="text-xl font-heading tracking-wider leading-none text-slate-800 dark:text-white">Lesson Notes</h1>
                <p class="text-[10px] text-blue font-bold tracking-[0.2em] uppercase leading-none mt-1">English 1 Batam</p>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-4">
            <div id="save-status" class="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-green/10 border border-green/20 opacity-0 transition-opacity duration-500">
                <div class="w-1.5 h-1.5 rounded-full bg-green animate-pulse"></div>
                <span class="text-[10px] font-bold text-green uppercase tracking-wider">Saved</span>
            </div>

            <div class="h-6 w-px bg-slate-200 dark:bg-white/10 mx-1 hidden md:block"></div>
            
            <button onclick="NoteApp.UI.toggleTheme()" class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-white/5 transition-colors tooltip" title="Switch Theme">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
            </button>

            <button onclick="NoteApp.UI.toggleSidebar()" class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-white/5 transition-colors flex items-center gap-2">
                 <i data-lucide="panel-left" class="w-5 h-5"></i>
            </button>

            <button onclick="NoteApp.UI.toggleTOC()" class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-white/5 transition-colors flex items-center gap-2">
                 <i data-lucide="list" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside id="sidebar" class="w-full md:w-80 bg-white dark:bg-panel border-r border-slate-200 dark:border-white/5 flex flex-col absolute md:relative z-20 h-full transform transition-all duration-300 md:translate-x-0 -translate-x-full shadow-2xl md:shadow-none overflow-hidden">
            
            <div class="p-5 border-b border-slate-200 dark:border-white/5 flex flex-col gap-4 items-center shrink-0">
                <button onclick="NoteApp.Logic.createNote()" class="group w-full bg-gradient-to-r from-pink to-orange hover:from-pink/90 hover:to-orange/90 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-orange/20 transition-all active:scale-[0.98] ring-offset-2 ring-pink/50 focus:ring-2">
                    <i data-lucide="plus" class="w-5 h-5 transition-transform duration-300 group-hover:rotate-90"></i> 
                    <span class="whitespace-nowrap">New Note</span>
                </button>
                <div class="relative group w-full">
                    <i data-lucide="search" class="absolute left-3.5 top-3 w-4 h-4 text-slate-400 dark:text-gray-500 group-focus-within:text-blue transition-colors"></i>
                    <input type="text" id="search-input" onkeyup="NoteApp.UI.renderList()" 
                        class="w-full bg-slate-100 dark:bg-dark/50 border border-slate-200 dark:border-white/5 rounded-xl py-2.5 pl-10 pr-4 text-sm text-slate-700 dark:text-gray-300 placeholder-slate-400 dark:placeholder-gray-600 focus:border-blue/50 focus:ring-1 focus:ring-blue/50 focus:outline-none transition-all"
                        placeholder="Search lessons...">
                </div>
            </div>

            <div id="note-list" class="flex-1 overflow-y-auto p-3 space-y-2 w-full">
                </div>
            
            <div class="p-3 text-center border-t border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-panel/50 shrink-0">
                <p class="text-[10px] text-slate-400 dark:text-gray-500 font-mono flex items-center justify-center gap-2">
                    <i data-lucide="hard-drive" class="w-3 h-3"></i> English 1 Storage
                </p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-100 dark:bg-dark relative w-full z-10 transition-all duration-300">
            
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 dark:text-gray-600 hidden animate-fade-in">
                <div class="w-24 h-24 rounded-full bg-white dark:bg-panel border border-slate-200 dark:border-white/5 flex items-center justify-center mb-6 shadow-xl shadow-slate-200/50 dark:shadow-none">
                    <i data-lucide="pen-tool" class="w-10 h-10 text-slate-300 dark:text-gray-700"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-500 dark:text-gray-500 mb-2">No Lesson Selected</h2>
                <p class="text-sm text-slate-400 dark:text-gray-600">Select a note from the sidebar or create a new one.</p>
            </div>

            <div id="editor-container" class="flex-1 flex flex-col h-full hidden animate-fade-in">
                
                <div class="px-8 pt-8 pb-4 flex gap-6 items-start shrink-0 max-w-5xl mx-auto w-full">
                    <input type="text" id="note-title" placeholder="Untitled Lesson" 
                        class="editor-input text-5xl font-heading tracking-wide text-slate-800 dark:text-white placeholder-slate-300 dark:placeholder-gray-700 caret-pink focus:text-gradient transition-all duration-300"
                        oninput="NoteApp.Logic.updateActiveNote()">
                    
                    <div class="flex gap-1 shrink-0 bg-white dark:bg-panel border border-slate-200 dark:border-white/5 rounded-lg p-1 shadow-sm mt-2">
                        <button onclick="NoteApp.Logic.exportPDF()" class="p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:text-blue hover:bg-blue/10 transition-colors" title="Export PDF">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                        <button onclick="NoteApp.Logic.deleteActiveNote()" class="p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors tooltip" title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="px-9 pb-2 flex items-center gap-4 text-[11px] text-slate-400 dark:text-gray-500 font-bold uppercase tracking-widest max-w-5xl mx-auto w-full">
                    <span id="note-date">--</span>
                    <span class="text-slate-300 dark:text-gray-700">•</span>
                    <span id="word-count" class="text-blue">0 words</span>
                </div>

                <div class="flex-1 overflow-hidden relative w-full flex justify-center pb-8">
                    <div class="w-full max-w-4xl h-full flex flex-col bg-white dark:bg-panel shadow-paper dark:shadow-none rounded-t-xl mx-4 overflow-hidden border-x border-t border-slate-200 dark:border-white/5">
                        <div id="editor" class="h-full"></div>
                    </div>
                </div>
            </div>
        </main>

        <aside id="toc-sidebar" class="w-0 opacity-0 bg-white dark:bg-panel border-l border-slate-200 dark:border-white/5 flex flex-col relative z-20 h-full shadow-none overflow-hidden transition-all duration-300">
            <div class="p-4 border-b border-slate-200 dark:border-white/5 bg-slate-50/50 dark:bg-panel/50">
                <h3 class="font-bold text-slate-400 dark:text-gray-400 uppercase tracking-widest text-xs flex items-center gap-2">
                    <i data-lucide="list-tree" class="w-3 h-3"></i> Outline
                </h3>
            </div>
            <div id="toc-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                </div>
        </aside>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[60] hidden bg-white/80 dark:bg-black/80 backdrop-blur-md flex flex-col items-center justify-center animate-fade-in text-slate-800 dark:text-white">
        <div class="relative w-16 h-16 mb-4">
            <div class="absolute inset-0 border-4 border-slate-200 dark:border-surface rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="font-heading text-xl tracking-wider">Generating PDF...</p>
    </div>

    <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/20 dark:bg-black/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white dark:bg-panel border border-slate-200 dark:border-white/10 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-6">
            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-500/10 flex items-center justify-center mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Delete Lesson Note?</h3>
            <p class="text-slate-500 dark:text-gray-400 text-sm mb-6 leading-relaxed">This action will permanently remove this note. This cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button onclick="NoteApp.UI.hideModal()" class="px-5 py-2.5 rounded-xl text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:bg-white/5 font-bold text-xs uppercase tracking-wide">Cancel</button>
                <button onclick="NoteApp.Logic.confirmDelete()" class="px-5 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/20 font-bold text-xs uppercase tracking-wide">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const NoteApp = (function() {
            let quill; 

            // --- STATE ---
            const State = { 
                notes: [], 
                activeNoteId: null,
                isTOCOpen: false,
                isSidebarOpen: true
            };

            const escapeHtml = (unsafe) => {
                if (!unsafe) return "";
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            };

            // OPTIMIZED: Regex based strip HTML for performance
            const stripHtml = (html) => {
                if (!html) return "";
                return html.replace(/<[^>]*>?/gm, '');
            }

            // --- PERSISTENCE ---
            const Storage = {
                KEY: 'english1_lesson_notes_v2',
                THEME_KEY: 'english1_theme',
                save: () => {
                    localStorage.setItem(Storage.KEY, JSON.stringify(State.notes));
                    UI.showSaveStatus();
                },
                load: () => {
                    const data = localStorage.getItem(Storage.KEY);
                    if (data) {
                        State.notes = JSON.parse(data);
                        State.notes.sort((a, b) => b.updatedAt - a.updatedAt);
                    }
                },
                saveTheme: (theme) => localStorage.setItem(Storage.THEME_KEY, theme),
                loadTheme: () => localStorage.getItem(Storage.THEME_KEY) || 'dark'
            };

            // --- LOGIC (WITH DEBOUNCE FIX) ---
            const Logic = {
                saveTimeout: null,

                createNote: () => {
                    const newNote = { id: Date.now(), title: '', content: '', updatedAt: Date.now() };
                    State.notes.unshift(newNote);
                    State.activeNoteId = newNote.id;
                    Storage.save();
                    UI.renderList();
                    UI.loadEditor(newNote.id);
                    if(window.innerWidth < 768) UI.toggleSidebar();
                    document.getElementById('note-title').focus();
                },

                updateActiveNote: () => {
                    if (!State.activeNoteId) return;
                    const note = State.notes.find(n => n.id === State.activeNoteId);
                    if (!note) return;

                    const titleInput = document.getElementById('note-title');
                    const htmlContent = quill.root.innerHTML;
                    const isEmpty = quill.getText().trim().length === 0;

                    note.title = titleInput.value;
                    note.content = isEmpty ? '' : htmlContent;
                    note.updatedAt = Date.now();

                    // Update meta immediately
                    UI.updateMeta(note);
                    
                    // DEBOUNCE LOGIC
                    clearTimeout(Logic.saveTimeout);
                    const saveStatus = document.getElementById('save-status');
                    if(saveStatus) saveStatus.style.opacity = '0';

                    Logic.saveTimeout = setTimeout(() => {
                        State.notes.sort((a, b) => b.updatedAt - a.updatedAt);
                        Storage.save();
                        UI.renderList(false);
                        UI.renderTOC(); 
                    }, 1000);
                },

                setActiveNote: (id) => {
                    if(Logic.saveTimeout) {
                        clearTimeout(Logic.saveTimeout);
                        Storage.save();
                    }
                    State.activeNoteId = id;
                    UI.renderList();
                    UI.loadEditor(id);
                    if(window.innerWidth < 768) UI.toggleSidebar();
                },

                deleteActiveNote: () => UI.showModal(),

                confirmDelete: () => {
                    State.notes = State.notes.filter(n => n.id !== State.activeNoteId);
                    State.activeNoteId = null;
                    Storage.save();
                    UI.renderList();
                    UI.resetEditor();
                    UI.hideModal();
                },

                exportPDF: () => {
                    if (!State.activeNoteId) return;
                    const note = State.notes.find(n => n.id === State.activeNoteId);
                    if (!note) return;

                    document.getElementById('loading-overlay').classList.add('active');

                    const tempContainer = document.createElement('div');
                    Object.assign(tempContainer.style, {
                        padding: '40px', color: '#000000', background: '#ffffff', fontFamily: 'Helvetica, sans-serif'
                    });
                    
                    tempContainer.innerHTML = `
                        <div style="border-bottom: 2px solid #2979FF; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="font-size: 28px; font-weight: bold; margin: 0; color: #1e293b;">${escapeHtml(note.title) || 'Untitled Lesson'}</h1>
                            <div style="margin-top: 10px; color: #64748b; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                                ${UI.formatDate(note.updatedAt)} • English 1 Batam
                            </div>
                        </div>
                        <div class="pdf-content" style="font-size: 14px; line-height: 1.8; color: #334155;">
                            ${note.content}
                        </div>
                    `;

                    const style = document.createElement('style');
                    style.innerHTML = `
                        .pdf-content h1 { font-size: 22px; font-weight: bold; margin-top: 25px; margin-bottom: 10px; color: #FF6B95; }
                        .pdf-content h2 { font-size: 18px; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: #FF8C42; border-bottom: 1px solid #FF8C42; padding-bottom: 5px; }
                        .pdf-content h3 { font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #2979FF; }
                        .pdf-content ul { margin-left: 20px; margin-bottom: 15px; }
                        .pdf-content ol { margin-left: 20px; margin-bottom: 15px; }
                        .pdf-content li { margin-bottom: 5px; }
                        .pdf-content p { margin-bottom: 15px; }
                    `;
                    tempContainer.appendChild(style);

                    const opt = {
                        margin: 0.5,
                        filename: `${note.title || 'lesson-plan'}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };

                    setTimeout(() => {
                        html2pdf().set(opt).from(tempContainer).save().then(() => {
                            document.getElementById('loading-overlay').classList.remove('active');
                        }).catch(err => {
                            console.error(err);
                            alert("Export failed.");
                            document.getElementById('loading-overlay').classList.remove('active');
                        });
                    }, 500);
                }
            };

            // --- UI ---
            const UI = {
                init: () => {
                    const savedTheme = Storage.loadTheme();
                    if (savedTheme !== 'dark' && savedTheme !== 'light') Storage.saveTheme('dark');
                    
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        placeholder: 'Start typing your lesson plan here...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'color': [] }, { 'background': [] }],
                                ['clean']
                            ]
                        }
                    });

                    quill.on('text-change', () => Logic.updateActiveNote());
                    document.getElementById('note-title').addEventListener('input', () => Logic.updateActiveNote());
                    
                    Storage.load();
                    UI.renderList();
                    
                    if (State.notes.length > 0) {
                        UI.loadEditor(State.notes[0].id);
                    } else {
                        UI.resetEditor();
                    }
                    lucide.createIcons();
                },

                toggleTheme: () => {
                    const html = document.documentElement;
                    if (html.classList.contains('dark')) {
                        html.classList.remove('dark');
                        Storage.saveTheme('light');
                    } else {
                        html.classList.add('dark');
                        Storage.saveTheme('dark');
                    }
                    setTimeout(() => lucide.createIcons(), 50); 
                },

                toggleSidebar: () => {
                    State.isSidebarOpen = !State.isSidebarOpen;
                    const sidebar = document.getElementById('sidebar');

                    if (State.isSidebarOpen) {
                        sidebar.classList.remove('-translate-x-full');
                        sidebar.classList.add('md:w-80');
                        sidebar.classList.remove('md:w-0', 'md:opacity-0', 'md:border-none');
                    } else {
                        sidebar.classList.add('-translate-x-full');
                        sidebar.classList.remove('md:w-80');
                        sidebar.classList.add('md:w-0', 'md:opacity-0', 'md:border-none');
                    }
                },

                toggleTOC: () => {
                    State.isTOCOpen = !State.isTOCOpen;
                    const tocSidebar = document.getElementById('toc-sidebar');
                    if (State.isTOCOpen) {
                        tocSidebar.classList.add('w-64', 'opacity-100');
                        tocSidebar.classList.remove('w-0', 'opacity-0');
                    } else {
                        tocSidebar.classList.remove('w-64', 'opacity-100');
                        tocSidebar.classList.add('w-0', 'opacity-0');
                    }
                },

                renderTOC: () => {
                    const tocList = document.getElementById('toc-list');
                    if (!tocList) return;
                    const headers = quill.root.querySelectorAll('h1, h2, h3');
                    
                    if (headers.length === 0) {
                        tocList.innerHTML = `<p class="text-xs text-slate-500 dark:text-gray-600 p-2 italic">No headings found.</p>`;
                        return;
                    }

                    tocList.innerHTML = Array.from(headers).map((header, index) => {
                        const text = header.textContent || "Untitled Section";
                        const tag = header.tagName.toLowerCase(); 
                        return `
                        <div onclick="NoteApp.UI.scrollToHeading(${index})" 
                             class="toc-link cursor-pointer py-1.5 pr-2 truncate text-sm hover:text-blue transition-colors select-none text-slate-600 dark:text-slate-400 ${tag === 'h1' ? 'font-bold' : 'pl-3'}">
                            ${escapeHtml(text)}
                        </div>
                        `;
                    }).join('');
                },

                scrollToHeading: (index) => {
                    const headers = quill.root.querySelectorAll('h1, h2, h3');
                    if (headers[index]) headers[index].scrollIntoView({ behavior: 'smooth', block: 'start' });
                },

                showModal: () => document.getElementById('delete-modal').classList.remove('hidden'),
                hideModal: () => document.getElementById('delete-modal').classList.add('hidden'),

                showSaveStatus: () => {
                    const el = document.getElementById('save-status');
                    el.classList.remove('opacity-0');
                    setTimeout(() => el.classList.add('opacity-0'), 2000);
                },

                formatDate: (timestamp) => {
                    return new Date(timestamp).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                },

                renderList: (fullRender = true) => {
                    const listEl = document.getElementById('note-list');
                    const search = document.getElementById('search-input').value.toLowerCase();
                    
                    const filtered = State.notes.filter(n => {
                        const plainText = stripHtml(n.content).toLowerCase();
                        return (n.title || '').toLowerCase().includes(search) || plainText.includes(search);
                    });

                    listEl.innerHTML = filtered.map((note, index) => {
                        const isActive = note.id === State.activeNoteId;
                        const title = escapeHtml(note.title) || 'Untitled Note';
                        const plainText = stripHtml(note.content);
                        const preview = plainText.slice(0, 50) + (plainText.length > 50 ? '...' : '') || 'No additional text';
                        
                        // NEW ACTIVE STATE DESIGN
                        const activeClasses = isActive 
                            ? 'bg-slate-100 dark:bg-white/5 border-l-4 border-l-transparent' // base active
                            : 'hover:bg-slate-50 dark:hover:bg-white/5 border-l-4 border-l-transparent';

                        const borderStyle = isActive 
                            ? 'background-image: linear-gradient(to bottom, #FF6B95, #FF8C42); background-size: 4px 100%; background-repeat: no-repeat;' 
                            : '';

                        return `
                        <div onclick="NoteApp.Logic.setActiveNote(${note.id})" style="${borderStyle}"
                             class="note-item p-4 rounded-r-xl cursor-pointer relative overflow-hidden group transition-all duration-200 ${activeClasses}">
                            <div class="relative z-10 pl-2">
                                <h3 class="font-bold text-sm text-slate-700 dark:text-gray-200 truncate group-hover:text-black dark:group-hover:text-white transition-colors ${!note.title ? 'italic text-slate-400 dark:text-gray-500' : ''}">${title}</h3>
                                <p class="text-[11px] text-slate-500 dark:text-gray-500 mt-1 truncate group-hover:text-slate-600 dark:group-hover:text-gray-400 transition-colors">${preview}</p>
                                <div class="mt-2 text-[10px] text-slate-400 dark:text-gray-600 font-mono flex items-center gap-1">
                                    <span>${UI.formatDate(note.updatedAt).split(',')[0]}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                },

                loadEditor: (id) => {
                    const note = State.notes.find(n => n.id === id);
                    if (!note) return;

                    State.activeNoteId = id;
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('editor-container').classList.remove('hidden');

                    document.getElementById('note-title').value = note.title;
                    quill.root.innerHTML = note.content;
                    
                    UI.updateMeta(note);
                    UI.renderTOC(); 
                    lucide.createIcons(); 
                },

                updateMeta: (note) => {
                    const text = quill.getText();
                    const wordCount = text.trim().length === 0 ? 0 : text.trim().split(/\s+/).length;
                    document.getElementById('word-count').innerText = `${wordCount} WORDS`;
                    document.getElementById('note-date').innerText = `EDITED ${UI.formatDate(note.updatedAt)}`;
                },

                resetEditor: () => {
                    document.getElementById('editor-container').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    State.activeNoteId = null;
                }
            };

            return { Logic, UI };
        })();

        window.onload = NoteApp.UI.init;
    </script>
</body>
</html>