<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Manager | English 1 Batam</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                            yellow: '#FACC15',
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .neo-border { border: 3px solid #1e293b; }
        .neo-shadow { box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1); }
        .neo-shadow-sm { box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1); }
        
        .neo-btn { transition: all 0.1s ease; }
        .neo-btn:hover { transform: translate(-1px, -1px); box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1); }
        .neo-btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1); }

        input, select, textarea {
            border: 2px solid #1e293b !important;
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
            transition: all 0.1s ease;
        }
        input:focus, select:focus { outline: none; box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1); transform: translate(-1px, -1px); }

        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; border: 2px solid #f8fafc; }
        
        .icon-option:hover { background-color: #2979FF; color: white; border-color: #1e293b; }
    </style>
</head>
<body class="text-brand-dark font-body min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-brand-pink border-b-4 border-brand-dark p-4 sticky top-0 z-40 neo-shadow text-brand-dark">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-4 justify-between items-center">
            <div class="flex items-center gap-3 bg-brand-chalk border-2 border-brand-dark rounded-xl px-4 py-2 neo-shadow-sm text-brand-dark">
                <i data-lucide="gamepad-2" class="w-6 h-6 text-brand-pink"></i>
                <h1 class="font-heading text-xl font-bold tracking-tight">Project Game Manager</h1>
            </div>
            <div class="flex gap-2">
                 <button onclick="copyToClipboard()" class="bg-brand-blue text-white border-2 border-brand-dark rounded-xl px-4 py-2 font-heading font-bold neo-shadow-sm neo-btn flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy JSON
                </button>
                 <button onclick="exportJson()" class="bg-brand-green border-2 border-brand-dark rounded-xl px-4 py-2 font-heading font-bold neo-shadow-sm neo-btn flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> Export
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar: Navigation & Metadata -->
            <div class="lg:col-span-4 space-y-6">
                
                <button onclick="resetForm()" class="w-full bg-brand-yellow border-4 border-brand-dark rounded-2xl py-4 font-heading text-xl font-bold neo-shadow neo-btn flex justify-center items-center gap-3">
                    <i data-lucide="plus-square" class="w-6 h-6"></i> Add New Entry
                </button>

                <!-- Project Meta Card -->
                <div class="bg-brand-blue border-4 border-brand-dark rounded-2xl p-5 neo-shadow text-white space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-heading font-bold">Project Info</h3>
                        <i data-lucide="info" class="w-4 h-4 opacity-50"></i>
                    </div>
                    <div class="space-y-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase opacity-70">Version</label>
                            <input type="text" id="metaVersion" oninput="updateProjectMeta()" class="w-full px-3 py-1.5 rounded-lg text-brand-dark font-bold text-sm shadow-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase opacity-70">Last Updated</label>
                            <input type="text" id="metaUpdated" oninput="updateProjectMeta()" class="w-full px-3 py-1.5 rounded-lg text-brand-dark font-bold text-sm shadow-none">
                        </div>
                    </div>
                    <div class="pt-2">
                        <input type="file" id="importFile" accept=".json" class="hidden">
                        <button onclick="document.getElementById('importFile').click()" class="w-full bg-brand-chalk text-brand-dark border-2 border-brand-dark rounded-xl py-3 font-heading font-bold neo-shadow-sm neo-btn flex justify-center items-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i> Import JSON
                        </button>
                    </div>
                </div>

                <!-- Games List -->
                <div class="bg-white border-4 border-brand-dark rounded-2xl neo-shadow flex flex-col h-[500px]">
                    <div class="p-4 border-b-4 border-brand-dark bg-brand-chalk font-heading font-bold flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span>Project Games</span>
                            <span id="gameCount" class="bg-brand-dark text-white px-2 py-1 rounded-lg text-[10px]">0</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="sortGamesAZ()" title="Sort Alphabetically" class="p-1.5 hover:bg-brand-blue hover:text-white rounded-lg border-2 border-transparent hover:border-brand-dark transition-all">
                                <i data-lucide="sort-asc" class="w-4 h-4"></i>
                            </button>
                            <button onclick="autoApplyColors()" title="Auto-Color Theme" class="p-1.5 hover:bg-brand-orange hover:text-white rounded-lg border-2 border-transparent hover:border-brand-dark transition-all">
                                <i data-lucide="palette" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div id="gameList" class="flex-grow overflow-y-auto p-2 space-y-2 custom-scrollbar">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>

            <!-- Main Panel: Game Form -->
            <div class="lg:col-span-8">
                <div class="bg-white border-4 border-brand-dark rounded-2xl neo-shadow overflow-hidden">
                    <div id="formHeader" class="bg-brand-orange border-b-4 border-brand-dark p-6 flex justify-between items-center transition-colors">
                        <h2 id="formTitle" class="font-heading text-2xl font-bold flex items-center gap-3">
                            <i data-lucide="edit-3"></i> Adding New Entry
                        </h2>
                        <div id="idBadge" class="text-[10px] font-black bg-brand-dark/10 px-2 py-1 rounded border border-brand-dark/20 uppercase tracking-tighter">New Entry</div>
                    </div>

                    <form id="gameForm" class="p-6 md:p-8 space-y-8" onsubmit="saveEntry(event)">
                        
                        <!-- 1. Basics -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Unique ID (Slug)</label>
                                <input type="text" id="id" required placeholder="word-rush" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Display Title</label>
                                <input type="text" id="title" required placeholder="Word Rush" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Category</label>
                                <select id="category" class="w-full px-4 py-3 rounded-xl font-bold bg-white appearance-none">
                                    <option value="game">Game</option>
                                    <option value="tool">Tool / Resource</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Theme Color</label>
                                <select id="color" class="w-full px-4 py-3 rounded-xl font-bold bg-white appearance-none">
                                    <option value="text-pink">Pink</option>
                                    <option value="text-orange">Orange</option>
                                    <option value="text-green">Green</option>
                                    <option value="text-blue">Blue</option>
                                </select>
                            </div>
                        </div>

                        <!-- 2. Display & Path -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Path / URL</label>
                                <input type="text" id="path" required placeholder="./word-rush/index.html" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <!-- Updated Icon Picker Field -->
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Display Icon</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="openIconPicker()" class="flex-1 bg-white border-2 border-brand-dark rounded-xl px-4 py-3 font-bold flex items-center justify-between group neo-shadow-sm hover:-translate-y-0.5 active:translate-y-0.5 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div id="currentIconDisplay" class="p-1 bg-brand-chalk border-2 border-brand-dark rounded-lg flex items-center justify-center">
                                                <i data-lucide="zap" class="w-5 h-5"></i>
                                            </div>
                                            <span id="currentIconName">zap</span>
                                        </div>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                    </button>
                                    <input type="hidden" id="icon" value="zap">
                                </div>
                            </div>
                        </div>

                        <!-- 3. Description & Details -->
                        <div class="space-y-4 border-t-2 border-brand-dark/10 pt-6">
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Short Description</label>
                                <input type="text" id="description" required placeholder="Vocabulary Race" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-1">
                                    <label class="text-xs font-black uppercase text-slate-400">Difficulty</label>
                                    <select id="difficulty" class="w-full px-4 py-3 rounded-xl font-bold bg-white appearance-none">
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-black uppercase text-slate-400">Age Range</label>
                                    <input type="text" id="ageRange" required placeholder="8+ or Teacher" class="w-full px-4 py-3 rounded-xl font-bold">
                                </div>
                            </div>
                            <div class="flex gap-8">
                                <label class="flex items-center gap-3 font-bold cursor-pointer">
                                    <input type="checkbox" id="featured" class="w-5 h-5 border-2 border-brand-dark rounded"> Featured
                                </label>
                                <label class="flex items-center gap-3 font-bold cursor-pointer">
                                    <input type="checkbox" id="active" checked class="w-5 h-5 border-2 border-brand-dark rounded"> Active
                                </label>
                            </div>
                        </div>

                        <!-- 4. Tags -->
                        <div class="space-y-4 pt-4">
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-black uppercase text-slate-400">Tags</label>
                                <button type="button" onclick="addTagRow()" class="text-[10px] font-bold bg-brand-dark text-white px-2 py-1 rounded">+ Add Tag</button>
                            </div>
                            <div id="tagsContainer" class="flex flex-wrap gap-2">
                                <!-- Tags here -->
                            </div>
                        </div>

                        <!-- 5. Guide -->
                        <div class="space-y-4 pt-4 bg-brand-chalk border-2 border-brand-dark rounded-2xl p-6">
                            <h4 class="font-heading font-bold text-lg">Instruction Guide</h4>
                            <div class="space-y-1">
                                <label class="text-xs font-black uppercase text-slate-400">Summary Intro</label>
                                <input type="text" id="guideShort" required placeholder="Quick one-liner..." class="w-full px-4 py-2 rounded-xl font-bold bg-white shadow-none">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label class="text-xs font-black uppercase text-slate-400">Steps</label>
                                    <button type="button" onclick="addStepRow()" class="text-[10px] font-bold bg-brand-blue text-white px-2 py-1 rounded">+ Add Step</button>
                                </div>
                                <div id="stepsContainer" class="space-y-2">
                                    <!-- Steps here -->
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-brand-green border-4 border-brand-dark rounded-2xl py-5 font-heading text-2xl font-bold neo-shadow neo-btn mt-8">
                            Save Entry to Directory
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- ICON PICKER MODAL -->
    <div id="iconPickerModal" class="fixed inset-0 bg-brand-dark/80 backdrop-blur-sm z-[100] hidden flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-2xl border-4 border-brand-dark rounded-2xl neo-shadow overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-brand-blue p-4 border-b-4 border-brand-dark flex justify-between items-center shrink-0">
                <h3 class="font-heading text-xl font-bold text-white">Choose an Icon</h3>
                <button onclick="closeIconPicker()" class="bg-white border-2 border-brand-dark rounded-lg p-1.5 hover:bg-brand-pink transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-4 border-b-2 border-brand-dark bg-brand-chalk shrink-0">
                <div class="relative">
                    <input type="text" id="iconSearchInput" placeholder="Search icons (e.g. book, game, music)..." oninput="filterIcons()" class="w-full px-4 py-2 pl-10 rounded-xl font-bold">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"></i>
                </div>
            </div>

            <div id="iconGrid" class="flex-grow overflow-y-auto p-4 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3 custom-scrollbar">
                <!-- Icons injected here -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 transform translate-y-32 opacity-0 transition-all duration-300">
        <div class="bg-brand-dark text-white neo-border rounded-2xl px-8 py-4 neo-shadow font-bold flex items-center gap-4">
            <i data-lucide="check-circle" class="text-brand-green"></i>
            <span id="toastMsg">Saved!</span>
        </div>
    </div>

    <script>
        let projectData = {
            version: "1.0.0",
            lastUpdated: new Date().toISOString().split('T')[0],
            metadata: { totalGames: 0, categories: ["tool", "game"], tags: [] },
            games: []
        };
        let editingId = null;

        const iconList = [
            "zap", "layers", "book-a", "briefcase", "utensils", "clock", "flame", "headphones", "eye", "flag", 
            "pen-tool", "graduation-cap", "brain-circuit", "check-circle", "book-open", "scale", "search", 
            "library", "trash-2", "edit-3", "file-up", "plus-square", "download", "gamepad-2", "mic", "music",
            "pencil", "brush", "palette", "languages", "globe", "map", "users", "smile", "heart", "star",
            "trophy", "medal", "award", "rocket", "plane", "compass", "puzzle", "dice-5", "swatch-book", "shapes",
            "type", "case-sensitive", "spell-check", "binary", "terminal", "code", "cpu", "database", "cloud",
            "wifi", "bluetooth", "battery-charging", "camera", "video", "layout", "monitor", "smartphone", "mouse-pointer", "copy", "clipboard-check"
        ];

        // Init
        lucide.createIcons();

        // --- ICON PICKER ---
        function openIconPicker() {
            document.getElementById('iconPickerModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            renderIconGrid(iconList);
            document.getElementById('iconSearchInput').value = '';
        }

        function closeIconPicker() {
            document.getElementById('iconPickerModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function renderIconGrid(list) {
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = list.map(icon => `
                <button type="button" onclick="selectIcon('${icon}')" class="icon-option flex flex-col items-center gap-1 p-2 border-2 border-brand-dark/10 rounded-xl transition-all">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                    <span class="text-[8px] font-black uppercase truncate w-full text-center">${icon}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function filterIcons() {
            const term = document.getElementById('iconSearchInput').value.toLowerCase();
            const filtered = iconList.filter(i => i.includes(term));
            renderIconGrid(filtered);
        }

        function selectIcon(icon) {
            document.getElementById('icon').value = icon;
            document.getElementById('currentIconName').innerText = icon;
            document.getElementById('currentIconDisplay').innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
            lucide.createIcons();
            closeIconPicker();
        }

        // --- MAINTENANCE TOOLS ---
        function sortGamesAZ() {
            if (projectData.games.length === 0) return;
            projectData.games.sort((a, b) => a.title.localeCompare(b.title));
            updateGameList();
            showToast("Sorted Alphabetically!");
        }

        function autoApplyColors() {
            if (projectData.games.length === 0) return;
            const colors = ["text-pink", "text-orange", "text-green", "text-blue"];
            projectData.games.forEach((game, index) => {
                game.color = colors[index % colors.length];
            });
            updateGameList();
            showToast("Theme Colors Applied!");
        }

        // --- CLIPBOARD ---
        function copyToClipboard() {
            if (projectData.games.length === 0) return showToast("Nothing to copy!", true);
            
            // Sync final meta
            projectData.metadata.totalGames = projectData.games.length;
            projectData.lastUpdated = new Date().toISOString().split('T')[0];
            
            const text = JSON.stringify(projectData, null, 2);
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Ensure textArea is not visible but part of DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.select();
            textArea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("JSON Copied to Clipboard!");
                } else {
                    throw new Error("Copy command failed");
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                showToast("Failed to copy JSON!", true);
            }
            
            document.body.removeChild(textArea);
        }

        // --- FILE HANDLING ---
        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let raw = event.target.result.trim();
                    if (raw.charCodeAt(0) === 0xFEFF) raw = raw.slice(1);
                    
                    const startObj = raw.indexOf('{');
                    if (startObj !== -1) {
                        let last = raw.lastIndexOf('}');
                        while (last > startObj) {
                            try {
                                const data = JSON.parse(raw.substring(startObj, last + 1));
                                if (data.games && Array.isArray(data.games)) {
                                    projectData = data;
                                    syncMetaToInputs();
                                    updateGameList();
                                    showToast("Data Imported Successfully!");
                                    return;
                                }
                                throw new Error();
                            } catch(e) { last = raw.lastIndexOf('}', last - 1); }
                        }
                    }
                    throw new Error("Invalid structure.");
                } catch (err) { console.error(err); showToast("Invalid JSON File!", true); }
                e.target.value = '';
            };
            reader.readAsText(file);
        });

        function exportJson() {
            if (projectData.games.length === 0) return showToast("Nothing to export!", true);
            projectData.metadata.totalGames = projectData.games.length;
            projectData.lastUpdated = new Date().toISOString().split('T')[0];
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "games.json"; a.click();
            URL.revokeObjectURL(url);
            showToast("File Exported!");
        }

        // --- UI SYNC ---
        function syncMetaToInputs() {
            document.getElementById('metaVersion').value = projectData.version || "1.0.0";
            document.getElementById('metaUpdated').value = projectData.lastUpdated || "";
        }

        function updateProjectMeta() {
            projectData.version = document.getElementById('metaVersion').value;
            projectData.lastUpdated = document.getElementById('metaUpdated').value;
        }

        function updateGameList() {
            const list = document.getElementById('gameList');
            document.getElementById('gameCount').innerText = projectData.games.length;
            if (projectData.games.length === 0) {
                list.innerHTML = `<p class="text-center py-10 opacity-30 font-bold italic text-sm">No entries found.</p>`;
                return;
            }
            list.innerHTML = projectData.games.map(g => `
                <div class="bg-white border-2 border-brand-dark rounded-xl p-3 neo-shadow-sm flex justify-between items-center group ${editingId === g.id ? 'ring-4 ring-brand-blue/20 border-brand-blue' : ''}">
                    <div class="truncate">
                        <p class="font-bold text-sm truncate">${g.title}</p>
                        <p class="text-[10px] font-black uppercase ${g.color || 'text-brand-dark'}">${g.category} â€¢ ${g.id}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editEntry('${g.id}')" class="p-2 border-2 border-brand-dark rounded-lg hover:bg-brand-blue hover:text-white transition-all">
                            <i data-lucide="edit-3" class="w-3 h-3"></i>
                        </button>
                        <button onclick="deleteEntry('${g.id}')" class="p-2 border-2 border-brand-dark rounded-lg hover:bg-brand-pink hover:text-white transition-all">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- FORM LOGIC ---
        function addTagRow(val = '') {
            const container = document.getElementById('tagsContainer');
            const div = document.createElement('div');
            div.className = "flex items-center gap-1 bg-white border-2 border-brand-dark rounded-lg px-2 py-1";
            div.innerHTML = `
                <input type="text" value="${val}" class="text-[10px] font-bold border-none shadow-none p-0 w-16 focus:ring-0 tag-val">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:scale-110">&times;</button>
            `;
            container.appendChild(div);
        }

        function addStepRow(val = '') {
            const container = document.getElementById('stepsContainer');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center group";
            div.innerHTML = `
                <span class="text-[10px] font-black bg-brand-dark text-white w-5 h-5 rounded flex items-center justify-center">${container.children.length + 1}</span>
                <input type="text" value="${val}" class="flex-grow px-3 py-1.5 rounded-lg text-sm font-bold bg-white step-val">
                <button type="button" onclick="this.parentElement.remove(); reorderSteps();" class="text-red-500 opacity-0 group-hover:opacity-100 transition-all">&times;</button>
            `;
            container.appendChild(div);
        }

        function reorderSteps() {
            const steps = document.querySelectorAll('#stepsContainer span');
            steps.forEach((s, i) => s.innerText = i + 1);
        }

        function saveEntry(e) {
            e.preventDefault();
            const tags = Array.from(document.querySelectorAll('.tag-val')).map(i => i.value).filter(v => v);
            const steps = Array.from(document.querySelectorAll('.step-val')).map(i => i.value).filter(v => v);
            const data = {
                id: document.getElementById('id').value,
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                path: document.getElementById('path').value,
                icon: document.getElementById('icon').value,
                color: document.getElementById('color').value,
                description: document.getElementById('description').value,
                tags: tags,
                difficulty: document.getElementById('difficulty').value,
                ageRange: document.getElementById('ageRange').value,
                featured: document.getElementById('featured').checked,
                active: document.getElementById('active').checked,
                guide: { short: document.getElementById('guideShort').value, steps: steps }
            };
            if (editingId) {
                const idx = projectData.games.findIndex(g => g.id === editingId);
                projectData.games[idx] = data;
                showToast("Entry Updated!");
            } else {
                if (projectData.games.some(g => g.id === data.id)) return showToast("ID already exists!", true);
                projectData.games.push(data);
                showToast("Entry Added!");
            }
            const allTags = new Set(projectData.metadata.tags);
            tags.forEach(t => allTags.add(t));
            projectData.metadata.tags = Array.from(allTags);
            resetForm(); updateGameList();
        }

        function editEntry(id) {
            const g = projectData.games.find(x => x.id === id);
            if (!g) return;
            editingId = id;
            document.getElementById('formTitle').innerHTML = `<i data-lucide="edit"></i> Editing Entry`;
            document.getElementById('formHeader').classList.replace('bg-brand-orange', 'bg-brand-blue');
            document.getElementById('idBadge').innerText = "ID: " + id;
            document.getElementById('id').value = g.id;
            document.getElementById('title').value = g.title;
            document.getElementById('category').value = g.category;
            document.getElementById('path').value = g.path;
            
            // Set Icon
            selectIcon(g.icon || 'zap');

            document.getElementById('color').value = g.color;
            document.getElementById('description').value = g.description;
            document.getElementById('difficulty').value = g.difficulty;
            document.getElementById('ageRange').value = g.ageRange;
            document.getElementById('featured').checked = g.featured;
            document.getElementById('active').checked = g.active;
            document.getElementById('guideShort').value = g.guide?.short || "";
            document.getElementById('tagsContainer').innerHTML = '';
            g.tags?.forEach(t => addTagRow(t));
            document.getElementById('stepsContainer').innerHTML = '';
            g.guide?.steps?.forEach(s => addStepRow(s));
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateGameList();
        }

        function deleteEntry(id) {
            if (!confirm("Delete permanently?")) return;
            projectData.games = projectData.games.filter(g => g.id !== id);
            if (editingId === id) resetForm();
            updateGameList();
            showToast("Entry Deleted.", true);
        }

        function resetForm() {
            editingId = null;
            document.getElementById('gameForm').reset();
            document.getElementById('tagsContainer').innerHTML = '';
            document.getElementById('stepsContainer').innerHTML = '';
            document.getElementById('formTitle').innerHTML = `<i data-lucide="plus-square"></i> Adding New Entry`;
            document.getElementById('formHeader').classList.replace('bg-brand-blue', 'bg-brand-orange');
            document.getElementById('idBadge').innerText = "New Entry";
            selectIcon('zap');
            addTagRow('vocabulary');
            addStepRow();
            lucide.createIcons();
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            const inner = t.querySelector('div');
            inner.classList.toggle('border-brand-dark', !isError);
            inner.classList.toggle('border-red-500', isError);
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        window.onload = () => { syncMetaToInputs(); resetForm(); updateGameList(); };
    </script>
</body>
</html>