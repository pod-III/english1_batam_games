<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Observation Form</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        dark: '#1e293b',
                        chalk: '#f8fafc',
                    },
                    fontFamily: {
                        fredoka: ['Fredoka', 'sans-serif'],
                        nunito: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'hard': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '3px 3px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    borderWidth: {
                        '3': '3px',
                        '4': '4px',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- SCREEN STYLES --- */
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.1) 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .dark body {
            background-color: #0f172a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
        }

        textarea {
            resize: none; 
            overflow: hidden;
            min-height: 50px;
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page { 
                margin: 0.75cm; 
                size: A4 portrait;
            }
            
            body { 
                background: white !important; 
                color: black !important;
                font-family: 'Times New Roman', serif;
                -webkit-print-color-adjust: exact; 
                padding: 0 !important;
                font-size: 11pt;
            }

            .no-print, header .lucide-save, #saveStatus, button { 
                display: none !important; 
            }

            main { 
                border: none !important; 
                box-shadow: none !important; 
                width: 100% !important; 
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            input, textarea {
                border: none !important;
                border-bottom: 1px solid #ccc !important;
                background: transparent !important;
                padding: 0px !important;
                color: black !important;
                font-weight: normal;
            }
            
            textarea:placeholder-shown {
                min-height: 100px !important;
                border: 1px solid #ddd !important;
                background-color: #fafafa !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                border: 2px solid black;
            }
            th {
                background-color: #f0f0f0 !important;
                color: black !important;
                border: 1px solid black !important;
                font-weight: bold;
                padding: 4px !important;
            }
            td {
                border: 1px solid black !important;
                padding: 4px !important;
                vertical-align: top;
            }
            td input, td textarea {
                border: none !important;
            }

            .grid-cols-1.md\:grid-cols-3 {
                display: flex !important;
                flex-direction: row !important;
                gap: 1cm !important;
            }
            .relative.group {
                flex: 1;
                border: 1px solid black !important;
                border-radius: 8px !important;
                box-shadow: none !important;
            }
            .absolute.inset-0 { display: none !important; }
            .relative.bg-white {
                border: none !important;
                padding: 10px !important;
            }
            
            #action_plan {
                border: 1px solid black !important;
                min-height: 150px !important;
                padding: 10px !important;
                border-radius: 8px;
            }

            h1 { font-size: 18pt !important; color: black !important; margin-bottom: 5px !important; }
            h2, h3 { font-size: 14pt !important; color: black !important; margin-bottom: 5px !important; }
            label { font-weight: bold !important; color: #333 !important; }
            
            tr, .relative.group, .action-plan-container {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="text-dark dark:text-white p-4 md:p-10 font-nunito min-h-screen flex flex-col items-center">

    <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleFileImport(this)">

    <div class="fixed top-4 right-4 flex flex-wrap gap-2 z-50 no-print justify-end">
        
        <div class="flex gap-2 bg-white dark:bg-slate-800 p-1 rounded-xl border-3 border-dark shadow-hard mr-2">
            <button onclick="exportData()" title="Export Data" class="bg-e1green text-dark px-3 py-2 rounded-lg border-2 border-dark hover:bg-e1green/80 transition-colors">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
            <button onclick="document.getElementById('importFile').click()" title="Import Data" class="bg-e1orange text-dark px-3 py-2 rounded-lg border-2 border-dark hover:bg-e1orange/80 transition-colors">
                <i data-lucide="upload" class="w-5 h-5"></i>
            </button>
        </div>

        <button onclick="window.print()" class="bg-e1blue text-white px-4 py-2 rounded-xl border-3 border-dark shadow-hard hover:translate-y-1 hover:shadow-hard-sm transition-all font-fredoka font-bold flex items-center gap-2">
            <i data-lucide="printer" class="w-5 h-5"></i> <span class="hidden md:inline">Print</span>
        </button>
        <button id="resetBtn" class="bg-e1pink text-dark px-4 py-2 rounded-xl border-3 border-dark shadow-hard hover:translate-y-1 hover:shadow-hard-sm transition-all font-fredoka font-bold flex items-center gap-2">
            <i data-lucide="trash-2" class="w-5 h-5"></i> <span class="hidden md:inline">Clear</span>
        </button>
        <button onclick="document.documentElement.classList.toggle('dark')" class="bg-dark text-white dark:bg-slate-700 dark:text-white p-2 rounded-xl border-3 border-dark shadow-hard hover:translate-y-1 hover:shadow-hard-sm transition-all">
            <i data-lucide="moon" class="w-6 h-6 dark:hidden"></i>
            <i data-lucide="sun" class="w-6 h-6 hidden dark:block"></i>
        </button>
    </div>

    <main class="w-full max-w-5xl bg-white dark:bg-slate-900 border-4 border-dark rounded-3xl shadow-hard p-6 md:p-10 relative">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-dark pb-6 mb-6 gap-4 print:border-b-2 print:border-black print:pb-2 print:mb-4">
            <div class="w-full">
                <div class="flex justify-between items-center w-full">
                    <div class="bg-e1blue text-white inline-block px-3 py-1 rounded-lg border-2 border-dark font-fredoka text-sm mb-2 shadow-hard-sm print:bg-transparent print:text-black print:border-black print:shadow-none print:px-0 print:py-0 print:mb-0 print:text-xs print:font-bold">
                        ENGLISH ONE BATAM
                    </div>
                    <div class="hidden print:block text-xs text-gray-500">
                        Date Printed: <span id="printDate"></span>
                    </div>
                </div>
                <h1 class="font-fredoka text-4xl font-bold tracking-tight print:text-2xl">Observation Record</h1>
            </div>
            <div class="flex items-center gap-2 opacity-70 no-print">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span id="saveStatus" class="text-sm font-bold font-nunito">Auto-saving...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-8 print:gap-4 print:mb-4">
            <div class="md:col-span-8 space-y-4 print:space-y-2">
                <div class="flex items-center gap-4">
                    <label class="w-24 font-fredoka font-bold text-lg text-right print:text-left print:text-base print:w-20">Teacher:</label>
                    <input type="text" id="teacher_name" class="flex-1 border-b-3 border-dark bg-transparent p-2 font-bold focus:border-e1pink outline-none transition-colors print:p-0 print:text-sm">
                </div>
                <div class="flex items-center gap-4">
                    <label class="w-24 font-fredoka font-bold text-lg text-right print:text-left print:text-base print:w-20">Observer:</label>
                    <input type="text" id="observer_name" class="flex-1 border-b-3 border-dark bg-transparent p-2 font-bold focus:border-e1pink outline-none transition-colors print:p-0 print:text-sm">
                </div>
                <div class="flex items-center gap-4">
                    <label class="w-24 font-fredoka font-bold text-lg text-right print:text-left print:text-base print:w-20">Students:</label>
                    <input type="text" id="students_info" class="flex-1 border-b-3 border-dark bg-transparent p-2 font-bold focus:border-e1pink outline-none transition-colors print:p-0 print:text-sm">
                </div>
            </div>

            <div class="md:col-span-4 bg-e1orange/20 border-3 border-dark rounded-xl p-4 space-y-3 shadow-hard-sm print:bg-transparent print:border-none print:shadow-none print:p-0 print:space-y-2">
                <div class="print:flex print:gap-2 print:items-center">
                    <label class="font-fredoka font-bold text-sm block print:w-20 print:text-base">DATE:</label>
                    <input type="datetime-local" id="date_time" class="w-full bg-white dark:bg-slate-800 border-2 border-dark rounded-lg p-2 mt-1 print:bg-transparent print:border-none print:mt-0 print:p-0 print:w-full">
                </div>
                <div class="print:flex print:gap-2 print:items-center">
                    <label class="font-fredoka font-bold text-sm block print:w-20 print:text-base">CLASS:</label>
                    <input type="text" id="class_name" class="w-full bg-white dark:bg-slate-800 border-2 border-dark rounded-lg p-2 mt-1 print:bg-transparent print:border-none print:mt-0 print:p-0 print:w-full">
                </div>
            </div>
        </div>

        <div class="mb-10 print:mb-6">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <div class="bg-dark w-3 h-3 rounded-full print:hidden"></div>
                    <h3 class="font-fredoka text-xl font-bold print:text-lg">Lesson Flow</h3>
                </div>
            </div>
            
            <div class="border-3 border-dark rounded-xl overflow-hidden shadow-hard-sm print:border-none print:shadow-none print:rounded-none">
                <table class="w-full text-left border-collapse" id="observationTable">
                    <thead class="bg-dark text-white print:bg-gray-200 print:text-black">
                        <tr>
                            <th class="p-3 font-fredoka border-r-2 border-slate-600 w-20 text-center print:border-black print:w-16">Time</th>
                            <th class="p-3 font-fredoka border-r-2 border-slate-600 w-1/4 print:border-black">Stage / Interaction</th>
                            <th class="p-3 font-fredoka border-r-2 border-slate-600 print:border-black">Procedures</th>
                            <th class="p-3 font-fredoka print:border-black">Comments</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white dark:bg-slate-800 divide-y-2 divide-dark print:divide-black print:border-black">
                        </tbody>
                </table>
            </div>
            
            <button onclick="addRow()" class="mt-4 w-full bg-e1green/20 border-dashed border-3 border-dark text-dark dark:text-white font-fredoka font-bold py-3 rounded-xl hover:bg-e1green/40 transition-all flex justify-center items-center gap-2 no-print">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Row
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print:gap-4 print:mb-4">
            <div class="relative group">
                <div class="absolute inset-0 bg-dark rounded-2xl translate-x-2 translate-y-2 group-hover:translate-x-1 group-hover:translate-y-1 transition-transform no-print"></div>
                <div class="relative bg-white dark:bg-slate-800 border-3 border-dark rounded-2xl p-5 h-full flex flex-col min-h-[300px] print:min-h-[150px] print:border-black print:rounded-lg">
                    <div class="flex items-center gap-2 mb-3 text-e1green print:text-black print:mb-1">
                        <i data-lucide="check-circle" class="w-8 h-8 stroke-[3px] print:w-5 print:h-5"></i>
                        <h3 class="font-fredoka text-xl font-bold text-dark dark:text-white print:text-base">Keep Doing</h3>
                    </div>
                    <textarea id="keep_doing" class="w-full flex-1 bg-e1green/10 dark:bg-e1green/5 border-2 border-e1green/30 rounded-xl p-3 outline-none focus:border-e1green transition-colors print:bg-transparent print:border-none print:p-0 print:text-sm" placeholder="Strengths..."></textarea>
                </div>
            </div>

            <div class="relative group">
                <div class="absolute inset-0 bg-dark rounded-2xl translate-x-2 translate-y-2 group-hover:translate-x-1 group-hover:translate-y-1 transition-transform no-print"></div>
                <div class="relative bg-white dark:bg-slate-800 border-3 border-dark rounded-2xl p-5 h-full flex flex-col min-h-[300px] print:min-h-[150px] print:border-black print:rounded-lg">
                    <div class="flex items-center gap-2 mb-3 text-e1blue print:text-black print:mb-1">
                        <i data-lucide="play-circle" class="w-8 h-8 stroke-[3px] print:w-5 print:h-5"></i>
                        <h3 class="font-fredoka text-xl font-bold text-dark dark:text-white print:text-base">Start Doing</h3>
                    </div>
                    <textarea id="start_doing" class="w-full flex-1 bg-e1blue/10 dark:bg-e1blue/5 border-2 border-e1blue/30 rounded-xl p-3 outline-none focus:border-e1blue transition-colors print:bg-transparent print:border-none print:p-0 print:text-sm" placeholder="New strategies..."></textarea>
                </div>
            </div>

             <div class="relative group">
                <div class="absolute inset-0 bg-dark rounded-2xl translate-x-2 translate-y-2 group-hover:translate-x-1 group-hover:translate-y-1 transition-transform no-print"></div>
                <div class="relative bg-white dark:bg-slate-800 border-3 border-dark rounded-2xl p-5 h-full flex flex-col min-h-[300px] print:min-h-[150px] print:border-black print:rounded-lg">
                    <div class="flex items-center gap-2 mb-3 text-e1pink print:text-black print:mb-1">
                        <i data-lucide="x-circle" class="w-8 h-8 stroke-[3px] print:w-5 print:h-5"></i>
                        <h3 class="font-fredoka text-xl font-bold text-dark dark:text-white print:text-base">Avoid Doing</h3>
                    </div>
                    <textarea id="avoid_doing" class="w-full flex-1 bg-e1pink/10 dark:bg-e1pink/5 border-2 border-e1pink/30 rounded-xl p-3 outline-none focus:border-e1pink transition-colors print:bg-transparent print:border-none print:p-0 print:text-sm" placeholder="Habits to break..."></textarea>
                </div>
            </div>
        </div>

        <div class="relative action-plan-container">
             <div class="bg-e1orange text-dark font-fredoka font-bold absolute -top-4 left-6 px-4 py-1 border-3 border-dark rounded-lg shadow-hard-sm z-10 print:static print:bg-transparent print:text-black print:border-none print:shadow-none print:p-0 print:mb-1 print:text-lg">
                ACTION PLAN
             </div>
             <div class="bg-white dark:bg-slate-800 border-3 border-dark rounded-2xl p-6 pt-8 shadow-hard print:border-none print:shadow-none print:p-0">
                <textarea id="action_plan" class="w-full h-32 bg-transparent outline-none text-lg resize-none print:border print:border-black print:rounded-lg print:p-2 print:text-sm" placeholder="Write specific steps for improvement here..."></textarea>
             </div>
        </div>

    </main>

    <div class="mt-8 text-dark/50 dark:text-white/30 font-bold font-fredoka text-sm no-print">
        ENGLISH 1 BATAM â€¢ TEACHER TOOLS
    </div>

    <script>
        // --- 1. SETUP & UTILS ---
        lucide.createIcons();
        const statusSpan = document.getElementById('saveStatus');

        // Set Print Date
        const d = new Date();
        document.getElementById('printDate').innerText = d.toLocaleDateString();

        // Auto-expand textarea function
        const autoExpand = (field) => {
            field.style.height = 'inherit';
            const computed = window.getComputedStyle(field);
            const height = parseInt(computed.getPropertyValue('border-top-width'), 10)
                         + parseInt(computed.getPropertyValue('padding-top'), 10)
                         + field.scrollHeight
                         + parseInt(computed.getPropertyValue('padding-bottom'), 10)
                         + parseInt(computed.getPropertyValue('border-bottom-width'), 10);
            field.style.height = height + 'px';
        };

        // --- 2. DYNAMIC TABLE LOGIC ---
        
        function createRowHTML(values = {}) {
            return `
                <td class="border-r-2 border-dark p-0 print:border-black"><input value="${values.time || ''}" class="row-input w-full h-full p-3 text-center bg-transparent outline-none focus:bg-e1blue/10 print:p-1 print:text-sm" placeholder="00:00" data-key="time"></td>
                <td class="border-r-2 border-dark p-0 print:border-black"><textarea class="row-input w-full h-full p-3 bg-transparent outline-none focus:bg-e1blue/10 auto-expand print:p-1 print:text-sm" rows="2" data-key="stage">${values.stage || ''}</textarea></td>
                <td class="border-r-2 border-dark p-0 print:border-black"><textarea class="row-input w-full h-full p-3 bg-transparent outline-none focus:bg-e1blue/10 auto-expand print:p-1 print:text-sm" rows="2" data-key="proc">${values.proc || ''}</textarea></td>
                <td class="p-0"><textarea class="row-input w-full h-full p-3 bg-transparent outline-none focus:bg-e1blue/10 auto-expand print:p-1 print:text-sm" rows="2" data-key="comm">${values.comm || ''}</textarea></td>
            `;
        }

        function addRow(values = {}) {
            const tbody = document.getElementById('tableBody');
            const tr = document.createElement('tr');
            tr.className = "group";
            tr.innerHTML = createRowHTML(values);
            tbody.appendChild(tr);
            
            // Re-attach listeners to new inputs
            const newInputs = tr.querySelectorAll('input, textarea');
            newInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if(input.tagName === 'TEXTAREA') autoExpand(input);
                    saveData();
                });
                if(input.tagName === 'TEXTAREA') autoExpand(input);
            });
        }

        // --- 3. SAVE/LOAD SYSTEM ---

        function getDataObject() {
            // Helper to build data object from current DOM
            const staticFields = {};
            ['teacher_name', 'observer_name', 'students_info', 'date_time', 'class_name', 'keep_doing', 'start_doing', 'avoid_doing', 'action_plan'].forEach(id => {
                staticFields[id] = document.getElementById(id).value;
            });

            const rows = [];
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                const rowData = {};
                tr.querySelectorAll('.row-input').forEach(input => {
                    rowData[input.dataset.key] = input.value;
                });
                rows.push(rowData);
            });
            
            return { staticFields, rows };
        }

        function saveData() {
            const fullData = getDataObject();
            localStorage.setItem('obsFormV3', JSON.stringify(fullData));

            // Visual Feedback
            statusSpan.innerText = "Saved";
            statusSpan.classList.add('text-e1green');
            setTimeout(() => statusSpan.classList.remove('text-e1green'), 1000);
        }

        function loadData() {
            const saved = JSON.parse(localStorage.getItem('obsFormV3'));

            if (saved) {
                // 1. Load Static Fields
                for (const [key, value] of Object.entries(saved.staticFields)) {
                    const el = document.getElementById(key);
                    if (el) el.value = value;
                }

                // 2. Load Table Rows
                if (saved.rows && saved.rows.length > 0) {
                    saved.rows.forEach(rowData => addRow(rowData));
                } else {
                    addRow(); addRow(); addRow();
                }
            } else {
                // Fresh start: 5 empty rows
                addRow(); addRow(); addRow(); addRow(); addRow();
            }
            
            setTimeout(() => {
                document.querySelectorAll('textarea').forEach(autoExpand);
            }, 100);
        }

        // --- 4. EXPORT / IMPORT LOGIC ---

        function exportData() {
            const data = localStorage.getItem('obsFormV3');
            if (!data) { alert('No data to export!'); return; }
            
            // Create filename based on teacher/date if available
            const teacher = document.getElementById('teacher_name').value || 'observation';
            const date = new Date().toISOString().slice(0,10);
            const filename = `${teacher.replace(/\s+/g, '_')}_${date}.json`;

            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Simple Validation
                    if (!data.staticFields || !data.rows) {
                        throw new Error("Invalid file format. Missing fields.");
                    }

                    // Confirm overwrite
                    if(!confirm("Importing will overwrite current data. Continue?")) {
                        input.value = ''; // Reset input
                        return;
                    }

                    // Save to local storage and reload
                    localStorage.setItem('obsFormV3', JSON.stringify(data));
                    location.reload();

                } catch (err) {
                    alert("Error importing file: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- 5. INITIALIZATION ---

        // Attach listeners to static fields
        ['teacher_name', 'observer_name', 'students_info', 'date_time', 'class_name', 'keep_doing', 'start_doing', 'avoid_doing', 'action_plan'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveData);
        });

        // Clear Button
        document.getElementById('resetBtn').addEventListener('click', () => {
            if(confirm("Clear all data? This cannot be undone.")) {
                localStorage.removeItem('obsFormV3');
                location.reload(); 
            }
        });

        // Load everything
        loadData();

    </script>
</body>
</html>