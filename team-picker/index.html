<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Picker: Classroom Console</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // English 1 Palette
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        // UI Base Colors
                        dark: '#0f172a',    // Slate-900
                        panel: '#1e293b',   // Slate-800
                    },
                    fontFamily: {
                        heading: ['Bebas Neue', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8) translateY(10px)', opacity: '0' },
                            '100%': { transform: 'scale(1) translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(41, 121, 255, 0.2)' },
                            '50%': { boxShadow: '0 0 40px rgba(41, 121, 255, 0.6)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@700&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Nunito', sans-serif;
            background-color: #0f172a;
            /* Subtle radial gradient background */
            background-image: 
                radial-gradient(at 50% 0%, rgba(41, 121, 255, 0.15) 0px, transparent 50%), 
                radial-gradient(at 50% 100%, rgba(255, 107, 149, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: white;
            overflow-x: hidden;
        }

        /* Glassmorphism Panel Helper */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Modal Overlay Background */
        .modal-overlay {
            background: rgba(15, 23, 42, 0.92); /* Dark, slightly transparent */
            backdrop-filter: blur(5px);
        }

        /* --- THEATRICAL ELEMENTS --- */
        
        /* The Spinning Ring */
        .roulette-ring {
            background: conic-gradient(transparent, #2979FF, #00E676, #FF8C42, #FF6B95, transparent);
            border-radius: 50%;
            mask: radial-gradient(transparent 60%, black 61%);
            -webkit-mask: radial-gradient(transparent 60%, black 61%);
        }

        /* Team Cards */
        .team-card {
            width: 100%;            /* Mobile: Full width */
            max-width: 20rem;       /* Desktop: Fixed 20rem (approx 320px) */
            flex: none;             /* Prevent flexing/stretching */
            transition: transform 0.2s ease;
        }
        .team-card:hover {
            transform: translateY(-4px); /* Lift effect on hover */
        }

        /* 3D Button Style */
        .btn-3d {
            transition: all 0.1s;
            transform: translateY(0);
            border-bottom-width: 4px;
            border-bottom-color: rgba(0,0,0,0.3);
        }
        .btn-3d:active {
            transform: translateY(3px); /* Push down effect */
            border-bottom-width: 0px;
            border-bottom-color: transparent;
            margin-bottom: -1px; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="w-full glass-panel sticky top-0 z-40 border-b border-white/5">
        <div class="max-w-4xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-orange to-pink flex items-center justify-center text-lg shadow-lg">ðŸŽ²</div>
                <div>
                    <h1 class="font-heading text-2xl tracking-wide leading-none text-white">Team Picker</h1>
                    <p class="text-[10px] text-gray-400 font-mono tracking-widest uppercase">English 1 Batam</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="sound-toggle" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-xl transition text-gray-400" title="Toggle Sound">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                <button id="reset-btn" class="w-10 h-10 flex items-center justify-center hover:bg-pink/20 text-pink rounded-xl transition" title="Clear All">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-6 w-full">
        
        <div class="w-full max-w-2xl flex flex-col gap-4 animate-fade-in">
            <div class="glass-panel p-8 rounded-3xl border border-white/10 shadow-2xl relative overflow-hidden">
                
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue/10 blur-3xl rounded-full -mr-32 -mt-32 pointer-events-none"></div>

                <div class="flex justify-between items-center mb-6 relative">
                    <h2 class="text-xl font-heading tracking-wider text-white flex items-center gap-2">
                        <i data-lucide="keyboard" class="w-5 h-5 text-blue"></i> Input Console
                    </h2>
                    <span id="player-count" class="bg-surface/50 text-gray-400 px-3 py-1 rounded-lg text-xs font-mono font-bold border border-white/5 transition-colors">
                        0 PLAYERS
                    </span>
                </div>
                
                <textarea id="name-input" 
                    class="w-full h-48 bg-dark/50 border border-white/10 rounded-xl p-5 text-base focus:border-blue focus:ring-1 focus:ring-blue outline-none resize-none font-mono mb-8 transition-colors shadow-inner text-gray-200 placeholder-gray-600 relative z-10"
                    placeholder="Enter student names here...&#10;One per line"></textarea>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                    
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex flex-col justify-center">
                        <div class="flex justify-between text-xs font-bold uppercase tracking-wider text-gray-400 mb-3">
                            <span>Total Teams</span>
                            <span id="team-val" class="text-orange text-xl leading-none font-heading">2</span>
                        </div>
                        <input type="range" id="team-slider" min="2" max="10" value="2" class="w-full accent-orange h-2 bg-dark rounded-lg appearance-none cursor-pointer">
                    </div>

                    <button id="generate-btn" class="btn-3d bg-gradient-to-br from-blue to-green text-white rounded-xl font-heading text-2xl tracking-widest shadow-lg flex items-center justify-center gap-3 hover:brightness-110">
                        <i data-lucide="zap" class="w-6 h-6"></i> GENERATE
                    </button>
                </div>
            </div>
            
            <p class="text-center text-gray-500 text-xs font-mono">English 1 Toolset â€¢ Batam</p>
        </div>

    </main>

    <div id="results-modal" class="fixed inset-0 z-50 hidden flex-col modal-overlay transition-opacity duration-300">
        
        <div class="flex justify-between items-center p-6 max-w-7xl mx-auto w-full border-b border-white/5 bg-dark/50 backdrop-blur-md sticky top-0 z-50">
            <h2 class="font-heading text-3xl text-white tracking-widest flex items-center gap-3">
                <span id="status-dot" class="w-3 h-3 rounded-full bg-green animate-pulse"></span> RESULTS
            </h2>
            <div class="flex gap-3">
                <button id="copy-btn" class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/10 text-xs font-bold uppercase tracking-wider text-gray-300 transition flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy List
                </button>
                <button id="close-modal-btn" class="w-10 h-10 rounded-full border border-white/10 hover:bg-pink/20 hover:border-pink text-white flex items-center justify-center transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto px-6 pb-20 relative">
            
            <div id="spinner-container" class="absolute inset-x-0 top-10 flex flex-col items-center justify-start z-10 pointer-events-none transition-opacity duration-500">
                <div class="relative w-64 h-64 flex items-center justify-center mb-4">
                    <div class="absolute inset-0 roulette-ring animate-spin-slow opacity-80"></div>
                    <div class="absolute inset-4 roulette-ring animate-spin-slow opacity-40" style="animation-direction: reverse; animation-duration: 5s;"></div>
                    
                    <div class="absolute inset-8 bg-dark rounded-full border border-white/10 flex flex-col items-center justify-center shadow-[0_0_50px_rgba(41,121,255,0.2)]">
                        <div class="text-[10px] text-blue font-mono uppercase tracking-[0.2em] mb-2 opacity-70">Sorting</div>
                        <div id="spinner-text" class="text-2xl font-heading text-white px-4 text-center truncate w-full">...</div>
                    </div>
                </div>
                <div class="bg-dark/80 px-4 py-1 rounded-full border border-white/10 backdrop-blur">
                    <span class="text-gray-400 font-mono text-xs tracking-widest uppercase">Assigning to</span> 
                    <span id="stage-team-current" class="text-white font-bold ml-2">Team 1</span>
                </div>
            </div>

            <div id="results-grid" class="flex flex-wrap justify-center gap-6 max-w-7xl mx-auto pt-[320px] pb-20">
                </div>

        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const PALETTE = ['pink', 'blue', 'green', 'orange']; // The English 1 Colors
        const LS_KEY = 'tp_data_v4'; // Local Storage Key

        // --- 2. AUDIO ENGINE (Tone.js) ---
        let audioEnabled = true;
        const Audio = {
            init: async () => await Tone.start(),
            
            // "Tick" sound for spinner movement
            tick: () => {
                if(!audioEnabled) return;
                const osc = new Tone.Oscillator(800, "sine").toDestination();
                osc.volume.value = -12;
                osc.start().stop("+0.02"); 
            },
            
            // "Lock" sound when a name is selected
            lock: () => {
                if(!audioEnabled) return;
                const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.volume.value = -8;
                synth.triggerAttackRelease(["C5", "E5"], "32n");
            },
            
            // Victory Fanfare
            win: () => {
                if(!audioEnabled) return;
                const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.volume.value = -5;
                const now = Tone.now();
                // Play a generic C-Major chord arpeggio
                synth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "4n", now);
                synth.triggerAttackRelease(["G4", "C5", "E5", "G5"], "2n", now + 0.2);
            }
        };

        // --- 3. DOM ELEMENT REFERENCES ---
        const els = {
            input: document.getElementById('name-input'),
            count: document.getElementById('player-count'),
            slider: document.getElementById('team-slider'),
            teamVal: document.getElementById('team-val'),
            genBtn: document.getElementById('generate-btn'),
            
            // Modal Elements
            modal: document.getElementById('results-modal'),
            grid: document.getElementById('results-grid'),
            spinnerContainer: document.getElementById('spinner-container'),
            spinner: document.getElementById('spinner-text'),
            stageTeam: document.getElementById('stage-team-current'),
            statusDot: document.getElementById('status-dot'),
            copyBtn: document.getElementById('copy-btn'),
            closeBtn: document.getElementById('close-modal-btn')
        };

        let players = [];

        // --- 4. UTILITY FUNCTIONS ---

        /** * Parses input text and updates player count badge 
         */
        function updateState() {
            const raw = els.input.value;
            // Split by newline or comma, remove whitespace, remove empty entries
            players = raw.split(/[\n,]+/).map(s => s.trim()).filter(s => s.length > 0);
            
            // Update UI
            els.count.innerText = `${players.length} PLAYERS`;
            
            // Change badge color if data exists
            if(players.length > 0) {
                els.count.className = "bg-green/20 text-green px-3 py-1 rounded-lg text-xs font-mono font-bold border border-green/30 transition-colors";
            } else {
                els.count.className = "bg-surface/50 text-gray-400 px-3 py-1 rounded-lg text-xs font-mono font-bold border border-white/5 transition-colors";
            }
            
            // Auto-Save
            localStorage.setItem(LS_KEY, raw);
        }

        /**
         * Mathematical easing for the spinner deceleration
         * x is progress (0 to 1)
         */
        function easeOutCubic(x) { return 1 - Math.pow(1 - x, 3); }

        /**
         * Visual "Scramble" effect
         * Cycles through random names before landing on 'targetName'
         */
        async function scrambleEffect(targetName) {
            const duration = 500; // Total spin time in ms
            const start = performance.now();
            let lastUpdate = 0;
            
            // Create a pool of "dummy" names to flash
            const pool = players.length > 1 ? players.filter(p => p !== targetName) : ["Detecting..."];
            
            return new Promise(resolve => {
                function frame(time) {
                    const elapsed = time - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = easeOutCubic(progress);
                    
                    // Calculate dynamic delay: Starts fast (30ms), ends slow (130ms)
                    const dynamicInterval = 30 + (100 * eased);

                    if (time - lastUpdate > dynamicInterval) {
                        if (progress < 1) {
                            // Flash a random name
                            els.spinner.innerText = pool[Math.floor(Math.random() * pool.length)];
                            Audio.tick();
                        } else {
                            // Final frame: Show target
                            els.spinner.innerText = targetName;
                            Audio.lock();
                            resolve();
                            return;
                        }
                        lastUpdate = time;
                    }
                    
                    if (progress < 1) requestAnimationFrame(frame);
                    else {
                        // Safety fallback to ensure loop ends
                        els.spinner.innerText = targetName;
                        resolve();
                    }
                }
                requestAnimationFrame(frame);
            });
        }

        // --- 5. MAIN LOGIC: GENERATE TEAMS ---

        async function generate() {
            if(players.length === 0) {
                alert("Please enter some names first!");
                return;
            }
            
            // Initialize Audio Context (required by browsers)
            await Audio.init();
            
            // A. Prepare UI
            els.modal.classList.remove('hidden');
            els.modal.classList.add('flex');
            els.spinnerContainer.style.opacity = '1';
            els.grid.innerHTML = ''; // Clear previous results
            els.grid.style.paddingTop = '320px'; // Make room for spinner

            const numTeams = parseInt(els.slider.value);
            const buckets = [];

            // B. Create Team Cards (Empty)
            for(let i=0; i<numTeams; i++) {
                const colorKey = PALETTE[i % PALETTE.length];
                
                // Create Card DOM
                const card = document.createElement('div');
                card.className = `glass-panel rounded-2xl team-card flex flex-col overflow-hidden animate-fade-in w-full sm:w-80`;
                card.style.animationDelay = `${i * 100}ms`; // Staggered entry
                
                card.innerHTML = `
                    <div class="h-2 w-full bg-${colorKey}"></div>
                    <div class="p-5 flex flex-col flex-grow">
                        <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                            <h3 class="font-heading text-2xl text-white tracking-wide">TEAM ${i+1}</h3>
                            <span class="text-xs font-bold font-mono bg-${colorKey}/20 text-${colorKey} px-2 py-0.5 rounded team-count">0</span>
                        </div>
                        <ul class="space-y-2 flex-grow" id="bucket-${i}"></ul>
                    </div>
                `;
                els.grid.appendChild(card);
                
                // Store reference for quick access
                buckets.push({ 
                    el: document.getElementById(`bucket-${i}`), 
                    countBadge: card.querySelector('.team-count') 
                });
            }

            // C. The Loop
            // Randomize player list
            const shuffled = [...players].sort(() => Math.random() - 0.5);
            let tIdx = 0;

            for(let p of shuffled) {
                // Update Overlay Text
                els.stageTeam.innerText = `TEAM ${tIdx+1}`;
                els.stageTeam.className = `font-bold ml-2 text-${PALETTE[tIdx % PALETTE.length]}`;
                
                // Run the Spinner Effect
                await scrambleEffect(p);
                
                // Add Player to List
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 animate-pop text-gray-200 font-medium text-sm p-2 rounded hover:bg-white/5 transition';
                li.innerHTML = `<i data-lucide="user" class="w-4 h-4 text-gray-500"></i> ${p}`;
                buckets[tIdx].el.appendChild(li);
                
                // Update Badge
                buckets[tIdx].countBadge.innerText = buckets[tIdx].el.children.length;
                lucide.createIcons(); // Re-render icons

                // Move to next team (Round Robin)
                tIdx = (tIdx + 1) % numTeams;
                
                // Tiny pause between players for pacing
                await new Promise(r => setTimeout(r, 200)); 
            }

            // D. Finish
            els.spinnerContainer.style.opacity = '0'; // Fade out spinner
            els.grid.style.transition = 'padding 0.5s ease';
            els.grid.style.paddingTop = '40px'; // Slide grid up
            
            Audio.win();
            confetti({ particleCount: 200, spread: 120, origin: { y: 0.5 }, zIndex: 60 });
        }

        // --- 6. INITIALIZATION ---
        window.onload = () => {
            // Setup Icons
            lucide.createIcons();
            
            // Load Saved Data
            const saved = localStorage.getItem(LS_KEY);
            if(saved) els.input.value = saved;
            updateState();

            // Event Listeners
            els.input.addEventListener('input', updateState);
            els.slider.addEventListener('input', e => els.teamVal.innerText = e.target.value);
            els.genBtn.addEventListener('click', generate);
            
            // Close Modal
            els.closeBtn.addEventListener('click', () => {
                els.modal.classList.add('hidden');
                els.modal.classList.remove('flex');
            });

            // Copy to Clipboard
            els.copyBtn.addEventListener('click', () => {
                let txt = '';
                document.querySelectorAll('.team-card').forEach(card => {
                    const title = card.querySelector('h3').innerText;
                    const names = Array.from(card.querySelectorAll('li')).map(l => l.innerText).join(', ');
                    txt += `${title}: ${names}\n`;
                });
                navigator.clipboard.writeText(txt);
                
                // Feedback animation
                const oldHTML = els.copyBtn.innerHTML;
                els.copyBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green"></i> Copied`;
                lucide.createIcons();
                setTimeout(() => { els.copyBtn.innerHTML = oldHTML; lucide.createIcons(); }, 2000);
            });

            // Reset
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(confirm('Are you sure you want to clear all names?')) {
                    els.input.value = '';
                    updateState();
                }
            });

            // Sound Toggle
            document.getElementById('sound-toggle').addEventListener('click', function() {
                audioEnabled = !audioEnabled;
                this.innerHTML = audioEnabled 
                    ? `<i data-lucide="volume-2" class="w-5 h-5"></i>` 
                    : `<i data-lucide="volume-x" class="w-5 h-5"></i>`;
                lucide.createIcons();
            });
        };
    </script>
</body>
</html>