<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Tally - English 1</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Using Fredoka for universal font style -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            // Removed darkMode: 'class' for light theme
            theme: {
                extend: {
                    colors: {
                        // Task Assigner / Brand Colors
                        brand: {
                            pink: '#EC4899',   // Pink
                            orange: '#F97316',  // Orange (Accent)
                            green: '#22C55E',  // Green
                            blue: '#3B82F6',   // Blue
                        },
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9', 
                            200: '#e2e8f0', 
                            400: '#94a3b8',
                            900: '#0f172a' // Dark text
                        },
                        accent: '#F97316', // Brand Orange for highlights
                        // Retaining old names for functional parts like confetti
                        pink: '#FF6B95', 
                        green: '#00E676',
                        yellow: '#FFD700',
                    },
                    fontFamily: {
                        // Setting Fredoka as the primary font
                        sans: ['Fredoka', 'sans-serif'],
                    },
                    animation: {
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'star-spin': 'starSpin 0.6s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'pulse-yellow': 'pulseYellow 1s infinite', // Will use Brand Green for pulse
                    },
                    keyframes: {
                        popIn: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        starSpin: {
                            '0%': { transform: 'scale(0) rotate(-180deg)', opacity: '0' },
                            '100%': { transform: 'scale(1) rotate(0deg)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        pulseYellow: {
                            // Using a pulsing green/yellow to match new positive colors
                            '0%, 100%': { 'box-shadow': '0 0 0 0 rgba(34, 197, 94, 0.4)' },
                            '50%': { 'box-shadow': '0 0 0 6px rgba(34, 197, 94, 0)' } 
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            /* Light theme background, matching task-assigner index.html */
            background-color: #f0f9ff;
            background-image: none; /* Removed heavy gradients */
            font-family: 'Fredoka', sans-serif;
            color: #0f172a; /* Dark text color */
        }

        .app-panel { /* New class name for light panels */
            background: white; 
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .tally-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .tally-item:hover {
            transform: scale(1.4) rotate(10deg);
            z-index: 10;
        }

        /* Custom Scrollbar for Tally Area - Light mode visibility fix */
        .tally-container::-webkit-scrollbar {
            height: 6px;
            width: 6px;
            background: transparent;
        }
        .tally-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15); /* Darker thumb on light background */
            border-radius: 10px;
        }
        .tally-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        /* Canvas specific styling */
        #signature-canvas {
            touch-action: none; 
            border-radius: 8px;
            border: 2px dashed rgba(0, 0, 0, 0.2); /* Darker dashed border */
            background-color: rgba(0, 0, 0, 0.05);
            width: 100%;
            /* INCREASED HEIGHT for better drawing space */
            height: 450px; 
        }

        /* Tab styles */
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 3px solid #F97316; /* Accent color */
            color: #0f172a; /* Dark text for active tab */
            font-weight: bold;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans overflow-hidden text-slate-900">

    <!-- HEADER -->
    <header class="h-auto md:h-20 border-b border-slate-200 app-panel flex flex-col md:flex-row items-center justify-between px-4 py-2 gap-2 z-50 shadow-sm">
        <!-- Logo -->
        <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
            <div class="flex items-center gap-3">
                <!-- Swapping gradient to match new brand colors -->
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-brand-orange to-brand-pink flex items-center justify-center text-xl shadow-md text-white">
                    <span id="header-icon">üåü</span>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-wide">Class Tally</h1>
                </div>
            </div>
            
            <!-- Mobile Toggle for Settings -->
            <button onclick="ClassTallyApp.UI.toggleSettings()" class="md:hidden p-2 text-slate-400 hover:text-slate-900 transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="hidden md:flex flex-col md:flex-row items-center gap-4 w-full md:w-auto animate-slide-down md:animate-none">
            
            <!-- Add Student Button (Opens Modal for Type or Draw) -->
            <button onclick="ClassTallyApp.UI.showStudentModal()" 
                class="bg-brand-blue hover:bg-brand-blue/90 text-white p-2 rounded-lg transition-colors active:scale-95 flex items-center gap-1 font-bold shadow-md">
                <i data-lucide="user-plus" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Add Student</span>
            </button>
            
            <!-- Emoji Dropdown Containers -->
            <div class="relative flex gap-2">
                <!-- Good Emoji Picker -->
                <div class="relative">
                    <button onclick="ClassTallyApp.UI.toggleGoodDropdown(event)" id="btn-good-picker" class="flex items-center gap-1 bg-slate-100 border border-slate-200 rounded-lg p-2 hover:bg-slate-200 transition-colors focus:ring-2 focus:ring-brand-green">
                        <span id="current-good-emoji" class="text-xl">‚≠êÔ∏è</span> 
                        <i data-lucide="chevron-down" id="chevron-good" class="w-4 h-4 text-brand-green transition-transform"></i>
                    </button>
                    <!-- Dropdown Panel for Good Emojis -->
                    <div id="dropdown-good" class="absolute top-12 left-0 w-64 app-panel rounded-xl shadow-lg p-3 z-50 hidden origin-top-left">
                        <div class="grid grid-cols-6 gap-2" id="good-picker-grid">
                            <!-- Emojis injected here -->
                        </div>
                    </div>
                </div>

                <!-- Bad Emoji Picker -->
                <div class="relative">
                    <button onclick="ClassTallyApp.UI.toggleBadDropdown(event)" id="btn-bad-picker" class="flex items-center gap-1 bg-slate-100 border border-slate-200 rounded-lg p-2 hover:bg-slate-200 transition-colors focus:ring-2 focus:ring-brand-pink">
                        <span id="current-bad-emoji" class="text-xl">‚ö†Ô∏è</span> 
                        <i data-lucide="chevron-down" id="chevron-bad" class="w-4 h-4 text-brand-pink transition-transform"></i>
                    </button>
                    <!-- Dropdown Panel for Bad Emojis -->
                    <div id="dropdown-bad" class="absolute top-12 left-0 w-64 app-panel rounded-xl shadow-lg p-3 z-50 hidden origin-top-left">
                        <div class="grid grid-cols-6 gap-2" id="bad-picker-grid">
                            <!-- Emojis injected here -->
                        </div>
                    </div>
                </div>
            </div>


            <div class="flex items-center gap-2">

                <div class="h-6 w-[1px] bg-slate-200 hidden md:block"></div>
                
                <!-- Fixed BUTTONS: Add All Good/Bad (using brand colors) -->
                <button onclick="ClassTallyApp.Student.addAllGood()" class="p-2 bg-brand-green/10 hover:bg-brand-green/30 text-brand-green rounded-full transition-colors active:scale-95" title="Add Good Point to All Students">
                    <i data-lucide="chevrons-up" class="w-5 h-5"></i>
                </button>
                <button onclick="ClassTallyApp.Student.addAllBad()" class="p-2 bg-brand-pink/10 hover:bg-brand-pink/30 text-brand-pink rounded-full transition-colors active:scale-95" title="Add Bad Point to All Students">
                    <i data-lucide="chevrons-down" class="w-5 h-5"></i>
                </button>

                <!-- Sound Toggle -->
                <button onclick="ClassTallyApp.UI.toggleSound()" id="btn-sound" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-400 hover:text-slate-900" title="Toggle Sound">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                <!-- Clear All -->
                <button onclick="ClassTallyApp.Student.clearAll()" class="p-2 hover:bg-red-200 text-brand-pink hover:text-red-600 rounded-full transition-colors active:scale-95" title="Reset All">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow p-4 md:p-6 overflow-y-auto relative bg-slate-50">
        
        <!-- Empty State -->
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
            <div class="w-32 h-32 rounded-full bg-slate-200 flex items-center justify-center text-6xl mb-6 opacity-80 shadow-inner text-slate-400">
                üìö
            </div>
            <h2 class="text-3xl font-bold text-slate-400 tracking-wider mb-2">ADD YOUR CLASS</h2>
            <p class="text-slate-400/80 text-sm mb-8">Click 'Add Student' to register a student.</p>
        </div>

        <!-- Cards Grid -->
        <div id="grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20 z-10 relative">
            <!-- Cards Injected Here -->
        </div>

    </main>

    <!-- MOBILE FAB (Now opens the drawing modal) -->
    <button onclick="ClassTallyApp.UI.showStudentModal()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-brand-orange to-brand-pink rounded-full shadow-lg flex items-center justify-center text-white z-50 border border-white/20 hover:scale-105 transition-transform active:scale-95">
        <i data-lucide="user-plus" class="w-8 h-8"></i>
    </button>
    
    <!-- MODAL 1: Add Student Modal (Dual Entry & Color Picker) -->
    <div id="add-student-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="app-panel w-full max-w-2xl rounded-xl p-6 shadow-2xl animate-pop-in" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-slate-900 mb-4">Student Registration</h3>
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 mb-4">
                <button onclick="ClassTallyApp.UI.setModalView('type')" id="tab-type" 
                    class="tab-button px-4 py-2 text-slate-400 hover:text-slate-900 transition-colors flex items-center gap-2 active">
                    <i data-lucide="type" class="w-5 h-5"></i> Type Name
                </button>
                <button onclick="ClassTallyApp.UI.setModalView('draw')" id="tab-draw" 
                    class="tab-button px-4 py-2 text-slate-400 hover:text-slate-900 transition-colors flex items-center gap-2">
                    <i data-lucide="pen-tool" class="w-5 h-5"></i> Draw Name
                </button>
            </div>

            <!-- Card Color Picker (Applied to both modes) -->
            <div class="mb-6 p-3 bg-slate-100 rounded-lg border border-slate-200">
                <span class="text-sm font-bold text-slate-900 mb-2 block">Choose Card Color:</span>
                <div class="flex items-center gap-3" id="card-color-picker">
                    <!-- Color buttons generated by JS -->
                </div>
            </div>

            <!-- TAB CONTENT: TYPE NAME -->
            <div id="content-type" class="tab-content" style="display:none;">
                <p class="text-slate-700 text-sm mb-4">Enter the student's name (for teacher reference).</p>
                <input type="text" id="student-name-input" placeholder="Enter student name..." 
                       class="w-full bg-white text-slate-900 p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-accent outline-none"
                       onkeypress="if(event.key === 'Enter') ClassTallyApp.Student.addTyped()">
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="ClassTallyApp.UI.hideStudentModal()" 
                            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="ClassTallyApp.Student.addTyped()" 
                            class="px-6 py-2 bg-brand-green hover:bg-brand-green/90 rounded-lg text-white font-bold transition-colors shadow-md active:scale-95">
                        <i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Register Student
                    </button>
                </div>
            </div>
            
            <!-- TAB CONTENT: DRAW NAME -->
            <div id="content-draw" class="tab-content" style="display:none;">
                <p class="text-slate-700 text-sm mb-4">Please draw your name or a unique ID below (Best for younger children).</p>
                
                <!-- Pen Settings -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 p-3 bg-slate-100 rounded-lg border border-slate-200">
                    <!-- Color Picker -->
                    <div class="flex items-center gap-3 mb-3 sm:mb-0">
                        <span class="text-sm font-bold text-slate-900">Draw Color:</span>
                        <!-- White is good for contrast on the dark panel -->
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeColor('#0f172a')" class="w-6 h-6 rounded-full bg-slate-900 ring-2 ring-transparent transition-all" id="color-dark" title="Dark"></button>
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeColor('#3B82F6')" class="w-6 h-6 rounded-full bg-brand-blue ring-2 ring-transparent transition-all" id="color-blue" title="Blue"></button>
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeColor('#22C55E')" class="w-6 h-6 rounded-full bg-brand-green ring-2 ring-transparent transition-all" id="color-green" title="Green"></button>
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeColor('#EC4899')" class="w-6 h-6 rounded-full bg-brand-pink ring-2 ring-transparent transition-all" id="color-pink" title="Pink"></button>
                    </div>
                    <!-- Stroke Width Picker -->
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold text-slate-900">Width:</span>
                        <!-- Changed internal circle colors to dark for contrast on white/light background -->
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeWidth(5)" class="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center transition-all" id="width-5" title="Thin">
                            <div class="w-2 h-2 rounded-full bg-slate-900"></div>
                        </button>
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeWidth(8)" class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center transition-all" id="width-8" title="Medium">
                            <div class="w-3 h-3 rounded-full bg-slate-900"></div>
                        </button>
                        <button onclick="ClassTallyApp.CanvasDraw.setStrokeWidth(12)" class="w-7 h-7 rounded-full bg-slate-200 flex items-center justify-center transition-all" id="width-12" title="Thick">
                            <div class="w-4 h-4 rounded-full bg-slate-900"></div>
                        </button>
                    </div>
                </div>
                
                <!-- Canvas -->
                <canvas id="signature-canvas"></canvas>

                <div class="flex justify-between items-center mt-4 gap-3">
                    <button onclick="ClassTallyApp.CanvasDraw.clear()" 
                            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-700 transition-colors flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                    </button>
                    <div class="flex gap-3">
                        <button onclick="ClassTallyApp.UI.hideStudentModal()" 
                                class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-700 transition-colors">
                            Cancel
                        </button>
                        <button onclick="ClassTallyApp.Student.addSignature()" 
                                class="px-6 py-2 bg-brand-green hover:bg-brand-green/90 rounded-lg text-white font-bold transition-colors shadow-md active:scale-95">
                            <i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Register Student
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- MODAL 2: Global Confirmation (Replaces confirm()) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0"
        onclick="ClassTallyApp.UI.handleModalAction(false)">
        <div class="app-panel w-full max-w-sm rounded-xl p-6 shadow-2xl animate-pop-in" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold text-slate-900 mb-3">Confirmation</h3>
            <p id="modal-message" class="text-slate-700 text-sm mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" onclick="ClassTallyApp.UI.handleModalAction(false)" 
                        class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-700 transition-colors">
                    Cancel
                </button>
                <button id="modal-confirm" onclick="ClassTallyApp.UI.handleModalAction(true)" 
                        class="px-4 py-2 bg-brand-pink hover:bg-brand-pink/90 rounded-lg text-white font-bold transition-colors shadow-md">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Class Tally Application Module (IIFE)
         * Encapsulates all state, logic, audio, and UI methods.
         */
        const ClassTallyApp = (function() {
            // --- STATE ---
            let modalCallback = null; 

            const State = {
                students: [],
                soundEnabled: true,
                isGoodDropdownOpen: false,
                isBadDropdownOpen: false,
                currentGood: '‚≠êÔ∏è',
                currentBad: '‚ö†Ô∏è',
                currentStrokeColor: '#0f172a', // Default to dark text color
                currentStrokeWidth: 8,         
                currentCardColor: '#3B82F6', // Default Brand Blue
                
                // UPDATED: Available card colors (Brand Palette)
                CARD_COLORS: [
                    { name: 'Blue', hex: '#3B82F6', border: 'border-brand-blue', ring: 'ring-brand-blue/30' },
                    { name: 'Green', hex: '#22C55E', border: 'border-brand-green', ring: 'ring-brand-green/30' },
                    { name: 'Orange', hex: '#F97316', border: 'border-brand-orange', ring: 'ring-brand-orange/30' },
                    { name: 'Pink', hex: '#EC4899', border: 'border-brand-pink', ring: 'ring-brand-pink/30' },
                    { name: 'Gray', hex: '#94A3B8', border: 'border-slate-400', ring: 'ring-slate-400/30' },
                ],
                
                modalView: 'type', 

                GOOD_EMOJIS: ['‚≠êÔ∏è', '‚ù§Ô∏è', 'üî•', 'üíé', 'üöÄ', 'ü¶Ñ', 'üíØ', 'üëç', 'üß†', 'üëë', 'üéâ', 'ü•á', 'üí°', '‚úÖ', 'üëè', 'üèÜ', 'üí´', '‚ú®'],
                BAD_EMOJIS: ['‚ö†Ô∏è', 'üõë', 'üê¢', 'üí§', 'üß®', 'üëª', '‚ùå', 'üï∞Ô∏è', 'ü§´', 'üåßÔ∏è', 'üöß', 'üêå', 'ü§∑‚Äç‚ôÄÔ∏è', '‚úã', 'üìâ', 'üò∂', 'üóëÔ∏è', '‚ùì'],
            };

            // --- CANVAS DRAWING MODULE ---
            const CanvasDraw = {
                canvas: null,
                ctx: null,
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                hasDrawn: false,

                init: (canvasId) => {
                    CanvasDraw.canvas = document.getElementById(canvasId);
                    if (!CanvasDraw.canvas) return;

                    CanvasDraw.ctx = CanvasDraw.canvas.getContext('2d');
                    
                    CanvasDraw.ctx.lineWidth = State.currentStrokeWidth;
                    CanvasDraw.ctx.lineCap = 'round';
                    CanvasDraw.ctx.strokeStyle = State.currentStrokeColor;
                    
                    ['mousedown', 'mousemove', 'mouseup', 'mouseout'].forEach(event => {
                        CanvasDraw.canvas.addEventListener(event, (e) => {
                            if (event === 'mousedown') CanvasDraw.startDraw(e);
                            else if (event === 'mousemove') CanvasDraw.draw(e);
                            else CanvasDraw.stopDraw();
                        });
                    });
                    
                    ['touchstart', 'touchmove'].forEach(event => {
                        CanvasDraw.canvas.addEventListener(event, (e) => {
                            e.preventDefault(); 
                            if (event === 'touchstart') CanvasDraw.startDraw(e.touches[0]);
                            else CanvasDraw.draw(e.touches[0]);
                        });
                    });
                    ['touchend', 'touchcancel'].forEach(event => {
                         CanvasDraw.canvas.addEventListener(event, CanvasDraw.stopDraw);
                    });
                    
                    CanvasDraw.updateUISelectors();
                },
                
                setStrokeColor: (color) => {
                    State.currentStrokeColor = color;
                    if (CanvasDraw.ctx) {
                        CanvasDraw.ctx.strokeStyle = color;
                    }
                    CanvasDraw.updateUISelectors();
                },

                setStrokeWidth: (width) => {
                    State.currentStrokeWidth = width;
                    if (CanvasDraw.ctx) {
                        CanvasDraw.ctx.lineWidth = width;
                    }
                    CanvasDraw.updateUISelectors();
                },
                
                updateUISelectors: () => {
                    // Update Draw Color Selectors (Matching new colors and dark text)
                    document.querySelectorAll('#content-draw button[id^="color-"]').forEach(btn => {
                        btn.classList.remove('ring-4', 'ring-offset-2', 'ring-offset-slate-50');
                        const colorHexMap = {
                            'dark': '#0f172a', 'blue': '#3B82F6', 'green': '#22C55E', 'pink': '#EC4899'
                        };
                        const colorName = btn.id.split('-')[1];
                        if (colorHexMap[colorName] === State.currentStrokeColor) {
                            btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-slate-50');
                        }
                    });

                    // Update Width Selectors
                    document.querySelectorAll('#content-draw button[id^="width-"]').forEach(btn => {
                        btn.classList.remove('bg-brand-blue/50');
                        btn.classList.add('bg-slate-200');
                        if (btn.id === `width-${State.currentStrokeWidth}`) {
                            btn.classList.remove('bg-slate-200');
                            btn.classList.add('bg-slate-300'); // Slightly darker highlight
                        }
                    });
                },

                resizeObserver: new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const { width, height } = entry.contentRect;
                        const dpr = window.devicePixelRatio || 1;
                        
                        let imageData = null;
                        if (CanvasDraw.hasDrawn) {
                            try {
                                imageData = CanvasDraw.getSignature();
                            } catch (error) {
                                console.error("Error saving image data before resize:", error);
                            }
                        }

                        CanvasDraw.canvas.width = width * dpr;
                        CanvasDraw.canvas.height = height * dpr;
                        
                        CanvasDraw.ctx.scale(dpr, dpr);
                        
                        CanvasDraw.ctx.lineWidth = State.currentStrokeWidth;
                        CanvasDraw.ctx.lineCap = 'round';
                        CanvasDraw.ctx.strokeStyle = State.currentStrokeColor;

                        if (imageData && CanvasDraw.hasDrawn) {
                            const img = new Image();
                            img.onload = () => {
                                CanvasDraw.ctx.drawImage(img, 0, 0, width, height);
                            };
                            img.src = imageData;
                        }
                    }
                }),

                startDraw: (e) => {
                    CanvasDraw.isDrawing = true;
                    [CanvasDraw.lastX, CanvasDraw.lastY] = CanvasDraw.getCoords(e);
                    CanvasDraw.hasDrawn = true;
                },

                draw: (e) => {
                    if (!CanvasDraw.isDrawing) return;
                    
                    CanvasDraw.ctx.beginPath();
                    CanvasDraw.ctx.moveTo(CanvasDraw.lastX, CanvasDraw.lastY);
                    
                    const [newX, newY] = CanvasDraw.getCoords(e);
                    CanvasDraw.ctx.lineTo(newX, newY);
                    CanvasDraw.ctx.stroke();
                    
                    [CanvasDraw.lastX, CanvasDraw.lastY] = [newX, newY];
                },

                stopDraw: () => {
                    CanvasDraw.isDrawing = false;
                },

                getCoords: (e) => {
                    const rect = CanvasDraw.canvas.getBoundingClientRect();
                    return [
                        e.clientX - rect.left,
                        e.clientY - rect.top
                    ];
                },

                clear: () => {
                    CanvasDraw.ctx.clearRect(0, 0, CanvasDraw.canvas.width, CanvasDraw.canvas.height);
                    CanvasDraw.hasDrawn = false;
                },

                getSignature: () => {
                    return CanvasDraw.canvas.toDataURL('image/png');
                }
            };

            // --- AUDIO ENGINE (Unchanged) ---
            const Audio = {
                ctx: null,
                init: () => {
                    if(!Audio.ctx) {
                        Audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
                        Tone.start();
                    }
                },
                playGood: () => {
                    if(!State.soundEnabled) return;
                    Audio.init();
                    const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    synth.volume.value = -8;
                    synth.triggerAttackRelease(["C5", "E5"], "16n");
                },
                playBad: () => {
                    if(!State.soundEnabled) return;
                    Audio.init();
                    const synth = new Tone.MembraneSynth().toDestination();
                    synth.volume.value = -5;
                    synth.triggerAttackRelease("A1", "8n");
                },
                playMilestone: () => {
                    if(!State.soundEnabled) return;
                    Audio.init();
                    const synth = new Tone.MetalSynth({
                        harmonicity: 12, resonance: 800, modulationIndex: 20, envelope: { decay: 0.4 }
                    }).toDestination();
                    synth.volume.value = -15;
                    synth.triggerAttackRelease("32n");
                    
                    const poly = new Tone.PolySynth().toDestination();
                    poly.volume.value = -8;
                    poly.triggerAttackRelease(["C4", "E4", "G4", "C5", "E5"], "4n");
                },
                playMassAction: (type) => {
                    if(!State.soundEnabled) return;
                    Audio.init();
                    if (type === 'good') {
                        const poly = new Tone.PolySynth().toDestination();
                        poly.volume.value = -10;
                        poly.triggerAttackRelease(["C5", "E5", "G5"], "8n");
                    } else {
                        const noise = new Tone.NoiseSynth({
                            noise: { type: "pink" },
                            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                        }).toDestination();
                        noise.volume.value = -12;
                        noise.triggerAttackRelease("4n");
                    }
                }
            };

            // --- PERSISTENCE (Unchanged) ---
            const Persistence = {
                save: () => {
                    localStorage.setItem('english1_tally_v2_data', JSON.stringify(State.students));
                },
                load: () => {
                    const dataV2 = localStorage.getItem('english1_tally_v2_data');
                    
                    if(dataV2) {
                        State.students = JSON.parse(dataV2);
                    } else {
                        const dataOld = localStorage.getItem('english1_tally_data');
                        if(dataOld) {
                            const oldStudents = JSON.parse(dataOld);
                            State.students = oldStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                goodLogs: Array(s.stars || 0).fill('‚≠êÔ∏è'),
                                badLogs: Array(s.warnings || 0).fill('‚ö†Ô∏è'),
                                signatureData: null,
                                cardColor: State.currentCardColor 
                            }));
                            Persistence.save(); 
                        }
                    }
                    // Ensure existing students have the cardColor property (for old data)
                    State.students = State.students.map(s => ({
                        ...s, 
                        cardColor: s.cardColor || State.currentCardColor 
                    }));
                }
            };


            // --- STUDENT LOGIC ---
            const Student = {
                addTyped: () => {
                    const nameInput = document.getElementById('student-name-input');
                    const name = nameInput.value.trim();
                    if (!name) {
                        alert("Please enter a student name.");
                        return;
                    }

                    State.students.push({
                        id: Date.now(),
                        name: name,
                        signatureData: null,
                        goodLogs: [], 
                        badLogs: [],
                        cardColor: State.currentCardColor 
                    });

                    nameInput.value = '';
                    UI.hideStudentModal();
                    Persistence.save();
                    UI.render();
                    Audio.playGood();
                },
                
                addSignature: () => {
                    if (!CanvasDraw.hasDrawn) {
                        alert("Please draw an identifier before registering.");
                        return;
                    }

                    const signature = CanvasDraw.getSignature();
                    
                    State.students.push({
                        id: Date.now(),
                        name: 'Student ' + (State.students.length + 1),
                        signatureData: signature,
                        goodLogs: [], 
                        badLogs: [],
                        cardColor: State.currentCardColor 
                    });

                    UI.hideStudentModal();
                    CanvasDraw.clear();
                    Persistence.save();
                    UI.render();
                    Audio.playGood();
                },

                add: (nameInput = null) => {},
                promptAdd: () => { UI.showStudentModal(); },

                remove: (id) => {
                    UI.showConfirmationModal(
                        'Remove Student?', 
                        'Are you sure you want to remove this student and clear all their records?',
                        'Remove',
                        (confirmed) => {
                            if (confirmed) {
                                State.students = State.students.filter(s => s.id !== id);
                                Persistence.save();
                                UI.render();
                            }
                        }
                    );
                },

                addPoint: (id, type) => {
                    const student = State.students.find(s => s.id === id);
                    if(!student) return;

                    const card = document.getElementById(`card-${id}`);

                    if(type === 'good') {
                        student.goodLogs.push(State.currentGood);
                        Audio.playGood();
                        
                        if(student.goodLogs.length > 0 && student.goodLogs.length % 5 === 0) {
                            UI.celebrate(id);
                            Audio.playMilestone();
                        }
                    } else {
                        student.badLogs.push(State.currentBad);
                        Audio.playBad();
                        
                        card.classList.remove('animate-shake');
                        void card.offsetWidth; 
                        card.classList.add('animate-shake');
                    }

                    Persistence.save();
                    UI.render();
                },

                removeLastPoint: (id, type) => {
                    const student = State.students.find(s => s.id === id);
                    if(!student) return;

                    if(type === 'good' && student.goodLogs.length > 0) student.goodLogs.pop();
                    if(type === 'bad' && student.badLogs.length > 0) student.badLogs.pop();

                    Persistence.save();
                    UI.render();
                },

                addAllGood: () => {
                    if (State.students.length === 0) return;
                    
                    UI.showConfirmationModal(
                        'Class Reward!',
                        `Add 1 ${State.currentGood} point to ALL ${State.students.length} students?`,
                        'Reward All',
                        (confirmed) => {
                            if (confirmed) {
                                State.students.forEach(s => { s.goodLogs.push(State.currentGood); });
                                Persistence.save();
                                UI.render();
                                Audio.playMassAction('good');
                                confetti({
                                    particleCount: 50, spread: 360, ticks: 100, origin: { x: 0.5, y: 0.5 },
                                    colors: ['#FFD700', '#FFA500', '#FFFFFF', '#00E676']
                                });
                            }
                        }
                    );
                },
                
                addAllBad: () => {
                    if (State.students.length === 0) return;

                    UI.showConfirmationModal(
                        'Class Warning!',
                        `Add 1 ${State.currentBad} point to ALL ${State.students.length} students?`,
                        'Warn All',
                        (confirmed) => {
                            if (confirmed) {
                                State.students.forEach(s => { s.badLogs.push(State.currentBad); });
                                Persistence.save();
                                UI.render();
                                Audio.playMassAction('bad');
                            }
                        }
                    );
                },

                clearAll: () => {
                    UI.showConfirmationModal(
                        'Clear All Data?',
                        'Are you sure you want to clear ALL students and their tallies? This cannot be undone.',
                        'Clear Data',
                        (confirmed) => {
                            if (confirmed) {
                                State.students = [];
                                Persistence.save();
                                UI.render();
                            }
                        }
                    );
                },
                
                sort: () => {
                    State.students.sort((a, b) => a.id - b.id);
                },
                
                setSort: (value, shouldRender = true) => {},
            };


            // --- UI/RENDER LOGIC ---
            const UI = {
                // Card Color Picker Logic
                initCardColorPicker: () => {
                    const picker = document.getElementById('card-color-picker');
                    picker.innerHTML = State.CARD_COLORS.map(color => `
                        <button onclick="ClassTallyApp.UI.setCardColor('${color.hex}')" 
                            class="w-8 h-8 rounded-full ring-2 ring-transparent transition-all hover:ring-slate-400/50" 
                            id="card-color-${color.name.toLowerCase()}" 
                            title="${color.name}"
                            style="background-color: ${color.hex}">
                        </button>
                    `).join('');
                    UI.updateCardColorPicker();
                },

                setCardColor: (hex) => {
                    State.currentCardColor = hex;
                    UI.updateCardColorPicker();
                },

                updateCardColorPicker: () => {
                    document.querySelectorAll('#card-color-picker button').forEach(btn => {
                        btn.classList.remove('ring-4', 'ring-offset-2', 'ring-offset-slate-50');
                        
                        const colorName = btn.id.split('-')[2];
                        const colorObj = State.CARD_COLORS.find(c => c.name.toLowerCase() === colorName);
                        
                        if (colorObj && colorObj.hex === State.currentCardColor) {
                            btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-slate-50');
                        }
                    });
                },

                // Tab Logic
                setModalView: (view) => {
                    State.modalView = view;
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    
                    document.getElementById(`tab-${view}`).classList.add('active');
                    document.getElementById(`content-${view}`).style.display = 'block';

                    // Special handling for the Draw tab
                    if (view === 'draw') {
                        CanvasDraw.resizeObserver.observe(CanvasDraw.canvas);
                        CanvasDraw.clear();
                    } else {
                        CanvasDraw.resizeObserver.unobserve(CanvasDraw.canvas);
                    }
                },

                // MODAL 1: Add Student
                showStudentModal: () => {
                    // Reset to default view (Type Name) on open
                    UI.setModalView('type'); 
                    UI.initCardColorPicker();
                    
                    const modal = document.getElementById('add-student-modal');
                    modal.classList.remove('hidden', 'opacity-0');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                },
                hideStudentModal: () => {
                    const modal = document.getElementById('add-student-modal');
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    CanvasDraw.resizeObserver.unobserve(CanvasDraw.canvas);
                },
                
                // MODAL 2: Confirmation Modal Handlers (Unchanged)
                showConfirmationModal: (title, message, confirmText, callback) => {
                    modalCallback = callback;
                    document.getElementById('modal-title').textContent = title;
                    document.getElementById('modal-message').textContent = message;
                    document.getElementById('modal-confirm').textContent = confirmText;
                    
                    const modal = document.getElementById('confirmation-modal');
                    modal.classList.remove('hidden', 'opacity-0');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                },

                hideModal: () => {
                    const modal = document.getElementById('confirmation-modal');
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                },

                handleModalAction: (confirmed) => {
                    UI.hideModal();
                    if (modalCallback) {
                        modalCallback(confirmed);
                        modalCallback = null;
                    }
                },

                // Dropdown logic (Updated classes for light theme)
                toggleDropdown: (dropdownId, chevronId, type) => {
                    const dropdown = document.getElementById(dropdownId);
                    const chevron = document.getElementById(chevronId);
                    
                    const isCurrentlyOpen = !dropdown.classList.contains('hidden');
                    const newState = !isCurrentlyOpen;

                    if (type === 'good') {
                        State.isGoodDropdownOpen = newState;
                        if (newState && State.isBadDropdownOpen) UI.toggleDropdown('dropdown-bad', 'chevron-bad', 'bad'); 
                    } else if (type === 'bad') {
                        State.isBadDropdownOpen = newState;
                        if (newState && State.isGoodDropdownOpen) UI.toggleDropdown('dropdown-good', 'chevron-good', 'good'); 
                    }

                    if (newState) {
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.classList.add('hidden');
                    }
                    chevron.style.transform = newState ? 'rotate(180deg)' : 'rotate(0deg)';
                },
                toggleGoodDropdown: (event) => {
                    event.stopPropagation();
                    UI.toggleDropdown('dropdown-good', 'chevron-good', 'good');
                },
                toggleBadDropdown: (event) => {
                    event.stopPropagation();
                    UI.toggleDropdown('dropdown-bad', 'chevron-bad', 'bad');
                },
                closeAllDropdowns: () => {
                    if (State.isGoodDropdownOpen) UI.toggleDropdown('dropdown-good', 'chevron-good', 'good');
                    if (State.isBadDropdownOpen) UI.toggleDropdown('dropdown-bad', 'chevron-bad', 'bad');
                },

                // Logic for populating and setting emojis (Updated classes for light theme)
                initEmojiPickers: () => {
                    const goodGrid = document.getElementById('good-picker-grid');
                    const badGrid = document.getElementById('bad-picker-grid');
                    const currentGoodEmojiSpan = document.getElementById('current-good-emoji');
                    const currentBadEmojiSpan = document.getElementById('current-bad-emoji');

                    if (currentGoodEmojiSpan) currentGoodEmojiSpan.textContent = State.currentGood;
                    if (currentBadEmojiSpan) currentBadEmojiSpan.textContent = State.currentBad;

                    const getButtonHtml = (emoji, current, type) => `
                        <button onclick="ClassTallyApp.UI.setEmoji('${type}', '${emoji}')" 
                            class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 transition-colors text-2xl ${emoji === current ? `ring-2 ring-brand-${type === 'good' ? 'green' : 'pink'} scale-110` : ''}"
                            title="Select ${emoji}">
                            ${emoji}
                        </button>
                    `;

                    goodGrid.innerHTML = State.GOOD_EMOJIS.map(emoji => 
                        getButtonHtml(emoji, State.currentGood, 'good')
                    ).join('');

                    badGrid.innerHTML = State.BAD_EMOJIS.map(emoji => 
                        getButtonHtml(emoji, State.currentBad, 'bad')
                    ).join('');
                },
                setEmoji: (type, emoji) => {
                    if(type === 'good') {
                        State.currentGood = emoji;
                        document.getElementById('current-good-emoji').textContent = emoji;
                        UI.toggleDropdown('dropdown-good', 'chevron-good', 'good'); 
                    }
                    else {
                        State.currentBad = emoji;
                        document.getElementById('current-bad-emoji').textContent = emoji;
                        UI.toggleDropdown('dropdown-bad', 'chevron-bad', 'bad'); 
                    }
                    
                    UI.initEmojiPickers();
                    UI.render(); 
                },

                // General UI Toggles (Updated classes for light theme)
                toggleSettings: () => {
                    const toolbar = document.getElementById('toolbar');
                    toolbar.classList.toggle('hidden');
                    toolbar.classList.toggle('flex');
                },

                toggleSound: () => {
                    State.soundEnabled = !State.soundEnabled;
                    const btn = document.getElementById('btn-sound');
                    btn.innerHTML = State.soundEnabled 
                        ? '<i data-lucide="volume-2" class="w-5 h-5"></i>' 
                        : '<i data-lucide="volume-x" class="w-5 h-5 text-brand-pink"></i>';
                    lucide.createIcons();
                },

                celebrate: (id) => {
                    const card = document.getElementById(`card-${id}`);
                    if(!card) return;
                    const rect = card.getBoundingClientRect();
                    const x = (rect.left + rect.width / 2) / window.innerWidth;
                    const y = (rect.top + rect.height / 2) / window.innerHeight;

                    confetti({
                        particleCount: 60, spread: 50, origin: { x, y },
                        colors: ['#22C55E', '#F97316', '#FFFFFF']
                    });
                },
                
                // Main Render Function
                render: () => {
                    const container = document.getElementById('grid-container');
                    const emptyState = document.getElementById('empty-state');
                    
                    if(State.students.length === 0) {
                        emptyState.style.display = 'flex';
                        container.innerHTML = '';
                    } else {
                        emptyState.style.display = 'none';
                    }

                    Student.sort();

                    // 2. Generate Student Cards
                    container.innerHTML = State.students.map(s => {
                        
                        // Look up the correct border class based on the stored cardColor hex
                        const cardColorObj = State.CARD_COLORS.find(c => c.hex === s.cardColor) || { border: 'border-slate-400' };
                        // const cardBorderClass = `border-l-4 ${cardColorObj.border}`; // REMOVED
                        const cardRingColor = cardColorObj.ring.replace('/30', ''); // Use full ring color
                        
                        // Generate Logs HTML
                        const goodHtml = s.goodLogs.map((emoji, i) => 
                            `<span class="tally-item inline-block text-xl md:text-2xl animate-star-spin select-none" style="animation-delay: ${Math.min(i*0.05, 0.5)}s">${emoji}</span>`
                        ).join('');

                        const badHtml = s.badLogs.map((emoji) => 
                            `<span class="tally-item inline-block text-lg md:text-xl select-none">${emoji}</span>`
                        ).join('');

                        // Conditional Classes for effects (based on points, independent of chosen color)
                        let goodButtonClass = 'bg-brand-green/10 hover:bg-brand-green/20 text-brand-green border-brand-green/50';
                        let badButtonClass = 'bg-brand-pink/10 hover:bg-brand-pink/20 text-brand-pink border-brand-pink/50';
                        let cardAnimation = '';
                        let cardRingClass = '';

                        if(s.badLogs.length > 2) {
                            cardRingClass = `ring-4 ring-brand-pink/20`; 
                        }
                        if(s.goodLogs.length > 4) {
                            cardRingClass = `ring-4 ring-brand-green/20`;
                            if (s.goodLogs.length % 5 === 0) {
                                cardAnimation = 'animate-pulse-yellow'; // Uses the green pulsing keyframe now
                            }
                        }
                        
                        // Card Tally Log Area Style
                        const logAreaClass = 'bg-slate-100 shadow-inner shadow-black/10';
                        
                        // Student Name/Signature display 
                        const nameDisplay = s.signatureData 
                            ? `<img src="${s.signatureData}" alt="Student Signature" class="max-h-12 w-auto object-contain object-left scale-[1.3] transform origin-left" />`
                            : `<h3 class="text-xl font-bold truncate pr-4 text-slate-900">${s.name}</h3>`;


                        return `
                        <div id="card-${s.id}" class="app-panel rounded-xl flex flex-col relative group transition-all duration-300 ${cardRingClass} hover:shadow-lg min-h-[220px] shadow-sm ${cardAnimation} overflow-hidden">
                            
                            <!-- ID Card Header Band -->
                            <div class="h-4 w-full" style="background-color: ${s.cardColor};"></div>

                            <div class="p-4 flex flex-col flex-grow">
                            
                                <!-- Header (Displays Name/Signature and Remove Button) -->
                                <div class="flex justify-between items-start mb-3 h-12">
                                    <div class="w-full truncate pr-4 text-slate-900 font-bold text-2xl">${nameDisplay}</div>
                                    <button onclick="ClassTallyApp.Student.remove(${s.id})" class="text-slate-400 hover:text-brand-pink transition-colors opacity-0 group-hover:opacity-100 p-1 -mt-1 -mr-1">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <!-- Tally Area -->
                                <div class="flex-grow flex flex-col gap-2 mb-4 rounded-lg p-2 overflow-y-auto max-h-[150px] tally-container ${logAreaClass}">
                                    
                                    <!-- Good Logs -->
                                    <div class="flex flex-wrap content-start gap-1 min-h-[40px]">
                                        ${goodHtml || '<span class="text-slate-400 text-xs italic p-1 select-none">No positive marks yet</span>'}
                                    </div>
                                    
                                    <!-- Bad Logs (Separator) -->
                                    ${s.badLogs.length > 0 ? `<div class="h-[1px] bg-slate-200 w-full my-1"></div>` : ''}
                                    
                                    <div class="flex flex-wrap content-start gap-1">
                                        ${badHtml}
                                    </div>
                                </div>

                                <!-- Controls -->
                                <div class="grid grid-cols-2 gap-2 mt-auto">
                                    <button onclick="ClassTallyApp.Student.addPoint(${s.id}, 'good')" 
                                        class="border border-slate-200 ${goodButtonClass} py-3 rounded-lg flex items-center justify-center gap-2 transition-all active:scale-95 shadow-sm font-bold">
                                        <span class="text-xl">${State.currentGood}</span>
                                        <span class="text-sm hidden sm:inline">Good</span>
                                    </button>
                                    
                                    <button onclick="ClassTallyApp.Student.addPoint(${s.id}, 'bad')" 
                                        class="border border-slate-200 ${badButtonClass} py-3 rounded-lg flex items-center justify-center gap-2 transition-all active:scale-95 shadow-sm font-bold">
                                        <span class="text-xl">${State.currentBad}</span>
                                        <span class="text-sm hidden sm:inline">Bad</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Context Menu (Undo) - Position adjusted to top of inner content -->
                            <div class="absolute top-6 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/70 rounded-md backdrop-blur-sm px-2 py-0.5 border border-slate-200 shadow-sm">
                                 <button onclick="ClassTallyApp.Student.removeLastPoint(${s.id}, 'good')" class="p-0.5 text-brand-green/50 hover:text-brand-green text-xs font-sans transition-colors" title="Undo Good">Undo +</button>
                                 <button onclick="ClassTallyApp.Student.removeLastPoint(${s.id}, 'bad')" class="p-0.5 text-brand-pink/50 hover:text-brand-pink text-xs font-sans transition-colors" title="Undo Bad">Undo -</button>
                            </div>
                        </div>
                        `;
                    }).join('');

                    // 4. Re-create icons and pickers after DOM manipulation
                    lucide.createIcons();
                    UI.initEmojiPickers();
                }
            };

            // --- INIT ---
            const init = () => {
                Persistence.load();
                
                // Initialize canvas logic
                CanvasDraw.init('signature-canvas');

                UI.render();
                lucide.createIcons();

                document.addEventListener('click', UI.closeAllDropdowns);
            };

            // Expose public methods for use in HTML event handlers
            return {
                init,
                State,
                Student,
                UI,
                Audio,
                CanvasDraw
            };
        })();

        // Global initialization call
        window.onload = ClassTallyApp.init;
    </script>
</body>
</html>