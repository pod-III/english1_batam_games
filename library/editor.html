<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Manager | English 1 Batam</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Quill.js for Rich Text Editing -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                            yellow: '#FACC15',
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-hover': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #1e293b; 
            border-radius: 10px; 
        }

        input, select {
            border-width: 2px !important;
            border-color: #1e293b !important;
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
            transition: all 0.1s ease;
        }
        input:focus, select:focus {
            outline: none;
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        /* Neo-Brutalist Quill Styling */
        .ql-toolbar.ql-snow {
            border: 2px solid #1e293b !important;
            border-bottom: none !important;
            border-radius: 12px 12px 0 0 !important;
            background: #f1f5f9 !important;
            padding: 8px !important;
        }
        .ql-container.ql-snow {
            border: 2px solid #1e293b !important;
            border-radius: 0 0 12px 12px !important;
            box-shadow: 3px 3px 0px 0px rgba(30, 41, 59, 1);
            font-family: 'Nunito', sans-serif !important;
            font-size: 16px !important;
            background: white !important;
            min-height: 150px;
        }
        .ql-editor {
            min-height: 150px;
        }
    </style>
</head>
<body class="text-brand-dark font-body min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-brand-orange border-b-4 border-brand-dark p-4 sticky top-0 z-40 shadow-hard">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 bg-brand-chalk border-2 border-brand-dark rounded-xl px-4 py-2 shadow-hard-sm">
                <i data-lucide="settings" class="w-6 h-6 text-brand-orange"></i>
                <h1 class="font-heading text-xl font-bold tracking-wide">Library Data Manager</h1>
            </div>
            <a href="index.html" class="bg-brand-chalk border-2 border-brand-dark rounded-xl px-4 py-2 font-heading font-bold shadow-hard-sm hover:-translate-y-0.5 active:translate-y-0.5 transition-all flex items-center gap-2">
                <i data-lucide="external-link" class="w-4 h-4"></i> View Library
            </a>
        </div>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left: Controls & Book List -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- New Book Action -->
                <button onclick="resetForm()" class="w-full bg-brand-yellow border-4 border-brand-dark rounded-2xl py-4 font-heading text-xl font-bold text-brand-dark shadow-hard hover:-translate-y-1 hover:shadow-hard-hover active:translate-y-1 active:shadow-none transition-all flex justify-center items-center gap-3">
                    <i data-lucide="sparkles" class="w-6 h-6"></i> Add New Book
                </button>

                <!-- JSON Actions Card -->
                <div class="bg-brand-blue border-4 border-brand-dark rounded-2xl p-6 shadow-hard text-white">
                    <h3 class="font-heading text-xl font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="file-json"></i> JSON Control
                    </h3>
                    <div class="space-y-3">
                        <label class="block">
                            <span class="text-sm font-bold opacity-80">Import Existing File</span>
                            <input type="file" id="importJson" accept=".json" class="mt-1 block w-full text-sm text-slate-200 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-2 file:border-brand-dark file:text-sm file:font-bold file:bg-brand-chalk file:text-brand-dark hover:file:bg-brand-green cursor-pointer shadow-none border-none">
                        </label>
                        <button onclick="exportJson()" class="w-full bg-brand-green border-2 border-brand-dark rounded-xl py-3 font-heading font-bold text-brand-dark shadow-hard-sm hover:-translate-y-1 hover:shadow-hard active:translate-y-1 transition-all flex justify-center items-center gap-2">
                            <i data-lucide="download"></i> Download books.json
                        </button>
                    </div>
                </div>

                <!-- Current Books List -->
                <div class="bg-white border-4 border-brand-dark rounded-2xl shadow-hard flex flex-col h-[500px]">
                    <div class="p-4 border-b-4 border-brand-dark bg-brand-chalk flex justify-between items-center">
                        <h3 class="font-heading font-bold">Books in Session</h3>
                        <span id="bookCount" class="bg-brand-dark text-white text-xs px-2 py-1 rounded-lg">0</span>
                    </div>
                    <div id="sessionList" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar">
                        <p class="text-center text-slate-400 py-10 font-bold italic">No books loaded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Right: Input Form -->
            <div class="lg:col-span-8">
                <div class="bg-white border-4 border-brand-dark rounded-2xl shadow-hard overflow-hidden">
                    <div id="formHeader" class="bg-brand-pink border-b-4 border-brand-dark p-6 flex justify-between items-center transition-colors">
                        <h2 id="formTitle" class="font-heading text-2xl font-bold text-brand-dark flex items-center gap-2">
                            <i data-lucide="plus-circle"></i> Adding New Book
                        </h2>
                        <button onclick="resetForm()" class="text-xs font-bold uppercase tracking-widest text-brand-dark/60 hover:text-brand-dark flex items-center gap-1">
                             <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset Form
                        </button>
                    </div>

                    <form id="bookForm" class="p-6 md:p-8 space-y-8" onsubmit="saveBook(event)">
                        <!-- Metadata Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="font-bold text-sm">Book Title</label>
                                <input type="text" id="title" required placeholder="e.g. Atomic Habits" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-sm">Author Name</label>
                                <input type="text" id="author" required placeholder="e.g. James Clear" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-sm">Category</label>
                                <select id="category" class="w-full px-4 py-3 rounded-xl font-bold appearance-none bg-white">
                                    <option value="Pedagogy">Pedagogy</option>
                                    <option value="Literature">Literature</option>
                                    <option value="Psychology">Psychology</option>
                                    <option value="Self-Help">Self-Help</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-sm">Theme Color</label>
                                <select id="color" class="w-full px-4 py-3 rounded-xl font-bold appearance-none bg-white">
                                    <option value="green">Green (Success)</option>
                                    <option value="pink">Pink (Playful)</option>
                                    <option value="orange">Orange (Energy)</option>
                                    <option value="blue">Blue (Logic)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-sm">Lucide Icon Name</label>
                                <input type="text" id="icon" required placeholder="e.g. graduation-cap" class="w-full px-4 py-3 rounded-xl font-bold">
                            </div>
                        </div>

                        <!-- Synopsis -->
                        <div class="space-y-2">
                            <label class="font-bold text-sm">Quick Synopsis (Card Text)</label>
                            <input type="text" id="synopsis" required class="w-full px-4 py-3 rounded-xl font-bold" placeholder="A short teaser for the library card...">
                        </div>

                        <!-- Chapters Dynamic Section -->
                        <div class="space-y-4 border-t-4 border-brand-dark pt-6">
                            <div class="flex justify-between items-center">
                                <h3 class="font-heading text-xl font-bold">Chapters Breakdown</h3>
                                <button type="button" onclick="addChapterRow()" class="bg-brand-blue text-white border-2 border-brand-dark rounded-xl px-4 py-2 font-heading font-bold shadow-hard-sm hover:translate-y-[-2px] transition-all flex items-center gap-2">
                                    <i data-lucide="plus"></i> Add Chapter
                                </button>
                            </div>
                            
                            <div id="chaptersContainer" class="space-y-6">
                                <!-- Chapter rows added here -->
                            </div>
                        </div>

                        <button id="submitBtn" type="submit" class="w-full bg-brand-green border-4 border-brand-dark rounded-2xl py-4 font-heading text-2xl font-bold shadow-hard hover:-translate-y-1 hover:shadow-hard-hover active:translate-y-1 active:shadow-none transition-all mt-8">
                            Save Book to Session
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Overlay Message Box -->
    <div id="msgBox" class="fixed bottom-8 right-8 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-brand-dark text-white border-2 border-white rounded-xl px-6 py-3 shadow-hard font-bold flex items-center gap-3">
            <i data-lucide="info"></i> <span id="msgContent">Success!</span>
        </div>
    </div>

    <script>
        let sessionBooks = [];
        let editingId = null;
        let quillInstances = {}; // Track Quill editors by row ID

        // Initialize Icons
        lucide.createIcons();

        // --- JSON HANDLING ---
        document.getElementById('importJson').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    sessionBooks = JSON.parse(e.target.result);
                    updateSessionList();
                    showMsg("Library Imported Successfully!");
                } catch (err) {
                    showMsg("Invalid JSON file!", true);
                }
            };
            reader.readAsText(file);
        });

        function exportJson() {
            if (sessionBooks.length === 0) {
                showMsg("Nothing to export!", true);
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sessionBooks, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "books.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showMsg("File downloaded!");
        }

        // --- CHAPTER MANAGEMENT ---
        function addChapterRow(title = '', content = '') {
            const container = document.getElementById('chaptersContainer');
            const rowId = 'chap-' + Date.now() + Math.floor(Math.random() * 1000);
            
            const row = document.createElement('div');
            row.id = rowId;
            row.className = "bg-brand-chalk border-2 border-brand-dark rounded-xl p-4 space-y-4 relative chapter-row";
            row.innerHTML = `
                <button type="button" onclick="removeChapterRow('${rowId}')" class="absolute top-2 right-2 text-red-500 hover:scale-110 transition-transform z-10">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
                <div class="space-y-2">
                    <label class="text-xs font-black uppercase text-slate-400">Chapter Title</label>
                    <input type="text" value="${title}" required placeholder="Chapter 1: The Basics" class="w-full px-3 py-2 rounded-lg font-bold chap-title bg-white">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-black uppercase text-slate-400">Detailed Content</label>
                    <div id="editor-${rowId}" class="quill-editor"></div>
                </div>
            `;
            container.appendChild(row);
            
            // Initialize Quill
            const quill = new Quill(`#editor-${rowId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
            
            // Set initial content if editing
            if (content) {
                quill.root.innerHTML = content;
            }

            quillInstances[rowId] = quill;
            lucide.createIcons();
        }

        function removeChapterRow(id) {
            delete quillInstances[id];
            document.getElementById(id).remove();
        }

        // --- FORM LOGIC ---
        function saveBook(e) {
            e.preventDefault();

            const chapterRows = document.querySelectorAll('.chapter-row');
            const chapters = Array.from(chapterRows).map(row => {
                const quill = quillInstances[row.id];
                return {
                    title: row.querySelector('.chap-title').value,
                    detailedContent: quill.root.innerHTML // Grab HTML from Quill
                };
            });

            if (chapters.length === 0) {
                showMsg("Add at least one chapter!", true);
                return;
            }

            const bookData = {
                id: editingId || Date.now(),
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                category: document.getElementById('category').value,
                color: document.getElementById('color').value,
                icon: document.getElementById('icon').value,
                synopsis: document.getElementById('synopsis').value,
                chapters: chapters
            };

            if (editingId) {
                const idx = sessionBooks.findIndex(b => b.id === editingId);
                sessionBooks[idx] = bookData;
                editingId = null;
                showMsg("Book updated!");
            } else {
                sessionBooks.push(bookData);
                showMsg("Book added to session!");
            }

            resetForm();
            updateSessionList();
        }

        function editBook(id) {
            const book = sessionBooks.find(b => b.id === id);
            if (!book) return;

            editingId = id;
            
            // UI Feedback
            const formTitle = document.getElementById('formTitle');
            const formHeader = document.getElementById('formHeader');
            const submitBtn = document.getElementById('submitBtn');
            
            formTitle.innerHTML = `<i data-lucide="edit"></i> Editing: ${book.title}`;
            formHeader.classList.replace('bg-brand-pink', 'bg-brand-blue');
            submitBtn.innerText = "Update Book in Session";
            submitBtn.classList.replace('bg-brand-green', 'bg-brand-orange');

            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.author;
            document.getElementById('category').value = book.category;
            document.getElementById('color').value = book.color;
            document.getElementById('icon').value = book.icon;
            document.getElementById('synopsis').value = book.synopsis;

            const container = document.getElementById('chaptersContainer');
            container.innerHTML = '';
            quillInstances = {}; // Clear previous instances
            
            book.chapters.forEach(c => addChapterRow(c.title, c.detailedContent));

            window.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        }

        function deleteBook(id) {
            if (!confirm("Remove this book from session?")) return;
            sessionBooks = sessionBooks.filter(b => b.id !== id);
            if (editingId === id) resetForm();
            updateSessionList();
            showMsg("Book removed.");
        }

        function resetForm() {
            editingId = null;
            document.getElementById('bookForm').reset();
            document.getElementById('chaptersContainer').innerHTML = '';
            quillInstances = {};
            
            // Reset UI to "Add Mode"
            const formTitle = document.getElementById('formTitle');
            const formHeader = document.getElementById('formHeader');
            const submitBtn = document.getElementById('submitBtn');
            
            formTitle.innerHTML = `<i data-lucide="plus-circle"></i> Adding New Book`;
            formHeader.classList.replace('bg-brand-blue', 'bg-brand-pink');
            submitBtn.innerText = "Save Book to Session";
            submitBtn.classList.replace('bg-brand-orange', 'bg-brand-green');

            addChapterRow(); 
            lucide.createIcons();
        }

        function updateSessionList() {
            const list = document.getElementById('sessionList');
            const count = document.getElementById('bookCount');
            count.innerText = sessionBooks.length;

            if (sessionBooks.length === 0) {
                list.innerHTML = `<p class="text-center text-slate-400 py-10 font-bold italic">No books loaded yet.</p>`;
                return;
            }

            list.innerHTML = sessionBooks.map(b => `
                <div class="bg-white border-2 border-brand-dark rounded-xl p-3 shadow-hard-sm flex justify-between items-center group ${editingId === b.id ? 'border-brand-blue ring-2 ring-brand-blue/20' : ''}">
                    <div class="truncate">
                        <p class="font-bold truncate text-sm">${b.title}</p>
                        <p class="text-[10px] font-black text-brand-blue uppercase">${b.category}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editBook(${b.id})" class="p-2 bg-brand-chalk hover:bg-brand-blue hover:text-white border-2 border-brand-dark rounded-lg transition-colors">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteBook(${b.id})" class="p-2 bg-brand-chalk hover:bg-brand-pink hover:text-white border-2 border-brand-dark rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function showMsg(txt, isError = false) {
            const box = document.getElementById('msgBox');
            const content = document.getElementById('msgContent');
            content.innerText = txt;
            
            box.querySelector('div').className = isError 
                ? "bg-red-500 text-white border-2 border-brand-dark rounded-xl px-6 py-3 shadow-hard font-bold flex items-center gap-3"
                : "bg-brand-dark text-white border-2 border-white rounded-xl px-6 py-3 shadow-hard font-bold flex items-center gap-3";

            box.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                box.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Initialize with one chapter row
        window.onload = () => {
            addChapterRow();
        };
    </script>
</body>
</html>