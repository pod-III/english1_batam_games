<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Search Creator | English 1 Batam</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#1e293b',
                        chalk: '#f8fafc',
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    borderWidth: {
                        '3': '3px',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc;
            /* Graph Paper Pattern */
            background-image: 
                linear-gradient(#e2e8f0 1px, transparent 1px), 
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            color: #1e293b;
        }

        /* Neo-Brutalism Base Classes */
        .neo-card {
            background: white;
            border: 3px solid #1e293b;
            border-radius: 1rem;
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-btn {
            border: 3px solid #1e293b;
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
            transition: all 0.15s ease;
            transform: translate(0, 0);
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
        }

        .neo-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
        }

        .neo-input {
            border: 3px solid #1e293b;
            border-radius: 0.75rem;
            background: #f1f5f9;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .neo-input:focus {
            background: white;
            outline: none;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.05), 0 0 0 2px #2979FF;
        }

        /* Grid System */
        .grid-cell {
            background: white;
            border: 2px solid #1e293b;
            color: #1e293b;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            position: relative;
        }

        /* Active/Preview States */
        .grid-cell.active-start {
            background: #2979FF !important;
            color: white !important;
            transform: scale(1.1);
            z-index: 20;
            border-color: #1e293b;
        }

        .grid-cell.preview-line {
            background: #bfdbfe; /* Light Blue */
            color: #1e293b;
        }

        /* Result States */
        .grid-cell.found {
            background: #00E676 !important;
            color: #1e293b !important;
            animation: pop 0.4s ease;
            z-index: 5;
        }

        .grid-cell.revealed {
            background: #FF6B95 !important;
            color: white !important;
            opacity: 0.8;
            animation: pop 0.4s ease;
        }

        .grid-cell.error {
            background: #FF6B95 !important;
            color: white !important;
            animation: shake 0.4s;
        }
        
        .grid-cell.locked {
            cursor: default;
            pointer-events: none;
        }

        /* Word Bank */
        .word-tag {
            transition: all 0.3s ease;
        }
        .word-tag.found {
            text-decoration: line-through;
            background: #00E676;
            color: #1e293b;
            border-color: #1e293b;
            opacity: 1;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- PRINT STYLES --- */
        @media print {
            body { 
                background: white; 
                background-image: none; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                margin: 0; padding: 0;
            }
            @page { size: A4; margin: 1cm; }
            
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            main { padding: 0 !important; width: 100%; max-width: 100%; }

            #game-container {
                box-shadow: none; border: none; background: none;
                display: block; width: 100%; padding: 0 !important;
            }
            
            .lg\:flex-row { flex-direction: column !important; gap: 1rem !important; }
            .lg\:w-1\/3, .lg\:w-2\/3 { width: 100% !important; }
            
            /* High contrast print grid */
            #word-grid {
                border: 3px solid black; 
                gap: 0 !important; 
                background: white;
                max-width: 100% !important;
                margin: 0 auto;
            }

            .grid-cell {
                background: white !important; color: black !important;
                border: 1px solid black !important; border-radius: 0 !important;
                box-shadow: none !important; animation: none !important;
                font-size: 12pt !important;
            }
            
            /* Print Header */
            .print-header {
                border-bottom: 3px solid black;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="w-full bg-white border-b-3 border-dark sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue w-12 h-12 rounded-xl border-3 border-dark flex items-center justify-center shadow-hard-sm">
                    <i data-lucide="grid" class="text-white w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-heading text-dark leading-none mt-1">WORD SEARCH</h1>
                    <div class="text-xs font-bold text-gray-500 tracking-widest">ENGLISH 1 BATAM</div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="give-up-btn" class="p-2 rounded-xl hover:bg-orange/10 border-2 border-transparent hover:border-orange transition-colors text-orange relative group" title="Give Up & Reveal">
                    <i data-lucide="flag" class="w-6 h-6"></i>
                </button>
                <button onclick="window.print()" class="p-2 rounded-xl hover:bg-blue/10 border-2 border-transparent hover:border-blue transition-colors text-blue" title="Print Worksheet">
                    <i data-lucide="printer" class="w-6 h-6"></i>
                </button>
                <button id="setup-btn" class="neo-btn bg-pink text-white px-6 py-2 rounded-xl text-lg flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-5 h-5"></i> SETUP
                </button>
            </div>
        </div>
    </header>

    <div class="print-only hidden w-full max-w-4xl mx-auto print-header">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black font-heading uppercase">Word Search</h1>
                <p class="text-sm text-gray-600">Find the hidden words in the grid below.</p>
            </div>
            <div class="text-right">
                <div class="mb-2">Name: __________________________</div>
                <div>Date: __________________________</div>
            </div>
        </div>
    </div>

    <main class="flex-grow flex justify-center w-full p-4 lg:p-8">
        
        <div id="game-container" class="w-full max-w-7xl flex flex-col lg:flex-row items-start gap-8">
            
            <div class="w-full lg:w-1/3 flex-none flex flex-col order-2 lg:order-1 gap-6">
                
                <div class="neo-card p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-pink border-b-3 border-dark"></div>
                    
                    <h3 class="text-xl font-heading text-dark mb-4 flex items-center gap-2 mt-2">
                        <i data-lucide="list" class="w-5 h-5"></i>
                        VOCABULARY
                    </h3>
                    
                    <div id="word-bank" class="flex flex-wrap gap-2 max-h-[40vh] overflow-y-auto pr-2">
                        </div>
                    
                    <div id="empty-bank-msg" class="text-center py-8 text-gray-400 hidden">
                        <p>No words loaded.</p>
                    </div>
                </div>

                <div id="play-controls" class="neo-card p-6 hidden relative">
                     <div class="absolute top-0 left-0 w-full h-2 bg-green border-b-3 border-dark"></div>
                    
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-gray-400 uppercase">Progress</span>
                            <div class="flex items-baseline gap-1">
                                <span id="found-count" class="text-green font-heading text-4xl">0</span>
                                <span class="text-gray-400 font-bold text-xl">/</span>
                                <span id="total-count" class="text-dark font-bold text-xl">0</span>
                            </div>
                        </div>
                        <button id="play-again-btn" class="hidden neo-btn bg-green text-white px-4 py-2 rounded-xl text-sm">
                            PLAY AGAIN
                        </button>
                    </div>
                    
                    <div id="status-bar" class="text-center text-sm font-bold text-blue bg-blue/10 border-2 border-blue px-3 py-2 rounded-lg">
                        Tap First Letter ‚ûî Tap Last Letter
                    </div>
                </div>
                
                <div id="empty-state-cta" class="text-center py-8">
                    <div class="bg-white inline-flex p-4 rounded-full border-3 border-dark shadow-hard mb-4">
                        <i data-lucide="search" class="w-10 h-10 text-blue"></i>
                    </div>
                    <h2 class="text-2xl font-heading text-dark mb-2">Ready to Teach?</h2>
                    <p class="text-gray-600 mb-6 max-w-xs mx-auto">Create a custom word search puzzle for your students in seconds.</p>
                    <button onclick="document.getElementById('setup-btn').click()" class="neo-btn bg-orange text-white px-8 py-3 rounded-xl text-lg w-full max-w-xs mx-auto">
                        Create Puzzle
                    </button>
                </div>
            </div>


            <div class="w-full lg:w-2/3 flex-none flex flex-col items-center order-1 lg:order-2">

                <div class="neo-card p-4 bg-white w-full max-w-[700px]"> 
                    <div id="word-grid" class="grid gap-1 bg-slate-100 p-2 border-3 border-dark rounded-lg w-full aspect-square">
                        </div>
                </div>

            </div>
        </div>
    </main>

    <div id="confirm-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-pop">
        <div class="neo-card max-w-sm w-full p-8 text-center border-orange">
            <div class="flex justify-center mb-4">
                <div class="bg-orange/20 p-4 rounded-full border-3 border-orange text-orange">
                    <i data-lucide="flag" class="w-10 h-10"></i>
                </div>
            </div>
            <h3 class="text-2xl font-heading text-dark mb-2">Give Up?</h3>
            <p class="text-gray-500 mb-8">This will end the current game and reveal all the hidden answers.</p>
            <div class="flex flex-col gap-3">
                <button id="cancel-reveal" class="neo-btn bg-white text-dark border-dark px-6 py-3 rounded-xl">Keep Playing</button>
                <button id="confirm-reveal" class="neo-btn bg-orange text-white px-6 py-3 rounded-xl">Reveal Answers</button>
            </div>
        </div>
    </div>

    <div id="setup-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-pop">
        <div class="neo-card w-full max-w-xl shadow-2xl flex flex-col max-h-[90vh]">
            
            <div class="p-6 border-b-3 border-dark flex justify-between items-center bg-gray-50 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <div class="bg-pink text-white p-2 rounded-lg border-2 border-dark">
                        <i data-lucide="settings-2" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-2xl font-heading text-dark mt-1">PUZZLE SETUP</h2>
                </div>
                <button id="close-setup" class="text-gray-400 hover:text-dark transition">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <div class="p-6 space-y-8 overflow-y-auto">
                
                <div>
                    <div class="flex justify-between items-end mb-3">
                        <label class="text-sm font-bold text-dark uppercase tracking-wider">Grid Size</label>
                        <span id="size-display" class="font-heading text-xl text-blue">10x10</span>
                    </div>
                    <input type="range" id="size-slider" min="6" max="14" value="10" class="w-full h-3 bg-gray-200 rounded-full appearance-none cursor-pointer accent-blue border-2 border-dark">
                    <div class="flex justify-between text-xs font-bold text-gray-400 mt-2">
                        <span>EASY (6)</span>
                        <span>HARD (14)</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-bold text-dark uppercase tracking-wider">Vocabulary List</label>
                    <textarea id="word-input" 
                        class="neo-input w-full h-32 p-4 text-dark font-mono text-sm resize-none"
                        placeholder="Enter words separated by commas...&#10;Example: APPLE, BANANA, ORANGE, GRAPE"></textarea>
                    <p class="text-xs text-gray-500 text-right">Duplicates and words longer than grid size will be removed.</p>
                </div>
                
                <div>
                    <label class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 block">Quick Presets</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="preset-btn px-4 py-2 bg-white hover:bg-pink/10 border-2 border-dark rounded-lg text-sm font-bold transition transform active:scale-95" data-words="RED, BLUE, GREEN, PINK, ORANGE, BLACK, WHITE">üé® Colors</button>
                        <button class="preset-btn px-4 py-2 bg-white hover:bg-pink/10 border-2 border-dark rounded-lg text-sm font-bold transition transform active:scale-95" data-words="LION, TIGER, BEAR, WOLF, ZEBRA, MONKEY">ü¶Å Animals</button>
                        <button class="preset-btn px-4 py-2 bg-white hover:bg-pink/10 border-2 border-dark rounded-lg text-sm font-bold transition transform active:scale-95" data-words="RUN, JUMP, SWIM, READ, WRITE, SPEAK">üèÉ Verbs</button>
                        <button class="preset-btn px-4 py-2 bg-white hover:bg-pink/10 border-2 border-dark rounded-lg text-sm font-bold transition transform active:scale-95" data-words="ONE, TWO, THREE, FOUR, FIVE, SIX, SEVEN">üî¢ Numbers</button>
                    </div>
                </div>

            </div>

            <div class="p-6 border-t-3 border-dark bg-gray-50 rounded-b-xl">
                <button id="generate-btn" class="neo-btn bg-blue text-white w-full py-4 rounded-xl font-heading text-xl hover:brightness-110">
                    GENERATE PUZZLE
                </button>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const playTone = (freq, type, duration) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };

        const Sound = {
            tap: () => playTone(600, 'sine', 0.1),
            success: () => {
                playTone(500, 'triangle', 0.1);
                setTimeout(() => playTone(1000, 'triangle', 0.2), 100);
            },
            error: () => playTone(150, 'sawtooth', 0.2),
            win: () => [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'square', 0.2), i * 100))
        };
    </script>

    <script>
        // Init Icons
        lucide.createIcons();

        // --- LOCAL STORAGE KEYS ---
        const LS_KEY_WORDS = 'wordSearchWords_E1';
        const LS_KEY_SIZE = 'wordSearchSize_E1';

        // State Management
        const State = {
            grid: [],
            solutions: new Set(),
            validWords: new Set(),
            foundWords: new Set(),
            selectionStart: null,
            isActive: false,
            totalWords: 0
        };

        // DOM Elements
        const DOM = {
            grid: document.getElementById('word-grid'),
            bank: document.getElementById('word-bank'),
            input: document.getElementById('word-input'),
            slider: document.getElementById('size-slider'),
            sizeDisp: document.getElementById('size-display'),
            foundCount: document.getElementById('found-count'),
            totalCount: document.getElementById('total-count'),
            statusBar: document.getElementById('status-bar'),
            playAgain: document.getElementById('play-again-btn'),
            modals: {
                setup: document.getElementById('setup-modal'),
                confirm: document.getElementById('confirm-modal')
            },
            controls: document.getElementById('play-controls'),
            emptyStateCta: document.getElementById('empty-state-cta'),
            emptyBankMsg: document.getElementById('empty-bank-msg')
        };
        
        // --- PERSISTENCE ---
        function saveInputs() {
             try {
                localStorage.setItem(LS_KEY_WORDS, DOM.input.value);
                localStorage.setItem(LS_KEY_SIZE, DOM.slider.value);
            } catch (e) { console.error(e); }
        }

        function loadInputs() {
            try {
                const savedWords = localStorage.getItem(LS_KEY_WORDS);
                const savedSize = localStorage.getItem(LS_KEY_SIZE);
                if (savedWords) DOM.input.value = savedWords;
                if (savedSize) {
                    DOM.slider.value = savedSize;
                    DOM.sizeDisp.innerText = `${savedSize}x${savedSize}`;
                }
            } catch (e) { console.error(e); }
        }

        // --- SETUP HANDLERS ---
        document.getElementById('setup-btn').onclick = () => DOM.modals.setup.classList.remove('hidden');
        document.getElementById('close-setup').onclick = () => DOM.modals.setup.classList.add('hidden');
        
        DOM.slider.oninput = (e) => {
            const val = e.target.value;
            DOM.sizeDisp.innerText = `${val}x${val}`;
            saveInputs();
        };

        DOM.input.oninput = () => saveInputs();

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.onclick = (e) => {
                DOM.input.value = e.target.dataset.words;
                saveInputs();
            };
        });

        document.getElementById('generate-btn').onclick = () => {
            const raw = DOM.input.value;
            const size = parseInt(DOM.slider.value);
            saveInputs(); 
            
            const words = raw.split(',')
                .map(w => w.trim().toUpperCase())
                .filter(w => w.length > 0 && w.length <= size);

            const uniqueWords = [...new Set(words)];

            if(uniqueWords.length < 1) {
                alert("Please enter valid words that fit in the grid.");
                return;
            }

            initGame(size, uniqueWords);
            DOM.modals.setup.classList.add('hidden');
        };

        // --- GAME CORE ---
        function initGame(size, words) {
            State.grid = Array(size).fill(null).map(() => Array(size).fill(''));
            State.solutions.clear();
            State.validWords = new Set();
            State.foundWords.clear();
            State.isActive = true;
            State.selectionStart = null;
            State.totalWords = 0;

            words.sort((a,b) => b.length - a.length);

            const placedWords = [];
            words.forEach(word => {
                if(placeWordInGrid(word, size)) {
                    placedWords.push(word);
                    State.validWords.add(word); 
                }
            });
            State.totalWords = placedWords.length;
            
            DOM.emptyStateCta.classList.add('hidden');
            DOM.controls.classList.remove('hidden');

            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for(let r=0; r<size; r++) {
                for(let c=0; c<size; c++) {
                    if(State.grid[r][c] === '') {
                        State.grid[r][c] = alphabet[Math.floor(Math.random() * alphabet.length)];
                    }
                }
            }

            renderGrid(size);
            renderWordBank(placedWords);
            updateHUD();

            Sound.success(); // Using success sound as start sound
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#2979FF', '#FF6B95', '#FF8C42'] });
        }

        function placeWordInGrid(word, size) {
            const directions = [
                {r:0, c:1}, {r:1, c:0}, {r:1, c:1}, {r:-1, c:1}, 
                {r:0, c:-1}, {r:-1, c:0}, {r:-1, c:-1}, {r:1, c:-1}
            ];
            
            for(let attempt=0; attempt<100; attempt++) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const startR = Math.floor(Math.random() * size);
                const startC = Math.floor(Math.random() * size);

                const endR = startR + (dir.r * (word.length - 1));
                const endC = startC + (dir.c * (word.length - 1));
                if(endR < 0 || endR >= size || endC < 0 || endC >= size) continue;

                let collision = false;
                for(let i=0; i<word.length; i++) {
                    const r = startR + (dir.r * i);
                    const c = startC + (dir.c * i);
                    const cell = State.grid[r][c];
                    if(cell !== '' && cell !== word[i]) {
                        collision = true; break;
                    }
                }

                if(!collision) {
                    for(let i=0; i<word.length; i++) {
                        const r = startR + (dir.r * i);
                        const c = startC + (dir.c * i);
                        State.grid[r][c] = word[i];
                        State.solutions.add(`${r},${c}`);
                    }
                    return true;
                }
            }
            return false;
        }

        function renderGrid(size) {
            DOM.grid.style.gridTemplateColumns = `repeat(${size}, minmax(0, 1fr))`;
            DOM.grid.innerHTML = '';
            
            // Font scaling based on grid density
            const baseSize = size > 12 ? 'text-sm' : (size > 8 ? 'text-lg' : 'text-xl');
            
            for(let r=0; r<size; r++) {
                for(let c=0; c<size; c++) {
                    const cell = document.createElement('div');
                    cell.className = `grid-cell aspect-square ${baseSize}`;
                    cell.innerText = State.grid[r][c];
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    cell.onmousedown = () => handleInput(r, c, cell);
                    cell.ontouchstart = (e) => { e.preventDefault(); handleInput(r, c, cell); };
                    cell.onmouseenter = () => handleHover(r, c);
                    
                    DOM.grid.appendChild(cell);
                }
            }
        }

        function renderWordBank(words) {
            DOM.bank.innerHTML = '';
            if(words.length === 0) {
                DOM.emptyBankMsg.classList.remove('hidden');
                return;
            }
            DOM.emptyBankMsg.classList.add('hidden');
            
            words.sort().forEach(w => {
                const tag = document.createElement('div');
                tag.className = 'word-tag px-3 py-1 bg-gray-100 border-2 border-dark rounded text-sm font-bold text-gray-500';
                tag.innerText = w;
                tag.id = `tag-${w}`;
                DOM.bank.appendChild(tag);
            });
        }

        function updateHUD() {
            DOM.foundCount.innerText = State.foundWords.size;
            DOM.totalCount.innerText = State.totalWords;
            
            if(State.foundWords.size === State.totalWords) {
                endGame(true);
            }
        }

        // --- INTERACTION LOGIC ---
        function handleInput(r, c, el) {
            if(!State.isActive || el.classList.contains('locked')) return;

            if(!State.selectionStart) {
                State.selectionStart = { r, c, el };
                el.classList.add('active-start');
                Sound.tap();
                return;
            }

            if(State.selectionStart.r === r && State.selectionStart.c === c) {
                clearSelection();
                return;
            }
            checkMatch(State.selectionStart, { r, c, el });
        }

        function handleHover(r, c) {
            if(!State.selectionStart || !State.isActive) return;
            document.querySelectorAll('.preview-line').forEach(el => el.classList.remove('preview-line'));
            const path = getLineCells(State.selectionStart, {r, c});
            if(path) {
                path.forEach(pos => {
                    const cell = getCell(pos.r, pos.c);
                    if(cell && !cell.classList.contains('found')) {
                        cell.classList.add('preview-line');
                    }
                });
            }
        }

        function checkMatch(start, end) {
            const path = getLineCells(start, end);
            
            if(!path) {
                Sound.error();
                end.el.classList.add('error');
                setTimeout(() => end.el.classList.remove('error'), 400);
                clearSelection();
                return;
            }

            const word = path.map(p => State.grid[p.r][p.c]).join('');
            const reversed = word.split('').reverse().join('');
            
            let match = null;
            if(State.validWords.has(word) && !State.foundWords.has(word)) match = word;
            else if(State.validWords.has(reversed) && !State.foundWords.has(reversed)) match = reversed;

            if(match) {
                Sound.success();
                path.forEach((p, i) => {
                    const cell = getCell(p.r, p.c);
                    setTimeout(() => cell.classList.add('found'), i * 30);
                });
                
                document.getElementById(`tag-${match}`).classList.add('found');
                State.foundWords.add(match);
                updateHUD();
                clearSelection();
            } else {
                Sound.error();
                path.forEach(p => {
                    const cell = getCell(p.r, p.c);
                    cell.classList.add('error');
                    setTimeout(() => cell.classList.remove('error'), 400);
                });
                clearSelection();
            }
        }

        function getLineCells(start, end) {
            const dr = end.r - start.r;
            const dc = end.c - start.c;
            if(dr !== 0 && dc !== 0 && Math.abs(dr) !== Math.abs(dc)) return null;

            const steps = Math.max(Math.abs(dr), Math.abs(dc));
            const rStep = dr === 0 ? 0 : dr / steps;
            const cStep = dc === 0 ? 0 : dc / steps;

            const path = [];
            for(let i=0; i<=steps; i++) {
                path.push({ r: start.r + (rStep*i), c: start.c + (cStep*i) });
            }
            return path;
        }

        function getCell(r, c) {
            return document.querySelector(`.grid-cell[data-r="${r}"][data-c="${c}"]`);
        }

        function clearSelection() {
            if(State.selectionStart) {
                State.selectionStart.el.classList.remove('active-start');
                State.selectionStart = null;
            }
            document.querySelectorAll('.preview-line').forEach(el => el.classList.remove('preview-line'));
        }

        // --- GAME OVER ---
        document.getElementById('give-up-btn').onclick = () => {
            if(!State.isActive) return;
            DOM.modals.confirm.classList.remove('hidden');
        };

        document.getElementById('cancel-reveal').onclick = () => DOM.modals.confirm.classList.add('hidden');
        
        document.getElementById('confirm-reveal').onclick = () => {
            DOM.modals.confirm.classList.add('hidden');
            endGame(false);
        };

        document.getElementById('play-again-btn').onclick = () => document.getElementById('setup-btn').click();

        function endGame(won) {
            State.isActive = false;
            
            if(won) {
                Sound.win();
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#00E676', '#2979FF', '#FF6B95'] });
                DOM.statusBar.innerText = "YOU WON! AMAZING WORK!";
                DOM.statusBar.className = "text-center text-sm font-bold text-green bg-green/10 border-2 border-green px-3 py-2 rounded-lg";
            } else {
                Sound.error();
                DOM.statusBar.innerText = "GAME OVER - ANSWERS REVEALED";
                DOM.statusBar.className = "text-center text-sm font-bold text-orange bg-orange/10 border-2 border-orange px-3 py-2 rounded-lg";
                
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    const key = `${cell.dataset.r},${cell.dataset.c}`;
                    if(State.solutions.has(key) && !cell.classList.contains('found')) {
                        cell.classList.add('revealed');
                    }
                    cell.classList.add('locked');
                });
            }

            DOM.playAgain.classList.remove('hidden');
            clearSelection();
        }

        // --- INIT ---
        window.onload = () => {
            loadInputs();
            DOM.controls.classList.add('hidden');
            DOM.emptyStateCta.classList.remove('hidden');
            DOM.modals.setup.classList.remove('hidden');
        };

    </script>
</body>
</html>