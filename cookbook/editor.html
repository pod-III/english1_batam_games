<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Manager | English 1 Batam</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Quill.js for Rich Text Editing -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                            yellow: '#FACC15',
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .neo-border { border: 3px solid #1e293b; }
        .neo-shadow { box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1); }
        .neo-shadow-sm { box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1); }
        
        .neo-btn {
            transition: all 0.1s ease;
        }
        .neo-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }
        .neo-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
        }

        input, select, textarea {
            border: 2px solid #1e293b !important;
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
            transition: all 0.1s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
            transform: translate(-1px, -1px);
        }

        .ql-toolbar.ql-snow { border: 2px solid #1e293b !important; border-bottom: none !important; border-radius: 12px 12px 0 0; background: #f1f5f9; }
        .ql-container.ql-snow { border: 2px solid #1e293b !important; border-radius: 0 0 12px 12px; background: white; font-family: 'Nunito', sans-serif !important; font-size: 16px; }

        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #1e293b; 
            border-radius: 10px; 
            border: 2px solid #f8fafc;
        }
    </style>
</head>
<body class="text-brand-dark font-body min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-brand-pink border-b-4 border-brand-dark p-4 sticky top-0 z-40 neo-shadow text-brand-dark">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 bg-brand-chalk border-2 border-brand-dark rounded-xl px-4 py-2 neo-shadow-sm">
                <i data-lucide="utensils" class="w-6 h-6 text-brand-pink"></i>
                <h1 class="font-heading text-xl font-bold">Recipe Data Manager</h1>
            </div>
            <div class="flex gap-3">
                 <button onclick="exportJson()" class="bg-brand-green border-2 border-brand-dark rounded-xl px-4 py-2 font-heading font-bold neo-shadow-sm neo-btn flex items-center gap-2 text-brand-dark">
                    <i data-lucide="download" class="w-4 h-4"></i> Export recipes.json
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-6">
                <button onclick="resetForm()" class="w-full bg-brand-yellow border-4 border-brand-dark rounded-2xl py-4 font-heading text-xl font-bold neo-shadow neo-btn flex justify-center items-center gap-3">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i> Add New Recipe
                </button>

                <div class="bg-brand-blue border-4 border-brand-dark rounded-2xl p-5 neo-shadow text-white">
                    <input type="file" id="importFile" accept=".json" class="hidden">
                    <button onclick="document.getElementById('importFile').click()" class="w-full bg-brand-chalk text-brand-dark border-2 border-brand-dark rounded-xl py-3 font-heading font-bold neo-shadow-sm neo-btn flex justify-center items-center gap-2">
                        <i data-lucide="file-up" class="w-5 h-5"></i> Import JSON
                    </button>
                </div>

                <div class="bg-white border-4 border-brand-dark rounded-2xl neo-shadow flex flex-col h-[600px]">
                    <div class="p-4 border-b-4 border-brand-dark bg-brand-chalk font-heading font-bold flex justify-between items-center">
                        <span>Stored Recipes</span>
                        <span id="recipeCount" class="bg-brand-dark text-white px-2 py-1 rounded-lg text-xs">0</span>
                    </div>
                    <div id="recipeList" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
                </div>
            </div>

            <!-- Form Panel -->
            <div class="lg:col-span-8">
                <div class="bg-white border-4 border-brand-dark rounded-2xl neo-shadow overflow-hidden">
                    <div id="formHeader" class="bg-brand-green border-b-4 border-brand-dark p-6 flex justify-between items-center transition-colors">
                        <h2 id="formTitle" class="font-heading text-2xl font-bold flex items-center gap-3 text-brand-dark">
                            <i data-lucide="chef-hat"></i> Adding New Recipe
                        </h2>
                    </div>

                    <form id="recipeForm" class="p-6 md:p-8 space-y-10" onsubmit="saveRecipe(event)">
                        
                        <!-- 1. Basic Info -->
                        <div class="space-y-6">
                            <h3 class="font-heading text-xl font-bold border-b-2 border-brand-dark pb-1 uppercase tracking-tight">1. Basic Info</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="font-bold text-sm uppercase text-slate-500">Recipe ID (Slug)</label>
                                    <input type="text" id="recipeId" required placeholder="apple-crumble" class="w-full px-4 py-3 rounded-xl font-bold">
                                </div>
                                <div class="space-y-2">
                                    <label class="font-bold text-sm uppercase text-slate-500">Main Title</label>
                                    <input type="text" id="title" required placeholder="Mini Apple Crumble" class="w-full px-4 py-3 rounded-xl font-bold">
                                </div>
                                <div class="space-y-2">
                                    <label class="font-bold text-sm uppercase text-slate-500">Subtitle</label>
                                    <input type="text" id="subtitle" required placeholder="Dessert Mission" class="w-full px-4 py-3 rounded-xl font-bold">
                                </div>
                                <div class="space-y-2">
                                    <label class="font-bold text-sm uppercase text-slate-500">Level & Color</label>
                                    <div class="flex gap-2">
                                        <select id="level" class="flex-grow px-4 py-3 rounded-xl font-bold bg-white">
                                            <option value="Beginner">Beginner</option>
                                            <option value="Intermediate">Intermediate</option>
                                            <option value="Advanced">Advanced</option>
                                        </select>
                                        <select id="color" class="px-4 py-3 rounded-xl font-bold bg-white">
                                            <option value="e1pink">Pink</option>
                                            <option value="e1orange">Orange</option>
                                            <option value="e1green">Green</option>
                                            <option value="e1blue">Blue</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-sm uppercase text-slate-500">Quick Description</label>
                                <textarea id="desc" required rows="2" class="w-full px-4 py-3 rounded-xl font-bold resize-none"></textarea>
                            </div>
                        </div>

                        <!-- 2. Metadata -->
                        <div class="space-y-4">
                            <h3 class="font-heading text-xl font-bold border-b-2 border-brand-dark pb-1 flex justify-between items-center uppercase tracking-tight">
                                2. Metadata
                                <button type="button" onclick="addMeta()" class="text-[10px] bg-brand-blue text-white px-3 py-1 rounded-lg neo-shadow-sm">+ Add</button>
                            </h3>
                            <div id="metaContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                        </div>

                        <!-- 3. Loadout -->
                        <div class="space-y-4">
                            <h3 class="font-heading text-xl font-bold border-b-2 border-brand-dark pb-1 flex justify-between items-center uppercase tracking-tight">
                                3. The Loadout
                                <button type="button" onclick="addLoadoutGroup()" class="text-[10px] bg-brand-orange text-white px-3 py-1 rounded-lg neo-shadow-sm">+ Add Group</button>
                            </h3>
                            <div id="loadoutContainer" class="space-y-6"></div>
                        </div>

                        <!-- 4. Vocabulary -->
                        <div class="space-y-4">
                            <h3 class="font-heading text-xl font-bold border-b-2 border-brand-dark pb-1 flex justify-between items-center uppercase tracking-tight">
                                4. Classroom Vocabulary
                                <button type="button" onclick="addVocab()" class="text-[10px] bg-brand-pink text-white px-3 py-1 rounded-lg neo-shadow-sm">+ Add Vocab</button>
                            </h3>
                            <div id="vocabContainer" class="space-y-4"></div>
                        </div>

                        <!-- 5. Steps -->
                        <div class="space-y-6">
                            <h3 class="font-heading text-xl font-bold border-b-2 border-brand-dark pb-1 flex justify-between items-center uppercase tracking-tight">
                                5. Cooking Steps
                                <button type="button" onclick="addStep()" class="text-[10px] bg-brand-green text-white px-3 py-1 rounded-lg neo-shadow-sm">+ Add Step</button>
                            </h3>
                            <div id="stepsContainer" class="space-y-8"></div>
                        </div>

                        <button type="submit" class="w-full bg-brand-green border-4 border-brand-dark rounded-2xl py-6 font-heading text-3xl font-bold neo-shadow neo-btn mt-12 text-brand-dark">
                            SAVE TO RECIPE BANK
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 transform translate-y-32 opacity-0 transition-all duration-300">
        <div class="bg-brand-dark text-white neo-border rounded-2xl px-8 py-4 neo-shadow font-bold flex items-center gap-4">
            <i data-lucide="check-circle" class="text-brand-green"></i>
            <span id="toastMsg">Saved!</span>
        </div>
    </div>

    <script>
        let recipes = [];
        let editingIdx = -1;
        let quillEditors = {};

        // Initialize Lucide
        lucide.createIcons();

        // --- DYNAMIC FIELDS ---
        function addMeta(label = '', value = '', icon = 'clock') {
            const container = document.getElementById('metaContainer');
            const div = document.createElement('div');
            div.className = "bg-brand-chalk border-2 border-brand-dark rounded-xl p-3 relative space-y-2 meta-item";
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 border-2 border-brand-dark"><i data-lucide="x" class="w-3 h-3"></i></button>
                <input type="text" placeholder="Label" value="${label}" class="w-full text-xs font-bold p-1 meta-label">
                <input type="text" placeholder="Value" value="${value}" class="w-full text-xs font-bold p-1 meta-value">
                <input type="text" placeholder="Icon" value="${icon}" class="w-full text-[10px] p-1 meta-icon">
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addLoadoutGroup(name = '', color = 'text-e1pink', items = []) {
            const container = document.getElementById('loadoutContainer');
            const groupId = 'group-' + Date.now() + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            div.className = "bg-white border-2 border-brand-dark rounded-2xl p-4 shadow-hard-sm loadout-group";
            div.id = groupId;
            div.innerHTML = `
                <div class="flex gap-2 mb-4 items-center">
                    <input type="text" placeholder="Group Name" value="${name}" class="flex-grow font-bold group-name">
                    <select class="text-xs font-bold group-color">
                        <option value="text-e1pink" ${color === 'text-e1pink' ? 'selected' : ''}>Pink</option>
                        <option value="text-e1orange" ${color === 'text-e1orange' ? 'selected' : ''}>Orange</option>
                        <option value="text-e1green" ${color === 'text-e1green' ? 'selected' : ''}>Green</option>
                        <option value="text-e1blue" ${color === 'text-e1blue' ? 'selected' : ''}>Blue</option>
                    </select>
                    <button type="button" onclick="document.getElementById('${groupId}').remove()" class="text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-2 items-list"></div>
                <button type="button" onclick="addIngredientItem('${groupId}')" class="mt-4 text-[10px] font-bold uppercase text-brand-blue">+ Add Item</button>
            `;
            container.appendChild(div);
            items.forEach(it => addIngredientItem(groupId, it));
            lucide.createIcons();
        }

        function addIngredientItem(groupId, val = '') {
            const list = document.querySelector(`#${groupId} .items-list`);
            const div = document.createElement('div');
            div.className = "flex gap-2";
            div.innerHTML = `<input type="text" value="${val}" placeholder="1 cup Flour" class="flex-grow text-sm ingredient-item"><button type="button" onclick="this.parentElement.remove()" class="text-slate-400">&times;</button>`;
            list.appendChild(div);
        }

        function addVocab(word = '', def = '', color = 'text-e1pink') {
            const container = document.getElementById('vocabContainer');
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-3 gap-2 bg-brand-chalk border-2 border-brand-dark rounded-xl p-3 vocab-item relative";
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 border-2 border-brand-dark"><i data-lucide="x" class="w-3 h-3"></i></button>
                <input type="text" placeholder="Word" value="${word}" class="font-bold vocab-word">
                <input type="text" placeholder="Definition" value="${def}" class="text-sm vocab-def">
                <select class="text-xs font-bold vocab-color">
                    <option value="text-e1pink" ${color === 'text-e1pink' ? 'selected' : ''}>Pink</option>
                    <option value="text-e1orange" ${color === 'text-e1orange' ? 'selected' : ''}>Orange</option>
                    <option value="text-e1green" ${color === 'text-e1green' ? 'selected' : ''}>Green</option>
                    <option value="text-e1blue" ${color === 'text-e1blue' ? 'selected' : ''}>Blue</option>
                </select>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function addStep(title = '', desc = '', note = '', color = 'green', icon = '') {
            const container = document.getElementById('stepsContainer');
            const stepId = 'step-' + Date.now() + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            div.className = "bg-white border-2 border-brand-dark rounded-2xl p-6 shadow-hard-sm recipe-step relative";
            div.id = stepId;
            div.innerHTML = `
                <button type="button" onclick="removeStepRow('${stepId}')" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2 border-2 border-brand-dark z-10"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" value="${title}" placeholder="Step Title" class="w-full font-bold step-title">
                    <div class="flex gap-2">
                        <select class="flex-grow font-bold step-color">
                            <option value="pink" ${color === 'pink' ? 'selected' : ''}>Pink</option>
                            <option value="orange" ${color === 'orange' ? 'selected' : ''}>Orange</option>
                            <option value="green" ${color === 'green' ? 'selected' : ''}>Green</option>
                            <option value="blue" ${color === 'blue' ? 'selected' : ''}>Blue</option>
                        </select>
                        <input type="text" value="${icon}" placeholder="Icon" class="w-24 text-xs font-bold step-icon">
                    </div>
                </div>
                <div id="editor-${stepId}" class="quill-editor h-32 mb-4"></div>
                <input type="text" value="${note}" placeholder="Note..." class="w-full text-sm italic step-note">
            `;
            container.appendChild(div);
            
            const quill = new Quill(`#editor-${stepId}`, { 
                theme: 'snow', 
                modules: { toolbar: [['bold', 'italic'], [{ 'list': 'bullet' }]] } 
            });
            if (desc) quill.root.innerHTML = desc;
            quillEditors[stepId] = quill;
            lucide.createIcons();
        }

        function removeStepRow(id) { delete quillEditors[id]; document.getElementById(id).remove(); }

        // --- DATA OPS ---
        function saveRecipe(e) {
            e.preventDefault();
            
            const meta = Array.from(document.querySelectorAll('.meta-item')).map(div => ({ 
                label: div.querySelector('.meta-label').value, 
                value: div.querySelector('.meta-value').value, 
                icon: div.querySelector('.meta-icon').value 
            }));
            
            const loadout = Array.from(document.querySelectorAll('.loadout-group')).map(group => ({ 
                groupName: group.querySelector('.group-name').value, 
                groupColor: group.querySelector('.group-color').value, 
                items: Array.from(group.querySelectorAll('.ingredient-item')).map(i => i.value).filter(v => v) 
            }));
            
            const vocab = Array.from(document.querySelectorAll('.vocab-item')).map(div => ({ 
                word: div.querySelector('.vocab-word').value, 
                def: div.querySelector('.vocab-def').value, 
                color: div.querySelector('.vocab-color').value 
            }));
            
            const steps = Array.from(document.querySelectorAll('.recipe-step')).map((div, i) => {
                const quill = quillEditors[div.id];
                const res = { 
                    number: i + 1, 
                    title: div.querySelector('.step-title').value, 
                    color: div.querySelector('.step-color').value, 
                    desc: quill.root.innerHTML, 
                    note: div.querySelector('.step-note').value 
                };
                const icon = div.querySelector('.step-icon').value;
                if (icon) res.icon = icon;
                return res;
            });

            const newRecipe = { 
                id: document.getElementById('recipeId').value, 
                title: document.getElementById('title').value, 
                subtitle: document.getElementById('subtitle').value, 
                desc: document.getElementById('desc').value, 
                level: document.getElementById('level').value, 
                color: document.getElementById('color').value, 
                meta, 
                loadout, 
                vocab, 
                steps 
            };

            if (editingIdx > -1) { 
                recipes[editingIdx] = newRecipe; 
                showToast("Recipe Updated!"); 
            } else { 
                recipes.push(newRecipe); 
                showToast("Recipe Added!"); 
            }
            
            resetForm(); 
            updateRecipeList();
        }

        function editRecipe(idx) {
            const r = recipes[idx]; 
            editingIdx = idx;
            
            document.getElementById('formTitle').innerHTML = `<i data-lucide="edit"></i> Editing: ${r.title}`;
            document.getElementById('formHeader').classList.replace('bg-brand-green', 'bg-brand-orange');
            
            document.getElementById('recipeId').value = r.id; 
            document.getElementById('title').value = r.title; 
            document.getElementById('subtitle').value = r.subtitle; 
            document.getElementById('desc').value = r.desc; 
            document.getElementById('level').value = r.level; 
            document.getElementById('color').value = r.color;
            
            document.getElementById('metaContainer').innerHTML = ''; 
            document.getElementById('loadoutContainer').innerHTML = ''; 
            document.getElementById('vocabContainer').innerHTML = ''; 
            document.getElementById('stepsContainer').innerHTML = ''; 
            quillEditors = {};

            r.meta?.forEach(m => addMeta(m.label, m.value, m.icon)); 
            r.loadout?.forEach(l => addLoadoutGroup(l.groupName, l.groupColor, l.items)); 
            r.vocab?.forEach(v => addVocab(v.word, v.def, v.color)); 
            r.steps?.forEach(s => addStep(s.title, s.desc, s.note, s.color, s.icon));
            
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
            lucide.createIcons();
        }

        function deleteRecipe(idx) { 
            if (!confirm("Delete permanently?")) return; 
            recipes.splice(idx, 1); 
            if (editingIdx === idx) resetForm(); 
            updateRecipeList(); 
            showToast("Deleted.", true); 
        }

        function resetForm() {
            editingIdx = -1; 
            document.getElementById('recipeForm').reset();
            document.getElementById('metaContainer').innerHTML = ''; 
            document.getElementById('loadoutContainer').innerHTML = ''; 
            document.getElementById('vocabContainer').innerHTML = ''; 
            document.getElementById('stepsContainer').innerHTML = ''; 
            quillEditors = {};
            
            document.getElementById('formTitle').innerHTML = `<i data-lucide="chef-hat"></i> Adding New Recipe`;
            document.getElementById('formHeader').classList.replace('bg-brand-orange', 'bg-brand-green');
            
            addMeta('Prep', '20m', 'clock'); 
            addMeta('Yield', '1 Cup', 'utensils'); 
            addLoadoutGroup(); 
            addVocab(); 
            addStep(); 
            lucide.createIcons();
        }

        function updateRecipeList() {
            const list = document.getElementById('recipeList');
            const count = document.getElementById('recipeCount');
            count.innerText = recipes.length;
            
            if (recipes.length === 0) { 
                list.innerHTML = `<p class="text-center py-20 opacity-50 font-bold italic">No recipes loaded.</p>`; 
                return; 
            }
            
            list.innerHTML = recipes.map((r, idx) => `
                <div class="bg-white border-2 border-brand-dark rounded-xl p-3 neo-shadow-sm flex justify-between items-center group">
                    <div class="truncate">
                        <p class="font-bold truncate text-sm">${r.title || 'Untitled'}</p>
                        <p class="text-[10px] font-black uppercase text-brand-pink">${r.id || 'No ID'}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editRecipe(${idx})" class="p-2 border-2 border-brand-dark rounded-lg hover:bg-brand-blue hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteRecipe(${idx})" class="p-2 border-2 border-brand-dark rounded-lg hover:bg-brand-pink hover:text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- FILE HANDLING ---
        function processImportedData(data) {
            if (Array.isArray(data)) {
                recipes = data; 
                updateRecipeList(); 
                showToast("Library Imported!");
            } else if (typeof data === 'object' && data !== null) {
                recipes = [data];
                updateRecipeList();
                showToast("Imported Single Recipe!");
            }
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; 
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                let rawContent = event.target.result;
                try {
                    // 1. Initial Cleanup
                    rawContent = rawContent.trim();
                    // Remove BOM if present
                    if (rawContent.charCodeAt(0) === 0xFEFF) rawContent = rawContent.slice(1);

                    // 2. Try parsing the whole thing first
                    try {
                        const data = JSON.parse(rawContent);
                        processImportedData(data);
                        e.target.value = '';
                        return;
                    } catch (initialErr) {
                        // Continue to Healing logic if it fails
                        console.warn("Initial parse failed, attempting healing...");
                    }

                    // 3. HEALER Logic: Find the first valid JSON block and ignore trailing noise
                    const firstBracket = rawContent.indexOf('[');
                    const firstBrace = rawContent.indexOf('{');
                    let start = -1;
                    let closer = '';

                    if (firstBracket !== -1 && (firstBrace === -1 || firstBracket < firstBrace)) {
                        start = firstBracket;
                        closer = ']';
                    } else if (firstBrace !== -1) {
                        start = firstBrace;
                        closer = '}';
                    }

                    if (start !== -1) {
                        // We search for the LAST occurrence of the closer and try to parse.
                        // If it fails with "Unexpected character after JSON", we step backwards.
                        let last = rawContent.lastIndexOf(closer);
                        while (last > start) {
                            let candidate = rawContent.substring(start, last + 1);
                            try {
                                const data = JSON.parse(candidate);
                                processImportedData(data);
                                e.target.value = '';
                                return;
                            } catch (err) {
                                const msg = err.message.toLowerCase();
                                // If the error is specifically that there's garbage AFTER a valid JSON block,
                                // we try to find the previous closing bracket.
                                if (msg.includes('after json') || msg.includes('non-whitespace') || msg.includes('unexpected token')) {
                                    last = rawContent.lastIndexOf(closer, last - 1);
                                    continue;
                                }
                                // If it's a different error (structural), we can't heal by shrinking.
                                break;
                            }
                        }
                    }

                    throw new Error("The file structure is too damaged to be repaired automatically.");
                } catch (err) { 
                    console.error("Import Error:", err);
                    showToast("Invalid JSON! Details in console.", true); 
                }
                e.target.value = ''; // Reset file input
            };
            reader.readAsText(file);
        });

        function exportJson() {
            if (recipes.length === 0) return showToast("Nothing to export!", true);
            const dataStr = JSON.stringify(recipes, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = "recipes.json"; 
            a.click();
            URL.revokeObjectURL(url); 
            showToast("Exported recipes.json!");
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast'); 
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            
            const inner = t.querySelector('div');
            inner.classList.toggle('border-brand-dark', !isError);
            inner.classList.toggle('border-red-500', isError);
            
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        window.onload = () => { 
            resetForm(); 
            updateRecipeList(); 
        };
    </script>
</body>
</html>