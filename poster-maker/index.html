<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Poster Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',
                            chalk: '#f8fafc',
                            yellow: '#FCD34D'
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                        hand: ['Patrick Hand', 'cursive'],
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': '0px 0px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    gridTemplateColumns: {
                        '24': 'repeat(24, minmax(0, 1fr))',
                    },
                    backgroundImage: {
                        'stripes-white': 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px)',
                    }
                }
            }
        }
    </script>
    <style>
        .bg-graph-paper {
            background-color: #f8fafc;
            background-image: linear-gradient(#cbd5e1 1px, transparent 1px),
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .dark .bg-graph-paper {
            background-color: #0f172a;
            background-image: linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Poster Assets */
        .tape-strip {
            width: 80px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.4);
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            border-left: 1px dashed rgba(0, 0, 0, 0.1);
            border-right: 1px dashed rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        .corkboard-pin {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #1e293b;
            border: 2px solid white;
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        /* Editor Inputs */
        .editor-input {
            @apply w-full border-2 border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700 focus:outline-none focus:border-brand-dark focus:ring-4 focus:ring-slate-100 transition-all bg-slate-50 focus:bg-white;
        }

        .editor-label {
            @apply block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1 flex items-center gap-1;
        }

        /* Module Item in List */
        .module-item {
            @apply bg-white border-2 border-slate-200 rounded-xl p-3 cursor-pointer hover:border-brand-blue hover:-translate-y-0.5 hover:shadow-sm transition-all relative overflow-hidden group;
        }

        .module-item.active {
            @apply border-brand-blue ring-2 ring-brand-blue/10 shadow-md translate-x-1;
        }

        /* Color Specific Active States */
        .module-item.active-pink {
            @apply border-brand-pink ring-brand-pink/10;
        }

        .module-item.active-blue {
            @apply border-brand-blue ring-brand-blue/10;
        }

        .module-item.active-green {
            @apply border-brand-green ring-brand-green/10;
        }

        .module-item.active-orange {
            @apply border-brand-orange ring-brand-orange/10;
        }

        .module-item.active-dark {
            @apply border-brand-dark ring-brand-dark/10;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                padding: 0;
                overflow: visible;
                height: auto;
                background: white;
            }

            #poster-wrapper {
                transform: scale(1) !important;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #poster-area {
                border: 2px solid #000;
                box-shadow: none;
                width: 100% !important;
                height: auto !important;
                margin: 0;
            }

            #preview-container {
                overflow: visible;
                display: block;
            }
        }

        /* Add to styles.css */

        /* The "English 1" Input Field */
        .input-chunky {
            @apply w-full bg-white border-2 border-brand-dark rounded-xl px-4 py-2 font-body font-bold text-slate-700 outline-none transition-all;
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
            /* Hard shadow */
        }

        .input-chunky:focus {
            @apply border-brand-blue translate-y-[2px];
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
            /* Press down effect */
        }

        /* Label Styling */
        .label-chunky {
            @apply block font-heading text-sm font-bold text-slate-500 mb-1 uppercase tracking-wider;
        }

        /* Segmented Control (Radio replacements) */
        .radio-group {
            @apply flex gap-2 p-1 bg-slate-100 rounded-xl border-2 border-slate-200;
        }

        .radio-option {
            @apply flex-1 py-2 text-center font-heading font-bold text-slate-400 rounded-lg cursor-pointer border-2 border-transparent transition-all;
        }

        .radio-option.selected {
            @apply bg-white text-brand-dark border-brand-dark shadow-sm;
        }
    </style>
    <link rel="stylesheet" href="./style/styles.css">
</head>

<body class="bg-slate-100 h-screen w-full flex overflow-hidden font-body text-brand-dark">

    <!-- SIDEBAR: MODULE MANAGER -->
    <aside class="w-[380px] bg-white border-r-2 border-slate-300 flex flex-col h-full z-20 shadow-xl no-print shrink-0">

        <!-- 1. Header -->
        <div class="p-4 bg-brand-dark text-white shrink-0 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-2">
                <div class="bg-brand-blue p-1.5 rounded-lg border border-white/20">
                    <i data-lucide="layout" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 class="font-heading text-lg font-bold leading-none">Poster Studio</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">English 1 Batam</p>
                </div>
            </div>
            <div class="flex gap-1">
                <button
                    onclick="confirmAction('Reset Default', 'Are you sure you want to reset to the A1 template?', resetTemplate, 'reset')"
                    class="p-1.5 hover:bg-white/10 rounded transition" title="Reset Default">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 text-white/70 hover:text-white"></i>
                </button>
                <button
                    onclick="confirmAction('Clear Workspace', 'This will remove all blocks. Continue?', clearAll, 'delete')"
                    class="p-1.5 hover:bg-red-500/20 rounded transition group" title="Clear All">
                    <i data-lucide="trash" class="w-4 h-4 text-brand-pink group-hover:text-red-400"></i>
                </button>
            </div>
        </div>

        <!-- 2. Toolbox (Add Blocks) -->
        <div class="p-3 bg-slate-50 border-b border-slate-200 shrink-0 z-10">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">Toolbox</h3>
            <div class="grid grid-cols-2 gap-2">
                <!-- Vocab -->
                <button onclick="addModule('vocab')"
                    class="flex items-center gap-2 p-2 bg-white border-2 border-slate-200 rounded-lg hover:border-brand-green hover:shadow-sm hover:-translate-y-0.5 transition-all group">
                    <div
                        class="bg-brand-green/10 p-1.5 rounded-md text-brand-green group-hover:bg-brand-green group-hover:text-white transition-colors">
                        <i data-lucide="list" class="w-4 h-4"></i>
                    </div>
                    <div class="text-left">
                        <span class="block text-xs font-bold text-slate-700">Vocabulary</span>
                        <span class="block text-[9px] text-slate-400">Bullet lists</span>
                    </div>
                </button>

                <!-- Logic -->
                <button onclick="addModule('grammar_logic')"
                    class="flex items-center gap-2 p-2 bg-white border-2 border-slate-200 rounded-lg hover:border-brand-blue hover:shadow-sm hover:-translate-y-0.5 transition-all group">
                    <div
                        class="bg-brand-blue/10 p-1.5 rounded-md text-brand-blue group-hover:bg-brand-blue group-hover:text-white transition-colors">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </div>
                    <div class="text-left">
                        <span class="block text-xs font-bold text-slate-700">Logic</span>
                        <span class="block text-[9px] text-slate-400">Rules & Formulas</span>
                    </div>
                </button>

                <!-- Structure -->
                <button onclick="addModule('grammar_structure')"
                    class="flex items-center gap-2 p-2 bg-white border-2 border-slate-200 rounded-lg hover:border-brand-pink hover:shadow-sm hover:-translate-y-0.5 transition-all group">
                    <div
                        class="bg-brand-pink/10 p-1.5 rounded-md text-brand-pink group-hover:bg-brand-pink group-hover:text-white transition-colors">
                        <i data-lucide="blocks" class="w-4 h-4"></i>
                    </div>
                    <div class="text-left">
                        <span class="block text-xs font-bold text-slate-700">Structure</span>
                        <span class="block text-[9px] text-slate-400">Sentence Building</span>
                    </div>
                </button>

                <!-- Text -->
                <button onclick="addModule('text')"
                    class="flex items-center gap-2 p-2 bg-white border-2 border-slate-200 rounded-lg hover:border-brand-orange hover:shadow-sm hover:-translate-y-0.5 transition-all group">
                    <div
                        class="bg-brand-orange/10 p-1.5 rounded-md text-brand-orange group-hover:bg-brand-orange group-hover:text-white transition-colors">
                        <i data-lucide="message-square" class="w-4 h-4"></i>
                    </div>
                    <div class="text-left">
                        <span class="block text-xs font-bold text-slate-700">Dialogue</span>
                        <span class="block text-[9px] text-slate-400">Q&A / Text</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- 3. Layer List -->
        <div class="flex-1 overflow-hidden flex flex-col bg-slate-50/30">
            <div
                class="px-4 py-2 flex justify-between items-center border-b border-slate-100 bg-white/50 backdrop-blur-sm sticky top-0 z-10">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Layers</span>
                <span class="text-[10px] font-bold text-slate-300" id="layer-count">0 items</span>
            </div>

            <div id="module-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-10 custom-scrollbar">
                <!-- Modules injected here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state"
                class="hidden absolute inset-0 top-[280px] flex flex-col items-center justify-start text-slate-400 p-6 text-center pointer-events-none">
                <div class="bg-slate-100 p-3 rounded-full mb-2">
                    <i data-lucide="layout-template" class="w-6 h-6 opacity-50"></i>
                </div>
                <p class="font-heading font-bold text-slate-500 text-sm">No Blocks Added</p>
                <p class="text-[10px] mt-1 max-w-[150px]">Use the toolbox above to add content to your poster.</p>
            </div>
        </div>

        <!-- 4. Properties Panel (Dynamic) -->
        <div id="properties-panel"
            class="h-[340px] bg-white border-t-4 border-slate-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-30 flex flex-col transition-all">

            <!-- A. Global Settings (Shown when nothing selected) -->
            <div id="global-settings" class="flex-1 flex flex-col">
                <div class="p-3 bg-slate-50 border-b border-slate-200 flex items-center gap-2">
                    <i data-lucide="globe" class="w-4 h-4 text-slate-400"></i>
                    <span class="text-xs font-bold text-slate-600 uppercase">Global Settings</span>
                </div>
                <div class="p-4 space-y-4 overflow-y-auto">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-1">
                            <label class="editor-label">Badge</label>
                            <input type="text" id="global_badge" class="editor-input py-1 text-center" value="Week 1"
                                oninput="updateGlobal()">
                        </div>
                        <div class="col-span-2">
                            <label class="editor-label">Main Title</label>
                            <input type="text" id="global_title" class="editor-input py-1" value="ENGLISH CLASS"
                                oninput="updateGlobal()">
                        </div>
                    </div>
                    <div>
                        <label class="editor-label">Subtitle</label>
                        <input type="text" id="global_subtitle" class="editor-input py-1"
                            value="Vocabulary • Grammar • Speaking" oninput="updateGlobal()">
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <button onclick="window.print()"
                            class="w-full bg-brand-dark text-white font-heading font-bold py-3 rounded-xl border-2 border-slate-900 shadow-neo hover:translate-y-[2px] hover:shadow-neo-sm active:translate-y-[4px] active:shadow-neo-pressed transition-all flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span>Save PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- B. Block Editor (Shown when block selected) -->
            <div id="block-editor" class="flex-1 flex flex-col hidden">
                <div class="p-2 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div class="flex items-center gap-2 px-2">
                        <span class="w-2 h-2 rounded-full bg-brand-blue animate-pulse"></span>
                        <span class="text-xs font-bold text-brand-blue uppercase">Edit Block</span>
                    </div>
                    <button onclick="closeEditor()"
                        class="flex items-center gap-1 text-[10px] font-bold text-slate-500 hover:text-brand-dark bg-white border border-slate-200 px-2 py-1 rounded-lg transition-all">
                        <i data-lucide="check" class="w-3 h-3"></i> Done
                    </button>
                </div>
                <div id="editor-fields" class="p-4 space-y-4 overflow-y-auto">
                    <!-- Fields injected here -->
                </div>
            </div>

        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <div class="flex-1 bg-slate-200 relative overflow-hidden flex flex-col" id="preview-container">

        <!-- Toolbar -->
        <div
            class="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-white border-2 border-brand-dark rounded-full shadow-lg p-1.5 pl-4 flex items-center gap-4 no-print transition-all hover:scale-105">
            <div class="flex items-center gap-3">
                <i data-lucide="zoom-out" class="w-4 h-4 text-slate-400 cursor-pointer hover:text-brand-dark"
                    onclick="adjustZoom(-0.1)"></i>
                <span id="zoom-level" class="text-xs font-bold text-slate-600 w-8 text-center">Fit</span>
                <i data-lucide="zoom-in" class="w-4 h-4 text-slate-400 cursor-pointer hover:text-brand-dark"
                    onclick="adjustZoom(0.1)"></i>
            </div>
            <div class="w-px h-6 bg-slate-200"></div>
            <button onclick="toggleTheme()" id="themeBtn"
                class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-brand-dark text-white hover:bg-slate-700 transition group">
                <i data-lucide="moon" class="w-3.5 h-3.5 group-hover:rotate-12 transition-transform"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Dark</span>
            </button>
            <div class="w-px h-6 bg-slate-200"></div>
            <button onclick="fitToScreen()"
                class="p-2 hover:bg-slate-100 rounded-full transition text-slate-500 hover:text-brand-blue"
                title="Fit to Screen">
                <i data-lucide="minimize" class="w-4 h-4"></i>
            </button>
            <button onclick="toggleFullScreen()"
                class="p-2 hover:bg-slate-100 rounded-full transition text-slate-500 hover:text-brand-blue"
                title="Fullscreen">
                <i data-lucide="maximize" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Canvas -->
        <div class="flex-1 flex items-center justify-center overflow-auto p-8 custom-scrollbar bg-slate-200"
            id="canvas-wrapper">
            <div id="poster-wrapper" class="origin-center transition-transform duration-300 ease-out">
                <!-- CANVAS SIZE: 1600x900 (16:9) -->
                <div id="poster-area"
                    class="bg-graph-paper w-[1600px] h-[900px] border-4 border-brand-dark shadow-neo rounded-2xl p-6 flex flex-col gap-6 bg-white transition-colors duration-300 box-border">

                    <!-- Poster Header -->
                    <header
                        class="bg-brand-chalk border-4 border-brand-dark rounded-xl shadow-neo p-5 shrink-0 flex justify-between items-center relative overflow-hidden group h-[120px]">
                        <div
                            class="absolute inset-0 bg-brand-dark opacity-0 dark:opacity-100 transition-opacity z-0 pointer-events-none">
                        </div>
                        <div class="absolute -right-10 -top-10 opacity-10 rotate-12 z-10">
                            <i data-lucide="book-open" class="w-64 h-64 text-brand-blue dark:text-white"></i>
                        </div>
                        <div class="flex items-center gap-6 relative z-10">
                            <div id="view_badge"
                                class="bg-brand-blue text-white font-heading font-bold text-3xl px-6 py-2 rounded-xl border-4 border-brand-dark dark:border-white shadow-neo-sm transform -rotate-2">
                                Week 1
                            </div>
                            <div>
                                <h1 id="view_title"
                                    class="font-heading text-5xl font-bold text-brand-dark dark:text-white leading-none tracking-tight drop-shadow-sm">
                                    ENGLISH CLASS</h1>
                                <p id="view_subtitle"
                                    class="text-lg font-bold text-slate-500 dark:text-slate-300 font-heading tracking-[0.2em] uppercase mt-1">
                                    Vocabulary • Grammar • Speaking</p>
                            </div>
                        </div>
                    </header>

                    <!-- Poster Grid (Dynamic: 24 Columns) -->
                    <main id="poster-grid"
                        class="grid grid-cols-24 gap-4 h-full min-h-0 pb-1 content-start overflow-hidden">
                        <!-- Dynamic Modules Render Here -->
                    </main>

                    <footer
                        class="text-center font-heading font-bold text-brand-dark/30 dark:text-white/30 text-xs shrink-0 flex justify-between px-4 h-[20px]">
                        <span>English 1 Design System</span>
                        <span>Generic A1 Template</span>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM POP-UP MODAL (REDESIGNED) -->
    <div id="custom-modal"
        class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm p-4 transition-all opacity-0 pointer-events-none">
        <div
            class="bg-white border-4 border-brand-dark rounded-2xl shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] max-w-sm w-full relative overflow-hidden transform scale-95 transition-transform">

            <!-- Modal Header -->
            <div class="bg-brand-dark p-4 flex items-center gap-3 bg-stripes-white">
                <div class="bg-white/10 p-2 rounded-lg border border-white/20">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-brand-yellow"></i>
                </div>
                <h3 id="modal-title" class="font-heading text-xl font-bold text-white tracking-wide">Confirm Action</h3>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <p id="modal-msg" class="text-slate-600 font-bold text-base leading-relaxed mb-6">Are you sure you want
                    to proceed?</p>

                <div class="flex gap-3">
                    <button onclick="closeModal()"
                        class="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-500 hover:bg-slate-100 hover:border-slate-400 transition-all">
                        Cancel
                    </button>
                    <button id="modal-confirm"
                        class="flex-1 py-3 border-2 border-brand-dark rounded-xl font-bold text-white shadow-neo-sm hover:translate-y-0.5 hover:shadow-none transition-all flex justify-center items-center gap-2">
                        <span>Confirm</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>// --- 1. STATE & DEFAULT A1 DATA ---

        const defaultModules = [
            { id: 1, type: 'vocab', size: 'mini', color: 'green', title: 'Fruit', data: 'Apple\nBanana\nOrange' },
            { id: 2, type: 'vocab', size: 'mini', color: 'pink', title: 'Colors', data: 'Red\nBlue\nGreen' },
            { id: 3, type: 'vocab', size: 'mini', color: 'orange', title: 'Days', data: 'Monday\nTuesday\nFriday' },
            { id: 4, type: 'vocab', size: 'mini', color: 'blue', title: 'Verbs', data: 'Run\nJump\nSleep' },
            { id: 5, type: 'grammar_structure', size: 'medium', color: 'blue', title: 'Present Continuous', data: { formula: 'Subject | + | am/is/are | + | Verb-ing', examples: '"I am eating."' } },
            { id: 6, type: 'text', size: 'medium', color: 'orange', title: 'Greetings', data: { prompt: 'How are you?', body: 'I am fine.\nI am great.\nNot bad.' } },
        ];

        let modules = JSON.parse(JSON.stringify(defaultModules));
        let editingId = null;
        let zoomLevel = 1;
        let modalCallback = null;

        // --- 2. RENDER FUNCTIONS ---

        function renderPoster() {
            const grid = document.getElementById('poster-grid');
            grid.innerHTML = '';

            modules.forEach(mod => {
                const el = document.createElement('div');

                // NEW SIZING LOGIC FOR 24-GRID
                let colClass = 'col-span-6'; // Small (default, 1/4)
                if (mod.size === 'mini') colClass = 'col-span-3'; // 1/8
                if (mod.size === 'third') colClass = 'col-span-8'; // 1/3
                if (mod.size === 'medium') colClass = 'col-span-12'; // 1/2
                if (mod.size === 'wide') colClass = 'col-span-16'; // 2/3
                if (mod.size === 'large') colClass = 'col-span-18'; // 3/4
                if (mod.size === 'full') colClass = 'col-span-24'; // Full

                el.className = `${colClass} flex flex-col h-full animate-fade-in`;
                el.innerHTML = getModuleHTML(mod);
                grid.appendChild(el);
            });
            lucide.createIcons();
            updateEmptyState();
            updateLayerCount();
        }

        function getModuleHTML(mod) {
            const colors = {
                pink: 'bg-brand-pink border-brand-dark dark:border-white',
                orange: 'bg-brand-orange border-brand-dark dark:border-white',
                green: 'bg-brand-green border-brand-dark dark:border-white',
                blue: 'bg-brand-blue border-brand-dark dark:border-white',
                dark: 'bg-brand-dark border-brand-dark dark:border-white',
            };
            const textColors = {
                pink: 'text-brand-pink', orange: 'text-brand-orange',
                green: 'text-brand-green', blue: 'text-brand-blue', dark: 'text-brand-dark'
            };

            const isMini = mod.size === 'mini';
            const paddingClass = isMini ? 'p-3' : 'p-6';
            const headerPadding = isMini ? 'p-1.5 mx-2 text-xs' : 'p-2 mx-4 text-center';
            const wrapperClass = `bg-white dark:bg-slate-800 border-4 border-brand-dark dark:border-white rounded-xl shadow-neo relative flex-1 flex flex-col overflow-hidden transition-colors h-full`;
            const headerClass = `${colors[mod.color]} ${headerPadding} mb-2 border-b-4 border-brand-dark dark:border-slate-900 rounded-t-lg shadow-sm truncate`;
            const pinClass = `corkboard-pin bg-brand-dark border-2 border-white dark:border-slate-300`;

            // 1. VOCABULARY
            if (mod.type === 'vocab') {
                const items = mod.data.split('\n').filter(i => i.trim()).map(i =>
                    `<li class="flex items-center gap-2"><div class="${isMini ? 'w-2 h-2' : 'w-2.5 h-2.5'} rounded-full shrink-0 border border-brand-dark/20 ${colors[mod.color]}"></div><span class="truncate">${i}</span></li>`
                ).join('');

                return `
                    <section class="${wrapperClass} ${isMini ? 'pt-4' : 'pt-6'}">
                        <div class="${pinClass}" style="${isMini ? 'top: 8px;' : 'top: 12px;'}"></div>
                        <div class="${headerClass}">
                            <h2 class="font-heading ${isMini ? 'text-sm' : 'text-lg'} font-bold text-white uppercase tracking-wide truncate">${mod.title}</h2>
                        </div>
                        <div class="${paddingClass} flex-1 overflow-y-auto">
                            <ul class="space-y-2 ${isMini ? 'text-xs' : 'text-sm'} font-bold text-slate-700 dark:text-slate-200">${items}</ul>
                        </div>
                    </section>`;
            }

            // 2. GRAMMAR STRUCTURE
            if (mod.type === 'grammar_structure') {
                const parts = mod.data.formula.split('|').map(p =>
                    `<div class="bg-brand-chalk border-2 border-brand-dark dark:border-slate-400 rounded-lg px-2 py-2 font-bold text-slate-700 text-sm shadow-sm text-center min-w-[40px] flex-1 whitespace-nowrap">${p.trim()}</div>`
                ).join('');

                return `
                    <section class="${colors[mod.color]} border-4 border-brand-dark dark:border-white rounded-xl shadow-neo p-0 relative overflow-hidden flex-1 flex flex-col transition-all h-full">
                         <div class="bg-brand-dark ${isMini ? 'p-2' : 'p-3'} flex justify-between items-center relative z-10 border-b-2 border-white/20">
                            <h2 class="font-heading ${isMini ? 'text-sm' : 'text-lg'} font-bold text-white uppercase flex items-center gap-2 truncate">
                                <i data-lucide="blocks" class="${isMini ? 'w-4 h-4' : 'w-5 h-5'} text-white"></i> <span class="truncate">${mod.title}</span>
                            </h2>
                        </div>
                        <div class="${paddingClass} flex-1 flex flex-col justify-center relative z-10 gap-3">
                            <div class="bg-white p-3 rounded-xl border-2 border-brand-dark shadow-sm flex flex-wrap gap-2 items-center justify-center">
                                ${parts}
                            </div>
                            ${!isMini ? `<div class="bg-white/10 p-3 rounded-xl border-2 border-white/20 backdrop-blur-sm text-center">
                                <p class="text-white font-bold text-[10px] mb-1 opacity-80 uppercase tracking-widest">Example</p>
                                <p class="text-white font-bold text-lg italic leading-tight truncate">${mod.data.examples}</p>
                            </div>` : ''}
                        </div>
                    </section>`;
            }

            // 3. GRAMMAR LOGIC
            if (mod.type === 'grammar_logic') {
                return `
                    <section class="${colors[mod.color]} border-4 border-brand-dark dark:border-white rounded-xl shadow-neo p-0 relative overflow-hidden flex-1 flex flex-col transition-all h-full">
                         <div class="bg-brand-dark ${isMini ? 'p-2' : 'p-3'} flex justify-between items-center relative z-10 border-b-2 border-white/20">
                            <h2 class="font-heading ${isMini ? 'text-sm' : 'text-lg'} font-bold text-white uppercase flex items-center gap-2 truncate">
                                <i data-lucide="zap" class="${isMini ? 'w-4 h-4' : 'w-5 h-5'} text-white"></i> <span class="truncate">${mod.title}</span>
                            </h2>
                        </div>
                        <div class="${paddingClass} flex-1 flex flex-col justify-center relative z-10 space-y-3">
                            <div class="bg-white/10 p-3 rounded-xl border-2 border-white/20 backdrop-blur-sm">
                                <p class="text-white text-center font-heading ${isMini ? 'text-sm' : 'text-xl'} font-bold leading-tight">${mod.data.concept}</p>
                            </div>
                            <div class="bg-white border-2 border-brand-dark rounded-lg p-3 shadow-neo-sm transform -rotate-1">
                                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1 tracking-widest">Example</p>
                                <p class="font-bold ${isMini ? 'text-sm' : 'text-lg'} text-slate-800 leading-tight">${mod.data.ex}</p>
                            </div>
                        </div>
                    </section>`;
            }

            // 4. HANDWRITTEN LIST
            if (mod.type === 'grammar_list') {
                const items = mod.data.split('\n').filter(i => i.trim()).map(i => `<p class="leading-snug truncate">"${i.replace(/"/g, '')}"</p>`).join('');
                return `
                     <section class="${colors[mod.color]} border-4 border-brand-dark dark:border-white rounded-xl shadow-neo p-0 flex-1 flex flex-col overflow-hidden transition-all h-full">
                        <div class="bg-brand-dark ${isMini ? 'p-2' : 'p-3'} flex justify-between items-center border-b-2 border-white/20">
                            <h2 class="font-heading ${isMini ? 'text-sm' : 'text-lg'} font-bold text-white uppercase flex items-center gap-2 truncate">
                                <i data-lucide="pen-tool" class="${isMini ? 'w-4 h-4' : 'w-5 h-5'} text-white"></i> <span class="truncate">${mod.title}</span>
                            </h2>
                        </div>
                        <div class="${paddingClass} flex-1 relative bg-[#fff7d1] m-3 rounded-lg border-2 border-brand-dark shadow-sm rotate-1 flex flex-col justify-center">
                            ${!isMini ? '<div class="tape-strip"></div>' : ''}
                            <div class="space-y-3 font-hand ${isMini ? 'text-sm' : 'text-xl'} text-slate-800 text-center leading-relaxed">${items}</div>
                        </div>
                    </section>`;
            }

            // 5. TEXT CHAT
            if (mod.type === 'text') {
                const items = mod.data.body.split('\n').filter(i => i.trim()).map(i =>
                    `<li class="flex items-center gap-2"><i data-lucide="message-circle" class="${isMini ? 'w-3 h-3' : 'w-4 h-4'} ${textColors[mod.color]} shrink-0"></i><span class="truncate">${i}</span></li>`
                ).join('');

                return `
                    <section class="${colors[mod.color]} border-4 border-brand-dark dark:border-white rounded-xl shadow-neo flex-1 flex flex-col relative overflow-hidden transition-all h-full">
                        <div class="bg-brand-dark ${isMini ? 'p-2' : 'p-3'} text-center border-b-2 border-white/20">
                            <h2 class="font-heading ${isMini ? 'text-sm' : 'text-lg'} font-bold text-white uppercase truncate">${mod.title}</h2>
                        </div>
                        <div class="${paddingClass} flex flex-col gap-3 flex-1 overflow-y-auto">
                            <div class="bg-white p-3 rounded-tl-xl rounded-tr-xl rounded-br-xl border-2 border-brand-dark shadow-neo-sm">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Prompt</p>
                                <p class="font-bold text-brand-dark leading-tight ${isMini ? 'text-sm' : 'text-lg'} truncate">${mod.data.prompt}</p>
                            </div>
                            <div class="bg-brand-chalk border-2 border-brand-dark rounded-xl shadow-sm border-dashed flex-1 p-3">
                                <ul class="${isMini ? 'text-xs' : 'text-sm'} font-bold text-slate-700 space-y-2">${items}</ul>
                            </div>
                        </div>
                    </section>`;
            }
            return '';
        }

        function renderEditorList() {
            const list = document.getElementById('module-list');
            list.innerHTML = '';

            modules.forEach((mod, index) => {
                const isActive = editingId === mod.id;
                const el = document.createElement('div');

                // Base class
                let baseClass = `module-item ${isActive ? `active active-${mod.color}` : ''}`;

                el.className = baseClass;
                el.onclick = () => openEditor(mod.id);

                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-brand-${mod.color} border border-brand-dark"></span>
                            <span class="font-heading font-bold text-sm text-brand-dark truncate max-w-[150px]">${mod.title || 'Untitled'}</span>
                        </div>
                        <span class="text-[9px] uppercase font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${mod.type.replace('grammar_', '')}</span>
                    </div>
                    <div class="flex justify-between items-center pl-4">
                        <span class="text-[10px] text-slate-400 font-bold">${mod.size.charAt(0).toUpperCase() + mod.size.slice(1)}</span>
                        <div class="flex gap-1 group-hover:opacity-100 transition-opacity">
                            <button onclick="duplicateModule(${mod.id}, event)" class="p-1 hover:bg-brand-blue/10 rounded text-brand-blue" title="Duplicate"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            <button onclick="moveModule(${index}, -1, event)" class="p-1 hover:bg-slate-100 rounded text-slate-500" title="Move Up"><i data-lucide="arrow-up" class="w-3 h-3"></i></button>
                            <button onclick="moveModule(${index}, 1, event)" class="p-1 hover:bg-slate-100 rounded text-slate-500" title="Move Down"><i data-lucide="arrow-down" class="w-3 h-3"></i></button>
                            <button onclick="confirmAction('Delete Block', 'Delete this block permanently?', () => performDelete(${mod.id}), 'delete')" class="p-1 hover:bg-red-50 rounded text-slate-400 hover:text-red-500" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
            updateEmptyState();
        }

        // --- 3. LOGIC FUNCTIONS ---

        function openEditor(id) {
            editingId = id;
            const mod = modules.find(m => m.id === id);
            if (!mod) return;

            // Switch to Block Editor View
            document.getElementById('global-settings').classList.add('hidden');
            document.getElementById('block-editor').classList.remove('hidden');

            const fields = document.getElementById('editor-fields');

            // Generate Form
            let html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="editor-label">Block Title</label>
                        <input type="text" class="editor-input" value="${mod.title}" oninput="updateModule(${id}, 'title', this.value)">
                    </div>
                    <div>
                        <label class="editor-label">Color Theme</label>
                        <div class="flex gap-1 mt-1">
                            ${['pink', 'orange', 'green', 'blue', 'dark'].map(c => `
                                <button onclick="updateModule(${id}, 'color', '${c}')" class="w-6 h-6 rounded-full bg-brand-${c} border-2 ${mod.color === c ? 'border-brand-dark scale-110 ring-2 ring-slate-200' : 'border-white'} transition-all shadow-sm"></button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div>
                    <label class="editor-label">Width</label>
                    <div class="flex flex-wrap gap-1 bg-slate-100 p-1.5 rounded-lg border border-slate-200">
                        ${['mini', 'small', 'third', 'medium', 'wide', 'large', 'full'].map(s => `
                            <button onclick="updateModule(${id}, 'size', '${s}')" class="flex-1 min-w-[40px] py-1 text-[9px] font-bold rounded-md transition-all ${mod.size === s ? 'bg-white text-brand-blue shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}">${s.charAt(0).toUpperCase() + s.slice(1)}</button>
                        `).join('')}
                    </div>
                </div>
                <hr class="border-slate-100">
            `;

            // Content Fields based on type
            if (mod.type === 'vocab') {
                html += `<div><label class="editor-label">List Items</label><textarea rows="4" class="editor-input" oninput="updateModule(${id}, 'data', this.value)">${mod.data}</textarea></div>`;
            } else if (mod.type === 'grammar_structure') {
                html += `
                    <div>
                        <label class="editor-label">Formula Parts (Separate by | )</label>
                        <input type="text" class="editor-input mb-2 font-mono text-xs text-brand-blue" value='${mod.data.formula}' oninput="updateDeepData(${id}, 'formula', this.value)" placeholder="Sub | + | Verb">
                        <label class="editor-label">Examples</label>
                        <input type="text" class="editor-input" value='${mod.data.examples}' oninput="updateDeepData(${id}, 'examples', this.value)">
                    </div>`;
            } else if (mod.type === 'grammar_logic') {
                html += `
                    <div>
                        <label class="editor-label">Main Concept</label><input type="text" class="editor-input mb-2" value='${mod.data.concept}' oninput="updateDeepData(${id}, 'concept', this.value)">
                        <label class="editor-label">Example Sentence</label><input type="text" class="editor-input" value='${mod.data.ex}' oninput="updateDeepData(${id}, 'ex', this.value)">
                    </div>`;
            } else if (mod.type === 'grammar_list') {
                html += `<div><label class="editor-label">Examples</label><textarea rows="4" class="editor-input font-hand text-lg" oninput="updateModule(${id}, 'data', this.value)">${mod.data}</textarea></div>`;
            } else if (mod.type === 'text') {
                html += `
                    <div>
                        <label class="editor-label">Prompt / Heading</label><input type="text" class="editor-input mb-2" value='${mod.data.prompt}' oninput="updateDeepData(${id}, 'prompt', this.value)">
                        <label class="editor-label">Responses / Body</label><textarea rows="4" class="editor-input" oninput="updateDeepData(${id}, 'body', this.value)">${mod.data.body}</textarea>
                    </div>`;
            }

            // ADDED: Explicit Delete Button inside editor
            html += `
                <div class="pt-4 mt-2">
                    <button onclick="confirmAction('Delete Block', 'Permanently delete this block?', () => performDelete(${mod.id}), 'delete')" class="w-full py-2 bg-white border-2 border-red-200 text-red-500 rounded-lg font-bold hover:bg-red-50 hover:border-red-300 transition-all flex justify-center items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Block
                    </button>
                </div>
            `;

            fields.innerHTML = html;
            renderEditorList();
        }

        function closeEditor() {
            editingId = null;
            // Revert to Global Settings
            document.getElementById('block-editor').classList.add('hidden');
            document.getElementById('global-settings').classList.remove('hidden');
            renderEditorList();
        }

        function updateGlobal() {
            document.getElementById('view_badge').innerText = document.getElementById('global_badge').value;
            document.getElementById('view_title').innerText = document.getElementById('global_title').value;
            document.getElementById('view_subtitle').innerText = document.getElementById('global_subtitle').value;
        }

        function updateModule(id, field, value) {
            const mod = modules.find(m => m.id === id);
            if (mod) {
                mod[field] = value;
                renderPoster();
                if (field !== 'data') {
                    renderEditorList(); // Refresh list if metadata changes
                    if (field === 'size' || field === 'color') openEditor(id); // Re-render editor UI
                }
            }
        }

        function updateDeepData(id, key, value) {
            const mod = modules.find(m => m.id === id);
            if (mod && typeof mod.data === 'object') {
                mod.data[key] = value;
                renderPoster();
            }
        }

        function addModule(type) {
            const id = Date.now();
            let newMod = { id, type, size: 'small', color: 'green', title: 'New Item', data: '' };
            if (type === 'grammar_logic') newMod = { id, type: 'grammar_logic', size: 'medium', color: 'blue', title: 'New Logic', data: { concept: 'Formula', ex: 'Example' } };
            if (type === 'grammar_structure') newMod = { id, type: 'grammar_structure', size: 'full', color: 'pink', title: 'Structure', data: { formula: 'Subject | + | Verb', examples: 'I run.' } };
            if (type === 'text') newMod = { id, type: 'text', size: 'medium', color: 'orange', title: 'Dialogue', data: { prompt: 'Q?', body: 'A.' } };
            if (type === 'vocab') newMod.data = 'Item 1\nItem 2';

            modules.push(newMod);
            renderEditorList();
            renderPoster();
            openEditor(id);

            // Auto Scroll List
            setTimeout(() => {
                const container = document.getElementById('module-list');
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        function duplicateModule(id, e) {
            e.stopPropagation();
            const mod = modules.find(m => m.id === id);
            if (mod) {
                const newId = Date.now();
                const copy = JSON.parse(JSON.stringify(mod));
                copy.id = newId;
                copy.title += " (Copy)";
                modules.push(copy);
                renderEditorList();
                renderPoster();
            }
        }

        // --- MODAL SYSTEM ---
        function confirmAction(title, msg, callback, type = 'normal') {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            modalCallback = callback;

            const modal = document.getElementById('custom-modal');
            const confirmBtn = document.getElementById('modal-confirm');

            // Style based on type
            if (type === 'delete') {
                confirmBtn.className = "flex-1 py-3 border-2 border-brand-dark bg-brand-pink text-white rounded-xl font-bold shadow-neo-sm hover:translate-y-0.5 hover:shadow-none transition-all flex justify-center items-center gap-2";
                confirmBtn.innerHTML = "<span>Yes, Delete</span>";
            } else if (type === 'reset') {
                confirmBtn.className = "flex-1 py-3 border-2 border-brand-dark bg-brand-orange text-white rounded-xl font-bold shadow-neo-sm hover:translate-y-0.5 hover:shadow-none transition-all flex justify-center items-center gap-2";
                confirmBtn.innerHTML = "<span>Yes, Reset</span>";
            } else {
                confirmBtn.className = "flex-1 py-3 border-2 border-brand-dark bg-brand-blue text-white rounded-xl font-bold shadow-neo-sm hover:translate-y-0.5 hover:shadow-none transition-all flex justify-center items-center gap-2";
                confirmBtn.innerHTML = "<span>Confirm</span>";
            }

            modal.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');

            document.getElementById('modal-confirm').onclick = () => {
                if (modalCallback) modalCallback();
                closeModal();
            };
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200); // Wait for transition
            modalCallback = null;
        }

        // --- ACTION HANDLERS ---
        function performDelete(id) {
            modules = modules.filter(m => m.id !== id);
            if (editingId === id) closeEditor();
            renderEditorList();
            renderPoster();
        }

        function clearAll() {
            modules = [];
            closeEditor();
            renderEditorList();
            renderPoster();
        }

        function resetTemplate() {
            modules = JSON.parse(JSON.stringify(defaultModules));
            renderEditorList();
            renderPoster();
        }

        function moveModule(index, direction, e) {
            e.stopPropagation();
            if (index + direction < 0 || index + direction >= modules.length) return;
            const temp = modules[index];
            modules[index] = modules[index + direction];
            modules[index + direction] = temp;
            renderEditorList();
            renderPoster();
        }

        function updateEmptyState() {
            const empty = document.getElementById('empty-state');
            if (modules.length === 0) empty.classList.remove('hidden');
            else empty.classList.add('hidden');
        }

        function updateLayerCount() {
            document.getElementById('layer-count').innerText = `${modules.length} block${modules.length !== 1 ? 's' : ''}`;
        }

        // View Controls
        function adjustZoom(delta) {
            zoomLevel = Math.max(0.3, Math.min(1.5, zoomLevel + delta));
            document.getElementById('poster-wrapper').style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoom-level').innerText = Math.round(zoomLevel * 100) + '%';
        }

        function fitToScreen() {
            // Calculate scale based on container height vs poster height
            const container = document.getElementById('canvas-wrapper');
            const posterHeight = 900 + 48; // height + padding
            const containerHeight = container.clientHeight - 40; // padding
            const scale = Math.min(1, containerHeight / posterHeight);

            zoomLevel = scale;
            document.getElementById('poster-wrapper').style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoom-level').innerText = Math.round(zoomLevel * 100) + '%';
        }

        function toggleTheme() {
            document.getElementById('poster-area').classList.toggle('dark');
        }

        function toggleFullScreen() {
            const editor = document.querySelector('aside');
            editor.classList.toggle('hidden');
        }

        // Init
        renderEditorList();
        renderPoster();

        // Auto-fit on load
        window.addEventListener('load', fitToScreen);
        window.addEventListener('resize', fitToScreen);</script>
</body>

</html>