<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Poster Studio</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">

    <!-- TAILWIND CONFIG -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',
                            orange: '#FF8C42',
                            green: '#00E676',
                            blue: '#2979FF',
                            dark: '#1e293b',   // Slate 900
                            chalk: '#f8fafc',  // Slate 50
                            yellow: '#FCD34D',
                            surface: '#E2E8F0' // Slate 200
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                        hand: ['Patrick Hand', 'cursive'],
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-lg': '8px 8px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-white': '4px 4px 0px 0px #ffffff',
                    }
                }
            }
        }
    </script>

    <!-- CUSTOM CSS -->
    <style>
        /* 1. RESET & BASICS */
        :root { --neo-dark: #1e293b; }
        body { -webkit-font-smoothing: antialiased; }

        /* 2. CUSTOM SCROLLBARS */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 99px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }

        /* 3. GRAPH PAPER BACKGROUND */
        .bg-graph-paper {
            background-color: #f8fafc;
            background-image:
                linear-gradient(#e2e8f0 1px, transparent 1px),
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .dark.bg-graph-paper {
            background-color: #1e293b;
            background-image:
                linear-gradient(#334155 1px, transparent 1px),
                linear-gradient(90deg, #334155 1px, transparent 1px);
        }

        /* 4. DECORATIONS */
        .tape-strip {
            position: absolute;
            top: -12px; left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            width: 80px; height: 24px;
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(2px);
            border-left: 2px dashed rgba(0,0,0,0.1);
            border-right: 2px dashed rgba(0,0,0,0.1);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 5. UTILITIES */
        #poster-wrapper {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: top center;
        }
        input:focus, textarea:focus, select:focus { outline: none; }
        
        /* Input Base Style */
        .neo-input {
            width: 100%;
            background-color: white;
            border: 2px solid #1e293b;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            color: #1e293b;
            transition: all 0.2s;
        }
        .neo-input:focus {
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
            background-color: #FEF9C3; /* brand-yellow light */
            transform: translateY(-2px);
        }

        /* ZEN MODE / FULL SCREEN (Sidebar Hidden) */
        body.zen-mode aside { display: none !important; }
        body.zen-mode #poster-viewport { 
            padding: 0; 
            align-items: center; 
            justify-content: center; 
        }

        /* 6. PRINT STYLES */
        @media print {
            .no-print, aside, button, .zoom-controls { display: none !important; }
            body, html, main, #poster-viewport { 
                margin: 0; padding: 0; background: white; overflow: visible; height: auto; 
            }
            #poster-wrapper { transform: none !important; width: 100%; margin: 0; }
            #poster-area {
                margin: 0; border: none; box-shadow: none;
                width: 100% !important; height: 100vh !important;
                background-color: white !important; background-image: none !important;
                page-break-after: always;
            }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>

<body class="bg-brand-surface h-screen w-screen overflow-hidden text-brand-dark font-body selection:bg-brand-yellow/50">

    <div class="flex h-full">

        <!-- ========================================= -->
        <!-- SIDEBAR: CONTROL PANEL                    -->
        <!-- ========================================= -->
        <aside class="w-[400px] h-full flex flex-col bg-white border-r-4 border-brand-dark shrink-0 relative z-30 no-print shadow-2xl transition-all duration-300">
            
            <!-- A. HEADER & PROJECT SWITCHER -->
            <div class="p-5 border-b-4 border-brand-dark bg-slate-50 relative overflow-hidden">
                <!-- Header Top -->
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <h1 class="font-heading font-black text-2xl text-brand-dark tracking-tight leading-none">
                        POSTER <br><span class="text-brand-pink text-3xl">STUDIO</span>
                    </h1>
                    <div class="flex gap-2">
                         <button onclick="toggleTheme()" title="Toggle Theme" class="w-10 h-10 flex items-center justify-center border-2 border-brand-dark rounded-xl bg-white shadow-neo hover:shadow-none hover:translate-y-1 transition-all">
                            <i data-lucide="moon" class="w-5 h-5 text-slate-700 dark:hidden"></i>
                            <i data-lucide="sun" class="w-5 h-5 text-brand-orange hidden dark:block"></i>
                        </button>
                    </div>
                </div>

                <!-- PROJECT SWITCHER (Quick Jump) -->
                <div class="mb-5 p-1.5 bg-brand-dark rounded-xl flex gap-1.5 shadow-neo relative z-10">
                    <button onclick="cyclePoster(-1)" title="Previous Poster" class="p-2.5 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    
                    <div class="flex-1 relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="folder" class="w-4 h-4 text-brand-yellow"></i>
                        </div>
                        <select id="project-quick-select" onchange="switchPoster(this.value)" 
                            class="w-full h-full pl-9 pr-8 bg-slate-800 rounded-lg font-heading font-bold text-sm text-white appearance-none cursor-pointer focus:bg-slate-700 transition-colors truncate border-none focus:ring-2 focus:ring-brand-yellow">
                            <!-- Options injected by JS -->
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none group-hover:text-white transition-colors"></i>
                    </div>

                    <button onclick="cyclePoster(1)" title="Next Poster" class="p-2.5 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>

                    <button onclick="createNewPoster()" title="New Project" class="p-2.5 bg-brand-green text-brand-dark rounded-lg hover:bg-[#00c965] transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- GLOBAL SETTINGS -->
                <div class="space-y-3 relative z-10">
                    <div class="grid grid-cols-4 gap-2">
                        <div class="col-span-1">
                            <label class="block font-heading font-bold text-[10px] text-slate-400 mb-1 uppercase tracking-wider">Badge</label>
                            <input type="text" id="global_badge" placeholder="#" class="neo-input text-center px-1">
                        </div>
                        <div class="col-span-3">
                            <label class="block font-heading font-bold text-[10px] text-slate-400 mb-1 uppercase tracking-wider">Main Title</label>
                            <input type="text" id="global_title" placeholder="TOPIC NAME" class="neo-input">
                        </div>
                    </div>
                    <div>
                        <label class="block font-heading font-bold text-[10px] text-slate-400 mb-1 uppercase tracking-wider">Subtitle / Context</label>
                        <input type="text" id="global_subtitle" placeholder="Description..." class="neo-input font-body font-semibold">
                    </div>
                </div>

                <!-- Background Decoration -->
                <div class="absolute -right-6 -bottom-12 opacity-10 pointer-events-none rotate-12">
                     <i data-lucide="pen-tool" class="w-48 h-48 text-brand-dark"></i>
                </div>
            </div>

            <!-- B. TOOLBOX -->
            <div class="p-5 border-b-4 border-brand-dark bg-white">
                <label class="block font-heading font-bold text-[10px] text-slate-400 mb-3 uppercase tracking-widest">Add Module</label>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Vocab -->
                    <button onclick="addModule('vocab')" class="flex flex-col items-center justify-center gap-2 p-3 bg-white border-2 border-brand-dark rounded-2xl shadow-[4px_4px_0px_0px_#00E676] hover:shadow-none hover:translate-y-1 transition-all active:shadow-none active:translate-y-1 group">
                        <div class="w-8 h-8 rounded-full bg-brand-green/20 flex items-center justify-center group-hover:bg-brand-green group-hover:text-white transition-colors text-brand-green">
                            <i data-lucide="list" class="w-5 h-5"></i>
                        </div>
                        <span class="font-heading font-bold text-slate-700 text-sm">Vocab</span>
                    </button>
                    <!-- Formula -->
                    <button onclick="addModule('grammar_structure')" class="flex flex-col items-center justify-center gap-2 p-3 bg-white border-2 border-brand-dark rounded-2xl shadow-[4px_4px_0px_0px_#2979FF] hover:shadow-none hover:translate-y-1 transition-all active:shadow-none active:translate-y-1 group">
                        <div class="w-8 h-8 rounded-full bg-brand-blue/20 flex items-center justify-center group-hover:bg-brand-blue group-hover:text-white transition-colors text-brand-blue">
                             <i data-lucide="layers" class="w-5 h-5"></i>
                        </div>
                        <span class="font-heading font-bold text-slate-700 text-sm">Formula</span>
                    </button>
                    <!-- Text -->
                    <button onclick="addModule('text')" class="flex flex-col items-center justify-center gap-2 p-3 bg-white border-2 border-brand-dark rounded-2xl shadow-[4px_4px_0px_0px_#FF8C42] hover:shadow-none hover:translate-y-1 transition-all active:shadow-none active:translate-y-1 group">
                        <div class="w-8 h-8 rounded-full bg-brand-orange/20 flex items-center justify-center group-hover:bg-brand-orange group-hover:text-white transition-colors text-brand-orange">
                            <i data-lucide="message-square" class="w-5 h-5"></i>
                        </div>
                        <span class="font-heading font-bold text-slate-700 text-sm">Text</span>
                    </button>
                    <!-- Logic -->
                    <button onclick="addModule('grammar_logic')" class="flex flex-col items-center justify-center gap-2 p-3 bg-white border-2 border-brand-dark rounded-2xl shadow-[4px_4px_0px_0px_#FF6B95] hover:shadow-none hover:translate-y-1 transition-all active:shadow-none active:translate-y-1 group">
                         <div class="w-8 h-8 rounded-full bg-brand-pink/20 flex items-center justify-center group-hover:bg-brand-pink group-hover:text-white transition-colors text-brand-pink">
                            <i data-lucide="lightbulb" class="w-5 h-5"></i>
                        </div>
                        <span class="font-heading font-bold text-slate-700 text-sm">Logic</span>
                    </button>
                </div>
            </div>

            <!-- C. LAYER LIST / EDITOR -->
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50 custom-scrollbar relative">
                <div id="layer-header" class="flex items-center justify-between mb-4 sticky top-0 bg-slate-50 z-10 py-2 border-b-2 border-slate-200">
                    <label class="block font-heading font-bold text-[10px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="layers" class="w-3 h-3"></i> Layers
                    </label>
                    <button onclick="clearAll()" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:underline">Clear All</button>
                </div>
                <div id="editor-container" class="space-y-3 pb-24"></div>
            </div>

            <!-- D. FOOTER -->
            <div class="p-4 border-t-4 border-brand-dark bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-10">
                <div class="flex gap-2">
                    <button onclick="saveState()" class="flex-1 py-3 bg-brand-dark text-white font-heading font-bold rounded-xl shadow-neo hover:shadow-none hover:translate-y-1 transition-all flex items-center justify-center gap-2 group">
                         <i data-lucide="save" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> Save Changes
                    </button>
                    <div class="flex border-2 border-brand-dark rounded-xl overflow-hidden shadow-neo bg-white">
                         <button onclick="exportPoster()" title="Export JSON" class="px-4 hover:bg-slate-100 border-r-2 border-brand-dark transition-colors"><i data-lucide="download" class="w-5 h-5"></i></button>
                         <button onclick="importPoster()" title="Import JSON" class="px-4 hover:bg-slate-100 transition-colors"><i data-lucide="upload" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ========================================= -->
        <!-- MAIN CONTENT: CANVAS                      -->
        <!-- ========================================= -->
        <main class="flex-1 h-full relative overflow-hidden flex flex-col bg-brand-surface">
            <!-- Toolbar -->
            <div class="absolute top-4 right-4 z-40 flex gap-2 no-print group">
                <!-- Zoom Controls -->
                <div class="bg-white border-2 border-brand-dark rounded-xl shadow-neo flex items-center p-1">
                    <button onclick="changeZoom(-0.1)" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 hover:text-brand-dark"><i data-lucide="minus" class="w-5 h-5"></i></button>
                    <span id="zoom-level" class="font-heading font-bold text-sm w-12 text-center text-brand-dark">100%</span>
                    <button onclick="changeZoom(0.1)" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 hover:text-brand-dark"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>

                <!-- NEW: LIBRARY BUTTON (Zen Mode Access) -->
                <button onclick="openLibrary()" title="My Posters" class="bg-brand-yellow border-2 border-brand-dark text-brand-dark p-3 rounded-xl shadow-neo hover:shadow-none hover:translate-y-1 transition-all">
                    <i data-lucide="folder-open" class="w-5 h-5"></i>
                </button>
                
                <!-- FULLSCREEN / ZEN TOGGLE -->
                <button id="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Sidebar" class="bg-white border-2 border-brand-dark text-brand-dark p-3 rounded-xl shadow-neo hover:shadow-none hover:translate-y-1 transition-all">
                    <i data-lucide="maximize" class="w-5 h-5"></i>
                </button>
                
                <!-- PRINT -->
                <button onclick="window.print()" title="Print" class="bg-brand-blue border-2 border-brand-dark text-white p-3 rounded-xl shadow-neo hover:shadow-none hover:translate-y-1 transition-all">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Viewport -->
            <div id="poster-viewport" class="flex-1 w-full h-full overflow-auto p-8 flex justify-center items-start transition-all duration-300">
                <div id="poster-wrapper">
                    <!-- ACER CHROMEBOOK RATIO: 1366x768 -->
                    <!-- Added HUGE shadow and transition -->
                    <div id="poster-area" class="w-[1366px] h-[768px] bg-brand-chalk bg-graph-paper relative shadow-neo-lg overflow-hidden border-4 border-brand-dark transition-all duration-300">
                        <!-- Content Injected Here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========================================= -->
    <!-- CUSTOM MODAL (Alerts)                     -->
    <!-- ========================================= -->
    <div id="custom-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-brand-dark/50 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-md rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] overflow-hidden transform scale-95 transition-all duration-200">
            <div class="bg-brand-dark p-4 flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg border border-white/20">
                    <i id="modal-icon" data-lucide="info" class="w-6 h-6 text-brand-yellow"></i>
                </div>
                <h3 id="modal-title" class="font-heading text-xl font-bold text-white tracking-wide">Notification</h3>
            </div>
            <div class="p-6">
                <p id="modal-msg" class="text-slate-600 font-bold text-base leading-relaxed mb-6">Message...</p>
                <div class="flex gap-3">
                    <button id="modal-cancel" onclick="closeModal()" class="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-500 hover:bg-slate-100 hover:border-slate-400 transition-all">Cancel</button>
                    <button id="modal-confirm" class="flex-1 py-3 border-2 border-brand-dark bg-brand-pink text-white rounded-xl font-bold shadow-neo-sm hover:translate-y-0.5 hover:shadow-none transition-all flex justify-center items-center gap-2">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- LIBRARY MODAL                             -->
    <!-- ========================================= -->
    <div id="library-modal" class="fixed inset-0 z-[90] hidden items-center justify-center bg-brand-dark/50 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-2xl h-[80vh] flex flex-col rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] overflow-hidden transform scale-95 transition-all duration-200">
            <!-- Header -->
            <div class="bg-slate-50 border-b-4 border-brand-dark p-5 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-brand-yellow border-2 border-brand-dark p-3 rounded-xl shadow-neo-sm">
                        <i data-lucide="library" class="w-6 h-6 text-brand-dark"></i>
                    </div>
                    <div>
                        <h2 class="font-heading font-black text-2xl text-brand-dark leading-none">MY POSTERS</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Manage your collection</p>
                    </div>
                </div>
                <button onclick="closeLibrary()" class="p-2 hover:bg-slate-200 rounded-lg"><i data-lucide="x" class="w-6 h-6 text-slate-600"></i></button>
            </div>
            
            <!-- List -->
            <div id="library-list" class="flex-1 overflow-y-auto p-5 space-y-3 bg-slate-100 custom-scrollbar">
                <!-- Posters injected here -->
            </div>

            <!-- Footer -->
            <div class="p-5 border-t-4 border-brand-dark bg-white">
                <button onclick="createNewPoster()" class="w-full py-4 border-2 border-brand-dark bg-brand-green text-brand-dark rounded-xl font-heading font-black text-lg shadow-neo hover:shadow-none hover:translate-y-1 transition-all flex justify-center items-center gap-2">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i> CREATE NEW POSTER
                </button>
            </div>
        </div>
    </div>

    <!-- HIDDEN INPUT -->
    <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleFileImport(this)">

    <!-- ========================================= -->
    <!-- APP LOGIC                                 -->
    <!-- ========================================= -->
    <script>
        // --- 1. STATE & STORAGE (V2) ---
        const STORAGE_KEY = 'english1-poster-studio-v2';
        
        // Structure: { currentId: 'id', theme: 'light', posters: [ {id, global, modules, zoom, lastModified} ] }
        const defaultPosterData = {
            id: 'default',
            global: { title: 'UNTITLED', subtitle: 'New Project', badge: '1' },
            modules: [],
            zoom: 1.0, // FIXED: Default zoom is now 100%
            lastModified: Date.now()
        };

        const defaultState = {
            currentId: 'default',
            theme: 'light',
            posters: [ JSON.parse(JSON.stringify(defaultPosterData)) ]
        };
        
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState;
        
        // State Migration Check
        if (!state.posters || !Array.isArray(state.posters)) {
            state = defaultState;
        }

        let currentPoster = state.posters.find(p => p.id === state.currentId) || state.posters[0];
        let editingId = null;
        let modalCallback = null;

        // --- 2. CORE ACTIONS ---
        function saveState() {
            // CRITICAL FIX: Ensure global inputs are saved to currentPoster object
            currentPoster.global.title = document.getElementById('global_title').value;
            currentPoster.global.subtitle = document.getElementById('global_subtitle').value;
            currentPoster.global.badge = document.getElementById('global_badge').value;
            currentPoster.lastModified = Date.now();

            // Sync back to main state array to ensure changes are persisted to the list
            const idx = state.posters.findIndex(p => p.id === currentPoster.id);
            if(idx !== -1) {
                state.posters[idx] = currentPoster;
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            
            // Visual Feedback
            updateQuickSelector(); // Refresh dropdown title
            
            const btn = document.querySelector('button[onclick="saveState()"]');
            if(btn) {
                const oldHTML = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Saved!`;
                btn.classList.add('bg-brand-green', 'text-brand-dark', 'border-brand-dark');
                btn.classList.remove('bg-brand-dark', 'text-white');
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = oldHTML;
                    btn.classList.remove('bg-brand-green', 'text-brand-dark', 'border-brand-dark');
                    btn.classList.add('bg-brand-dark', 'text-white');
                    lucide.createIcons();
                }, 1000);
            }
        }

        // --- 3. MODULE LOGIC ---
        function addModule(type) {
            const id = crypto.randomUUID();
            let newMod = { id, type, size: 'medium', title: 'New Section', color: 'blue', data: {} };

            // Defaults
            if (type === 'vocab') { newMod.title = 'Vocabulary'; newMod.color = 'green'; newMod.data.list = 'Apple\nBanana\nOrange'; }
            if (type === 'grammar_structure') { newMod.title = 'Formula'; newMod.color = 'blue'; newMod.data = { formula: 'S + V + O', example: 'I play chess.' }; }
            if (type === 'text') { newMod.title = 'Dialogue'; newMod.color = 'orange'; newMod.data.text = 'A: Hello!\nB: Hi there!'; }
            if (type === 'grammar_logic') { newMod.title = 'Concept'; newMod.color = 'pink'; newMod.data = { concept: 'Why?', rule: 'Because...' }; }

            currentPoster.modules.push(newMod);
            saveState();
            renderAll();
            setTimeout(() => document.getElementById('editor-container').scrollTop = 9999, 50);
        }

        function deleteModule(id) {
            showModal('Delete Module?', 'This cannot be undone.', true, () => {
                currentPoster.modules = currentPoster.modules.filter(m => m.id !== id);
                if (editingId === id) closeEditor();
                saveState();
                renderAll();
            });
        }

        function moveModule(idx, dir) {
            if (idx + dir < 0 || idx + dir >= currentPoster.modules.length) return;
            [currentPoster.modules[idx], currentPoster.modules[idx+dir]] = [currentPoster.modules[idx+dir], currentPoster.modules[idx]];
            saveState();
            renderAll();
        }

        function updateModule(id, key, val) {
            const mod = currentPoster.modules.find(m => m.id === id);
            if (!mod) return;
            if (key.includes('.')) {
                const [p, c] = key.split('.');
                mod[p][c] = val;
            } else {
                mod[key] = val;
            }
            renderPoster();
        }

        // --- 4. UI RENDERING ---
        function renderAll() {
            renderEditorList();
            renderPoster();
            updateQuickSelector();
        }

        function renderEditorList() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            if (currentPoster.modules.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-slate-300 rounded-xl mt-4">
                        <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="box" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-500 font-bold text-sm">No layers yet</p>
                        <p class="text-slate-400 text-xs mt-1">Add a module above to start</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            currentPoster.modules.forEach((mod, idx) => {
                const isActive = editingId === mod.id;
                const div = document.createElement('div');
                div.className = `relative group flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${isActive ? 'bg-white border-brand-dark shadow-neo translate-x-1 z-10' : 'bg-white border-slate-200 hover:border-slate-400 hover:shadow-sm'}`;
                
                div.innerHTML = `
                    <div class="w-1.5 h-10 rounded-full bg-brand-${mod.color}"></div>
                    <div class="flex-1 min-w-0" onclick="openEditor('${mod.id}')">
                        <div class="flex items-center gap-2 mb-0.5">
                            <span class="text-[9px] font-black uppercase tracking-wider text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded-md">${mod.type.replace('_', ' ')}</span>
                        </div>
                        <h4 class="font-heading font-bold text-slate-800 text-sm truncate leading-tight">${mod.title}</h4>
                    </div>
                    <div class="flex items-center gap-1 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity">
                        <button onclick="moveModule(${idx}, -1)" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-brand-dark"><i data-lucide="arrow-up" class="w-3.5 h-3.5"></i></button>
                        <button onclick="moveModule(${idx}, 1)" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-brand-dark"><i data-lucide="arrow-down" class="w-3.5 h-3.5"></i></button>
                        <button onclick="deleteModule('${mod.id}')" class="p-1.5 hover:bg-red-50 rounded text-red-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function openEditor(id) {
            editingId = id;
            const mod = currentPoster.modules.find(m => m.id === id);
            if (!mod) return;

            const container = document.getElementById('editor-container');
            const commonFields = `
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div><label class="l">Color</label><select class="neo-input" onchange="updateModule('${id}','color',this.value)">
                        <option value="pink" ${mod.color=='pink'?'selected':''}>Pink</option>
                        <option value="orange" ${mod.color=='orange'?'selected':''}>Orange</option>
                        <option value="green" ${mod.color=='green'?'selected':''}>Green</option>
                        <option value="blue" ${mod.color=='blue'?'selected':''}>Blue</option>
                    </select></div>
                    <div><label class="l">Size</label><select class="neo-input" onchange="updateModule('${id}','size',this.value)">
                        <option value="mini" ${mod.size=='mini'?'selected':''}>Mini (1/4)</option>
                        <option value="medium" ${mod.size=='medium'?'selected':''}>Medium (1/2)</option>
                        <option value="full" ${mod.size=='full'?'selected':''}>Full</option>
                    </select></div>
                </div>
                <div class="mb-3"><label class="l">Title</label><input type="text" class="neo-input" value="${mod.title}" oninput="updateModule('${id}','title',this.value)"></div>
            `;

            let specificFields = '';
            if (mod.type === 'vocab') specificFields = `<label class="l">List Items</label><textarea class="neo-input h-32 font-mono text-sm" oninput="updateModule('${id}','data.list',this.value)">${mod.data.list||''}</textarea>`;
            if (mod.type === 'text') specificFields = `<label class="l">Body Text</label><textarea class="neo-input h-32" oninput="updateModule('${id}','data.text',this.value)">${mod.data.text||''}</textarea>`;
            if (mod.type === 'grammar_structure') specificFields = `<label class="l">Formula</label><input class="neo-input mb-2" value="${mod.data.formula||''}" oninput="updateModule('${id}','data.formula',this.value)"><label class="l">Example</label><input class="neo-input" value="${mod.data.example||''}" oninput="updateModule('${id}','data.example',this.value)">`;
            if (mod.type === 'grammar_logic') specificFields = `<label class="l">Concept</label><input class="neo-input mb-2" value="${mod.data.concept||''}" oninput="updateModule('${id}','data.concept',this.value)"><label class="l">Rule / Explanation</label><textarea class="neo-input h-20" oninput="updateModule('${id}','data.rule',this.value)">${mod.data.rule||''}</textarea>`;

            container.innerHTML = `
                <div class="bg-white rounded-xl border-2 border-brand-dark p-4 shadow-neo z-20 relative">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-slate-100">
                        <button onclick="closeEditor()" class="flex items-center gap-1 text-xs font-bold text-slate-500 hover:text-brand-dark"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                        <span class="text-[10px] font-black uppercase text-slate-300 tracking-wider">Editing Module</span>
                    </div>
                    ${commonFields} ${specificFields}
                    <button onclick="deleteModule('${id}')" class="w-full mt-6 py-2 border-2 border-red-100 text-red-500 rounded-lg hover:bg-red-50 font-bold text-xs flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Delete Module
                    </button>
                </div>
            `;
            
            container.querySelectorAll('.l').forEach(el => el.className = 'block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-1.5 ml-1');
            lucide.createIcons();
        }

        function closeEditor() { editingId = null; renderEditorList(); }

        function renderPoster() {
            const canvas = document.getElementById('poster-area');
            const { title, subtitle, badge } = currentPoster.global;
            
            // Header (Oval Badge)
            const headerHTML = `
                <div class="w-full flex items-start justify-between mb-6 border-b-4 border-brand-dark pb-4">
                    <div class="flex-1 pr-8">
                        <h1 class="font-heading font-black text-6xl text-brand-dark tracking-tight leading-none mb-2">${title}</h1>
                        <p class="font-body font-bold text-2xl text-slate-500 dark:text-slate-400">${subtitle}</p>
                    </div>
                    <div class="h-20 min-w-[120px] px-8 flex items-center justify-center bg-brand-yellow border-4 border-brand-dark rounded-full shadow-neo transform rotate-2">
                        <span class="font-heading font-black text-4xl text-brand-dark whitespace-nowrap">${badge}</span>
                    </div>
                </div>
            `;

            let gridHTML = `<div class="grid grid-cols-12 gap-6 items-start auto-rows-min">`;
            currentPoster.modules.forEach(mod => {
                let span = 'col-span-12';
                if (mod.size === 'medium') span = 'col-span-6';
                if (mod.size === 'mini') span = 'col-span-4';

                let content = '';
                if (mod.type === 'vocab') {
                    content = `<ul class="p-5 bg-white h-full">` + (mod.data.list||'').split('\n').filter(x=>x).map(x => `
                        <li class="flex items-center gap-3 mb-3"><div class="w-3 h-3 rounded-sm bg-brand-${mod.color} border border-brand-dark shadow-[1px_1px_0_0_rgba(30,41,59,1)]"></div><span class="font-body font-bold text-xl text-brand-dark">${x}</span></li>
                    `).join('') + `</ul>`;
                } else if (mod.type === 'grammar_structure') {
                    content = `<div class="p-6 bg-white text-center h-full flex flex-col justify-center"><div class="mb-4 font-heading font-black text-2xl text-brand-blue bg-blue-50 px-4 py-3 rounded-xl border-2 border-brand-blue border-dashed">${mod.data.formula||''}</div><p class="font-hand text-2xl text-slate-600">"${mod.data.example||''}"</p></div>`;
                } else if (mod.type === 'text') {
                    content = `<div class="p-5 bg-white font-body text-xl whitespace-pre-line text-slate-700 h-full leading-relaxed">${mod.data.text||''}</div>`;
                } else if (mod.type === 'grammar_logic') {
                    content = `<div class="flex flex-col h-full"><div class="bg-slate-50 p-4 border-b-2 border-brand-dark"><span class="text-[11px] font-black text-slate-400 uppercase tracking-widest">CONCEPT</span><p class="font-heading font-bold text-2xl text-brand-dark mt-1">${mod.data.concept||''}</p></div><div class="bg-white p-4 flex-1"><span class="text-[11px] font-black text-slate-400 uppercase tracking-widest">RULE</span><p class="font-hand text-2xl text-brand-pink mt-1">${mod.data.rule||''}</p></div></div>`;
                }

                gridHTML += `
                    <div class="${span} bg-white border-4 border-brand-dark rounded-2xl overflow-hidden shadow-neo relative h-full flex flex-col">
                        <div class="bg-brand-${mod.color} px-5 py-2.5 border-b-4 border-brand-dark flex justify-between items-center relative z-10">
                            <h3 class="font-heading font-black text-white text-xl uppercase shadow-sm tracking-wide">${mod.title}</h3>
                            <div class="w-3 h-3 rounded-full bg-brand-dark opacity-20"></div>
                        </div>
                        <div class="flex-1">${content}</div>
                        <div class="tape-strip"></div>
                    </div>
                `;
            });
            gridHTML += `</div>`;

            canvas.innerHTML = `
                <div class="p-12 h-full flex flex-col">
                    ${headerHTML}
                    ${gridHTML}
                    <div class="mt-auto pt-8 text-center opacity-40"><p class="font-heading font-bold text-brand-dark text-sm uppercase tracking-[0.3em]">English 1 Batam â€¢ Educational Resource</p></div>
                </div>
            `;

            // Theme Apply
            if (state.theme === 'dark') {
                canvas.classList.add('dark');
                canvas.classList.replace('bg-brand-chalk', 'bg-slate-900');
            } else {
                canvas.classList.remove('dark');
                canvas.classList.replace('bg-slate-900', 'bg-brand-chalk');
            }
            lucide.createIcons();
        }

        // --- 5. UTILS ---
        function init() {
            // Populate Global inputs with current poster data
            document.getElementById('global_title').value = currentPoster.global.title;
            document.getElementById('global_subtitle').value = currentPoster.global.subtitle;
            document.getElementById('global_badge').value = currentPoster.global.badge;
            
            ['global_title', 'global_subtitle', 'global_badge'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    renderPoster(); // Live preview
                    
                    // Update state object immediately so dropdown reflects title
                    currentPoster.global[id.replace('global_', '')] = document.getElementById(id).value;
                    
                    // Don't full save to LS on every keystroke, but update quick selector
                    updateQuickSelector();
                });
            });

            updateQuickSelector();
            changeZoom(0); // init zoom (now calls apply with default 1.0)
            renderAll();
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            saveState(); // Global save
            renderPoster();
        }

        function changeZoom(delta) {
            // Default 1.0, allowed range 0.3 to 1.5
            currentPoster.zoom = Math.max(0.3, Math.min(1.5, (currentPoster.zoom || 1.0) + delta));
            
            document.getElementById('poster-wrapper').style.transform = `scale(${currentPoster.zoom})`;
            document.getElementById('zoom-level').innerText = `${Math.round(currentPoster.zoom * 100)}%`;
        }
        
        function toggleFullScreen() {
            document.body.classList.toggle('zen-mode');
            
            // Toggle Icon
            const btnIcon = document.querySelector('#fullscreen-btn i');
            if (document.body.classList.contains('zen-mode')) {
                btnIcon.setAttribute('data-lucide', 'minimize');
            } else {
                btnIcon.setAttribute('data-lucide', 'maximize');
            }
            lucide.createIcons();
        }

        function clearAll() {
            showModal('Clear Poster', 'Are you sure? This removes everything.', true, () => {
                currentPoster.modules = [];
                saveState();
                renderAll();
            });
        }

        // --- 6. LIBRARY SYSTEM ---
        
        // NEW: Populate the Quick Dropdown
        function updateQuickSelector() {
            const sel = document.getElementById('project-quick-select');
            // Save current selection before clearing
            const currentVal = currentPoster.id;
            
            sel.innerHTML = state.posters.map(p => 
                `<option value="${p.id}" ${p.id === currentVal ? 'selected' : ''}>${p.global.title}</option>`
            ).join('');
        }

        function cyclePoster(dir) {
            const idx = state.posters.findIndex(p => p.id === currentPoster.id);
            if (idx === -1) return;
            
            let newIdx = idx + dir;
            if (newIdx >= state.posters.length) newIdx = 0;
            if (newIdx < 0) newIdx = state.posters.length - 1;
            
            switchPoster(state.posters[newIdx].id);
        }

        function openLibrary() {
            saveState(); // Ensure current progress is saved
            const modal = document.getElementById('library-modal');
            const list = document.getElementById('library-list');
            list.innerHTML = '';
            
            // Sort by last modified
            const sortedPosters = [...state.posters].sort((a,b) => (b.lastModified || 0) - (a.lastModified || 0));

            sortedPosters.forEach(p => {
                const isCurrent = p.id === currentPoster.id;
                const date = new Date(p.lastModified || Date.now()).toLocaleDateString();
                const div = document.createElement('div');
                div.className = `p-4 border-2 rounded-xl flex items-center justify-between transition-all ${isCurrent ? 'border-brand-blue bg-blue-50 shadow-neo-sm' : 'border-slate-200 bg-white hover:border-slate-400 hover:shadow-sm'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-xl ${isCurrent ? 'bg-brand-blue text-white' : 'bg-slate-100 text-slate-400'} flex items-center justify-center font-black text-2xl border-2 border-brand-dark shadow-sm">
                            ${p.global.badge || '#'}
                        </div>
                        <div>
                            <h4 class="font-heading font-black text-xl text-brand-dark uppercase tracking-tight">${p.global.title}</h4>
                            <p class="font-body text-xs font-bold text-slate-500 mt-1 flex items-center gap-2">
                                <i data-lucide="layers" class="w-3 h-3"></i> ${p.modules.length} modules
                                <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                ${date}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${isCurrent 
                            ? `<span class="px-4 py-2 bg-brand-dark text-white rounded-lg font-bold text-xs flex items-center gap-2 shadow-neo-sm"><i data-lucide="check" class="w-3 h-3"></i> OPEN</span>` 
                            : `<button onclick="switchPoster('${p.id}')" class="px-4 py-2 border-2 border-slate-200 hover:border-brand-dark hover:bg-white rounded-lg font-bold text-xs text-slate-600 transition-all">OPEN</button>`
                        }
                        ${state.posters.length > 1 ? `<button onclick="deletePoster('${p.id}')" class="p-2.5 bg-red-50 text-red-400 border-2 border-transparent hover:border-red-200 hover:text-red-600 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
            
            lucide.createIcons();
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0', 'pointer-events-none'); }, 10);
        }

        function closeLibrary() {
            const modal = document.getElementById('library-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function createNewPoster() {
            const newP = JSON.parse(JSON.stringify(defaultPosterData));
            newP.id = crypto.randomUUID();
            newP.lastModified = Date.now();
            
            // Fix: ensure global data is reset, not copied from last session defaults if they were mutated
            newP.global = { title: 'UNTITLED', subtitle: 'New Project', badge: '1' };
            newP.modules = [];

            state.posters.push(newP);
            state.currentId = newP.id;
            currentPoster = newP;
            
            saveState();
            closeLibrary();
            init(); // Re-bind inputs and update selector
        }

        function switchPoster(id) {
            const target = state.posters.find(p => p.id === id);
            if(target) {
                // Save current state first before switching!
                saveState();

                state.currentId = id;
                currentPoster = target;
                
                // We don't need to saveState() again immediately, but we must update LocalStorage with new currentId
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                
                closeLibrary();
                init();
            }
        }

        function deletePoster(id) {
            if(!confirm("Delete this poster permanently?")) return; // Using native confirm for inside library simplicity
            state.posters = state.posters.filter(p => p.id !== id);
            
            // If we deleted the current one, switch to the first available
            if(id === currentPoster.id) {
                state.currentId = state.posters[0].id;
                currentPoster = state.posters[0];
                init();
            }
            saveState();
            openLibrary(); // Refresh list
        }


        // --- 7. MODAL ---
        function showModal(title, msg, isConfirm, callback) {
            const m = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            
            const icon = document.getElementById('modal-icon');
            if(title.toLowerCase().includes('delete') || title.toLowerCase().includes('clear')) {
                icon.setAttribute('data-lucide', 'alert-triangle'); icon.classList.replace('text-brand-yellow','text-brand-pink');
            } else {
                icon.setAttribute('data-lucide', 'info'); icon.classList.replace('text-brand-pink','text-brand-yellow');
            }

            const cancel = document.getElementById('modal-cancel');
            const confirm = document.getElementById('modal-confirm');
            cancel.style.display = isConfirm ? 'block' : 'none';
            confirm.innerText = isConfirm ? 'Confirm' : 'OK';
            modalCallback = callback || closeModal;

            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0', 'pointer-events-none'); }, 10);
            lucide.createIcons();
        }

        function closeModal() {
            const m = document.getElementById('custom-modal');
            m.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => m.classList.add('hidden'), 200);
            modalCallback = null;
        }

        document.getElementById('modal-confirm').onclick = () => { if(modalCallback) modalCallback(); closeModal(); };

        // --- 8. EXPORT/IMPORT ---
        function exportPoster() {
            // Export ONLY the current poster, not the whole library
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentPoster));
            const dl = document.createElement('a');
            dl.href = data;
            dl.download = `poster_${currentPoster.global.title.replace(/\s+/g, '_')}.json`;
            dl.click();
        }

        function importPoster() { document.getElementById('import-file').click(); }
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Check if valid poster structure
                    if(json.global && json.modules) {
                        // Create a new ID to avoid conflicts
                        json.id = crypto.randomUUID();
                        json.lastModified = Date.now();
                        
                        state.posters.push(json);
                        state.currentId = json.id;
                        currentPoster = json;
                        
                        saveState();
                        init();
                        showModal('Success', 'Poster imported!', false);
                    } else {
                         showModal('Error', 'Invalid file format.', false);
                    }
                } catch(e) { showModal('Error', 'Invalid file.', false); }
            };
            r.readAsText(file);
            input.value = '';
        }

        window.onload = init;
    </script>
</body>
</html>