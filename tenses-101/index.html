<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 â€¢ Tense Diver</title>
    
    <!-- 
      FONTS: 
      - Fredoka: Headings & UI elements (Playful)
      - Nunito: Body text (Readable)
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ICONS: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CONFIGURATION: English 1 Batam Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',   
                            orange: '#FF8C42', 
                            green: '#00E676',  
                            blue: '#2979FF',   
                            purple: '#A855F7', 
                            dark: '#1e293b',   
                            chalk: '#f8fafc',  
                            blackboard: '#0f172a',
                            chalkboard: '#1e293b',
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': '0px 0px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-white': '4px 4px 0px 0px rgba(255, 255, 255, 1)', 
                        'neo-sm-white': '2px 2px 0px 0px rgba(255, 255, 255, 1)',
                    },
                    borderWidth: {
                        '3': '3px',
                    },
                    animation: {
                        'pop-center': 'pop-in-center 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pop-left': 'pop-in-left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                        'bounce-subtle': 'bounce-subtle 2s infinite',
                    },
                    keyframes: {
                        'pop-in-center': {
                            '0%': { transform: 'translate(-50%, -50%) scale(0.5)', opacity: '0' },
                            '100%': { transform: 'translate(-50%, -50%) scale(1)', opacity: '1' }
                        },
                        'pop-in-left': {
                            '0%': { transform: 'translate(0, -50%) scale(0.5)', opacity: '0' },
                            '100%': { transform: 'translate(0, -50%) scale(1)', opacity: '1' }
                        },
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        'bounce-subtle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        html.dark body {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }

        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 99px; }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        html.dark .scroller::-webkit-scrollbar-thumb { background-color: #475569; }
        html.dark .scroller::-webkit-scrollbar-thumb:hover { background-color: #64748b; }

        .t-item {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            z-index: 10;
            pointer-events: none;
        }
        
        .t-item > * { pointer-events: auto; }
        
        /* Builder Mode Styles */
        .cursor-pen { cursor: crosshair; }
    </style>
</head>
<body class="bg-slate-50 text-brand-dark font-body h-screen flex flex-col overflow-hidden transition-colors duration-300 dark:bg-brand-blackboard dark:text-white" onload="App.init()">

    <!-- ================= 1. HEADER ================= -->
    <nav class="h-16 shrink-0 bg-white/90 dark:bg-brand-blackboard/90 backdrop-blur-sm border-b-3 border-brand-dark dark:border-white px-4 md:px-6 flex items-center justify-between z-50 sticky top-0 transition-colors duration-300">
        <div class="flex items-center gap-3 select-none cursor-pointer" onclick="location.reload()">
            <div class="bg-brand-pink p-1.5 rounded-lg border-2 border-brand-dark dark:border-white shadow-sm transform -rotate-3 transition-transform hover:rotate-0">
                <i data-lucide="compass" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-xl md:text-2xl font-heading font-black tracking-tight text-brand-dark dark:text-white">
                Tense <span class="text-brand-blue">Diver</span>
            </h1>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="hidden md:flex gap-3 text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest items-center">
                <span class="px-2 py-1 bg-slate-100 dark:bg-brand-chalkboard rounded border border-slate-200 dark:border-slate-600">English 1 Batam</span>
                <span class="w-1.5 h-1.5 bg-brand-green rounded-full animate-pulse"></span>
                <span>Live Preview</span>
            </div>

            <button onclick="App.toggleTheme()" class="p-2 rounded-lg border-2 border-brand-dark dark:border-white shadow-neo dark:shadow-neo-white active:shadow-neo-pressed active:translate-y-1 transition-all bg-white dark:bg-brand-chalkboard hover:bg-slate-50 dark:hover:bg-slate-700 ml-2 group">
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-brand-dark"></i>
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
            </button>

            <button onclick="App.toggleSidebar()" class="md:hidden p-2 rounded-lg border-2 border-brand-dark dark:border-white shadow-neo dark:shadow-neo-white active:shadow-neo-pressed active:translate-y-1 transition-all bg-white dark:bg-brand-chalkboard hover:bg-slate-50 dark:hover:bg-slate-700">
                <i data-lucide="menu" class="w-6 h-6 dark:text-white"></i>
            </button>
        </div>
    </nav>

    <!-- ================= 2. MAIN LAYOUT ================= -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-64 md:w-72 bg-white dark:bg-brand-blackboard border-r-3 border-brand-dark dark:border-white flex flex-col shrink-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 absolute md:relative h-full shadow-[10px_0_20px_rgba(0,0,0,0.1)] md:shadow-none">
            <div class="p-4 border-b-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-brand-chalkboard/50">
                <h2 class="font-heading font-black text-slate-400 uppercase tracking-widest text-[10px]">Time Frames</h2>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-auto scroller p-3 pb-20 space-y-6"></div>
        </aside>

        <!-- STAGE -->
        <main class="flex-1 overflow-y-auto scroller p-4 md:p-8 relative w-full" onclick="App.closeSidebarMobile()">
            
            <!-- SECTION A: Header -->
            <div class="max-w-4xl mx-auto mb-8 animate-fade-in">
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between mb-4">
                    <div>
                        <span id="tense-category" class="text-[10px] md:text-xs font-black uppercase tracking-widest px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded border border-slate-200 dark:border-slate-700 select-none transition-colors">Category</span>
                        <h1 id="tense-title" class="text-3xl md:text-5xl font-heading font-black text-brand-dark dark:text-white mt-2 leading-tight drop-shadow-sm transition-colors">Tense Title</h1>
                    </div>
                    
                    <div class="bg-white dark:bg-brand-chalkboard border-2 border-brand-dark dark:border-white shadow-neo-sm dark:shadow-neo-sm-white rounded-xl px-4 py-2 flex items-center gap-2 shrink-0 transform hover:scale-105 transition-transform cursor-help group relative select-none">
                        <i data-lucide="function-square" class="w-5 h-5 text-brand-purple"></i>
                        <span id="tense-formula" class="font-bold font-mono text-lg text-brand-purple">Formula</span>
                        <div class="absolute -bottom-8 right-0 bg-brand-dark text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                            Grammar Structure
                        </div>
                    </div>
                </div>

                <p id="tense-desc" class="text-lg md:text-xl text-slate-600 dark:text-slate-300 font-bold max-w-2xl leading-relaxed">
                    Description text...
                </p>
            </div>

            <!-- SECTION B: Visualization -->
            <div class="max-w-4xl mx-auto mb-8 animate-fade-in" style="animation-delay: 0.1s">
                <!-- Timeline Container -->
                <div id="timeline-container" onclick="App.handleTimelineClick(event)" class="bg-slate-50 dark:bg-slate-800 border-3 border-brand-dark dark:border-white rounded-2xl shadow-neo dark:shadow-neo-white relative overflow-hidden h-[340px] w-full select-none group transition-all duration-300">
                    
                    <!-- Builder Mode Badge -->
                    <div id="builder-badge" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-brand-orange text-white px-3 py-1 rounded-full font-black text-xs uppercase tracking-widest border-2 border-brand-dark shadow-sm z-30 hidden animate-bounce-subtle">
                        Builder Mode Active
                    </div>

                    <button onclick="App.replayAnimation()" class="absolute top-4 right-4 z-30 p-2 rounded-lg bg-white/80 dark:bg-slate-700/80 border-2 border-brand-dark dark:border-white shadow-sm hover:scale-110 active:scale-95 transition-all text-slate-500 dark:text-white hover:text-brand-dark" title="Replay Animation / Reset Builder">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>

                    <div class="absolute inset-0 opacity-40 pointer-events-none" style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 40px 40px;"></div>
                    
                    <!-- Axis Labels -->
                    <div class="absolute top-4 left-4 flex items-center gap-1 opacity-40">
                        <i data-lucide="arrow-left" class="w-3 h-3 text-brand-dark dark:text-white"></i>
                        <span class="font-black text-brand-dark dark:text-white text-xs uppercase tracking-[0.2em]">Past</span>
                    </div>
                    <div class="absolute top-4 right-16 flex items-center gap-1 opacity-40">
                        <span class="font-black text-brand-dark dark:text-white text-xs uppercase tracking-[0.2em]">Future</span>
                        <i data-lucide="arrow-right" class="w-3 h-3 text-brand-dark dark:text-white"></i>
                    </div>

                    <!-- Timeline Track -->
                    <div class="absolute top-1/2 left-0 right-0 h-1.5 bg-slate-200 dark:bg-slate-600 border-y border-slate-300 dark:border-slate-500 z-0 transform -translate-y-1/2"></div>
                    <div class="absolute top-12 bottom-12 left-1/2 w-0 border-r-2 border-dashed border-brand-dark/30 dark:border-white/30 z-0 transform -translate-x-1/2"></div>
                    
                    <!-- NOW Label -->
                    <div class="absolute top-[18%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 flex flex-col items-center gap-1 cursor-default pointer-events-none">
                        <div class="bg-brand-dark dark:bg-white dark:text-brand-dark text-white text-[9px] font-black px-2 py-0.5 rounded border-2 border-brand-dark dark:border-white shadow-sm tracking-widest">NOW</div>
                        <div class="w-0.5 h-full bg-brand-dark dark:bg-white"></div>
                    </div>

                    <!-- Layer for items -->
                    <div id="timeline-layer" class="absolute inset-0 z-20 pointer-events-none"></div>
                </div>
            </div>

            <!-- SECTION C: Info & Builder -->
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in" style="animation-delay: 0.2s">
                
                <!-- Usage Card -->
                <div class="bg-white dark:bg-brand-chalkboard border-3 border-brand-dark dark:border-white rounded-2xl shadow-neo dark:shadow-neo-white p-6 relative overflow-hidden flex flex-col h-full transition-colors duration-300">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-brand-orange/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none"></div>
                    <div class="flex items-center gap-2 mb-4 relative z-10">
                        <div class="bg-brand-orange/20 p-1.5 rounded-lg">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-brand-orange"></i>
                        </div>
                        <h3 class="text-xl font-heading font-bold text-brand-dark dark:text-white">When to use?</h3>
                    </div>
                    <ul id="usage-list" class="space-y-3 relative z-10 flex-1"></ul>
                </div>

                <!-- Timeline Builder Card -->
                <div id="builder-card" class="bg-white dark:bg-brand-chalkboard border-3 border-brand-dark dark:border-white rounded-2xl shadow-neo dark:shadow-neo-white p-6 relative overflow-hidden transition-colors duration-300 flex flex-col">
                    <div id="ex-blob" class="absolute top-0 right-0 w-20 h-20 bg-brand-blue/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none transition-colors duration-300"></div>
                    
                    <div class="relative z-10 flex-1 flex flex-col">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <div class="bg-brand-purple/20 p-1.5 rounded-lg">
                                    <i data-lucide="wrench" class="w-5 h-5 text-brand-purple"></i>
                                </div>
                                <h3 class="text-xl font-heading font-bold text-brand-dark dark:text-white">Timeline Builder</h3>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500 dark:text-slate-300">Challenge</span>
                        </div>

                        <p class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-4">
                            Rebuild the visualization for this tense. Select a tool and click on the timeline to place it.
                        </p>

                        <!-- Toolbox Grid -->
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button onclick="App.selectTool('pin')" id="tool-pin" class="tool-btn flex flex-col items-center justify-center p-2 rounded-xl border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 hover:border-brand-blue hover:bg-brand-blue/5 transition-all active:scale-95 group">
                                <div class="w-8 h-8 rounded-full bg-brand-blue border-2 border-brand-dark mb-1 flex items-center justify-center shadow-sm"><i data-lucide="map-pin" class="w-4 h-4 text-white"></i></div>
                                <span class="text-[10px] font-black uppercase text-slate-500 dark:text-slate-400">Pin</span>
                            </button>
                            <button onclick="App.selectTool('range')" id="tool-range" class="tool-btn flex flex-col items-center justify-center p-2 rounded-xl border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 hover:border-brand-blue hover:bg-brand-blue/5 transition-all active:scale-95 group">
                                <div class="w-8 h-3 rounded bg-brand-blue border-2 border-brand-dark mb-2 shadow-sm"></div>
                                <span class="text-[10px] font-black uppercase text-slate-500 dark:text-slate-400">Range</span>
                            </button>
                            <button onclick="App.selectTool('arrow')" id="tool-arrow" class="tool-btn flex flex-col items-center justify-center p-2 rounded-xl border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 hover:border-brand-blue hover:bg-brand-blue/5 transition-all active:scale-95 group">
                                <div class="w-8 h-0 border-b-2 border-brand-blue mb-2 relative"><div class="absolute right-0 -top-[3px] w-2 h-2 border-t-2 border-r-2 border-brand-blue rotate-45"></div></div>
                                <span class="text-[10px] font-black uppercase text-slate-500 dark:text-slate-400">Arrow</span>
                            </button>
                             <button onclick="App.selectTool('marker')" id="tool-marker" class="tool-btn flex flex-col items-center justify-center p-2 rounded-xl border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 hover:border-brand-blue hover:bg-brand-blue/5 transition-all active:scale-95 group">
                                <i data-lucide="align-justify" class="w-4 h-4 text-brand-dark dark:text-white mb-1"></i>
                                <span class="text-[10px] font-black uppercase text-slate-500 dark:text-slate-400">Time</span>
                            </button>
                        </div>

                        <!-- Actions & Feedback -->
                        <div class="mt-auto">
                            <div id="builder-feedback" class="text-center font-bold text-sm mb-3 min-h-[20px] text-brand-dark dark:text-white"></div>
                            <div class="flex gap-3">
                                <button onclick="App.resetBuilder()" class="flex-1 py-3 rounded-xl border-2 border-brand-dark dark:border-white font-black uppercase tracking-widest text-xs hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">Clear</button>
                                <button onclick="App.checkBuilder()" class="flex-[2] py-3 rounded-xl border-2 border-brand-dark dark:border-white bg-brand-green text-brand-dark shadow-neo-sm active:translate-y-1 active:shadow-none transition-all font-black uppercase tracking-widest text-xs flex items-center justify-center gap-2">
                                    <i data-lucide="check-circle-2" class="w-4 h-4"></i> Check Answer
                                </button>
                            </div>
                        </div>

                         <!-- Static Example (Small) -->
                        <div class="mt-4 pt-4 border-t-2 border-slate-100 dark:border-slate-700">
                             <div class="flex items-center gap-2 mb-1 opacity-50">
                                <i data-lucide="quote" class="w-3 h-3 text-brand-dark dark:text-white"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest">Example</span>
                            </div>
                            <p id="static-example" class="font-bold text-brand-dark dark:text-white text-sm italic">Loading...</p>
                        </div>

                    </div>
                </div>

            </div>

            <div class="h-24"></div>
        </main>
    </div>

    <!-- ================= 3. LOGIC ================= -->
    <script>
        const App = (function() {
            
            // --- DATA STORE ---
            const TENSES = {
                // PRESENT GROUP
                presentSimple: {
                    cat: 'Present', color: 'green',
                    title: "Simple Present", formula: "S + V1 (s/es)",
                    desc: "Used for facts, habits, and routines that are generally true.",
                    usage: ["Habits & Routines", "General Facts/Truths", "Scheduled Events"],
                    signals: ["Every day", "Always", "Often", "Usually"],
                    example: "I play tennis every Sunday.",
                    viz: [ {type:'pin', l:15, label:'Action', y:50}, {type:'pin', l:35, label:'Action', y:50}, {type:'pin', l:50, label:'Action', y:50}, {type:'pin', l:65, label:'Action', y:50}, {type:'pin', l:85, label:'Action', y:50}, {type:'range', l:10, w:80, label:'Routine / Always True', y:68} ]
                },
                presentCont: {
                    cat: 'Present', color: 'green',
                    title: "Present Continuous", formula: "S + am/is/are + V-ing",
                    desc: "Actions happening exactly right now or temporary situations.",
                    usage: ["Actions happening NOW", "Temporary situations", "Future plans"],
                    signals: ["Now", "At the moment", "Look!", "Listen!"],
                    example: "I am studying right now.",
                    viz: [ {type:'range', l:42, w:16, label:'Happening Now', y:50, active:true} ]
                },
                presentPerfect: {
                    cat: 'Present', color: 'green',
                    title: "Present Perfect", formula: "S + have/has + V3",
                    desc: "Actions in the past with a result in the present.",
                    usage: ["Past action, Present result", "Life Experiences", "Started past, continues now"],
                    signals: ["Just", "Already", "Yet", "Since", "For"],
                    example: "I have finished my homework.",
                    viz: [ {type:'pin', l:30, label:'Action Done', y:45}, {type:'arrow', l:30, w:20, label:'Result affects NOW', y:65} ]
                },
                presentPerfectCont: {
                    cat: 'Present', color: 'green',
                    title: "Present Perf. Cont.", formula: "S + have/has + been + V-ing",
                    desc: "Actions that started in the past and are still continuing now.",
                    usage: ["Duration of present activity", "Action just stopped"],
                    signals: ["For 2 hours", "Since morning", "All day"],
                    example: "I have been waiting for 2 hours.",
                    viz: [ {type:'range', l:20, w:30, label:'Started Past', y:45}, {type:'arrow', l:20, w:30, label:'Duration leading to NOW', y:65} ]
                },

                // PAST GROUP
                pastSimple: {
                    cat: 'Past', color: 'pink',
                    title: "Simple Past", formula: "S + V2",
                    desc: "Actions completed at a specific time in the past.",
                    usage: ["Completed action in past", "Series of past actions", "Past habits/facts"],
                    signals: ["Yesterday", "Last week", "In 2010", "Ago"],
                    example: "I visited Batam yesterday.",
                    viz: [ {type:'pin', l:25, label:'Action Happened', y:40}, {type:'marker', l:25, label:'Specific Time', y:75} ]
                },
                pastCont: {
                    cat: 'Past', color: 'pink',
                    title: "Past Continuous", formula: "S + was/were + V-ing",
                    desc: "Actions that were in progress at a specific moment in the past.",
                    usage: ["Action in progress in past", "Interrupted action", "Parallel actions"],
                    signals: ["When", "While", "At 8 PM last night"],
                    example: "I was sleeping when you called.",
                    viz: [ {type:'range', l:15, w:20, label:'Was Doing...', y:55}, {type:'pin', l:25, label:'Interruption', y:30} ]
                },
                pastPerfect: {
                    cat: 'Past', color: 'pink',
                    title: "Past Perfect", formula: "S + had + V3",
                    desc: "An action that happened before another action in the past.",
                    usage: ["Action before another past action", "Reported speech"],
                    signals: ["Before", "After", "By the time"],
                    example: "She had left before I arrived.",
                    viz: [ {type:'pin', l:15, label:'Event 1 (Had done)', y:45}, {type:'pin', l:35, label:'Event 2', y:45}, {type:'arrow', l:15, w:20, label:'Before', y:65} ]
                },
                pastPerfectCont: {
                    cat: 'Past', color: 'pink',
                    title: "Past Perf. Cont.", formula: "S + had + been + V-ing",
                    desc: "Duration of an activity up to a point in the past.",
                    usage: ["Duration before past event", "Cause of a past result"],
                    signals: ["For", "Since", "Before"],
                    example: "I had been running so I was tired.",
                    viz: [ {type:'range', l:10, w:25, label:'Was doing...', y:50}, {type:'pin', l:35, label:'Event', y:50} ]
                },

                // FUTURE GROUP
                futureSimple: {
                    cat: 'Future', color: 'blue',
                    title: "Simple Future", formula: "S + will + V1",
                    desc: "Decisions made now, predictions, or promises for the future.",
                    usage: ["Spontaneous decision", "Prediction", "Promise/Threat"],
                    signals: ["Tomorrow", "Next week", "Soon"],
                    example: "I will call you later.",
                    viz: [ {type:'pin', l:75, label:'Action Future', y:50}, {type:'arrow', l:50, w:25, label:'Decision Now', y:65} ]
                },
                futureCont: {
                    cat: 'Future', color: 'blue',
                    title: "Future Continuous", formula: "S + will + be + V-ing",
                    desc: "Action that will be in progress at a specific time in the future.",
                    usage: ["In progress at future time", "Polite inquiry"],
                    signals: ["At 8 PM tomorrow", "This time next week"],
                    example: "I will be flying at 8 PM.",
                    viz: [ {type:'range', l:70, w:20, label:'Will be doing...', y:50}, {type:'marker', l:80, label:'Specific Time', y:75} ]
                },
                futurePerfect: {
                    cat: 'Future', color: 'blue',
                    title: "Future Perfect", formula: "S + will + have + V3",
                    desc: "Action that will be completed before a specific time in the future.",
                    usage: ["Completed before future moment"],
                    signals: ["By tomorrow", "By the time"],
                    example: "I will have finished by 5 PM.",
                    viz: [ {type:'pin', l:80, label:'Finished', y:40}, {type:'arrow', l:50, w:30, label:'Done Before', y:65}, {type:'marker', l:85, label:'Time Limit', y:75} ]
                },
                futurePerfectCont: {
                    cat: 'Future', color: 'blue',
                    title: "Future Perf. Cont.", formula: "S + will + have + been + V-ing",
                    desc: "Duration of an activity up to a specific time in the future.",
                    usage: ["Duration leading to future point"],
                    signals: ["By next year", "For 10 years"],
                    example: "By 2026, I will have been teaching for 10 years.",
                    viz: [ {type:'range', l:55, w:35, label:'Duration', y:50}, {type:'marker', l:90, label:'Time Limit', y:75} ]
                },

                // PAST FUTURE GROUP
                pastFutureSimple: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Simple", formula: "S + would + V1",
                    desc: "An action predicted/promised in the past for the future.",
                    usage: ["Future from past perspective", "Hypothetical (Conditional 2)"],
                    signals: ["The next day", "If I were you"],
                    example: "He said he would buy the car.",
                    viz: [ {type:'pin', l:20, label:'He Said', y:50}, {type:'arrow', l:20, w:15, label:'"Would..."', y:30, dashed:true}, {type:'pin', l:35, label:'Action', y:50, ghost:true} ]
                },
                pastFutureCont: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Cont.", formula: "S + would + be + V-ing",
                    desc: "Action predicted to be in progress in the future (from a past perspective).",
                    usage: ["Imagined duration", "Conditional Continuous"],
                    signals: ["At that time"],
                    example: "I thought I would be working.",
                    viz: [ {type:'pin', l:20, label:'Thought', y:50}, {type:'range', l:30, w:15, label:'Would be doing...', y:50, ghost:true} ]
                },
                pastFuturePerfect: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Perfect", formula: "S + would + have + V3",
                    desc: "Hypothetical action that didn't happen in the past (Conditional Type 3).",
                    usage: ["Regrets", "Impossible conditions"],
                    signals: ["If + had V3"],
                    example: "I would have helped if I knew.",
                    viz: [ {type:'pin', l:30, label:'Did NOT Happen', y:50, cross:true}, {type:'arrow', l:30, w:10, label:'Imagined', y:65} ]
                },
                pastFuturePerfectCont: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Perf. Cont.", formula: "S + would + have + been + V-ing",
                    desc: "Hypothetical duration in the past.",
                    usage: ["Imaginary duration in past"],
                    signals: ["If + had V3"],
                    example: "I would have been sleeping.",
                    viz: [ {type:'range', l:20, w:20, label:'Would have been...', y:50, ghost:true, cross:true} ]
                }
            };

            // --- STATE & INIT ---
            let currentTenseKey = 'presentSimple';
            let builderState = {
                active: false,
                tool: null,
                items: [] // {type: 'pin', l: 50}
            };

            function init() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                lucide.createIcons();
                renderSidebar();
                loadTense('presentSimple');
            }

            // --- VIEW LOGIC ---
            function renderSidebar() {
                const sidebarEl = document.getElementById('sidebar-content');
                sidebarEl.innerHTML = '';
                const groups = {
                    green: { label: 'Present', keys: ['presentSimple', 'presentCont', 'presentPerfect', 'presentPerfectCont'] },
                    pink: { label: 'Past', keys: ['pastSimple', 'pastCont', 'pastPerfect', 'pastPerfectCont'] },
                    blue: { label: 'Future', keys: ['futureSimple', 'futureCont', 'futurePerfect', 'futurePerfectCont'] },
                    orange: { label: 'Past Future', keys: ['pastFutureSimple', 'pastFutureCont', 'pastFuturePerfect', 'pastFuturePerfectCont'] }
                };
                for (const [color, group] of Object.entries(groups)) {
                    const groupContainer = document.createElement('div');
                    groupContainer.innerHTML = `
                        <div class="flex items-center gap-2 mb-2 px-2">
                            <div class="w-2.5 h-2.5 rounded bg-brand-${color} border border-brand-dark dark:border-white/50"></div>
                            <span class="font-heading font-bold text-brand-dark dark:text-slate-200">${group.label}</span>
                        </div>
                        <div class="space-y-1">
                            ${group.keys.map(key => `
                                <button onclick="App.loadTense('${key}')" id="nav-${key}" 
                                    class="nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-transparent font-bold text-slate-400 hover:text-brand-dark dark:hover:text-white transition-all hover:bg-slate-50 dark:hover:bg-slate-800 mb-1 text-sm flex items-center justify-between group">
                                    <span>${TENSES[key].title}</span>
                                    <div class="w-1.5 h-1.5 rounded-full bg-brand-${color} opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                </button>
                            `).join('')}
                        </div>
                    `;
                    sidebarEl.appendChild(groupContainer);
                }
            }

            function loadTense(key) {
                currentTenseKey = key;
                resetBuilder(false); // Reset builder state without clearing feedback immediately
                const data = TENSES[key];

                // Sidebar Logic
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.className = "nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-transparent font-bold text-slate-400 hover:text-brand-dark dark:hover:text-white transition-all hover:bg-slate-50 dark:hover:bg-slate-800 mb-1 text-sm flex items-center justify-between group";
                    btn.querySelector('div').className = `w-1.5 h-1.5 rounded-full bg-brand-${data.color} opacity-0 group-hover:opacity-100 transition-opacity`;
                });
                
                const activeBtn = document.getElementById(`nav-${key}`);
                if(activeBtn) {
                    activeBtn.className = "nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-brand-dark dark:border-white bg-brand-dark dark:bg-white text-white dark:text-brand-dark shadow-neo-sm dark:shadow-neo-sm-white font-bold transition-all mb-1 text-sm active:translate-y-1 active:shadow-none flex items-center justify-between";
                    activeBtn.querySelector('div').className = `w-2 h-2 rounded-full bg-brand-${data.color}`; 
                }

                // Header Info
                const badge = document.getElementById('tense-category');
                badge.innerText = data.cat;
                badge.className = `text-[10px] md:text-xs font-black uppercase tracking-widest px-2 py-1 rounded border bg-brand-${data.color}/10 text-brand-${data.color} border-brand-${data.color}/30 select-none transition-colors`;
                
                const title = document.getElementById('tense-title');
                title.innerText = data.title;
                title.className = `text-3xl md:text-5xl font-heading font-black mt-2 leading-tight text-brand-${data.color} drop-shadow-sm transition-colors`;

                document.getElementById('tense-formula').innerText = data.formula;
                document.getElementById('tense-desc').innerText = data.desc;
                document.getElementById('static-example').innerText = data.example;

                // Usage List
                const listEl = document.getElementById('usage-list');
                listEl.innerHTML = '';
                data.usage.forEach((u, idx) => {
                    listEl.innerHTML += `
                        <li class="flex items-start gap-3 animate-fade-in" style="animation-delay: ${idx * 0.05}s">
                            <div class="bg-brand-green/20 p-0.5 rounded-full mt-0.5 shrink-0">
                                <i data-lucide="check" class="w-3 h-3 text-brand-green"></i>
                            </div>
                            <span class="font-bold text-slate-600 dark:text-slate-300 leading-snug text-sm md:text-base">${u}</span>
                        </li>`;
                });

                drawTimeline(data.viz, data.color);
                lucide.createIcons();
                
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            }

            // --- BUILDER LOGIC ---
            function selectTool(toolName) {
                // Activate Builder Mode
                if (!builderState.active) {
                    builderState.active = true;
                    builderState.items = []; // Clear current items for building
                    document.getElementById('builder-badge').classList.remove('hidden');
                    drawTimeline([], 'dark'); // Clear timeline, use neutral color
                }
                
                builderState.tool = toolName;

                // Update UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('border-brand-blue', 'bg-brand-blue/10');
                    btn.classList.add('border-slate-200', 'dark:border-slate-600');
                });
                const activeBtn = document.getElementById(`tool-${toolName}`);
                if(activeBtn) {
                    activeBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
                    activeBtn.classList.add('border-brand-blue', 'bg-brand-blue/10');
                }
                
                // Add cursor hint to timeline
                document.getElementById('timeline-container').classList.add('cursor-pen');
                document.getElementById('builder-feedback').innerText = `Place the ${toolName} on the timeline...`;
                document.getElementById('builder-feedback').className = "text-center font-bold text-sm mb-3 min-h-[20px] text-brand-blue";
            }

            function handleTimelineClick(e) {
                if (!builderState.active || !builderState.tool) return;

                // Calculate % position
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percent = Math.max(5, Math.min(95, (x / rect.width) * 100)); // Clamp between 5% and 95%

                // Add item
                const newItem = {
                    type: builderState.tool,
                    l: percent,
                    label: 'My Item', 
                    y: 50,
                    w: builderState.tool === 'range' ? 20 : (builderState.tool === 'arrow' ? 20 : 0) // Defaults
                };
                
                builderState.items.push(newItem);
                
                // Redraw
                const currentColor = TENSES[currentTenseKey].color;
                drawTimeline(builderState.items, currentColor);
                lucide.createIcons();
            }

            function resetBuilder(fullReset = true) {
                builderState.active = false;
                builderState.tool = null;
                builderState.items = [];
                document.getElementById('builder-badge').classList.add('hidden');
                document.getElementById('timeline-container').classList.remove('cursor-pen');
                
                // Reset Tool UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('border-brand-blue', 'bg-brand-blue/10');
                    btn.classList.add('border-slate-200', 'dark:border-slate-600');
                });

                if(fullReset) {
                    replayAnimation();
                    document.getElementById('builder-feedback').innerText = "";
                }
            }

            function checkBuilder() {
                if(!builderState.active) {
                    document.getElementById('builder-feedback').innerText = "Select a tool first!";
                     document.getElementById('builder-feedback').className = "text-center font-bold text-sm mb-3 min-h-[20px] text-brand-pink";
                    return;
                }

                const correctViz = TENSES[currentTenseKey].viz;
                const userViz = builderState.items;

                // Simple Logic: Do we have roughly the same number of items of each type?
                // And are they in roughly the correct position (Left vs Right)?
                
                let score = 0;
                let maxScore = correctViz.length;
                let hints = [];

                // Copy userViz to track matches
                let remainingUserItems = [...userViz];

                correctViz.forEach(target => {
                    // Find a match in user items
                    const matchIndex = remainingUserItems.findIndex(u => 
                        u.type === target.type && Math.abs(u.l - target.l) < 20 // 20% tolerance
                    );

                    if(matchIndex !== -1) {
                        score++;
                        remainingUserItems.splice(matchIndex, 1);
                    } else {
                        hints.push(`Missing a ${target.type} at ${target.l < 50 ? 'Past' : 'Future'} side.`);
                    }
                });

                const feedbackEl = document.getElementById('builder-feedback');
                if (score === maxScore && remainingUserItems.length === 0) {
                     feedbackEl.innerText = "Perfect! You rebuilt the timeline!";
                     feedbackEl.className = "text-center font-bold text-sm mb-3 min-h-[20px] text-brand-green animate-bounce-subtle";
                } else if (score === maxScore) {
                     feedbackEl.innerText = "Correct! (You added some extra items though).";
                     feedbackEl.className = "text-center font-bold text-sm mb-3 min-h-[20px] text-brand-green";
                } else {
                    feedbackEl.innerText = hints.length > 0 ? hints[0] : "Not quite right. Try again!";
                    feedbackEl.className = "text-center font-bold text-sm mb-3 min-h-[20px] text-brand-pink";
                }
            }

            function replayAnimation() {
                const data = TENSES[currentTenseKey];
                drawTimeline(data.viz, data.color);
                lucide.createIcons();
            }

            // --- DRAWING LOGIC ---
            function drawTimeline(items, color) {
                const layer = document.getElementById('timeline-layer');
                layer.innerHTML = ''; 
                
                items.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 't-item pointer-events-none'; // Items shouldn't block clicks in builder mode
                    const topVal = item.y ? item.y + '%' : '50%';
                    el.style.left = item.l + '%';
                    el.style.top = topVal;
                    
                    let animationClass = (item.type === 'range' || item.type === 'arrow') ? 'animate-pop-left' : 'animate-pop-center';
                    el.style.animationDelay = (index * 0.1) + 's';
                    el.classList.add(animationClass);

                    if (item.type === 'pin') {
                        const ghostClass = item.ghost ? 'opacity-50 border-dashed' : '';
                        const crossHTML = item.cross ? '<div class="absolute inset-0 flex items-center justify-center text-white font-black text-lg">X</div>' : '';
                        const iconHTML = item.cross ? '' : '<i data-lucide="map-pin" class="w-3.5 h-3.5 relative z-10"></i>';
                        el.innerHTML = `
                            <div class="flex flex-col items-center group">
                                <div class="w-8 h-8 rounded-full bg-brand-${color} border-2 border-brand-dark dark:border-white shadow-neo-sm dark:shadow-neo-sm-white flex items-center justify-center text-white relative z-20 ${ghostClass}">
                                    ${iconHTML} ${crossHTML}
                                </div>
                                <div class="h-8 w-0.5 bg-brand-dark/50 dark:bg-white/50 z-10"></div>
                            </div>`;
                    } else if (item.type === 'range') {
                        const width = item.w + '%';
                        const activeClass = item.active ? 'animate-pulse' : '';
                        const ghostClass = item.ghost ? 'opacity-50 border-dashed' : '';
                        el.style.width = width;
                        el.style.transform = 'translate(0, -50%)';
                        el.innerHTML = `
                            <div class="w-full h-8 bg-brand-${color} border-2 border-brand-dark dark:border-white rounded-lg shadow-neo-sm dark:shadow-neo-sm-white opacity-90 flex items-center justify-center ${activeClass} ${ghostClass} origin-left">
                                <span class="bg-white/90 dark:bg-brand-blackboard/90 backdrop-blur-sm px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest border border-brand-dark dark:border-white text-brand-dark dark:text-white shadow-sm whitespace-nowrap select-none opacity-0 group-hover:opacity-100 transition-opacity">Range</span>
                            </div>`;
                    } else if (item.type === 'arrow') {
                        const dashed = item.dashed ? 'border-dashed' : 'border-solid';
                        el.style.width = item.w + '%';
                        el.style.transform = 'translate(0, -50%)';
                        el.innerHTML = `
                            <div class="w-full h-4 bg-transparent border-b-4 border-brand-dark/40 dark:border-white/40 ${dashed} relative flex justify-center group">
                                <div class="absolute right-0 -bottom-[5px] w-0 h-0 border-t-[6px] border-t-transparent border-l-[10px] border-l-brand-dark/40 dark:border-l-white/40 border-b-[6px] border-b-transparent"></div>
                            </div>`;
                    } else if (item.type === 'marker') {
                        el.innerHTML = `
                            <div class="flex flex-col items-center">
                                <span class="text-[9px] font-black text-brand-dark/70 dark:text-white/70 uppercase tracking-widest mb-1 bg-white/50 dark:bg-brand-blackboard/50 px-1 rounded">TIME</span>
                                <div class="w-0.5 h-3 bg-brand-dark/70 dark:bg-white/70"></div>
                            </div>`;
                    }
                    layer.appendChild(el);
                });
            }

            function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
            function closeSidebarMobile() { if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full'); }
            function toggleTheme() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            }

            return { init, loadTense, selectTool, handleTimelineClick, resetBuilder, checkBuilder, toggleSidebar, closeSidebarMobile, replayAnimation, renderSidebar, toggleTheme };
        })();
    </script>
</body>
</html>