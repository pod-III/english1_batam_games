<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 â€¢ Tense Diver</title>
    
    <!-- 
      FONTS: 
      - Fredoka: Headings & UI elements (Playful)
      - Nunito: Body text (Readable)
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ICONS: Lucide (Thick strokes match the brutalist aesthetic) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CONFIGURATION: English 1 Batam Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95',   
                            orange: '#FF8C42', 
                            green: '#00E676',  
                            blue: '#2979FF',   
                            purple: '#A855F7', 
                            dark: '#1e293b',   
                            chalk: '#f8fafc',  
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': '0px 0px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    borderWidth: {
                        '3': '3px',
                    },
                    // Custom keyframes for timeline elements
                    animation: {
                        'pop-center': 'pop-in-center 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pop-left': 'pop-in-left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                    keyframes: {
                        'pop-in-center': {
                            '0%': { transform: 'translate(-50%, -50%) scale(0.5)', opacity: '0' },
                            '100%': { transform: 'translate(-50%, -50%) scale(1)', opacity: '1' }
                        },
                        'pop-in-left': {
                            '0%': { transform: 'translate(0, -50%) scale(0.5)', opacity: '0' },
                            '100%': { transform: 'translate(0, -50%) scale(1)', opacity: '1' }
                        },
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-color: #f8fafc; /* brand-chalk */
            /* Graph Paper Pattern Background */
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Clean Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 99px; }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Timeline Item Base */
        .t-item {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0; /* Hidden initially for animation */
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to container */
        }
        
        /* Interactive elements inside timeline items need pointer events back */
        .t-item > * { pointer-events: auto; }
    </style>
</head>
<body class="text-brand-dark font-body h-screen flex flex-col overflow-hidden" onload="App.init()">

    <!-- ================= 1. HEADER ================= -->
    <nav class="h-16 shrink-0 bg-white/90 backdrop-blur-sm border-b-3 border-brand-dark px-4 md:px-6 flex items-center justify-between z-50 sticky top-0">
        <!-- Logo Area -->
        <div class="flex items-center gap-3 select-none cursor-pointer" onclick="location.reload()">
            <div class="bg-brand-pink p-1.5 rounded-lg border-2 border-brand-dark shadow-sm transform -rotate-3 transition-transform hover:rotate-0">
                <i data-lucide="compass" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-xl md:text-2xl font-heading font-black tracking-tight text-brand-dark">
                Tense <span class="text-brand-blue">Diver</span>
            </h1>
        </div>
        
        <!-- Desktop Badge -->
        <div class="hidden md:flex gap-3 text-xs font-bold text-slate-400 uppercase tracking-widest items-center">
            <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">English 1 Batam</span>
            <span class="w-1.5 h-1.5 bg-brand-green rounded-full animate-pulse"></span>
            <span>Live Preview</span>
        </div>

        <!-- Mobile Menu Toggle -->
        <button onclick="App.toggleSidebar()" class="md:hidden p-2 rounded-lg border-2 border-brand-dark shadow-neo active:shadow-neo-pressed active:translate-y-1 transition-all bg-white hover:bg-slate-50">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </nav>

    <!-- ================= 2. MAIN LAYOUT ================= -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- SIDEBAR (Generated via JS) -->
        <aside id="sidebar" class="w-64 md:w-72 bg-white border-r-3 border-brand-dark flex flex-col shrink-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 absolute md:relative h-full shadow-[10px_0_20px_rgba(0,0,0,0.1)] md:shadow-none">
            <div class="p-4 border-b-2 border-slate-100 bg-slate-50">
                <h2 class="font-heading font-black text-slate-400 uppercase tracking-widest text-[10px]">Time Frames</h2>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-auto scroller p-3 pb-20 space-y-6">
                <!-- Content injected by App.renderSidebar() -->
            </div>
        </aside>

        <!-- STAGE (Main Content) -->
        <main class="flex-1 overflow-y-auto scroller p-4 md:p-8 relative w-full" onclick="App.closeSidebarMobile()">
            
            <!-- SECTION A: Header Info -->
            <div class="max-w-4xl mx-auto mb-8 animate-fade-in">
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between mb-4">
                    <div>
                        <!-- Category Badge -->
                        <span id="tense-category" class="text-[10px] md:text-xs font-black uppercase tracking-widest px-2 py-1 bg-slate-100 text-slate-500 rounded border border-slate-200 select-none transition-colors">Category</span>
                        <!-- Title -->
                        <h1 id="tense-title" class="text-3xl md:text-5xl font-heading font-black text-brand-dark mt-2 leading-tight drop-shadow-sm transition-colors">Tense Title</h1>
                    </div>
                    
                    <!-- Formula Badge -->
                    <div class="bg-white border-2 border-brand-dark shadow-neo-sm rounded-xl px-4 py-2 flex items-center gap-2 shrink-0 transform hover:scale-105 transition-transform cursor-help group relative select-none">
                        <i data-lucide="function-square" class="w-5 h-5 text-brand-purple"></i>
                        <span id="tense-formula" class="font-bold font-mono text-lg text-brand-purple">Formula</span>
                        <!-- Tooltip -->
                        <div class="absolute -bottom-8 right-0 bg-brand-dark text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                            Grammar Structure
                        </div>
                    </div>
                </div>

                <p id="tense-desc" class="text-lg md:text-xl text-slate-600 font-bold max-w-2xl leading-relaxed">
                    Description text...
                </p>
            </div>

            <!-- SECTION B: Visualization Stage -->
            <div class="max-w-4xl mx-auto mb-8 animate-fade-in" style="animation-delay: 0.1s">
                <div class="bg-white border-3 border-brand-dark rounded-2xl shadow-neo relative overflow-hidden h-[340px] w-full bg-slate-50 select-none group">
                    
                    <!-- Replay Button -->
                    <button onclick="App.replayAnimation()" class="absolute top-4 right-4 z-30 p-2 rounded-lg bg-white/80 border-2 border-brand-dark shadow-sm hover:scale-110 active:scale-95 transition-all text-slate-500 hover:text-brand-dark" title="Replay Animation">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>

                    <!-- Background Grid -->
                    <div class="absolute inset-0 opacity-40 pointer-events-none" 
                         style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 40px 40px;">
                    </div>

                    <!-- Axis Labels -->
                    <div class="absolute top-4 left-4 flex items-center gap-1 opacity-40">
                        <i data-lucide="arrow-left" class="w-3 h-3 text-brand-dark"></i>
                        <span class="font-black text-brand-dark text-xs uppercase tracking-[0.2em]">Past</span>
                    </div>
                    <div class="absolute top-4 right-16 flex items-center gap-1 opacity-40"> <!-- shifted left for replay btn -->
                        <span class="font-black text-brand-dark text-xs uppercase tracking-[0.2em]">Future</span>
                        <i data-lucide="arrow-right" class="w-3 h-3 text-brand-dark"></i>
                    </div>

                    <!-- Timeline Track (Horizontal Line) -->
                    <div class="absolute top-1/2 left-0 right-0 h-1.5 bg-slate-200 border-y border-slate-300 z-0 transform -translate-y-1/2"></div>
                    
                    <!-- NOW Marker (Vertical Axis) -->
                    <div class="absolute top-12 bottom-12 left-1/2 w-0 border-r-2 border-dashed border-brand-dark/30 z-0 transform -translate-x-1/2"></div>
                    <div class="absolute top-[18%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 flex flex-col items-center gap-1 cursor-default">
                        <div class="bg-brand-dark text-white text-[9px] font-black px-2 py-0.5 rounded border-2 border-brand-dark shadow-sm tracking-widest transition-colors group-hover:bg-brand-blue group-hover:border-brand-blue">NOW</div>
                        <div class="w-0.5 h-full bg-brand-dark transition-colors group-hover:bg-brand-blue"></div>
                    </div>

                    <!-- DYNAMIC LAYER (Injected Items) -->
                    <div id="timeline-layer" class="absolute inset-0 z-20"></div>
                </div>
            </div>

            <!-- SECTION C: Details & Examples -->
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in" style="animation-delay: 0.2s">
                
                <!-- Usage Card -->
                <div class="bg-white border-3 border-brand-dark rounded-2xl shadow-neo p-6 relative overflow-hidden flex flex-col h-full">
                    <!-- Decorative Blob -->
                    <div class="absolute top-0 right-0 w-20 h-20 bg-brand-orange/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none"></div>
                    
                    <div class="flex items-center gap-2 mb-4 relative z-10">
                        <div class="bg-brand-orange/20 p-1.5 rounded-lg">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-brand-orange"></i>
                        </div>
                        <h3 class="text-xl font-heading font-bold text-brand-dark">When to use?</h3>
                    </div>
                    <ul id="usage-list" class="space-y-3 relative z-10 flex-1">
                        <!-- Items injected by JS -->
                    </ul>
                </div>

                <!-- Examples Card -->
                <div id="example-card" class="bg-white border-3 border-brand-dark rounded-2xl shadow-neo p-6 relative overflow-hidden transition-colors duration-500">
                     <!-- Decorative Blob (Color changes dynamically) -->
                     <div id="ex-blob" class="absolute top-0 right-0 w-20 h-20 bg-brand-green/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none transition-colors duration-300"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <div class="bg-brand-pink/20 p-1.5 rounded-lg">
                                    <i data-lucide="message-square" class="w-5 h-5 text-brand-pink"></i>
                                </div>
                                <h3 class="text-xl font-heading font-bold text-brand-dark">Examples</h3>
                            </div>
                            
                            <!-- Toggle Buttons -->
                            <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                <button onclick="App.setExampleType('pos')" id="btn-ex-pos" class="w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold bg-white text-brand-green shadow-sm border border-slate-200 transition-all hover:scale-105 active:scale-95" aria-label="Positive">+</button>
                                <button onclick="App.setExampleType('neg')" id="btn-ex-neg" class="w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold text-slate-400 hover:text-brand-pink transition-all hover:scale-105 active:scale-95" aria-label="Negative">-</button>
                                <button onclick="App.setExampleType('int')" id="btn-ex-int" class="w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold text-slate-400 hover:text-brand-blue transition-all hover:scale-105 active:scale-95" aria-label="Interrogative">?</button>
                            </div>
                        </div>

                        <!-- Example Text Box -->
                        <div class="bg-brand-dark text-white p-5 rounded-xl border-2 border-brand-dark shadow-neo-sm mb-4 relative overflow-hidden group min-h-[80px] flex items-center">
                            <div class="absolute -right-2 -top-4 text-white/5 text-9xl font-black italic select-none pointer-events-none font-heading">Ex</div>
                            <p id="example-text" class="text-xl font-heading font-bold relative z-10 transition-all duration-300 transform translate-y-0 opacity-100">Loading...</p>
                        </div>
                        
                        <!-- Time Signals -->
                        <div class="flex items-start gap-2">
                            <i data-lucide="clock" class="w-4 h-4 text-slate-400 mt-1 shrink-0"></i>
                            <div class="text-sm font-bold text-slate-400 flex flex-wrap gap-2" id="time-signals">
                                <!-- Signals injected JS -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="h-24"></div> <!-- Footer Spacer -->
        </main>
    </div>

    <!-- ================= 3. LOGIC ================= -->
    <script>
        /**
         * ENGLISH 1 TENSE DIVER - LOGIC CONTROLLER
         * * This script handles:
         * 1. Data storage for all 16 tenses.
         * 2. Rendering the Sidebar and Main Stage.
         * 3. Drawing the complex timeline visualizations (Pins, Ranges, Arrows).
         * 4. Handling user interactions and animations.
         */

        const App = (function() {
            
            // --- A. DATA STORE ---
            const TENSES = {
                // PRESENT GROUP
                presentSimple: {
                    cat: 'Present', color: 'green',
                    title: "Simple Present", formula: "S + V1 (s/es)",
                    desc: "Used for facts, habits, and routines that are generally true.",
                    usage: ["Habits & Routines", "General Facts/Truths", "Scheduled Events"],
                    examples: { pos: "I play tennis every Sunday.", neg: "I do not play tennis.", int: "Do you play tennis?" },
                    signals: ["Every day", "Always", "Often", "Usually"],
                    // Visualization Config: l=left%, y=top%, w=width%
                    viz: [
                        {type:'pin', l:15, label:'Play', y:50}, {type:'pin', l:35, label:'Play', y:50}, {type:'pin', l:50, label:'Play', y:50}, {type:'pin', l:65, label:'Play', y:50}, {type:'pin', l:85, label:'Play', y:50},
                        {type:'range', l:10, w:80, label:'Routine / Always True', y:68}
                    ]
                },
                presentCont: {
                    cat: 'Present', color: 'green',
                    title: "Present Continuous", formula: "S + am/is/are + V-ing",
                    desc: "Actions happening exactly right now or temporary situations.",
                    usage: ["Actions happening NOW", "Temporary situations", "Future plans"],
                    examples: { pos: "I am studying right now.", neg: "I am not studying.", int: "Are you studying?" },
                    signals: ["Now", "At the moment", "Look!", "Listen!"],
                    viz: [
                        {type:'range', l:42, w:16, label:'Happening Now', y:50, active:true}
                    ]
                },
                presentPerfect: {
                    cat: 'Present', color: 'green',
                    title: "Present Perfect", formula: "S + have/has + V3",
                    desc: "Actions in the past with a result in the present.",
                    usage: ["Past action, Present result", "Life Experiences", "Started past, continues now"],
                    examples: { pos: "I have finished my homework.", neg: "I haven't finished yet.", int: "Have you finished?" },
                    signals: ["Just", "Already", "Yet", "Since", "For"],
                    viz: [
                        {type:'pin', l:30, label:'Action Done', y:45}, 
                        {type:'arrow', l:30, w:20, label:'Result affects NOW', y:65}
                    ]
                },
                presentPerfectCont: {
                    cat: 'Present', color: 'green',
                    title: "Present Perf. Cont.", formula: "S + have/has + been + V-ing",
                    desc: "Actions that started in the past and are still continuing now.",
                    usage: ["Duration of present activity", "Action just stopped"],
                    examples: { pos: "I have been waiting for 2 hours.", neg: "I haven't been waiting long.", int: "Have you been waiting?" },
                    signals: ["For 2 hours", "Since morning", "All day"],
                    viz: [
                        {type:'range', l:20, w:30, label:'Started Past', y:45},
                        {type:'arrow', l:20, w:30, label:'Duration leading to NOW', y:65}
                    ]
                },

                // PAST GROUP
                pastSimple: {
                    cat: 'Past', color: 'pink',
                    title: "Simple Past", formula: "S + V2",
                    desc: "Actions completed at a specific time in the past.",
                    usage: ["Completed action in past", "Series of past actions", "Past habits/facts"],
                    examples: { pos: "I visited Batam yesterday.", neg: "I didn't visit Batam.", int: "Did you visit Batam?" },
                    signals: ["Yesterday", "Last week", "In 2010", "Ago"],
                    viz: [
                        {type:'pin', l:25, label:'Action Happened', y:40}, 
                        {type:'marker', l:25, label:'Specific Time', y:75}
                    ]
                },
                pastCont: {
                    cat: 'Past', color: 'pink',
                    title: "Past Continuous", formula: "S + was/were + V-ing",
                    desc: "Actions that were in progress at a specific moment in the past.",
                    usage: ["Action in progress in past", "Interrupted action", "Parallel actions"],
                    examples: { pos: "I was sleeping when you called.", neg: "I wasn't sleeping.", int: "Were you sleeping?" },
                    signals: ["When", "While", "At 8 PM last night"],
                    viz: [
                        {type:'range', l:15, w:20, label:'Was Sleeping...', y:55},
                        {type:'pin', l:25, label:'You Called', y:30} // Higher than range to show interruption
                    ]
                },
                pastPerfect: {
                    cat: 'Past', color: 'pink',
                    title: "Past Perfect", formula: "S + had + V3",
                    desc: "An action that happened before another action in the past.",
                    usage: ["Action before another past action", "Reported speech"],
                    examples: { pos: "She had left before I arrived.", neg: "She hadn't left.", int: "Had she left?" },
                    signals: ["Before", "After", "By the time"],
                    viz: [
                        {type:'pin', l:15, label:'Event 1 (Had Left)', y:45},
                        {type:'pin', l:35, label:'Event 2 (I Arrived)', y:45},
                        {type:'arrow', l:15, w:20, label:'Before', y:65}
                    ]
                },
                pastPerfectCont: {
                    cat: 'Past', color: 'pink',
                    title: "Past Perf. Cont.", formula: "S + had + been + V-ing",
                    desc: "Duration of an activity up to a point in the past.",
                    usage: ["Duration before past event", "Cause of a past result"],
                    examples: { pos: "I had been running so I was tired.", neg: "I hadn't been running.", int: "Had you been running?" },
                    signals: ["For", "Since", "Before"],
                    viz: [
                        {type:'range', l:10, w:25, label:'Running', y:50},
                        {type:'pin', l:35, label:'Event (Got Tired)', y:50}
                    ]
                },

                // FUTURE GROUP
                futureSimple: {
                    cat: 'Future', color: 'blue',
                    title: "Simple Future", formula: "S + will + V1",
                    desc: "Decisions made now, predictions, or promises for the future.",
                    usage: ["Spontaneous decision", "Prediction", "Promise/Threat"],
                    examples: { pos: "I will call you later.", neg: "I won't call you.", int: "Will you call me?" },
                    signals: ["Tomorrow", "Next week", "Soon"],
                    viz: [
                        {type:'pin', l:75, label:'Action Future', y:50},
                        {type:'arrow', l:50, w:25, label:'Decision Now', y:65}
                    ]
                },
                futureCont: {
                    cat: 'Future', color: 'blue',
                    title: "Future Continuous", formula: "S + will + be + V-ing",
                    desc: "Action that will be in progress at a specific time in the future.",
                    usage: ["In progress at future time", "Polite inquiry"],
                    examples: { pos: "I will be flying at 8 PM.", neg: "I won't be flying.", int: "Will you be flying?" },
                    signals: ["At 8 PM tomorrow", "This time next week"],
                    viz: [
                        {type:'range', l:70, w:20, label:'Flying...', y:50},
                        {type:'marker', l:80, label:'8 PM', y:75}
                    ]
                },
                futurePerfect: {
                    cat: 'Future', color: 'blue',
                    title: "Future Perfect", formula: "S + will + have + V3",
                    desc: "Action that will be completed before a specific time in the future.",
                    usage: ["Completed before future moment"],
                    examples: { pos: "I will have finished by 5 PM.", neg: "I won't have finished.", int: "Will you have finished?" },
                    signals: ["By tomorrow", "By the time"],
                    viz: [
                        {type:'pin', l:80, label:'Finished', y:40},
                        {type:'arrow', l:50, w:30, label:'Done Before', y:65},
                        {type:'marker', l:85, label:'5 PM', y:75}
                    ]
                },
                futurePerfectCont: {
                    cat: 'Future', color: 'blue',
                    title: "Future Perf. Cont.", formula: "S + will + have + been + V-ing",
                    desc: "Duration of an activity up to a specific time in the future.",
                    usage: ["Duration leading to future point"],
                    examples: { pos: "By 2026, I will have been teaching for 10 years.", neg: "I won't have been teaching long.", int: "Will you?" },
                    signals: ["By next year", "For 10 years"],
                    viz: [
                        {type:'range', l:55, w:35, label:'Teaching (Duration)', y:50},
                        {type:'marker', l:90, label:'2026', y:75}
                    ]
                },

                // PAST FUTURE GROUP
                pastFutureSimple: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Simple", formula: "S + would + V1",
                    desc: "An action predicted/promised in the past for the future.",
                    usage: ["Future from past perspective", "Hypothetical (Conditional 2)"],
                    examples: { pos: "He said he would buy the car.", neg: "He said he wouldn't buy it.", int: "Would you buy it?" },
                    signals: ["The next day", "If I were you"],
                    viz: [
                        {type:'pin', l:20, label:'He Said', y:50},
                        {type:'arrow', l:20, w:15, label:'"Would Buy"', y:30, dashed:true},
                        {type:'pin', l:35, label:'Action', y:50, ghost:true}
                    ]
                },
                pastFutureCont: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Cont.", formula: "S + would + be + V-ing",
                    desc: "Action predicted to be in progress in the future (from a past perspective).",
                    usage: ["Imagined duration", "Conditional Continuous"],
                    examples: { pos: "I thought I would be working.", neg: "I wouldn't be working.", int: "Would you be working?" },
                    signals: ["At that time"],
                    viz: [
                        {type:'pin', l:20, label:'I Thought', y:50},
                        {type:'range', l:30, w:15, label:'Working...', y:50, ghost:true}
                    ]
                },
                pastFuturePerfect: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Perfect", formula: "S + would + have + V3",
                    desc: "Hypothetical action that didn't happen in the past (Conditional Type 3).",
                    usage: ["Regrets", "Impossible conditions"],
                    examples: { pos: "I would have helped if I knew.", neg: "I wouldn't have gone.", int: "Would you have helped?" },
                    signals: ["If + had V3"],
                    viz: [
                        {type:'pin', l:30, label:'Did NOT Happen', y:50, cross:true},
                        {type:'arrow', l:30, w:10, label:'Imagined', y:65}
                    ]
                },
                pastFuturePerfectCont: {
                    cat: 'Past Future', color: 'orange',
                    title: "Past Future Perf. Cont.", formula: "S + would + have + been + V-ing",
                    desc: "Hypothetical duration in the past.",
                    usage: ["Imaginary duration in past"],
                    examples: { pos: "I would have been sleeping.", neg: "I wouldn't have been waiting.", int: "?" },
                    signals: ["If + had V3"],
                    viz: [
                        {type:'range', l:20, w:20, label:'Would have been...', y:50, ghost:true, cross:true}
                    ]
                }
            };

            // --- B. STATE MANAGEMENT ---
            let currentTenseKey = 'presentSimple';
            let currentExType = 'pos'; // pos, neg, int

            // --- C. INITIALIZATION ---
            function init() {
                lucide.createIcons();
                renderSidebar();
                loadTense('presentSimple');
            }

            // --- D. VIEW LOGIC: SIDEBAR ---
            function renderSidebar() {
                const sidebarEl = document.getElementById('sidebar-content');
                sidebarEl.innerHTML = '';

                // Group tenses by color/category
                const groups = {
                    green: { label: 'Present', keys: ['presentSimple', 'presentCont', 'presentPerfect', 'presentPerfectCont'] },
                    pink: { label: 'Past', keys: ['pastSimple', 'pastCont', 'pastPerfect', 'pastPerfectCont'] },
                    blue: { label: 'Future', keys: ['futureSimple', 'futureCont', 'futurePerfect', 'futurePerfectCont'] },
                    orange: { label: 'Past Future', keys: ['pastFutureSimple', 'pastFutureCont', 'pastFuturePerfect', 'pastFuturePerfectCont'] }
                };

                // Generate HTML for each group
                for (const [color, group] of Object.entries(groups)) {
                    const groupContainer = document.createElement('div');
                    groupContainer.innerHTML = `
                        <div class="flex items-center gap-2 mb-2 px-2">
                            <div class="w-2.5 h-2.5 rounded bg-brand-${color} border border-brand-dark"></div>
                            <span class="font-heading font-bold text-brand-dark">${group.label}</span>
                        </div>
                        <div class="space-y-1">
                            ${group.keys.map(key => `
                                <button onclick="App.loadTense('${key}')" id="nav-${key}" 
                                    class="nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-transparent font-bold text-slate-400 transition-all hover:bg-slate-50 hover:text-brand-dark mb-1 text-sm flex items-center justify-between group">
                                    <span>${TENSES[key].title}</span>
                                    <div class="w-1.5 h-1.5 rounded-full bg-brand-${color} opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                </button>
                            `).join('')}
                        </div>
                    `;
                    sidebarEl.appendChild(groupContainer);
                }
            }

            // --- E. VIEW LOGIC: MAIN STAGE ---
            function loadTense(key) {
                currentTenseKey = key;
                const data = TENSES[key];

                // 1. Sidebar Active State Logic
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    // Reset all buttons
                    btn.className = "nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-transparent font-bold text-slate-400 transition-all hover:bg-slate-50 hover:text-brand-dark mb-1 text-sm flex items-center justify-between group";
                    // Reset indicator dot
                    btn.querySelector('div').className = `w-1.5 h-1.5 rounded-full bg-brand-${data.color} opacity-0 group-hover:opacity-100 transition-opacity`;
                });
                
                // Set active button style
                const activeBtn = document.getElementById(`nav-${key}`);
                if(activeBtn) {
                    activeBtn.className = "nav-btn w-full text-left px-4 py-2.5 rounded-xl border-2 border-brand-dark bg-brand-dark text-white shadow-neo-sm font-bold transition-all mb-1 text-sm active:translate-y-1 active:shadow-none flex items-center justify-between";
                    activeBtn.querySelector('div').className = `w-2 h-2 rounded-full bg-brand-${data.color}`; // Highlight dot
                }

                // 2. Update Header Info
                const badge = document.getElementById('tense-category');
                badge.innerText = data.cat;
                // Dynamic colors for badge
                badge.className = `text-[10px] md:text-xs font-black uppercase tracking-widest px-2 py-1 rounded border bg-brand-${data.color}/10 text-brand-${data.color} border-brand-${data.color}/30 select-none transition-colors`;
                
                const title = document.getElementById('tense-title');
                title.innerText = data.title;
                title.className = `text-3xl md:text-5xl font-heading font-black mt-2 leading-tight text-brand-${data.color} drop-shadow-sm transition-colors`;

                document.getElementById('tense-formula').innerText = data.formula;
                document.getElementById('tense-desc').innerText = data.desc;

                // 3. Update Usage List
                const listEl = document.getElementById('usage-list');
                listEl.innerHTML = '';
                data.usage.forEach((u, idx) => {
                    // Stagger animation for list items
                    listEl.innerHTML += `
                        <li class="flex items-start gap-3 animate-fade-in" style="animation-delay: ${idx * 0.05}s">
                            <div class="bg-brand-green/20 p-0.5 rounded-full mt-0.5 shrink-0">
                                <i data-lucide="check" class="w-3 h-3 text-brand-green"></i>
                            </div>
                            <span class="font-bold text-slate-600 leading-snug text-sm md:text-base">${u}</span>
                        </li>`;
                });

                // 4. Update Signals
                const sigEl = document.getElementById('time-signals');
                sigEl.innerHTML = '';
                data.signals.forEach(s => {
                    sigEl.innerHTML += `<span class="bg-slate-100 px-2 py-1 rounded text-slate-500 border border-slate-200 text-[10px] font-black uppercase tracking-wide whitespace-nowrap">${s}</span>`;
                });

                // 5. Update Example
                updateExampleDisplay();

                // 6. Draw Timeline Visualization
                drawTimeline(data.viz, data.color);

                // Re-init Icons
                lucide.createIcons();
                
                // Close mobile sidebar if open
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            }

            // --- F. TIMELINE RENDERING ---
            function drawTimeline(items, color) {
                const layer = document.getElementById('timeline-layer');
                layer.innerHTML = ''; // Clear previous items
                
                items.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 't-item';
                    
                    // Positioning
                    const topVal = item.y ? item.y + '%' : '50%';
                    el.style.left = item.l + '%';
                    el.style.top = topVal;
                    
                    // Animation Logic: 
                    // Use 'pop-left' for items that grow from left (Ranges, Arrows)
                    // Use 'pop-center' for items that scale from center (Pins, Markers)
                    let animationClass = 'animate-pop-center'; 
                    if(item.type === 'range' || item.type === 'arrow') {
                        animationClass = 'animate-pop-left'; 
                    }
                    el.style.animationDelay = (index * 0.1) + 's';
                    el.classList.add(animationClass);

                    // Render HTML based on Item Type
                    if (item.type === 'pin') {
                        // A point in time
                        const ghostClass = item.ghost ? 'opacity-50 border-dashed' : '';
                        const crossHTML = item.cross ? '<div class="absolute inset-0 flex items-center justify-center text-white font-black text-lg">X</div>' : '';
                        const iconHTML = item.cross ? '' : '<i data-lucide="map-pin" class="w-3.5 h-3.5 relative z-10"></i>';
                        
                        el.innerHTML = `
                            <div class="flex flex-col items-center group cursor-grab active:cursor-grabbing hover:-translate-y-1 transition-transform">
                                <div class="w-8 h-8 rounded-full bg-brand-${color} border-2 border-brand-dark shadow-neo-sm flex items-center justify-center text-white relative z-20 ${ghostClass}">
                                    ${iconHTML} ${crossHTML}
                                </div>
                                <div class="h-8 w-0.5 bg-brand-dark/50 z-10"></div>
                                <span class="bg-white/90 backdrop-blur-sm text-brand-dark border border-brand-dark/20 text-[10px] px-2 py-0.5 rounded font-bold uppercase whitespace-nowrap shadow-sm mt-0.5 tracking-wide z-30">${item.label}</span>
                            </div>
                        `;
                    } 
                    else if (item.type === 'range') {
                        // A duration of time
                        const width = item.w + '%';
                        const activeClass = item.active ? 'animate-pulse' : '';
                        const ghostClass = item.ghost ? 'opacity-50 border-dashed' : '';
                        
                        el.style.width = width;
                        el.style.transform = 'translate(0, -50%)'; // Override default transform for proper alignment
                        
                        el.innerHTML = `
                            <div class="w-full h-8 bg-brand-${color} border-2 border-brand-dark rounded-lg shadow-neo-sm opacity-90 flex items-center justify-center ${activeClass} ${ghostClass} cursor-grab active:cursor-grabbing hover:scale-105 transition-transform origin-left">
                                <span class="bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest border border-brand-dark text-brand-dark shadow-sm whitespace-nowrap select-none">${item.label}</span>
                            </div>
                        `;
                    }
                    else if (item.type === 'arrow') {
                        // A relationship or direction
                        const dashed = item.dashed ? 'border-dashed' : 'border-solid';
                        el.style.width = item.w + '%';
                        el.style.transform = 'translate(0, -50%)'; 
                        
                        el.innerHTML = `
                            <div class="w-full h-4 bg-transparent border-b-4 border-brand-dark/40 ${dashed} relative flex justify-center group">
                                <div class="absolute right-0 -bottom-[5px] w-0 h-0 border-t-[6px] border-t-transparent border-l-[10px] border-l-brand-dark/40 border-b-[6px] border-b-transparent"></div>
                                <span class="absolute -top-6 text-[9px] font-bold uppercase text-slate-500 bg-white/80 backdrop-blur-sm px-1.5 py-0.5 rounded border border-slate-200 group-hover:scale-110 transition-transform">${item.label}</span>
                            </div>
                        `;
                    }
                    else if (item.type === 'marker') {
                        // Time marker (e.g. "8 PM")
                        el.innerHTML = `
                            <div class="flex flex-col items-center">
                                <span class="text-[9px] font-black text-brand-dark/70 uppercase tracking-widest mb-1 bg-white/50 px-1 rounded">${item.label}</span>
                                <div class="w-0.5 h-3 bg-brand-dark/70"></div>
                            </div>
                        `;
                    }

                    layer.appendChild(el);
                });
            }

            // --- G. EXAMPLE LOGIC ---
            function setExampleType(type) {
                currentExType = type;
                const btns = {
                    pos: document.getElementById('btn-ex-pos'),
                    neg: document.getElementById('btn-ex-neg'),
                    int: document.getElementById('btn-ex-int')
                };

                // Reset all
                Object.values(btns).forEach(b => b.className = "w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold text-slate-400 hover:bg-slate-50 border border-transparent transition-all");
                
                // Set Active State & Color Theme
                const blob = document.getElementById('ex-blob');
                
                if(type === 'pos') {
                    btns.pos.className = "w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold bg-brand-green/10 text-brand-green border border-brand-green/30 shadow-sm transform scale-110";
                    blob.className = "absolute top-0 right-0 w-20 h-20 bg-brand-green/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none transition-colors duration-300";
                }
                if(type === 'neg') {
                    btns.neg.className = "w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold bg-brand-pink/10 text-brand-pink border border-brand-pink/30 shadow-sm transform scale-110";
                    blob.className = "absolute top-0 right-0 w-20 h-20 bg-brand-pink/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none transition-colors duration-300";
                }
                if(type === 'int') {
                    btns.int.className = "w-8 h-8 flex items-center justify-center rounded-md text-sm font-bold bg-brand-blue/10 text-brand-blue border border-brand-blue/30 shadow-sm transform scale-110";
                    blob.className = "absolute top-0 right-0 w-20 h-20 bg-brand-blue/10 rounded-bl-[40px] -mr-8 -mt-8 pointer-events-none transition-colors duration-300";
                }

                updateExampleDisplay();
            }

            function updateExampleDisplay() {
                const data = TENSES[currentTenseKey];
                const textEl = document.getElementById('example-text');
                
                // Simple fade transition
                textEl.style.opacity = 0;
                textEl.style.transform = 'translateY(5px)';
                
                setTimeout(() => {
                    textEl.innerText = data.examples[currentExType];
                    textEl.style.opacity = 1;
                    textEl.style.transform = 'translateY(0)';
                }, 150);
            }

            function replayAnimation() {
                const data = TENSES[currentTenseKey];
                drawTimeline(data.viz, data.color);
                lucide.createIcons();
            }

            function toggleSidebar() {
                const sb = document.getElementById('sidebar');
                sb.classList.toggle('-translate-x-full');
            }
            
            function closeSidebarMobile() {
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            }

            // Expose public methods
            return {
                init,
                loadTense,
                setExampleType,
                toggleSidebar,
                closeSidebarMobile,
                replayAnimation,
                renderSidebar
            };

        })();
    </script>
</body>
</html>