<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 â€¢ Tense Master</title>
    
    <!-- 
      FONTS: 
      - Fredoka: Used for Headings, Buttons, and UI Labels (Playful, rounded).
      - Nunito: Used for body text and sentences (Readable, friendly).
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ICONS: Lucide Icons (Clean, thick strokes) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- STYLING: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TAILWIND CONFIGURATION: English 1 Batam Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Official Palette
                        brand: {
                            pink: '#FF6B95',   // Playful
                            orange: '#FF8C42', // Energy
                            green: '#00E676',  // Success
                            blue: '#2979FF',   // Logic
                            purple: '#A855F7', // Time/Complex
                            dark: '#1e293b',   // Borders/Text
                            chalk: '#f8fafc',  // Background
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        // Neo-Brutalism Hard Shadows
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-lg': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': '0px 0px 0px 0px rgba(30, 41, 59, 1)', // Flat when pressed
                    },
                    borderWidth: {
                        '3': '3px', // Standard thick border
                    },
                    backgroundImage: {
                        // Visual pattern for "Duration" blocks in timeline
                        'tape-pattern': "repeating-linear-gradient(-45deg, transparent, transparent 5px, rgba(255,255,255,0.3) 5px, rgba(255,255,255,0.3) 10px)",
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        /* --- GLOBAL STYLES --- */
        body {
            @apply bg-brand-chalk text-brand-dark font-body min-h-screen flex flex-col;
            /* Graph Paper Background Effect */
            background-image: 
                linear-gradient(#e2e8f0 1px, transparent 1px),
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- NEO-BRUTALISM COMPONENTS --- */
        
        /* Standard Button */
        .btn-neo {
            @apply border-3 border-brand-dark rounded-xl shadow-neo transition-all duration-150 font-heading font-bold px-4 py-2 flex items-center justify-center gap-2 bg-white select-none relative;
        }
        /* Hover State: Lift up */
        .btn-neo:hover:not(:disabled) {
            @apply -translate-y-0.5 shadow-neo-lg;
        }
        /* Active State: Press flat */
        .btn-neo:active:not(:disabled) {
            @apply translate-y-1 shadow-neo-pressed;
        }
        /* Disabled State */
        .btn-neo:disabled {
            @apply opacity-50 cursor-not-allowed shadow-none translate-y-1 bg-slate-100 text-slate-400;
        }

        /* Standard Card */
        .card-neo {
            @apply bg-white border-3 border-brand-dark rounded-2xl shadow-neo p-6 relative overflow-hidden;
        }

        /* --- TIMELINE SPECIFIC STYLES --- */
        .draggable-item {
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), left 0.05s linear; /* Smooth pop, snappy drag */
        }
        .draggable-item:active { 
            cursor: grabbing; 
            transform: scale(1.1); 
            z-index: 50;
        }

        /* Custom Scrollbar for Tense Selector */
        .preset-scroll::-webkit-scrollbar { height: 10px; }
        .preset-scroll::-webkit-scrollbar-track { background: transparent; }
        .preset-scroll::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 10px; 
            border: 3px solid #f8fafc; /* Creates padding effect */
        }
        .preset-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation Classes */
        @keyframes pop-in {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>

    <!-- ================= HEADER ================= -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b-3 border-brand-dark px-4 py-3 shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center gap-3 select-none">
                <div class="bg-brand-blue p-2 rounded-xl border-2 border-brand-dark shadow-sm transform -rotate-3 hover:rotate-0 transition-transform">
                    <i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-heading font-black tracking-tight text-brand-dark">
                    English 1 <span class="text-brand-blue">Master</span>
                </h1>
            </div>
            
            <!-- Mode Switcher -->
            <div class="flex gap-2 bg-slate-100 p-1 rounded-xl border-2 border-brand-dark">
                <button onclick="setMode('study')" id="btn-mode-study" class="px-5 py-1.5 rounded-lg font-heading font-bold text-sm transition-all border-2 border-transparent hover:bg-white">
                    Study
                </button>
                <button onclick="setMode('game')" id="btn-mode-game" class="px-5 py-1.5 rounded-lg font-heading font-bold text-sm transition-all border-2 border-transparent hover:bg-white">
                    Quiz
                </button>
            </div>
        </div>
    </nav>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="flex-grow w-full max-w-6xl mx-auto p-4 md:p-8 flex flex-col items-center">

        <!-- +++++++++++++++++ VIEW 1: STUDY MODE (TIMELINE) +++++++++++++++++ -->
        <div id="view-study" class="w-full flex flex-col gap-8 animate-pop">
            
            <!-- 1. Tense Selector (Scrollable Row) -->
            <div class="w-full">
                <div class="w-full overflow-x-auto preset-scroll pb-4 -mx-4 px-4 md:mx-0 md:px-0">
                    <div class="flex gap-5 w-max mx-auto">
                        
                        <!-- Simple Tenses Group -->
                        <div class="group-container bg-brand-pink/5 border-brand-pink/20">
                            <span class="group-label text-brand-pink border-brand-pink/20">Simple</span>
                            <button onclick="loadTense('pastSimple')" class="btn-tense hover:bg-brand-pink hover:text-white hover:border-brand-dark">Past Simple</button>
                            <button onclick="loadTense('presentSimple')" class="btn-tense hover:bg-brand-pink hover:text-white hover:border-brand-dark">Present Simple</button>
                            <button onclick="loadTense('futureSimple')" class="btn-tense hover:bg-brand-pink hover:text-white hover:border-brand-dark">Future Simple</button>
                        </div>

                        <!-- Continuous Tenses Group -->
                        <div class="group-container bg-brand-orange/5 border-brand-orange/20">
                            <span class="group-label text-brand-orange border-brand-orange/20">Continuous</span>
                            <button onclick="loadTense('pastCont')" class="btn-tense hover:bg-brand-orange hover:text-white hover:border-brand-dark">Past Cont.</button>
                            <button onclick="loadTense('presentCont')" class="btn-tense hover:bg-brand-orange hover:text-white hover:border-brand-dark">Present Cont.</button>
                            <button onclick="loadTense('futureCont')" class="btn-tense hover:bg-brand-orange hover:text-white hover:border-brand-dark">Future Cont.</button>
                        </div>

                        <!-- Perfect Tenses Group -->
                        <div class="group-container bg-brand-blue/5 border-brand-blue/20">
                            <span class="group-label text-brand-blue border-brand-blue/20">Perfect</span>
                            <button onclick="loadTense('presentPerfect')" class="btn-tense hover:bg-brand-blue hover:text-white hover:border-brand-dark">Pres. Perfect</button>
                            <button onclick="loadTense('pastPerfect')" class="btn-tense hover:bg-brand-blue hover:text-white hover:border-brand-dark">Past Perfect</button>
                            <button onclick="loadTense('futurePerfect')" class="btn-tense hover:bg-brand-blue hover:text-white hover:border-brand-dark">Future Perfect</button>
                        </div>

                        <!-- Perfect Continuous Group -->
                        <div class="group-container bg-brand-purple/5 border-brand-purple/20">
                            <span class="group-label text-brand-purple border-brand-purple/20">Perf. Cont.</span>
                            <button onclick="loadTense('presentPerfectCont')" class="btn-tense hover:bg-brand-purple hover:text-white hover:border-brand-dark">Pr. Perf. Cont.</button>
                            <button onclick="loadTense('pastPerfectCont')" class="btn-tense hover:bg-brand-purple hover:text-white hover:border-brand-dark">Pa. Perf. Cont.</button>
                            <button onclick="loadTense('futurePerfectCont')" class="btn-tense hover:bg-brand-purple hover:text-white hover:border-brand-dark">Fu. Perf. Cont.</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Context Card (Title & Example) -->
            <div class="card-neo w-full flex flex-col items-center text-center gap-6 bg-white min-h-[220px] justify-center transition-all">
                <div class="w-full">
                    <h2 id="tense-title" class="text-4xl md:text-6xl font-heading font-black text-brand-dark mb-3 transition-colors duration-300 drop-shadow-sm">Select a Tense</h2>
                    <p id="tense-desc" class="text-slate-500 font-bold text-lg max-w-3xl mx-auto leading-relaxed">Click a button above to visualize how the tense works on the timeline.</p>
                </div>
                
                <!-- Example Sentence Box -->
                <div class="w-full max-w-3xl relative group transform transition-transform hover:scale-[1.01]">
                    <div class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400">
                        <i data-lucide="message-square" class="w-6 h-6"></i>
                    </div>
                    <input type="text" id="sentence-input" 
                           class="w-full pl-14 pr-6 py-5 bg-slate-50 border-3 border-brand-dark rounded-xl font-heading font-bold text-xl md:text-2xl text-brand-dark focus:outline-none focus:ring-4 focus:ring-brand-blue/20 transition-all text-center shadow-inner placeholder:text-slate-300"
                           placeholder="Example sentence appears here..." readonly>
                    <!-- Label -->
                    <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-2 text-[10px] font-black uppercase tracking-widest text-slate-400">Example Sentence</span>
                </div>
            </div>

            <!-- 3. The Timeline (Visualization Tool) -->
            <div class="card-neo w-full h-[400px] bg-slate-50 relative border-3 border-brand-dark select-none overflow-visible group" id="timeline-box">
                <!-- Grid Background -->
                <div class="absolute inset-0 opacity-10 pointer-events-none" 
                     style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 20px 20px;">
                </div>

                <!-- Labels -->
                <div class="absolute top-6 left-6 flex items-center gap-2 opacity-50">
                    <div class="bg-brand-dark text-white p-1 rounded"><i data-lucide="arrow-left" class="w-4 h-4"></i></div>
                    <span class="font-black text-brand-dark uppercase tracking-widest text-sm">PAST</span>
                </div>
                <div class="absolute top-6 right-6 flex items-center gap-2 opacity-50">
                    <span class="font-black text-brand-dark uppercase tracking-widest text-sm">FUTURE</span>
                    <div class="bg-brand-dark text-white p-1 rounded"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                </div>

                <!-- Central Track (The "Groove") -->
                <div class="absolute top-1/2 left-0 right-0 h-10 bg-slate-200 border-y-4 border-slate-300 transform -translate-y-1/2 shadow-[inset_0_2px_4px_rgba(0,0,0,0.1)]"></div>
                
                <!-- "NOW" Indicator -->
                <div class="absolute top-12 bottom-12 left-1/2 w-0.5 border-r-4 border-dashed border-brand-green/30 z-0 transform -translate-x-1/2"></div>
                <div class="absolute top-[18%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 hover:scale-110 transition-transform cursor-help" title="The Present Moment">
                    <div class="bg-brand-green text-white text-[11px] font-black px-3 py-1 rounded-lg border-3 border-brand-dark shadow-neo-sm tracking-widest flex items-center gap-1">
                        <i data-lucide="clock" class="w-3 h-3"></i> NOW
                    </div>
                </div>

                <!-- Interactive Layer (Items injected here) -->
                <div id="timeline-layer" class="absolute inset-0 z-20 overflow-hidden">
                    <!-- Javascript will generate draggable items here -->
                </div>
            </div>
            
            <!-- Legend / Instructions -->
            <div class="flex flex-wrap justify-center gap-4 md:gap-8 text-xs font-bold text-slate-400 uppercase tracking-widest bg-white p-4 rounded-xl border-2 border-slate-200 mx-auto">
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-brand-dark"></div>Drag items to explore time</span>
                <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-3 h-3"></i> Represents Single Action</span>
                <span class="flex items-center gap-2"><div class="w-4 h-2 bg-brand-dark/20 rounded-sm"></div> Represents Duration</span>
            </div>
        </div>


        <!-- +++++++++++++++++ VIEW 2: GAME MODE (QUIZ) +++++++++++++++++ -->
        <div id="view-game" class="w-full max-w-3xl hidden flex-col items-center gap-6 animate-pop">
            
            <!-- Score & Timer Bar -->
            <div class="w-full flex justify-between items-center bg-white border-3 border-brand-dark p-4 rounded-2xl shadow-neo">
                <div class="flex flex-col pl-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">CURRENT SCORE</span>
                    <span id="score-val" class="text-4xl font-heading font-black text-brand-orange leading-none">0</span>
                </div>
                <div class="h-10 w-0.5 bg-slate-200"></div> <!-- Divider -->
                <div class="flex flex-col items-end pr-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">TIME LEFT</span>
                    <div class="flex items-baseline gap-1">
                        <span id="timer-val" class="text-4xl font-heading font-black text-brand-pink leading-none">20</span>
                        <span class="text-sm font-bold text-slate-400">s</span>
                    </div>
                </div>
            </div>

            <!-- Quiz Card -->
            <div id="game-card" class="card-neo w-full text-center py-12 px-6 md:px-12 flex flex-col items-center gap-6 min-h-[400px] justify-center">
                <!-- Icon Decoration -->
                <div class="bg-brand-blue/10 p-5 rounded-full border-3 border-brand-blue mb-2 shadow-sm transform hover:rotate-12 transition-transform duration-300">
                    <i data-lucide="gamepad-2" class="w-12 h-12 text-brand-blue"></i>
                </div>
                
                <!-- Question Text -->
                <h2 id="q-text" class="text-3xl md:text-4xl font-heading font-bold leading-tight text-brand-dark max-w-2xl">
                    Ready to Challenge<br>Your Grammar?
                </h2>
                
                <!-- Loading State (Hidden by default) -->
                <div id="loading-msg" class="flex flex-col items-center gap-3 hidden animate-pulse mt-4">
                    <div class="w-10 h-10 border-4 border-brand-blue border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm font-bold text-slate-400">Loading questions from ./questions.json...</span>
                </div>

                <!-- Options Grid (Injected by JS) -->
                <div id="options-area" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full mt-6 hidden">
                    <!-- Buttons go here -->
                </div>

                <!-- Start Button -->
                <button id="btn-start" onclick="startGame()" class="btn-neo bg-brand-green text-white text-xl px-12 py-5 mt-6 shadow-neo border-brand-dark hover:bg-brand-green/90 group">
                    Start Game <i data-lucide="play" class="w-5 h-5 ml-2 fill-current"></i>
                </button>
            </div>

            <!-- Feedback Overlay (Absolute positioning on top of game card logic) -->
            <div id="feedback-area" class="hidden w-full bg-brand-dark text-white p-8 md:p-12 rounded-2xl border-3 border-white/20 text-center shadow-neo relative overflow-hidden animate-pop">
                <!-- Top Stripe -->
                <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-brand-pink via-brand-orange to-brand-blue"></div>
                
                <!-- Feedback Icon -->
                <div id="fb-icon" class="mx-auto mb-6 w-20 h-20 rounded-full flex items-center justify-center border-4 border-white/20 text-3xl shadow-lg"></div>
                
                <h3 id="fb-title" class="text-4xl font-heading font-black mb-4 tracking-tight">Correct!</h3>
                <div id="fb-desc" class="text-slate-300 text-lg mb-8 leading-relaxed font-medium"></div>
                
                <button onclick="nextQuestion()" class="btn-neo bg-white text-brand-dark w-full py-4 text-xl border-transparent hover:border-brand-blue">
                    Next Question <i data-lucide="arrow-right" class="w-6 h-6 ml-2"></i>
                </button>
            </div>

        </div>

    </main>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        /**
         * --------------------------------------------------------------------------
         * SECTION 1: DATA CONFIGURATION
         * Defines the visual rules for each tense on the timeline.
         * --------------------------------------------------------------------------
         */
        const TENSES = {
            // --- SIMPLE TENSES ---
            pastSimple: {
                title: "Past Simple",
                desc: "Action started and finished at a specific time in the past.",
                sentence: "I visited Batam last year.",
                color: 'pink',
                items: [
                    { type: 'pin', left: 25, label: 'Visited' },
                    { type: 'time', left: 25, label: 'Last Year' }
                ]
            },
            presentSimple: {
                title: "Present Simple",
                desc: "Facts, habits, or routines that are generally true.",
                sentence: "I teach English every day.",
                color: 'pink',
                items: [
                    { type: 'pin', left: 15, label: 'Teach' },
                    { type: 'pin', left: 35, label: 'Teach' },
                    { type: 'pin', left: 50, label: 'Teach' }, // Center point (Now)
                    { type: 'pin', left: 65, label: 'Teach' },
                    { type: 'pin', left: 85, label: 'Teach' },
                    { type: 'arrow', left: 15, width: 70, label: 'Routine' }
                ]
            },
            futureSimple: {
                title: "Future Simple",
                desc: "Decisions made at the moment of speaking or predictions.",
                sentence: "I will call you later.",
                color: 'pink',
                items: [
                    { type: 'pin', left: 75, label: 'Call You' },
                    { type: 'arrow', left: 50, width: 25, label: 'Decision' }
                ]
            },
            // --- CONTINUOUS TENSES ---
            pastCont: {
                title: "Past Continuous",
                desc: "Action was in progress at a specific moment in the past.",
                sentence: "I was reading when you called.",
                color: 'orange',
                items: [
                    { type: 'duration', left: 15, width: 30, label: 'Reading...' },
                    { type: 'time', left: 35, label: 'You Called' }
                ]
            },
            presentCont: {
                title: "Present Continuous",
                desc: "Action happening right now.",
                sentence: "I am explaining this tool.",
                color: 'orange',
                items: [
                    { type: 'duration', left: 40, width: 20, label: 'Happening Now' }
                ]
            },
            futureCont: {
                title: "Future Continuous",
                desc: "Action will be in progress at a specific future time.",
                sentence: "I will be flying to Jakarta at 8 PM.",
                color: 'orange',
                items: [
                    { type: 'duration', left: 65, width: 25, label: 'Flying...' },
                    { type: 'time', left: 78, label: '8 PM' }
                ]
            },
            // --- PERFECT TENSES ---
            presentPerfect: {
                title: "Present Perfect",
                desc: "Past action with a result or connection to the present.",
                sentence: "I have lost my keys.",
                color: 'blue',
                items: [
                    { type: 'pin', left: 35, label: 'Lost Keys' },
                    { type: 'arrow', left: 35, width: 15, label: 'Result Now' }
                ]
            },
            pastPerfect: {
                title: "Past Perfect",
                desc: "Action completed before another action in the past.",
                sentence: "The train had left before I arrived.",
                color: 'blue',
                items: [
                    { type: 'pin', left: 15, label: 'Train Left' },
                    { type: 'time', left: 35, label: 'I Arrived' },
                    { type: 'arrow', left: 15, width: 20, label: 'Before' }
                ]
            },
            futurePerfect: {
                title: "Future Perfect",
                desc: "Action will be completed before a specific future time.",
                sentence: "I will have finished by 5 PM.",
                color: 'blue',
                items: [
                    { type: 'pin', left: 70, label: 'Finished' },
                    { type: 'time', left: 85, label: '5 PM' },
                    { type: 'arrow', left: 50, width: 35, label: 'Before' }
                ]
            },
            // --- PERFECT CONTINUOUS TENSES ---
            presentPerfectCont: {
                title: "Pres. Perfect Continuous",
                desc: "Action started in the past and continues to now.",
                sentence: "I have been waiting for 2 hours.",
                color: 'purple',
                items: [
                    { type: 'duration', left: 20, width: 30, label: 'Waiting...' },
                    { type: 'arrow', left: 20, width: 30, label: '2 Hours' }
                ]
            },
            pastPerfectCont: {
                title: "Past Perfect Continuous",
                desc: "Duration leading up to a specific past moment.",
                sentence: "It had been raining when I woke up.",
                color: 'purple',
                items: [
                    { type: 'duration', left: 10, width: 25, label: 'Raining...' },
                    { type: 'time', left: 35, label: 'Woke Up' }
                ]
            },
            futurePerfectCont: {
                title: "Future Perfect Continuous",
                desc: "Duration leading up to a specific future moment.",
                sentence: "I will have been teaching for 10 years by 2030.",
                color: 'purple',
                items: [
                    { type: 'duration', left: 40, width: 45, label: 'Teaching...' },
                    { type: 'time', left: 85, label: 'By 2030' }
                ]
            }
        };

        /**
         * --------------------------------------------------------------------------
         * SECTION 2: GLOBAL STATE & INIT
         * --------------------------------------------------------------------------
         */
        let QUESTIONS = []; // To be populated via fetch
        let currentQIndex = 0;
        let score = 0;
        let timer = 20;
        let timerInterval;

        // DOM Element References (Cached for performance)
        const DOM = {
            views: {
                study: document.getElementById('view-study'),
                game: document.getElementById('view-game')
            },
            btns: {
                modeStudy: document.getElementById('btn-mode-study'),
                modeGame: document.getElementById('btn-mode-game'),
                start: document.getElementById('btn-start')
            },
            timeline: {
                layer: document.getElementById('timeline-layer'),
                title: document.getElementById('tense-title'),
                desc: document.getElementById('tense-desc'),
                input: document.getElementById('sentence-input')
            },
            quiz: {
                card: document.getElementById('game-card'),
                feedback: document.getElementById('feedback-area'),
                options: document.getElementById('options-area'),
                loading: document.getElementById('loading-msg'),
                questionText: document.getElementById('q-text'),
                scoreVal: document.getElementById('score-val'),
                timerVal: document.getElementById('timer-val')
            }
        };

        // Initial Setup
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setMode('study'); 
            loadTense('presentSimple'); // Default View
        });

        /**
         * --------------------------------------------------------------------------
         * SECTION 3: CORE UTILS (Mode Switching & Fetching)
         * --------------------------------------------------------------------------
         */
        
        // Handles switching between "Study" and "Quiz" views
        function setMode(mode) {
            if (mode === 'study') {
                DOM.views.study.classList.remove('hidden');
                DOM.views.game.classList.add('hidden');
                
                // Visual Button States
                updateNavButton(DOM.btns.modeStudy, true);
                updateNavButton(DOM.btns.modeGame, false);
            } else {
                DOM.views.study.classList.add('hidden');
                DOM.views.game.classList.remove('hidden');

                updateNavButton(DOM.btns.modeGame, true);
                updateNavButton(DOM.btns.modeStudy, false);

                // Check/Load Questions only when needed
                if (QUESTIONS.length === 0) {
                    loadQuestionsFromFile();
                }
            }
        }

        // Helper to styling nav buttons
        function updateNavButton(btn, isActive) {
            if (isActive) {
                btn.classList.add('bg-brand-orange', 'text-white', 'border-brand-dark', 'shadow-neo-sm');
                btn.classList.remove('border-transparent', 'hover:bg-white');
            } else {
                btn.classList.remove('bg-brand-orange', 'text-white', 'border-brand-dark', 'shadow-neo-sm');
                btn.classList.add('border-transparent', 'hover:bg-white');
            }
        }

        // Fetches questions.json from the same directory
        async function loadQuestionsFromFile() {
            try {
                // Show loading state
                DOM.btns.start.classList.add('hidden');
                DOM.quiz.loading.classList.remove('hidden');
                
                // Note: Fetching local files via fetch() requires a server context
                const response = await fetch('./questions.json');
                
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                
                QUESTIONS = await response.json();
                
                // Hide loading, show start
                DOM.quiz.loading.classList.add('hidden');
                DOM.btns.start.classList.remove('hidden');
                console.log("Questions loaded:", QUESTIONS.length);

            } catch (error) {
                console.error("Fetch Error:", error);
                DOM.quiz.loading.innerHTML = `
                    <div class="text-brand-pink font-bold">Error loading questions</div>
                    <div class="text-xs text-slate-400 mt-2 max-w-xs">
                        If viewing locally, please use a local server (e.g., Live Server) as browsers block file:// requests.
                    </div>
                `;
            }
        }

        /**
         * --------------------------------------------------------------------------
         * SECTION 4: STUDY MODE LOGIC (Timeline Renderer)
         * --------------------------------------------------------------------------
         */

        function loadTense(key) {
            const data = TENSES[key];
            if (!data) return;

            // 1. Animate Title Change
            DOM.timeline.title.style.opacity = '0';
            setTimeout(() => {
                DOM.timeline.title.innerText = data.title;
                // Dynamic Tailwind Class for Color
                DOM.timeline.title.className = `text-4xl md:text-6xl font-heading font-black mb-3 transition-colors duration-300 drop-shadow-sm text-brand-${data.color}`;
                DOM.timeline.title.style.opacity = '1';
            }, 150);

            // 2. Update Content
            DOM.timeline.desc.innerText = data.desc;
            DOM.timeline.input.value = data.sentence;

            // 3. Clear & Re-render Timeline
            DOM.timeline.layer.style.opacity = '0';
            setTimeout(() => {
                DOM.timeline.layer.innerHTML = '';
                renderTimelineItems(data);
                DOM.timeline.layer.style.opacity = '1';
                lucide.createIcons();
            }, 200);
        }

        function renderTimelineItems(data) {
            data.items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'draggable-item absolute group flex flex-col items-center justify-center';
                
                // Default centering
                el.style.left = item.left + '%';
                el.style.top = '50%'; 

                // Generate HTML based on item type
                if(item.type === 'pin') {
                    // PIN: Represents a single moment
                    el.innerHTML = `
                        <div class="relative z-10 -mt-8 flex flex-col items-center">
                            <div class="bg-brand-${data.color} text-white w-10 h-10 rounded-full border-3 border-brand-dark shadow-neo flex items-center justify-center hover:-translate-y-1 transition-transform">
                                <i data-lucide="map-pin" class="w-5 h-5"></i>
                            </div>
                            <div class="w-1.5 h-12 bg-brand-dark"></div>
                            <div class="w-4 h-4 bg-brand-dark rounded-full -mt-2"></div>
                            <span class="absolute -top-10 bg-white border-3 border-brand-dark px-3 py-1 rounded-lg text-xs font-heading font-black uppercase whitespace-nowrap shadow-neo-sm opacity-0 group-hover:opacity-100 transition-all text-brand-dark pointer-events-none">${item.label}</span>
                        </div>
                    `;
                } else if (item.type === 'duration') {
                    // DURATION: Represents a span of time
                    el.style.width = item.width + '%';
                    el.style.transform = 'translate(0, -50%)'; // Vertically center the bar
                    el.innerHTML = `
                        <div class="w-full h-12 bg-brand-${data.color} border-3 border-brand-dark rounded-xl shadow-neo opacity-90 flex items-center justify-center relative bg-tape-pattern hover:scale-105 transition-transform">
                             <span class="bg-white px-2 py-0.5 rounded border-2 border-brand-dark text-brand-dark text-[10px] font-black uppercase tracking-widest shadow-sm z-10 select-none">${item.label}</span>
                        </div>
                    `;
                } else if (item.type === 'arrow') {
                    // ARROW: Represents a relationship or flow
                    el.style.width = item.width + '%';
                    el.style.top = '72%'; // Position slightly below track
                    el.innerHTML = `
                        <div class="w-full h-3 bg-brand-dark rounded-full relative flex items-center justify-center opacity-60">
                            <div class="absolute -right-1 w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-brand-dark border-b-[8px] border-b-transparent"></div>
                            <span class="absolute -bottom-6 text-[10px] font-black uppercase text-brand-dark bg-white px-1 rounded border border-brand-dark whitespace-nowrap">${item.label}</span>
                        </div>
                    `;
                } else if (item.type === 'time') {
                    // TIME MARKER: Represents specific time reference (e.g. "Yesterday")
                    el.style.top = '28%'; // Position slightly above track
                    el.innerHTML = `
                        <div class="flex flex-col items-center group-hover:-translate-y-1 transition-transform">
                            <span class="bg-brand-dark text-white px-3 py-1 rounded-lg border-2 border-brand-dark text-[11px] font-black uppercase mb-1 shadow-sm whitespace-nowrap">${item.label}</span>
                            <div class="h-20 w-1 border-l-4 border-dashed border-brand-dark opacity-30"></div>
                        </div>
                    `;
                }

                makeDraggable(el);
                DOM.timeline.layer.appendChild(el);
            });
        }

        // --- Dragging Logic ---
        function makeDraggable(element) {
            let startX = 0, initialLeft = 0;

            const onMouseDown = (e) => {
                e.preventDefault(); // Prevent text selection
                startX = e.clientX || e.touches[0].clientX;
                initialLeft = element.offsetLeft;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('touchmove', onMouseMove);
                document.addEventListener('touchend', onMouseUp);
            };

            const onMouseMove = (e) => {
                const clientX = e.clientX || e.touches[0].clientX;
                const deltaX = clientX - startX;
                let newLeft = initialLeft + deltaX;

                // Constraints (Stay within parent width)
                const parentWidth = DOM.timeline.layer.offsetWidth;
                if (newLeft < 0) newLeft = 0;
                if (newLeft > parentWidth - 40) newLeft = parentWidth - 40;

                element.style.left = newLeft + 'px';
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            };

            element.addEventListener('mousedown', onMouseDown);
            element.addEventListener('touchstart', onMouseDown);
        }

        /**
         * --------------------------------------------------------------------------
         * SECTION 5: GAME MODE LOGIC (Quiz)
         * --------------------------------------------------------------------------
         */

        function startGame() {
            if (QUESTIONS.length === 0) {
                // Retry loading if empty
                loadQuestionsFromFile(); 
                return;
            }
            
            // UI Transition
            DOM.btns.start.classList.add('hidden');
            DOM.quiz.options.classList.remove('hidden');
            DOM.quiz.options.classList.add('grid');
            
            // Reset State
            currentQIndex = 0;
            score = 0;
            updateScoreUI();
            
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (currentQIndex >= QUESTIONS.length) {
                showEndScreen();
                return;
            }

            const q = QUESTIONS[currentQIndex];
            
            // UI Updates
            DOM.quiz.questionText.innerText = q.q;
            DOM.quiz.card.classList.remove('hidden');
            DOM.quiz.feedback.classList.add('hidden');
            DOM.quiz.options.innerHTML = ''; // Clear previous

            // Create Buttons
            q.opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                // Styling specifically for quiz options
                btn.className = 'btn-neo bg-white hover:bg-slate-50 border-3 border-brand-dark w-full py-5 text-lg justify-start relative group overflow-hidden transition-all';
                btn.innerHTML = `
                    <span class="absolute left-0 top-0 bottom-0 w-2 bg-brand-dark group-hover:w-full transition-all duration-300 opacity-10"></span>
                    <span class="bg-brand-dark text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm font-black mr-3 relative z-10">${['A','B','C','D'][idx]}</span> 
                    <span class="font-bold text-slate-700 relative z-10 text-left flex-1">${opt}</span>
                `;
                btn.onclick = () => handleAnswer(idx);
                DOM.quiz.options.appendChild(btn);
            });

            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timer = 20;
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                timer--;
                updateTimerUI();
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1); // Timeout
                }
            }, 1000);
        }

        function updateTimerUI() {
            DOM.quiz.timerVal.innerText = timer;
            if (timer <= 5) DOM.quiz.timerVal.classList.add('animate-pulse', 'text-red-500');
            else DOM.quiz.timerVal.classList.remove('animate-pulse', 'text-red-500');
        }

        function handleAnswer(selectedIndex) {
            clearInterval(timerInterval);
            const q = QUESTIONS[currentQIndex];
            const isCorrect = (selectedIndex === q.a);

            if (isCorrect) score += 100;
            updateScoreUI();

            showFeedback(isCorrect, q, selectedIndex);
        }

        function showFeedback(isCorrect, question, selectedIndex) {
            DOM.quiz.card.classList.add('hidden');
            DOM.quiz.feedback.classList.remove('hidden');

            const iconContainer = document.getElementById('fb-icon');
            const title = document.getElementById('fb-title');
            const desc = document.getElementById('fb-desc');

            if (isCorrect) {
                iconContainer.className = 'mx-auto mb-6 w-24 h-24 rounded-full flex items-center justify-center border-4 border-white/20 text-white bg-brand-green shadow-neo animate-bounce';
                iconContainer.innerHTML = '<i data-lucide="check" class="w-12 h-12"></i>';
                title.innerText = "Correct!";
            } else {
                iconContainer.className = 'mx-auto mb-6 w-24 h-24 rounded-full flex items-center justify-center border-4 border-white/20 text-white bg-brand-pink shadow-neo animate-pulse';
                iconContainer.innerHTML = '<i data-lucide="x" class="w-12 h-12"></i>';
                title.innerText = selectedIndex === -1 ? "Time's Up!" : "Incorrect";
            }

            desc.innerHTML = `
                <div class="bg-white/10 p-5 rounded-xl border-2 border-white/10 mb-4 text-left">
                    <span class="block text-xs uppercase tracking-widest opacity-70 mb-1">Correct Answer</span>
                    <strong class="text-2xl text-brand-orange font-heading">${question.opts[question.a]}</strong>
                </div>
                <div class="opacity-90 font-bold bg-brand-dark/50 p-3 rounded-lg border border-white/10">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i> ${question.exp}
                </div>
            `;
            lucide.createIcons();
        }

        function nextQuestion() {
            currentQIndex++;
            loadNextQuestion();
        }

        function updateScoreUI() {
            DOM.quiz.scoreVal.innerText = score;
        }

        function showEndScreen() {
            clearInterval(timerInterval);
            DOM.quiz.card.classList.remove('hidden');
            DOM.quiz.options.classList.add('hidden');
            DOM.quiz.feedback.classList.add('hidden');
            
            DOM.quiz.questionText.innerHTML = `Quiz Complete!<br><span class="text-base text-slate-400">Final Score</span>`;
            
            // Remove any previous score displays
            const existingScore = document.getElementById('final-score-display');
            if(existingScore) existingScore.remove();

            // Create Final Score Element
            const finalScoreEl = document.createElement('div');
            finalScoreEl.id = 'final-score-display';
            finalScoreEl.className = 'animate-pop mb-6';
            finalScoreEl.innerHTML = `
                <div class="text-8xl font-black text-brand-orange drop-shadow-sm mb-2 font-heading">${score}</div>
                <div class="text-slate-400 font-bold uppercase tracking-widest text-sm">Points Earned</div>
            `;
            
            DOM.quiz.card.insertBefore(finalScoreEl, DOM.btns.start);
            
            DOM.btns.start.classList.remove('hidden');
            DOM.btns.start.innerHTML = 'Play Again <i data-lucide="rotate-ccw" class="w-5 h-5 ml-2"></i>';
        }

    </script>
    
    <style type="text/tailwindcss">
        /* Utility classes for grouping Tense buttons */
        .group-container {
            @apply flex flex-col gap-2 p-3 rounded-2xl border-3 min-w-[140px] relative mt-2;
        }
        .group-label {
            @apply absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-2 py-0.5 rounded border-2 text-[10px] font-black uppercase tracking-widest shadow-sm;
        }
        .btn-tense {
            @apply btn-neo text-xs whitespace-nowrap w-full justify-start;
        }
    </style>
</body>
</html>