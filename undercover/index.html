<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undercover Game - English 1 Batam</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        fredoka: ['Fredoka', 'sans-serif'],
                        nunito: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        e1dark: '#1e293b',
                        e1chalk: '#f8fafc',
                    },
                    boxShadow: {
                        'hard': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-sm': '3px 3px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-lg': '10px 10px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    borderWidth: {
                        '3': '3px',
                        '4': '4px',
                    },
                    animation: {
                        'bounce-slight': 'bounce-slight 2s infinite',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'bounce-slight': {
                            '0%, 100%': { transform: 'translateY(-5%)' },
                            '50%': { transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        popIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(#1e293b 1.5px, transparent 1.5px), 
                linear-gradient(90deg, #1e293b 1.5px, transparent 1.5px);
            background-size: 40px 40px;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(248, 250, 252, 0.94); 
            z-index: -1;
        }

        .btn-press {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-press:active {
            transform: translate(6px, 6px) !important;
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1) !important;
        }
        .btn-press:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px 0px rgba(30, 41, 59, 1);
        }

        .card-hover:hover {
            transform: translateY(-6px);
            box-shadow: 10px 10px 0px 0px rgba(30, 41, 59, 1);
        }

        /* Blur effect for teacher view */
        .blur-secret {
            filter: blur(8px);
            transition: filter 0.3s;
            cursor: pointer;
        }
        .blur-secret:hover, .blur-secret:active {
            filter: blur(0px);
        }
    </style>
</head>
<body class="font-nunito text-e1dark min-h-screen flex flex-col selection:bg-e1pink selection:text-white dark:bg-slate-900 dark:text-white">

    <header class="bg-white dark:bg-slate-800 border-b-4 border-e1dark px-6 py-4 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="initGame()">
                <div class="bg-e1pink p-2 rounded-xl border-3 border-e1dark shadow-hard-sm transform -rotate-3">
                    <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
                </div>
                <span class="font-fredoka font-bold text-2xl tracking-wide hidden sm:block">English 1 Batam</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleTeacherView()" class="bg-e1orange text-white px-3 py-2 rounded-lg border-2 border-e1dark shadow-hard-sm btn-press" title="Teacher Eyes Only">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                </button>
                <button onclick="initGame()" class="font-fredoka font-bold text-sm bg-e1blue text-white px-4 py-2 rounded-lg border-2 border-e1dark shadow-hard-sm btn-press">
                    <i data-lucide="home" class="w-4 h-4 inline mr-1"></i> Home
                </button>
            </div>
        </div>
    </header>

    <main id="app" class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center justify-start max-w-4xl">
        </main>

    <div id="teacherModal" class="fixed inset-0 z-[60] hidden flex-col items-center justify-center bg-e1dark/90 backdrop-blur-sm p-4">
        <div class="bg-white border-4 border-e1dark rounded-3xl shadow-hard-lg max-w-2xl w-full flex flex-col max-h-[90vh]">
            <div class="p-6 border-b-4 border-e1dark bg-slate-50 rounded-t-3xl flex justify-between items-center">
                <h2 class="font-fredoka text-3xl font-black text-e1dark flex items-center gap-2">
                    <i data-lucide="glasses" class="text-e1blue"></i> Teacher View
                </h2>
                <button onclick="toggleTeacherView()" class="bg-e1pink text-white p-2 rounded-xl border-3 border-e1dark shadow-hard-sm hover:scale-95 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-8 overflow-y-auto">
                <div class="bg-yellow-100 border-3 border-yellow-500 text-yellow-800 p-4 rounded-xl mb-6 font-bold text-center">
                    <i data-lucide="alert-triangle" class="inline w-5 h-5 mb-1 mr-1"></i> 
                    Hover over the blurred area below to reveal answers. <br>Ensure projector is FREEZE or OFF if mirroring screen!
                </div>

                <div class="blur-secret bg-slate-100 p-6 rounded-2xl border-3 border-dashed border-slate-400">
                    <h3 class="font-black text-xl mb-4 text-center underline decoration-wavy decoration-e1pink">CURRENT GAME STATE</h3>
                    <div id="teacherContent" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORD_PAIRS = [
            ["School", "University"], ["Teacher", "Professor"], ["Student", "Pupil"],
            ["Apple", "Pear"], ["Coffee", "Tea"], ["Car", "Bus"],
            ["Guitar", "Violin"], ["Soccer", "Basketball"], ["Beach", "Pool"],
            ["Cinema", "Netflix"], ["Book", "Magazine"], ["Pen", "Pencil"],
            ["Laptop", "Tablet"], ["Cat", "Dog"], ["Doctor", "Nurse"],
            ["Summer", "Spring"], ["Happy", "Excited"], ["King", "President"],
            ["Chair", "Sofa"], ["Shoes", "Sandals"]
        ];

        const state = {
            screen: 'instructions',
            lastScreen: null,
            timer: null,
            timeLeft: 0,
            config: {
                playerNames: [], 
                spies: 1,
                mrWhite: 0,
                useCustomWords: false,
                customWord1: '',
                customWord2: ''
            },
            game: {
                players: [], 
                currentTurnIndex: 0,
                civWord: '',
                spyWord: '',
                eliminatedPlayer: null,
                winner: ''
            }
        };

        function initGame() {
            setScreen('instructions');
        }

        function setScreen(screenName) {
            state.lastScreen = state.screen;
            state.screen = screenName;
            render();
        }

        function toggleTeacherView() {
            const modal = document.getElementById('teacherModal');
            const content = document.getElementById('teacherContent');
            
            if (modal.classList.contains('hidden')) {
                // Open
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Populate content
                if (state.game.players.length === 0) {
                    content.innerHTML = '<p class="col-span-2 text-center font-bold text-slate-400">Game has not started yet.</p>';
                } else {
                    let html = state.game.players.map(p => {
                        let color = 'text-e1blue';
                        if(p.role === 'Undercover') color = 'text-e1pink';
                        if(p.role === 'Mr. White') color = 'text-e1orange';
                        
                        return `
                            <div class="bg-white border-2 border-e1dark p-3 rounded-lg shadow-sm flex justify-between items-center">
                                <span class="font-bold text-e1dark">${p.name}</span>
                                <div class="text-right">
                                    <div class="text-xs font-black uppercase ${color}">${p.role}</div>
                                    <div class="text-sm font-bold text-slate-500">${p.word}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML = `
                        <div class="col-span-2 text-center mb-2">
                            <span class="bg-e1blue text-white px-2 py-1 rounded text-xs font-bold">Civilian: ${state.game.civWord}</span>
                            <span class="bg-e1pink text-white px-2 py-1 rounded text-xs font-bold">Spy: ${state.game.spyWord}</span>
                        </div>
                        ${html}
                    `;
                }
            } else {
                // Close
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function startGame() {
            // Word Selection Logic
            if (state.config.useCustomWords && state.config.customWord1 && state.config.customWord2) {
                state.game.civWord = state.config.customWord1;
                state.game.spyWord = state.config.customWord2;
                // Randomize which is which
                if (Math.random() > 0.5) {
                    [state.game.civWord, state.game.spyWord] = [state.game.spyWord, state.game.civWord];
                }
            } else {
                const pair = WORD_PAIRS[Math.floor(Math.random() * WORD_PAIRS.length)];
                const flip = Math.random() > 0.5;
                state.game.civWord = flip ? pair[0] : pair[1];
                state.game.spyWord = flip ? pair[1] : pair[0];
            }

            let total = state.config.playerNames.length;
            let roles = Array(total).fill('Civilian');
            let spyCount = state.config.spies;
            let whiteCount = state.config.mrWhite;

            // Assign special roles
            let indices = Array.from({length: total}, (_, i) => i);
            indices.sort(() => Math.random() - 0.5); // Shuffle indices

            for (let i = 0; i < spyCount; i++) roles[indices.pop()] = 'Undercover';
            for (let i = 0; i < whiteCount; i++) roles[indices.pop()] = 'Mr. White';

            // Build Players
            state.game.players = state.config.playerNames.map((name, idx) => ({
                id: idx,
                name: name,
                role: roles[idx],
                word: roles[idx] === 'Civilian' ? state.game.civWord : (roles[idx] === 'Undercover' ? state.game.spyWord : '???'),
                isAlive: true,
                avatarId: idx % 6 
            }));

            // Randomize turn order for variety, but keep mapping consistent
            state.game.players.sort(() => Math.random() - 0.5);

            state.game.currentTurnIndex = 0;
            state.game.winner = null;
            setScreen('pass');
        }

        // Timer Logic
        function startTimer(seconds) {
            clearInterval(state.timer);
            state.timeLeft = seconds;
            renderTimer();
            state.timer = setInterval(() => {
                state.timeLeft--;
                renderTimer();
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    document.getElementById('timerDisplay').classList.add('animate-pulse-fast', 'text-red-500');
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(state.timer);
            state.timeLeft = 0;
            renderTimer();
        }

        function renderTimer() {
            const el = document.getElementById('timerDisplay');
            if (el) {
                const mins = Math.floor(state.timeLeft / 60);
                const secs = state.timeLeft % 60;
                el.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        function handleEliminate(playerIdx) {
            stopTimer(); // Stop timer if eliminating
            const player = state.game.players[playerIdx];
            state.game.eliminatedPlayer = player;
            
            if (player.role === 'Mr. White') {
                setScreen('mrwhite');
            } else {
                finalizeElimination(player, false);
            }
        }

        function finalizeElimination(player, mrWhiteGuessedCorrectly) {
            const pIndex = state.game.players.findIndex(p => p.id === player.id);
            state.game.players[pIndex].isAlive = false;

            const alive = state.game.players.filter(p => p.isAlive);
            const badGuys = alive.filter(p => p.role === 'Undercover' || p.role === 'Mr. White');
            
            if (mrWhiteGuessedCorrectly) {
                state.game.winner = "Mr. White Wins!";
                setScreen('gameover');
                return;
            }

            if (badGuys.length === 0) {
                state.game.winner = "Civilians Win!";
                setScreen('gameover');
                return;
            }

            if (alive.length <= 2 && badGuys.length > 0) {
                state.game.winner = "Spies / Mr. White Win!";
                setScreen('gameover');
                return;
            }

            setScreen('discussion');
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 
            
            const wrapper = document.createElement('div');
            const isTransition = state.screen !== state.lastScreen;
            wrapper.className = `w-full ${isTransition ? 'animate-slide-up' : ''} flex flex-col items-center`;
            
            if (state.screen === 'instructions') wrapper.innerHTML = getInstructionsHTML();
            else if (state.screen === 'setup') wrapper.innerHTML = getSetupHTML();
            else if (state.screen === 'pass') wrapper.innerHTML = getPassHTML();
            else if (state.screen === 'reveal') wrapper.innerHTML = getRevealHTML();
            else if (state.screen === 'discussion') wrapper.innerHTML = getDiscussionHTML();
            else if (state.screen === 'mrwhite') wrapper.innerHTML = getMrWhiteHTML();
            else if (state.screen === 'gameover') wrapper.innerHTML = getGameOverHTML();

            app.appendChild(wrapper);
            lucide.createIcons(); 
            
            if (state.screen === 'setup') {
                document.getElementById('playerNameInput')?.focus();
            }
            if (state.screen === 'discussion' && isTransition) {
                // Optional: Auto start timer? Better to let teacher start it.
            }
            
            state.lastScreen = state.screen;
        }

        /* --- HTML Generators --- */

        function getInstructionsHTML() {
            return `
                <div class="text-center mb-10">
                    <h1 class="font-fredoka text-6xl font-black text-e1dark mb-2 tracking-tight">How to Play?</h1>
                    <p class="text-slate-500 font-bold text-xl uppercase tracking-widest">Undercover Edition</p>
                </div>
                <div class="bg-white border-4 border-e1dark rounded-3xl shadow-hard p-8 mb-10 w-full">
                    <h2 class="font-fredoka text-3xl font-bold mb-6 flex items-center gap-3">
                        <i data-lucide="users" class="text-e1blue w-8 h-8"></i> The Roles
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-5 bg-blue-50 border-3 border-e1dark rounded-2xl">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="user-check" class="text-e1blue w-5 h-5"></i>
                                <h4 class="font-fredoka text-xl font-bold text-e1blue uppercase">Civilian</h4>
                            </div>
                            <p class="text-sm font-bold text-slate-600 leading-tight">Most players. You have the <span class="text-e1dark underline decoration-2">true secret word</span>.</p>
                        </div>
                        <div class="p-5 bg-pink-50 border-3 border-e1dark rounded-2xl">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="eye-off" class="text-e1pink w-5 h-5"></i>
                                <h4 class="font-fredoka text-xl font-bold text-e1pink uppercase">Undercover</h4>
                            </div>
                            <p class="text-sm font-bold text-slate-600 leading-tight">You have a word that is <span class="text-e1dark underline decoration-2">almost same</span> as Civilians. Blend in!</p>
                        </div>
                        <div class="p-5 bg-orange-50 border-3 border-e1dark rounded-2xl">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="ghost" class="text-e1orange w-5 h-5"></i>
                                <h4 class="font-fredoka text-xl font-bold text-e1orange uppercase">Mr. White</h4>
                            </div>
                            <p class="text-sm font-bold text-slate-600 leading-tight">You have <span class="text-e1dark underline decoration-2">NO word</span>. Guess the topic!</p>
                        </div>
                    </div>
                </div>
                <button onclick="setScreen('setup')" class="w-full bg-e1green text-white font-fredoka font-bold text-3xl py-6 rounded-2xl border-4 border-e1dark shadow-hard-lg btn-press flex justify-center items-center gap-4">
                    Got it, Let's Setup! <i data-lucide="arrow-right" class="w-8 h-8"></i>
                </button>
            `;
        }

        function getSetupHTML() {
            const namesList = state.config.playerNames.map((name, i) => `
                <div class="flex items-center justify-between bg-white border-3 border-e1dark rounded-xl px-4 py-2 shadow-hard-sm animate-pop-in">
                    <span class="font-bold text-e1dark">${name}</span>
                    <button onclick="removeName(${i})" class="bg-e1pink text-white p-1 rounded-lg border-2 border-e1dark hover:bg-red-500 transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');

            return `
                <div class="text-center mb-8">
                    <h1 class="font-fredoka text-5xl font-black text-e1dark mb-2">Class Setup</h1>
                    <p class="text-slate-500 font-bold">Add students and choose words</p>
                </div>
                
                <div class="bg-white w-full border-4 border-e1dark rounded-3xl shadow-hard p-8 relative mb-8">
                    <div class="mb-10">
                        <label class="font-fredoka text-2xl font-bold mb-4 flex items-center gap-3 text-e1blue">
                            <i data-lucide="user-plus" class="w-8 h-8"></i> Add Students
                        </label>
                        <div class="flex gap-4 mb-6">
                            <input type="text" id="playerNameInput" placeholder="Name..." 
                                onkeydown="if(event.key==='Enter') addName()"
                                class="flex-grow bg-e1chalk border-4 border-e1dark rounded-2xl px-6 py-4 font-black text-xl focus:outline-none focus:ring-4 focus:ring-e1blue/20 transition-all placeholder:text-slate-300">
                            <button onclick="addName()" class="bg-e1blue text-white px-8 rounded-2xl border-4 border-e1dark shadow-hard-sm btn-press font-fredoka font-bold text-xl">ADD</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-40 overflow-y-auto p-4 bg-slate-50 rounded-2xl border-3 border-dashed border-slate-300">
                            ${namesList || '<p class="col-span-2 text-center py-6 text-slate-400 font-bold italic">No students joined yet...</p>'}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-4 bg-pink-50 rounded-2xl border-4 border-e1dark shadow-hard-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="font-fredoka font-bold flex items-center gap-2"><i data-lucide="user-x" class="w-4 h-4"></i> Spies</label>
                                    <span class="bg-e1pink text-white px-3 py-1 rounded-lg border-2 border-e1dark font-black">${state.config.spies}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="adjustConfig('spies', -1)" class="flex-1 bg-white border-2 border-e1dark rounded-lg py-1 font-black hover:bg-slate-50">-</button>
                                    <button onclick="adjustConfig('spies', 1)" class="flex-1 bg-white border-2 border-e1dark rounded-lg py-1 font-black hover:bg-slate-50">+</button>
                                </div>
                            </div>
                            <div class="p-4 bg-orange-50 rounded-2xl border-4 border-e1dark shadow-hard-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="font-fredoka font-bold flex items-center gap-2"><i data-lucide="ghost" class="w-4 h-4"></i> Mr. White</label>
                                    <span class="bg-e1orange text-white px-3 py-1 rounded-lg border-2 border-e1dark font-black">${state.config.mrWhite}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="adjustConfig('mrWhite', -1)" class="flex-1 bg-white border-2 border-e1dark rounded-lg py-1 font-black hover:bg-slate-50">-</button>
                                    <button onclick="adjustConfig('mrWhite', 1)" class="flex-1 bg-white border-2 border-e1dark rounded-lg py-1 font-black hover:bg-slate-50">+</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-5 bg-e1chalk rounded-2xl border-4 border-e1dark shadow-hard-sm flex flex-col justify-center">
                            <label class="font-fredoka text-xl font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="book-open" class="text-e1green"></i> Word Source
                            </label>
                            
                            <div class="flex bg-white rounded-xl border-3 border-e1dark p-1 mb-4">
                                <button onclick="setWordMode(false)" class="flex-1 py-2 rounded-lg font-bold transition-all ${!state.config.useCustomWords ? 'bg-e1green text-white shadow-sm' : 'text-slate-400'}">Random</button>
                                <button onclick="setWordMode(true)" class="flex-1 py-2 rounded-lg font-bold transition-all ${state.config.useCustomWords ? 'bg-e1blue text-white shadow-sm' : 'text-slate-400'}">Custom</button>
                            </div>

                            ${state.config.useCustomWords ? `
                                <div class="flex flex-col gap-2 animate-pop-in">
                                    <input type="text" id="customWord1" placeholder="Civilian Word (e.g. Tea)" onchange="state.config.customWord1 = this.value" value="${state.config.customWord1}" class="w-full border-3 border-e1dark rounded-xl px-3 py-2 font-bold focus:outline-none focus:border-e1blue">
                                    <input type="text" id="customWord2" placeholder="Spy Word (e.g. Coffee)" onchange="state.config.customWord2 = this.value" value="${state.config.customWord2}" class="w-full border-3 border-e1dark rounded-xl px-3 py-2 font-bold focus:outline-none focus:border-e1pink">
                                </div>
                            ` : `
                                <div class="text-center py-4 opacity-50 font-bold text-slate-500 animate-pop-in">
                                    Words will be chosen randomly from category list.
                                </div>
                            `}
                        </div>
                    </div>

                    <button onclick="startGame()" ${state.config.playerNames.length < 3 ? 'disabled opacity-50 cursor-not-allowed' : ''} 
                        class="w-full mt-8 bg-e1green text-white font-fredoka font-bold text-3xl py-6 rounded-2xl border-4 border-e1dark shadow-hard btn-press flex justify-center items-center gap-4 transition-all">
                        ${state.config.playerNames.length < 3 ? 'Need 3+ Players' : 'START LESSON!'}
                        <i data-lucide="sparkles" class="w-8 h-8"></i>
                    </button>
                </div>
            `;
        }

        function getPassHTML() {
            const player = state.game.players[state.game.currentTurnIndex];
            const colors = ['bg-e1blue', 'bg-e1pink', 'bg-e1orange', 'bg-e1green'];
            const color = colors[state.game.currentTurnIndex % colors.length];

            return `
                <div class="flex flex-col items-center justify-center min-h-[50vh] gap-8 w-full">
                    <div class="bg-white border-4 border-e1dark rounded-3xl shadow-hard-lg p-12 text-center max-w-md w-full relative">
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-e1dark text-white px-6 py-2 rounded-full font-bold text-sm border-4 border-white">
                            Turn ${state.game.currentTurnIndex + 1} / ${state.game.players.length}
                        </div>
                        
                        <div class="w-32 h-32 ${color} border-4 border-e1dark rounded-full flex items-center justify-center mx-auto mb-8 shadow-hard animate-bounce-slight">
                            <i data-lucide="user" class="text-white w-16 h-16"></i>
                        </div>
                        
                        <h2 class="font-fredoka text-3xl font-bold mb-2 text-slate-400">Pass to...</h2>
                        <h2 class="font-fredoka text-6xl font-black mb-10 text-e1blue tracking-tight">${player.name}</h2>
                        
                        <div class="bg-slate-100 border-4 border-dashed border-slate-300 rounded-3xl p-6 mb-10">
                             <p class="text-slate-500 font-black text-xl flex items-center justify-center gap-3">
                                <i data-lucide="lock" class="w-6 h-6 text-e1green"></i> Privacy First!
                             </p>
                        </div>
                        
                        <button onclick="setScreen('reveal')" class="w-full bg-e1dark text-white font-fredoka font-bold text-2xl py-6 rounded-2xl border-4 border-e1dark shadow-hard btn-press flex justify-center items-center gap-4">
                            <i data-lucide="eye" class="w-8 h-8"></i> REVEAL WORD
                        </button>
                    </div>
                </div>
            `;
        }

        function getRevealHTML() {
            const player = state.game.players[state.game.currentTurnIndex];
            const isWhite = player.role === 'Mr. White';
            const isSpy = player.role === 'Undercover';
            
            let cardBg = 'bg-blue-50', borderColor = 'border-e1blue', icon = 'user-check', roleColor = 'text-e1blue';

            if (isSpy) { cardBg = 'bg-pink-50'; borderColor = 'border-e1pink'; icon = 'eye-off'; roleColor = 'text-e1pink'; }
            else if (isWhite) { cardBg = 'bg-orange-50'; borderColor = 'border-e1orange'; icon = 'ghost'; roleColor = 'text-e1orange'; }

            let content = '';
            if (isWhite) {
                content = `
                    <div class="flex flex-col items-center gap-6 mb-10">
                        <div class="w-32 h-32 bg-white rounded-3xl border-4 border-e1orange flex items-center justify-center shadow-hard-sm mb-4 transform -rotate-3">
                            <i data-lucide="ghost" class="w-16 h-16 text-e1orange"></i>
                        </div>
                        <h1 class="font-fredoka text-5xl font-black text-e1dark leading-none">You are<br><span class="text-e1orange">Mr. White</span></h1>
                        <p class="text-lg font-black text-slate-600 bg-white p-6 rounded-2xl border-3 border-dashed border-e1orange shadow-sm">You have NO WORD! Blend in and guess the civilian word to win.</p>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex flex-col items-center gap-6 mb-10">
                        <p class="font-fredoka text-xl font-black text-slate-400 uppercase tracking-widest">Secret Word</p>
                        <div class="bg-white border-6 ${borderColor} rounded-3xl px-12 py-10 shadow-hard-lg transform -rotate-2 mb-4">
                            <h1 class="font-fredoka text-6xl font-black text-e1dark tracking-tight">
                                ${player.word}
                            </h1>
                        </div>
                        <div class="flex items-center gap-3 px-6 py-3 bg-white border-3 ${borderColor} rounded-full shadow-hard-sm">
                            <i data-lucide="${icon}" class="${roleColor} w-6 h-6"></i>
                            <span class="font-black text-xl ${roleColor}">THE ${player.role.toUpperCase()}</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col items-center justify-center min-h-[50vh] gap-8 w-full animate-pop-in">
                    <div class="${cardBg} border-4 border-e1dark rounded-3xl shadow-hard-lg p-12 text-center max-w-lg w-full relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 opacity-5"><i data-lucide="${icon}" class="w-64 h-64"></i></div>
                        <h3 class="font-fredoka text-2xl text-e1dark mb-10 opacity-30 font-black uppercase tracking-widest">${player.name}'s Identity</h3>
                        ${content}
                        <button onclick="nextTurn()" class="relative z-10 w-full bg-e1dark text-white font-fredoka font-bold text-2xl py-6 rounded-2xl border-4 border-slate-400 shadow-hard btn-press">
                            GOT IT!
                        </button>
                    </div>
                </div>
            `;
        }

        function getDiscussionHTML() {
            let playersGrid = state.game.players.map((p, idx) => {
                const isDead = !p.isAlive;
                const colors = ['bg-e1blue', 'bg-e1pink', 'bg-e1orange', 'bg-e1green', 'bg-purple-500', 'bg-yellow-400'];
                const color = colors[idx % colors.length];
                
                return `
                <div class="relative bg-white border-4 border-e1dark rounded-2xl p-4 flex flex-col items-center text-center transition-all ${isDead ? 'opacity-40 grayscale bg-slate-100 scale-95' : 'card-hover'}">
                    ${isDead ? `<div class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none rotate-12"><div class="border-4 border-e1dark text-white bg-e1pink font-black text-sm px-4 py-2 shadow-hard-sm">OUT!</div></div>` : ''}
                    <div class="w-16 h-16 rounded-2xl border-3 border-e1dark mb-3 flex items-center justify-center text-3xl font-black text-white ${color} shadow-hard-sm">${p.name.charAt(0)}</div>
                    <h3 class="font-black text-e1dark text-lg truncate w-full font-fredoka tracking-tight mb-4">${p.name}</h3>
                    ${!isDead ? `<button onclick="handleEliminate(${idx})" class="mt-auto w-full bg-white text-e1dark text-xs font-black py-2 rounded-xl border-3 border-e1dark shadow-hard-sm hover:bg-e1orange hover:text-white transition-all">ELIMINATE</button>` : `<div class="h-8"></div>`}
                </div>
            `}).join('');

            return `
                <div class="w-full">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-e1orange text-white p-3 rounded-2xl border-4 border-e1dark shadow-hard transform rotate-6">
                                <i data-lucide="message-circle" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="font-fredoka text-5xl font-black text-e1dark tracking-tight">The Debate</h2>
                                <p class="font-bold text-slate-400 uppercase tracking-widest text-sm">Find the Spy!</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 bg-white border-3 border-e1dark rounded-2xl p-2 shadow-hard-sm">
                             <div id="timerDisplay" class="font-fredoka font-black text-3xl w-24 text-center text-e1dark">0:00</div>
                             <div class="flex gap-1">
                                <button onclick="startTimer(60)" class="bg-e1blue text-white p-2 rounded-lg border-2 border-e1dark font-bold text-xs hover:bg-e1blue/90">1m</button>
                                <button onclick="startTimer(180)" class="bg-e1blue text-white p-2 rounded-lg border-2 border-e1dark font-bold text-xs hover:bg-e1blue/90">3m</button>
                                <button onclick="stopTimer()" class="bg-red-400 text-white p-2 rounded-lg border-2 border-e1dark hover:bg-red-500"><i data-lucide="square" class="w-4 h-4"></i></button>
                             </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-12">${playersGrid}</div>

                    <div class="bg-e1chalk border-4 border-e1dark rounded-3xl p-8 shadow-hard relative overflow-hidden">
                        <div class="absolute -top-6 -right-6 opacity-10 rotate-12"><i data-lucide="lightbulb" class="w-32 h-32 text-e1blue"></i></div>
                        <h3 class="font-fredoka text-2xl font-bold mb-4 flex items-center gap-3 text-e1blue underline decoration-4">
                            <i data-lucide="mic-2"></i> Teacher's Guide
                        </h3>
                        <p class="font-bold text-lg text-slate-600 leading-relaxed italic text-center">Encourage students to use English to describe their word. Remember: Spies and Mr. White will try to echo the Civilians to survive!</p>
                        <div class="mt-4 flex justify-center">
                            <button onclick="initGame()" class="bg-white text-e1dark px-6 py-2 rounded-xl border-3 border-e1dark shadow-hard-sm font-black text-xs hover:bg-slate-50">RESTART GAME</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMrWhiteHTML() {
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-e1dark/95 p-6 backdrop-blur-xl animate-pop-in">
                    <div class="bg-white border-4 border-e1dark rounded-3xl shadow-hard-lg p-10 max-w-md w-full text-center relative">
                        <div class="absolute -top-16 left-1/2 transform -translate-x-1/2">
                            <div class="bg-e1orange text-white p-6 rounded-full border-4 border-e1dark shadow-hard transform rotate-12">
                                <i data-lucide="ghost" class="w-12 h-12"></i>
                            </div>
                        </div>
                        <h2 class="font-fredoka text-4xl font-black mt-8 mb-4 text-e1dark">${state.game.eliminatedPlayer.name} caught!</h2>
                        <p class="text-xl font-black text-e1orange mb-8 leading-tight italic uppercase tracking-wider text-center">Can they guess the word to steal the win?</p>
                        <div class="p-8 bg-e1blue/5 border-4 border-dashed border-e1blue rounded-3xl mb-10 shadow-inner-hard">
                            <p class="text-xs font-black text-e1blue uppercase mb-2 tracking-widest opacity-50">Civilian Word Was</p>
                            <p class="text-5xl font-black text-e1blue tracking-tighter">${state.game.civWord}</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button onclick="finalizeElimination(state.game.eliminatedPlayer, true)" class="bg-e1green text-white font-fredoka font-bold py-6 rounded-2xl border-4 border-e1dark shadow-hard btn-press text-xl">THEY WON</button>
                            <button onclick="finalizeElimination(state.game.eliminatedPlayer, false)" class="bg-e1pink text-white font-fredoka font-bold py-6 rounded-2xl border-4 border-e1dark shadow-hard btn-press text-xl">FAILED</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getGameOverHTML() {
            const playerReveal = state.game.players.map(p => {
                let colorClass = p.role === 'Civilian' ? 'text-e1blue' : (p.role === 'Undercover' ? 'text-e1pink' : 'text-e1orange');
                return `<div class="p-4 bg-white rounded-2xl border-3 border-e1dark shadow-hard-sm flex flex-col items-center"><span class="font-black text-sm truncate w-full text-e1dark">${p.name}</span><span class="text-[10px] font-black uppercase tracking-widest ${colorClass}">${p.role}</span></div>`;
            }).join('');

            return `
                <div class="flex flex-col items-center justify-center gap-10 w-full max-w-2xl mx-auto animate-pop-in">
                    <div class="bg-white w-full text-center border-4 border-e1dark rounded-3xl shadow-hard p-12 overflow-hidden relative">
                        <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-e1pink via-e1orange to-e1blue"></div>
                        <div class="flex justify-center mb-6">
                            <i data-lucide="crown" class="w-24 h-24 text-yellow-400 fill-yellow-400 drop-shadow-md animate-bounce-slight"></i>
                        </div>
                        <h1 class="font-fredoka text-6xl font-black mb-10 text-e1dark tracking-tighter">${state.game.winner}</h1>
                        <div class="grid grid-cols-2 gap-6 mb-12 text-left">
                            <div class="bg-blue-50 p-6 rounded-2xl border-4 border-e1dark shadow-hard-sm"><span class="block text-xs font-black text-e1blue uppercase mb-2 tracking-widest">Civilians</span><span class="text-3xl font-black text-e1dark">${state.game.civWord}</span></div>
                            <div class="bg-pink-50 p-6 rounded-2xl border-4 border-e1dark shadow-hard-sm"><span class="block text-xs font-black text-e1pink uppercase mb-2 tracking-widest">Undercover</span><span class="text-3xl font-black text-e1dark">${state.game.spyWord}</span></div>
                        </div>
                        <div class="bg-slate-50 rounded-3xl border-4 border-e1dark p-8 mb-12">
                            <h3 class="font-fredoka text-xl font-bold mb-6 text-slate-400 uppercase tracking-widest text-center">Class Stats</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">${playerReveal}</div>
                        </div>
                        <button onclick="initGame()" class="w-full bg-e1blue text-white font-fredoka font-bold text-4xl py-8 rounded-2xl border-4 border-e1dark shadow-hard-lg btn-press">PLAY AGAIN!</button>
                    </div>
                </div>
            `;
        }

        /* --- Logic --- */

        function addName() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            if (name && !state.config.playerNames.includes(name)) {
                state.config.playerNames.push(name);
                input.value = '';
                updateSpiesLogic();
                render();
            }
        }

        function removeName(index) {
            state.config.playerNames.splice(index, 1);
            updateSpiesLogic();
            render();
        }

        function setWordMode(isCustom) {
            state.config.useCustomWords = isCustom;
            render();
        }

        function updateSpiesLogic() {
            const total = state.config.playerNames.length;
            if (state.config.spies > total - 2) {
                state.config.spies = Math.max(1, total - 2);
            }
        }

        function adjustConfig(key, delta) {
            let newVal = state.config[key] + delta;
            let total = state.config.playerNames.length;
            if (key === 'spies') {
                if (newVal < 1) newVal = 1;
                if (newVal > total - 2) newVal = Math.max(1, total - 2);
            }
            if (key === 'mrWhite') {
                if (newVal < 0) newVal = 0;
                if (newVal > 1) newVal = 1; 
            }
            state.config[key] = newVal;
            render();
        }

        function nextTurn() {
            if (state.game.currentTurnIndex + 1 < state.game.players.length) {
                state.game.currentTurnIndex++;
                setScreen('pass');
            } else {
                setScreen('discussion');
            }
        }

        initGame();
    </script>
</body>
</html>