<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystery Picture: Classroom Edition</title>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#0f172a',
                        panel: '#1e293b',
                        surface: '#334155'
                    },
                    fontFamily: {
                        heading: ['Bebas Neue', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Nunito', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(0, 230, 118, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(41, 121, 255, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: white;
            overflow-x: hidden;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn-3d {
            transition: all 0.1s;
            transform: translateY(0);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            border-bottom: 4px solid rgba(0,0,0,0.2);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
            border-bottom: 0px solid transparent;
        }

        /* Tile Styles & Animation Fix */
        @keyframes fadeOutAnimation {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }

        .tile {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            z-index: 20; /* Ensure tiles are above image */
        }
        .tile:hover {
            filter: brightness(1.2);
            z-index: 30;
        }
        .tile.revealed {
            pointer-events: none;
            animation: fadeOutAnimation 0.5s forwards;
        }

        /* Responsive Grid Container */
        #game-container {
            aspect-ratio: 16/9;
            max-height: 70vh;
        }

        input[type="range"] {
            accent-color: #2979FF;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="w-full glass-panel border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-green to-blue w-10 h-10 rounded-lg flex items-center justify-center text-xl shadow-lg">
                    üñºÔ∏è
                </div>
                <div>
                    <h1 class="text-2xl font-heading tracking-wider text-white leading-none">MYSTERY PICTURE</h1>
                    <div class="text-[10px] font-mono text-gray-400 tracking-widest">ENGLISH 1 BATAM</div>
                </div>
            </div>

            <!-- Round Indicator -->
            <div id="round-indicator" class="hidden md:flex items-center gap-2 bg-surface/50 px-3 py-1 rounded-full border border-white/10">
                <span class="text-xs text-gray-400 uppercase font-bold">Round</span>
                <span id="round-display" class="font-mono text-blue font-bold">1 / 1</span>
            </div>

            <div class="flex items-center gap-3">
                <button id="sound-toggle" class="p-2 rounded-full hover:bg-white/10 transition-colors text-gray-400" title="Toggle Sound">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                <button id="setup-trigger" class="btn-3d bg-blue text-white px-4 py-2 rounded-lg font-bold text-sm tracking-wide">
                    SETUP
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 w-full max-w-7xl mx-auto">
        
        <!-- Game Stats/Controls -->
        <div id="game-controls" class="w-full max-w-5xl flex justify-between items-center mb-4 hidden animate-pop">
            <div class="flex items-center gap-4">
                <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="text-xs text-gray-400 font-bold uppercase">Hidden</span>
                    <span id="tiles-count" class="text-blue font-bold font-mono">0</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="reset-tiles-btn" class="px-4 py-2 rounded-lg hover:bg-white/10 text-white text-sm font-bold border border-white/10 transition flex items-center gap-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset
                </button>
                
                <!-- Next Round Button (Initially Hidden or Disabled) -->
                <button id="next-round-btn" class="hidden btn-3d bg-gradient-to-r from-green to-blue text-white px-4 py-2 rounded-lg font-bold text-sm tracking-wide shadow-lg flex items-center gap-2">
                    NEXT IMAGE <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

                <button id="reveal-all-btn" class="btn-3d bg-gradient-to-r from-pink to-orange text-white px-6 py-2 rounded-lg font-bold text-sm tracking-wide shadow-lg">
                    REVEAL ALL
                </button>
            </div>
        </div>

        <!-- The Game Board -->
        <div id="game-area-wrapper" class="w-full max-w-5xl relative hidden animate-pop">
            <div id="game-container" class="w-full relative rounded-2xl overflow-hidden shadow-2xl bg-dark border-4 border-white/10">
                <!-- The Image (Bottom Layer) -->
                <img id="target-image" class="absolute inset-0 w-full h-full object-contain z-0 pointer-events-none bg-black" src="" alt="Hidden Picture">
                
                <!-- The Grid (Top Layer) -->
                <div id="tile-grid" class="absolute inset-0 z-10 grid w-full h-full">
                    <!-- Tiles generated here -->
                </div>
            </div>
        </div>

        <!-- Empty State / Start Prompt -->
        <div id="empty-state" class="text-center py-20 animate-pop">
            <div class="text-6xl mb-4">üé®</div>
            <h2 class="text-3xl font-heading text-white mb-2">No Image Loaded</h2>
            <p class="text-gray-400 mb-8">Click "SETUP" to upload pictures for the class.</p>
            <button onclick="document.getElementById('setup-trigger').click()" class="btn-3d bg-gradient-to-r from-green to-blue text-white px-8 py-4 rounded-xl font-bold text-xl shadow-lg">
                SETUP GAME
            </button>
        </div>

    </main>

    <!-- SETUP MODAL -->
    <div id="setup-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-pop">
        <div class="glass-panel w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-black/20">
                <h2 class="text-2xl font-heading text-white tracking-wide">SETUP PICTURES</h2>
                <button id="close-setup" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6 space-y-6">
                
                <!-- Image Upload (Supports Multiple) -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-blue uppercase tracking-widest">1. Choose Images (Multiple)</label>
                    <div class="relative w-full h-32 border-2 border-dashed border-white/20 rounded-xl hover:border-blue/50 transition bg-surface/30 flex flex-col items-center justify-center cursor-pointer group" id="drop-zone">
                        <input type="file" id="file-input" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <i data-lucide="images" class="w-8 h-8 text-gray-400 group-hover:text-white mb-2 transition"></i>
                        <span class="text-sm text-gray-400 group-hover:text-white transition font-bold" id="file-label">Click to select images</span>
                    </div>
                    <div id="file-count-msg" class="text-xs text-green font-bold hidden text-center"></div>
                </div>

                <!-- Grid Settings -->
                <div class="space-y-4">
                    <label class="text-xs font-bold text-orange uppercase tracking-widest">2. Grid Size</label>
                    
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-300 text-sm">Rows & Columns</span>
                        <span id="grid-val" class="font-mono text-orange font-bold text-lg">4 x 4</span>
                    </div>
                    <input type="range" id="grid-slider" min="2" max="8" value="4" class="w-full h-2 bg-surface rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-gray-500 font-mono mt-1">
                        <span>2x2 (Easy)</span>
                        <span>8x8 (Hard)</span>
                    </div>
                </div>

            </div>

            <div class="p-6 border-t border-white/10 bg-black/20">
                <button id="start-game-btn" class="w-full btn-3d bg-green text-dark px-8 py-3 rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    START GAME
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        let audioEnabled = true;
        const AudioEngine = {
            init: async () => { await Tone.start(); },
            playPop: (pitch = "C4") => {
                if(!audioEnabled) return;
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.4, attackCurve: "exponential" }
                }).toDestination();
                synth.triggerAttackRelease(pitch, "8n");
            },
            playWin: () => {
                if(!audioEnabled) return;
                const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
                synth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n", now + 0.25);
            }
        };

        // --- STATE ---
        let imagesList = [];
        let currentImageIndex = 0;
        let gridSize = 4;
        let tilesRemaining = 0;

        // --- DOM ELEMENTS ---
        const setupModal = document.getElementById('setup-modal');
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.getElementById('file-label');
        const fileCountMsg = document.getElementById('file-count-msg');
        const gridSlider = document.getElementById('grid-slider');
        const gridVal = document.getElementById('grid-val');
        const startBtn = document.getElementById('start-game-btn');
        const gameArea = document.getElementById('game-area-wrapper');
        const gameControls = document.getElementById('game-controls');
        const emptyState = document.getElementById('empty-state');
        const targetImage = document.getElementById('target-image');
        const tileGrid = document.getElementById('tile-grid');
        const tilesCountDisplay = document.getElementById('tiles-count');
        const roundIndicator = document.getElementById('round-indicator');
        const roundDisplay = document.getElementById('round-display');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const revealAllBtn = document.getElementById('reveal-all-btn');

        // --- FUNCTIONS ---

        function initIcons() {
            lucide.createIcons();
        }

        function updateGridVal() {
            const val = gridSlider.value;
            gridSize = parseInt(val);
            gridVal.textContent = `${val} x ${val}`;
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                imagesList = []; // Reset list
                let loadedCount = 0;

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagesList.push(e.target.result);
                        loadedCount++;
                        
                        // Update UI
                        fileLabel.textContent = "Images Selected!";
                        fileCountMsg.textContent = `${loadedCount} images loaded ready for rounds.`;
                        fileCountMsg.classList.remove('hidden');
                        startBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function startGame() {
            if (imagesList.length === 0) return;

            // Reset to first round if starting fresh
            currentImageIndex = 0;

            // Hide setup, show game
            setupModal.classList.add('hidden');
            emptyState.classList.add('hidden');
            gameArea.classList.remove('hidden');
            gameControls.classList.remove('hidden');
            roundIndicator.classList.remove('hidden');

            loadRound();
        }

        function loadRound() {
            // Check bounds
            if (currentImageIndex >= imagesList.length) currentImageIndex = 0;

            // Set Image
            targetImage.src = imagesList[currentImageIndex];
            
            // Update Round Display
            roundDisplay.textContent = `${currentImageIndex + 1} / ${imagesList.length}`;

            // Reset Next Button
            nextRoundBtn.classList.add('hidden');
            revealAllBtn.classList.remove('hidden');

            resetTiles();
        }

        function resetTiles() {
            tileGrid.innerHTML = '';
            
            // Set Grid Layout
            tileGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            tileGrid.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

            const totalTiles = gridSize * gridSize;
            tilesRemaining = totalTiles;
            updateStats();

            // Create Tiles
            for (let i = 0; i < totalTiles; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile bg-panel border border-white/5 flex items-center justify-center';
                
                // Styling
                const number = i + 1;
                tile.innerHTML = `<span class="text-2xl font-heading text-white/50 pointer-events-none select-none">${number}</span>`;
                
                // Colors (Checkerboard pattern subtle)
                const isEven = i % 2 === 0;
                tile.style.backgroundColor = isEven ? '#1e293b' : '#334155'; // panel vs surface

                tile.addEventListener('click', () => revealTile(tile));
                tileGrid.appendChild(tile);
            }
        }

        function revealTile(tile) {
            if (tile.classList.contains('revealed')) return;

            // Audio init on first interaction
            if (Tone.context.state !== 'running') Tone.start();

            tile.classList.add('revealed');
            tilesRemaining--;
            updateStats();

            // Play Sound
            AudioEngine.playPop();

            if (tilesRemaining === 0) {
                celebrate();
            }
        }

        function revealAll() {
            const allTiles = document.querySelectorAll('.tile:not(.revealed)');
            let delay = 0;
            
            if (Tone.context.state !== 'running') Tone.start();

            if (allTiles.length === 0) return;

            allTiles.forEach((tile, index) => {
                setTimeout(() => {
                    if (!tile.classList.contains('revealed')) {
                        tile.classList.add('revealed');
                        AudioEngine.playPop();
                    }
                }, delay);
                delay += 50; // Stagger effect
            });

            setTimeout(() => {
                tilesRemaining = 0;
                updateStats();
                celebrate();
            }, delay + 200);
        }

        function updateStats() {
            tilesCountDisplay.innerText = tilesRemaining;
        }

        function celebrate() {
            AudioEngine.playWin();
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#FF6B95', '#FF8C42', '#00E676', '#2979FF']
            });

            // Show Next Round Button if more images exist, or loop
            if (imagesList.length > 1) {
                nextRoundBtn.classList.remove('hidden');
                revealAllBtn.classList.add('hidden'); // Hide reveal btn to clean up UI
            }
        }

        function nextRound() {
            currentImageIndex++;
            if(currentImageIndex >= imagesList.length) {
                // Loop back or finish? Let's loop for endless play
                currentImageIndex = 0;
            }
            loadRound();
        }

        // --- EVENT LISTENERS ---

        document.getElementById('setup-trigger').addEventListener('click', () => {
            setupModal.classList.remove('hidden');
        });

        document.getElementById('close-setup').addEventListener('click', () => {
            setupModal.classList.add('hidden');
        });

        fileInput.addEventListener('change', handleFileSelect);
        gridSlider.addEventListener('input', updateGridVal);
        startBtn.addEventListener('click', startGame);
        
        revealAllBtn.addEventListener('click', revealAll);
        nextRoundBtn.addEventListener('click', nextRound);
        
        document.getElementById('reset-tiles-btn').addEventListener('click', resetTiles);

        document.getElementById('sound-toggle').addEventListener('click', (e) => {
            audioEnabled = !audioEnabled;
            const icon = audioEnabled ? 'volume-2' : 'volume-x';
            e.currentTarget.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
            initIcons();
        });

        // Init
        initIcons();
        // Trigger setup initially if no image
        document.getElementById('setup-trigger').click();

    </script>
</body>
</html>
