<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mystery Box: English 1 Batam</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Brand Palette
                        pink: '#FF6B95',   // Playful
                        orange: '#FF8C42', // Energy
                        green: '#00E676',  // Success
                        blue: '#2979FF',   // Logic
                        
                        // UI Neutrals
                        dark: '#1e293b',   // Borders/Text
                        chalk: '#f8fafc',  // Backgrounds
                        surface: '#FFFFFF',
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'], 
                        body: ['Nunito', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    // Neo-Brutalism Shadows
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #1e293b',
                        'hard-sm': '2px 2px 0px 0px #1e293b',
                        'hard-lg': '8px 8px 0px 0px #1e293b',
                        'hard-xl': '12px 12px 0px 0px #1e293b',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            background-color: #f8fafc; /* Chalk */
            background-image: 
                linear-gradient(#e2e8f0 1.5px, transparent 1.5px),
                linear-gradient(90deg, #e2e8f0 1.5px, transparent 1.5px);
            background-size: 30px 30px;
            color: #1e293b;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI COMPONENTS --- */
        .console-frame {
            background: #FFFFFF;
            border: 4px solid #1e293b; /* Thick Border */
            border-radius: 1.5rem;
            box-shadow: 12px 12px 0px rgba(30, 41, 59, 0.15);
            display: flex;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Chunky Button Style */
        .btn-chunky {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            position: relative;
            border: 3px solid #1e293b;
            box-shadow: 4px 4px 0 #1e293b;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-chunky:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1e293b;
            filter: brightness(105%);
        }

        .btn-chunky:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #1e293b !important;
        }

        .btn-chunky:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(2px);
            box-shadow: 0 0 0 #1e293b;
            filter: grayscale(100%);
        }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #1e293b; border: 4px solid #FF8C42; margin-top: -8px; cursor: pointer;
            box-shadow: 2px 2px 0px rgba(30,41,59,1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; background: #e2e8f0; border: 2px solid #1e293b; border-radius: 99px;
        }

        /* --- GAME BOARD --- */
        .retro-window {
            border: 4px solid #1e293b;
            border-radius: 1rem;
            box-shadow: 8px 8px 0px #1e293b;
            overflow: hidden;
            background: #000;
            display: flex;
            flex-direction: column;
            width: 100%;
            aspect-ratio: 16/9;
        }

        .window-header {
            height: 40px;
            background: #FFFFFF;
            border-bottom: 4px solid #1e293b;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
        }
        
        .window-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #1e293b; }

        .game-viewport {
            flex: 1;
            position: relative;
            background: #f8fafc;
            overflow: hidden;
        }

        /* --- TILES --- */
        .tile {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 20;
            background-color: #FFFFFF;
            border: 2px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Prevents gaps on some screens */
            margin: -1px; 
        }
        
        .tile::after {
            content: '';
            position: absolute;
            inset: 4px;
            border: 2px dashed #cbd5e1;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .tile:hover {
            background-color: #F0F9FF;
            z-index: 30;
            border-color: #2979FF;
            box-shadow: inset 0 0 20px rgba(41, 121, 255, 0.1);
        }
        .tile:hover::after { border-color: #93C5FD; }

        /* Animation: Pop Out */
        .tile.revealed {
            animation: popOut 0.4s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        @keyframes popOut {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            40% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
            100% { transform: scale(0) rotate(-10deg); opacity: 0; }
        }

        /* Drag & Drop Overlay */
        #drag-overlay {
            background-image: repeating-linear-gradient(45deg, #2979FF 0, #2979FF 20px, #ffffff 20px, #ffffff 40px);
            opacity: 0.1;
            pointer-events: none;
        }
        .dragging #drag-overlay { opacity: 0.2; }
        .dragging .console-frame { transform: scale(0.98); border-color: #2979FF; }

        /* Mobile Helper Classes */
        .hidden-panel-mobile { transform: translateY(100%); }
        .hidden-panel-desktop { margin-left: -24rem; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center p-2 md:p-6 overflow-hidden">

    <div id="drag-overlay" class="fixed inset-0 z-0 transition-opacity duration-300"></div>

    <div class="console-frame w-full h-full relative flex-col md:flex-row max-w-[1600px] mx-auto z-10">
        
        <aside id="controls" class="w-full md:w-96 bg-white border-b-4 md:border-b-0 md:border-r-4 border-dark flex flex-col z-50 transition-all duration-300 shadow-xl md:shadow-none h-[45%] md:h-full relative shrink-0">
            
            <div class="p-6 border-b-4 border-dark bg-yellow-50 flex justify-between items-center shrink-0">
                <div>
                    <h1 class="text-3xl font-heading text-dark tracking-wide leading-none drop-shadow-sm">
                        MYSTERY<span class="text-pink">BOX</span>
                    </h1>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="px-2 py-0.5 bg-dark text-white text-[10px] font-bold rounded uppercase">English 1</span>
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Batam Edition</span>
                    </div>
                </div>
                <button onclick="UI.togglePanel(true)" class="md:hidden p-2 bg-pink/10 text-pink border-2 border-dark rounded-lg shadow-hard-sm active:translate-y-1 active:shadow-none transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-8 bg-white relative">
                
                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="folder-open" class="w-4 h-4 text-blue"></i> Load Content
                    </label>
                    <div class="relative w-full h-24 border-4 border-dashed border-slate-200 rounded-2xl hover:border-blue hover:bg-blue/5 transition-all cursor-pointer group flex flex-col items-center justify-center gap-2">
                        <input type="file" id="file-input" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="p-2 bg-white rounded-full border-2 border-slate-200 group-hover:border-blue group-hover:scale-110 transition-transform">
                            <i data-lucide="upload-cloud" class="w-5 h-5 text-slate-400 group-hover:text-blue"></i>
                        </div>
                        <span class="text-[10px] text-slate-400 font-bold group-hover:text-blue uppercase tracking-wide" id="file-label">
                            Browse or Drop Files
                        </span>
                    </div>
                </div>

                <div class="space-y-4 p-4 bg-chalk border-2 border-dark rounded-xl shadow-sm">
                    <div class="flex justify-between items-end border-b-2 border-slate-200 pb-2 border-dashed">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Grid Size</label>
                        <span id="grid-val" class="font-mono text-orange font-black text-lg">4 x 4</span>
                    </div>
                    <div class="px-1 pt-2">
                        <input type="range" id="grid-slider" min="2" max="10" value="4" class="w-full">
                    </div>
                    
                    <div class="flex items-center justify-between pt-2">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Audio FX</label>
                        <button id="sound-toggle" class="p-2 bg-white rounded-lg border-2 border-slate-200 hover:border-dark transition-all text-slate-400 hover:text-dark">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="space-y-4 p-4 bg-blue/5 border-2 border-blue/30 rounded-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1 bg-blue text-white rounded-bl-lg">
                        <i data-lucide="sparkles" class="w-3 h-3"></i>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-black text-blue uppercase tracking-widest">Auto Speed</label>
                        <div class="flex items-center gap-2">
                             <span id="speed-label" class="text-[10px] font-bold text-blue font-mono">1.5s</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="rabbit" class="w-4 h-4 text-blue/50"></i>
                        <input type="range" id="speed-slider" min="100" max="3000" step="100" value="1500" class="w-full accent-blue">
                        <i data-lucide="turtle" class="w-4 h-4 text-blue/50"></i>
                    </div>
                </div>

                <button onclick="Game.resetLevel()" class="w-full btn-chunky bg-white text-dark py-3 rounded-xl text-sm tracking-wider flex items-center justify-center gap-2 hover:bg-pink/5 hover:text-pink hover:border-pink">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i> RESET PUZZLE
                </button>

            </div>
            
            <div class="p-4 border-t-4 border-dark bg-slate-50 flex justify-between items-center shrink-0">
                 <div class="font-heading text-slate-400 text-sm tracking-wide">
                    TILES LEFT
                </div>
                <div class="bg-dark text-green px-4 py-1 rounded-lg font-mono font-bold text-xl shadow-sm border-2 border-dark">
                    <span id="tiles-count">0</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative h-[55%] md:h-full bg-slate-50 flex flex-col overflow-hidden">
            
            <div class="h-16 md:h-20 border-b-4 border-dark bg-white flex items-center px-4 md:px-6 justify-between shrink-0 z-20 shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="UI.togglePanel(false)" class="p-2 bg-white border-2 border-dark rounded-xl shadow-hard-sm hover:translate-y-[-2px] transition-transform text-slate-400 hover:text-dark group">
                        <i data-lucide="settings-2" class="w-5 h-5 group-hover:rotate-45 transition-transform"></i>
                    </button>
                    <div class="hidden md:flex flex-col border-l-2 border-slate-200 pl-4">
                        <span class="text-[10px] uppercase font-black text-slate-400 tracking-wider">Progress</span>
                        <span id="round-display" class="font-mono text-lg font-bold text-dark">0 / 0</span>
                    </div>
                </div>

                <div class="flex items-center gap-2 md:gap-3">
                    <button id="next-round-btn" onclick="Game.nextLevel()" class="btn-chunky bg-green text-dark px-4 md:px-5 py-2 rounded-xl text-xs md:text-sm font-bold tracking-wide flex items-center gap-2 transition-all disabled:opacity-50" disabled>
                        <span>NEXT</span> <i data-lucide="arrow-right" class="w-4 h-4 md:w-5 md:h-5"></i>
                    </button>
                    
                    <button id="auto-reveal-btn" onclick="AutoReveal.toggle()" class="btn-chunky bg-blue text-white px-4 md:px-6 py-2 rounded-xl text-xs md:text-sm font-bold tracking-wide flex items-center gap-2 transition-all">
                        <i data-lucide="play" class="w-4 h-4 md:w-5 md:h-5 fill-current"></i> 
                        <span class="hidden md:inline">AUTO</span>
                    </button>

                    <button onclick="Game.revealAll()" class="btn-chunky bg-pink text-white px-4 md:px-6 py-2 rounded-xl text-xs md:text-sm font-bold tracking-wide flex items-center gap-2">
                        <i data-lucide="eye" class="w-4 h-4 md:w-5 md:h-5"></i> <span class="hidden md:inline">REVEAL ALL</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 relative p-4 md:p-8 flex flex-col items-center justify-center overflow-hidden bg-slate-50">
                
                <div class="absolute top-4 left-4 w-32 h-32 bg-blue/5 rounded-full blur-2xl pointer-events-none"></div>
                <div class="absolute bottom-4 right-4 w-40 h-40 bg-pink/5 rounded-full blur-3xl pointer-events-none"></div>

                <div class="w-full max-w-5xl retro-window shadow-hard-xl transition-transform duration-300 transform hover:scale-[1.005]">
                    <div class="window-header">
                        <div class="flex gap-2">
                            <div class="window-dot bg-pink"></div>
                            <div class="window-dot bg-orange"></div>
                            <div class="window-dot bg-green"></div>
                        </div>
                        <div class="ml-auto text-[10px] font-mono font-bold text-slate-400 tracking-widest">IMG_VIEWER.EXE</div>
                    </div>

                    <div class="game-viewport">
                        <img id="target-image" class="absolute inset-0 w-full h-full object-contain z-0 select-none pointer-events-none" src="" alt="">
                        
                        <div id="empty-state" class="absolute inset-0 z-0 flex flex-col items-center justify-center text-slate-300 bg-slate-100">
                            <div class="p-6 border-4 border-dashed border-slate-200 rounded-3xl mb-4 animate-bounce">
                                <i data-lucide="image-plus" class="w-12 h-12 md:w-16 md:h-16"></i>
                            </div>
                            <span class="font-heading text-xl md:text-3xl text-slate-400">NO IMAGE LOADED</span>
                            <span class="font-body text-xs md:text-sm font-bold text-slate-400 mt-2">Upload images via sidebar</span>
                        </div>

                        <div id="tile-grid" class="absolute inset-0 z-10 grid w-full h-full">
                            </div>
                    </div>
                </div>

                <div id="toast" class="absolute bottom-10 bg-dark text-white px-6 py-3 rounded-xl font-bold font-heading shadow-hard-sm transform translate-y-20 transition-transform opacity-0">
                    Action Completed
                </div>

            </div>
        </main>
    </div>

    <script>
        /**
         * AUDIO CONTROLLER
         * Handles Tone.js logic and sound effects
         */
        const Audio = {
            enabled: true,
            init: async () => { await Tone.start(); },
            
            toggle: () => {
                Audio.enabled = !Audio.enabled;
                const btn = document.getElementById('sound-toggle');
                const icon = Audio.enabled ? 'volume-2' : 'volume-x';
                btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i>`;
                if(!Audio.enabled) btn.classList.add('text-pink');
                else btn.classList.remove('text-pink');
                lucide.createIcons();
                localStorage.setItem('mb_audio', Audio.enabled);
            },

            playPop: () => {
                if(!Audio.enabled) return;
                const notes = ["C3", "E3", "G3", "A3"];
                const note = notes[Math.floor(Math.random() * notes.length)];
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.4 }
                }).toDestination();
                synth.triggerAttackRelease(note, "32n");
            },

            playWin: () => {
                if(!Audio.enabled) return;
                const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease(["C4", "E4", "G4"], "8n", now);
                synth.triggerAttackRelease(["E4", "G4", "C5"], "8n", now + 0.1);
                synth.triggerAttackRelease(["G4", "C5", "E5"], "4n", now + 0.2);
            }
        };

        /**
         * AUTO REVEAL CONTROLLER (UPDATED)
         * Handles the slow reveal logic with new button position
         */
        const AutoReveal = {
            intervalId: null,
            speed: 1500,
            isPlaying: false,

            init() {
                const slider = document.getElementById('speed-slider');
                const label = document.getElementById('speed-label');
                
                slider.addEventListener('input', (e) => {
                    AutoReveal.speed = parseInt(e.target.value);
                    label.innerText = (AutoReveal.speed / 1000).toFixed(1) + 's';
                    
                    if(AutoReveal.isPlaying) {
                        AutoReveal.stop();
                        AutoReveal.start();
                    }
                });
            },

            toggle() {
                if (this.isPlaying) this.stop();
                else this.start();
            },

            start() {
                if (Game.tilesRemaining <= 0) return;
                
                this.isPlaying = true;
                const btn = document.getElementById('auto-reveal-btn');
                
                // Update UI: Switch to White background, Blue text (Inverted)
                btn.innerHTML = `<i data-lucide="pause" class="w-4 h-4 md:w-5 md:h-5 fill-current"></i> <span class="hidden md:inline">PAUSE</span>`;
                btn.classList.replace('bg-blue', 'bg-white');
                btn.classList.replace('text-white', 'text-blue');
                btn.classList.add('border-blue'); // Add border to keep visual weight
                lucide.createIcons();

                this.intervalId = setInterval(() => {
                    const tiles = Array.from(document.querySelectorAll('.tile:not(.revealed)'));
                    if (tiles.length === 0) {
                        this.stop();
                        return;
                    }
                    const randomTile = tiles[Math.floor(Math.random() * tiles.length)];
                    Game.revealTile(randomTile);
                }, this.speed);
            },

            stop() {
                this.isPlaying = false;
                clearInterval(this.intervalId);
                
                const btn = document.getElementById('auto-reveal-btn');
                
                // Update UI: Switch back to Blue background, White text
                btn.innerHTML = `<i data-lucide="play" class="w-4 h-4 md:w-5 md:h-5 fill-current"></i> <span class="hidden md:inline">AUTO</span>`;
                btn.classList.replace('bg-white', 'bg-blue');
                btn.classList.replace('text-blue', 'text-white');
                btn.classList.remove('border-blue');
                lucide.createIcons();
            }
        };

        /**
         * CORE GAME ENGINE
         */
        const Game = {
            images: [],
            currentIndex: 0,
            gridSize: 4,
            tilesRemaining: 0,

            init() {
                // Restore Settings
                const savedGrid = localStorage.getItem('mb_grid');
                if(savedGrid) {
                    Game.gridSize = parseInt(savedGrid);
                    document.getElementById('grid-slider').value = Game.gridSize;
                    document.getElementById('grid-val').textContent = `${Game.gridSize} x ${Game.gridSize}`;
                }

                const savedAudio = localStorage.getItem('mb_audio');
                if(savedAudio === 'false') Audio.toggle(); // Default is true

                // Init modules
                AutoReveal.init();
            },

            start(fileList) {
                this.images = fileList;
                this.currentIndex = 0;
                document.getElementById('empty-state').style.display = 'none';
                this.loadLevel();
                
                // Mobile QoL: Hide sidebar on start
                if(window.innerWidth < 768) UI.togglePanel(true);
            },

            loadLevel() {
                if (this.currentIndex >= this.images.length) this.currentIndex = 0;
                
                // Update Image
                document.getElementById('target-image').src = this.images[this.currentIndex];
                document.getElementById('round-display').textContent = `${this.currentIndex + 1} / ${this.images.length}`;
                
                // Reset State
                document.getElementById('next-round-btn').disabled = true;
                AutoReveal.stop();
                this.buildGrid();
            },

            buildGrid() {
                const grid = document.getElementById('tile-grid');
                grid.innerHTML = '';
                grid.style.gridTemplateColumns = `repeat(${this.gridSize}, 1fr)`;
                
                this.tilesRemaining = this.gridSize * this.gridSize;
                UI.updateCount(this.tilesRemaining);

                for (let i = 0; i < this.tilesRemaining; i++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    // Alternate text colors for texture
                    const numColor = (i % 2 === 0) ? 'text-slate-200' : 'text-slate-300';
                    tile.innerHTML = `<span class="text-3xl font-heading ${numColor} pointer-events-none select-none">${i + 1}</span>`;
                    
                    // Interaction
                    tile.onmousedown = () => this.revealTile(tile);
                    grid.appendChild(tile);
                }
            },

            revealTile(tile) {
                if (tile.classList.contains('revealed')) return;

                // Ensure Audio Context is ready
                if (Tone.context.state !== 'running') Tone.start();

                tile.classList.add('revealed');
                this.tilesRemaining--;
                UI.updateCount(this.tilesRemaining);
                Audio.playPop();

                if (this.tilesRemaining <= 0) this.win();
            },

            revealAll() {
                if(this.tilesRemaining === 0) return;
                
                AutoReveal.stop(); // Stop auto if running
                const tiles = document.querySelectorAll('.tile:not(.revealed)');
                
                // Staggered cascade
                tiles.forEach((t, i) => {
                    setTimeout(() => {
                        t.classList.add('revealed');
                        // Play sound occasionally to avoid chaos
                        if(i % 3 === 0) Audio.playPop();
                    }, i * 30);
                });

                setTimeout(() => {
                    this.tilesRemaining = 0;
                    UI.updateCount(0);
                    this.win();
                }, tiles.length * 30 + 100);
            },

            win() {
                Audio.playWin();
                UI.fireConfetti();
                
                AutoReveal.stop(); // Reset button state

                // Enable Next Button
                const btn = document.getElementById('next-round-btn');
                btn.disabled = false;
                btn.classList.add('animate-bounce');
                setTimeout(() => btn.classList.remove('animate-bounce'), 1000);
            },

            resetLevel() {
                this.buildGrid();
                AutoReveal.stop();
            },

            nextLevel() {
                this.currentIndex++;
                if(this.currentIndex >= this.images.length) this.currentIndex = 0; // Loop
                this.loadLevel();
            },

            updateGridSize(val) {
                this.gridSize = parseInt(val);
                document.getElementById('grid-val').textContent = `${val} x ${val}`;
                localStorage.setItem('mb_grid', val);
                // Only rebuild if game is active
                if(this.images.length > 0) this.buildGrid();
            }
        };

        /**
         * UI MANAGER
         */
        const UI = {
            togglePanel(forceHide) {
                const panel = document.getElementById('controls');
                const isHidden = window.innerWidth >= 768 
                    ? panel.classList.contains('hidden-panel-desktop')
                    : panel.classList.contains('hidden-panel-mobile');

                if (forceHide || !isHidden) {
                    panel.classList.add('hidden-panel-mobile', 'hidden-panel-desktop');
                } else {
                    panel.classList.remove('hidden-panel-mobile', 'hidden-panel-desktop');
                }
                
                // Fix grid layout glitch on resize
                setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            },

            updateCount(num) {
                document.getElementById('tiles-count').innerText = num;
            },

            fireConfetti() {
                const end = Date.now() + 1000;
                const colors = ['#FF6B95', '#FF8C42', '#00E676', '#2979FF'];

                (function frame() {
                    confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0 }, colors });
                    confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1 }, colors });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.remove('opacity-0', 'translate-y-20');
                setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 2000);
            }
        };

        // --- EVENT BINDINGS ---
        
        // 1. Inputs
        document.getElementById('grid-slider').addEventListener('input', (e) => Game.updateGridSize(e.target.value));
        document.getElementById('sound-toggle').addEventListener('click', Audio.toggle);
        
        // 2. File Loading
        const handleFiles = (files) => {
            const list = [];
            let loaded = 0;
            Array.from(files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    list.push(e.target.result);
                    loaded++;
                    if(loaded === files.length) {
                        Game.start(list);
                        UI.showToast(`Loaded ${loaded} Images!`);
                    }
                };
                reader.readAsDataURL(f);
            });
        };

        document.getElementById('file-input').addEventListener('change', (e) => handleFiles(e.target.files));

        // 3. Drag & Drop
        window.addEventListener('dragover', (e) => {
            e.preventDefault();
            document.body.classList.add('dragging');
        });
        window.addEventListener('dragleave', (e) => {
            if(e.clientX === 0 && e.clientY === 0) document.body.classList.remove('dragging');
        });
        window.addEventListener('drop', (e) => {
            e.preventDefault();
            document.body.classList.remove('dragging');
            if(e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });

        // 4. Keyboard Shortcuts (Quality of Life)
        document.addEventListener('keydown', (e) => {
            if(Game.images.length === 0) return;
            switch(e.code) {
                case 'Space': 
                    e.preventDefault();
                    AutoReveal.toggle(); 
                    break;
                case 'KeyR': Game.resetLevel(); break;
                case 'KeyN': if(Game.tilesRemaining <= 0) Game.nextLevel(); break;
            }
        });

        // 5. Responsive Logic
        window.addEventListener('resize', () => {
             const panel = document.getElementById('controls');
             if(window.innerWidth >= 768) panel.classList.remove('hidden-panel-mobile'); 
             else panel.classList.remove('hidden-panel-desktop');
        });

        // Init
        window.onload = () => {
            Game.init();
            lucide.createIcons();
            if(window.innerWidth < 768) UI.togglePanel(true);
        };

    </script>
</body>
</html>