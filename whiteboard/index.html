<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom Whiteboard | English 1</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        e1: {
                            pink: '#FF6B95',   /* Playful */
                            orange: '#FF8C42', /* Energy */
                            green: '#00E676',  /* Success */
                            blue: '#2979FF',   /* Logic */
                            dark: '#1e293b',   /* Slate 800 - Borders/Text */
                            chalk: '#f8fafc',  /* Backgrounds */
                        }
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    borderWidth: {
                        '3': '3px',
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)', 
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'none': '0px 0px 0px 0px rgba(0,0,0,0)',
                    },
                    cursor: {
                        'pencil': 'url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSZNMTcgM0wyMSA3TTE3IDNMNCAxNlYyMEg4TDIxIDdNMTcgM0wxNCA2IiBzdHJva2U9IiMxZTI5M2IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+) 0 24, auto',
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc;
            /* Graph Paper Grid */
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden; /* Prevent scrolling */
            touch-action: none; /* Critical for drawing */
        }

        /* --- Neo-Brutalism Components --- */
        
        .panel-neo {
            background-color: white;
            border: 3px solid #1e293b;
            border-radius: 1rem;
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        .btn-tool {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #1e293b;
            border-radius: 0.75rem;
            background-color: white;
            color: #1e293b;
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
            transition: all 0.1s ease;
        }

        .btn-tool:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        .btn-tool:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
        }

        .btn-tool.active {
            background-color: #2979FF; /* e1-blue */
            color: white;
            box-shadow: 0px 0px 0px 0px rgba(30, 41, 59, 1);
            transform: translate(2px, 2px);
        }

        .btn-tool.danger:hover { background-color: #FF6B95; color: white; }
        
        /* Color Picker Radio Logic */
        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 99px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-option.selected {
            border-color: #1e293b;
            transform: scale(1.2);
            box-shadow: 0 0 0 2px white;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2979FF;
            border: 3px solid #1e293b;
            cursor: pointer;
            margin-top: -8px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #cbd5e1;
            border: 1px solid #1e293b;
            border-radius: 4px;
        }

        /* Canvas Animation */
        canvas {
            touch-action: none;
        }

    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="absolute top-0 left-0 right-0 z-50 px-4 py-3 pointer-events-none">
        <div class="max-w-7xl mx-auto flex justify-between items-start">
            
            <div class="bg-white border-3 border-e1-dark px-4 py-2 rounded-xl shadow-neo pointer-events-auto flex items-center gap-3">
                <div class="bg-e1-orange text-white p-1 rounded border-2 border-e1-dark">
                    <i data-lucide="pen-tool" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-heading font-bold text-lg leading-none text-e1-dark">Whiteboard</h1>
                    <span class="text-xs font-bold text-e1-blue uppercase">English 1</span>
                </div>
            </div>

            <div class="flex gap-2 pointer-events-auto">
                <button onclick="downloadCanvas()" class="btn-tool w-auto px-4 bg-e1-green text-white font-heading font-bold gap-2">
                    <i data-lucide="download" class="w-4 h-4 stroke-[3px]"></i> Save
                </button>
            </div>
        </div>
    </header>

    <div class="absolute top-24 left-4 z-40 flex flex-col gap-4">
        
        <div class="panel-neo p-3 flex flex-col gap-3 w-16 items-center">
            
            <button class="btn-tool active" id="btn-pen" onclick="setTool('pen')" title="Pen">
                <i data-lucide="pencil" class="w-5 h-5"></i>
            </button>
            <button class="btn-tool" id="btn-eraser" onclick="setTool('eraser')" title="Eraser">
                <i data-lucide="eraser" class="w-5 h-5"></i>
            </button>
            <button class="btn-tool" id="btn-hand" onclick="setTool('hand')" title="Pan">
                <i data-lucide="hand" class="w-5 h-5"></i>
            </button>
            
            <div class="w-8 h-1 bg-slate-200 rounded"></div>

            <button class="btn-tool" onclick="undoLast()" title="Undo">
                <i data-lucide="undo-2" class="w-5 h-5"></i>
            </button>

            <div class="w-8 h-1 bg-slate-200 rounded"></div>

            <div class="flex flex-col gap-2 items-center pb-2">
                <div class="color-option bg-e1-dark selected" onclick="setColor('#1e293b', this)"></div>
                <div class="color-option bg-e1-blue" onclick="setColor('#2979FF', this)"></div>
                <div class="color-option bg-e1-green" onclick="setColor('#00E676', this)"></div>
                <div class="color-option bg-e1-orange" onclick="setColor('#FF8C42', this)"></div>
                <div class="color-option bg-e1-pink" onclick="setColor('#FF6B95', this)"></div>
            </div>

            <div class="w-8 h-1 bg-slate-200 rounded"></div>

             <button class="btn-tool danger hover:bg-e1-pink hover:text-white" onclick="showClearModal()" title="Clear">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
        </div>

    </div>

    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-40 flex gap-4">
        
        <div class="panel-neo px-4 py-2 flex items-center gap-3">
            <i data-lucide="circle" class="w-3 h-3 text-slate-400 fill-current"></i>
            <input type="range" id="brush-size" min="2" max="40" value="5" class="w-32">
            <i data-lucide="circle" class="w-6 h-6 text-slate-400 fill-current"></i>
        </div>

        <div class="panel-neo px-2 py-2 flex items-center gap-1">
            <button class="btn-tool w-8 h-8 rounded shadow-none border-none hover:bg-slate-100" onclick="changeZoom(-0.1)">
                <i data-lucide="minus" class="w-4 h-4"></i>
            </button>
            <span id="zoom-level" class="font-heading font-bold text-e1-dark w-12 text-center text-sm">100%</span>
            <button class="btn-tool w-8 h-8 rounded shadow-none border-none hover:bg-slate-100" onclick="changeZoom(0.1)">
                <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
            <button class="btn-tool w-8 h-8 rounded shadow-none border-none hover:bg-slate-100 text-slate-400" onclick="resetZoom()">
                <i data-lucide="maximize" class="w-4 h-4"></i>
            </button>
        </div>

    </div>

    <main id="canvas-container" class="flex-grow w-full h-full relative cursor-pencil">
        <canvas id="whiteboard"></canvas>
    </main>

    <div id="clear-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="panel-neo p-6 text-center max-w-sm w-full mx-4 transform scale-90 transition-transform duration-200" id="modal-box">
            <div class="w-16 h-16 bg-e1-pink rounded-full border-3 border-e1-dark flex items-center justify-center mx-auto mb-4 shadow-neo-sm">
                <i data-lucide="bomb" class="w-8 h-8 text-white"></i>
            </div>
            <h2 class="font-heading font-bold text-2xl text-e1-dark mb-2">Wipe it clean?</h2>
            <p class="font-body text-slate-600 mb-6">This will delete everything on the whiteboard. This cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeClearModal()" class="flex-1 btn-tool w-auto h-12 font-bold bg-white text-slate-600">Cancel</button>
                <button onclick="confirmClear()" class="flex-1 btn-tool w-auto h-12 font-bold bg-e1-pink text-white hover:bg-red-500">Yes, Clear It</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & ELEMENTS ---
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('canvas-container');
        const brushSizeInput = document.getElementById('brush-size');
        const clearModal = document.getElementById('clear-modal');
        const modalBox = document.getElementById('modal-box');
        const zoomLevelDisplay = document.getElementById('zoom-level');
        const STORAGE_KEY = 'english1-board-neo-save';

        // --- 2. STATE ---
        let state = {
            isDrawing: false,
            isPanning: false,
            currentTool: 'pen',
            currentColor: '#1e293b',
            scale: 1,
            panX: 0,
            panY: 0,
            startPanX: 0,
            startPanY: 0
        };
        
        let undoStack = [];
        let undoIndex = -1;

        // --- 3. CORE FUNCTIONS ---

        function initIcons() {
            lucide.createIcons();
        }
        
        function resizeCanvas() {
            let tempImage = null;
            if (canvas.width > 0 && canvas.height > 0) tempImage = canvas.toDataURL();

            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            if (tempImage) {
                const img = new Image();
                img.src = tempImage;
                img.onload = function() { 
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(img, 0, 0); 
                }
            }
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            updateTransform(); 
        }

        function updateTransform() {
            // Apply visual transform to canvas element
            canvas.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.scale})`;
            
            // Move the background grid to match (Parallax effect)
            const gridSize = 30 * state.scale;
            document.body.style.backgroundSize = `${gridSize}px ${gridSize}px`;
            document.body.style.backgroundPosition = `${state.panX}px ${state.panY}px`;
            
            zoomLevelDisplay.innerText = Math.round(state.scale * 100) + "%";
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let cx, cy;
            
            if (e.touches && e.touches.length > 0) {
                cx = e.touches[0].clientX;
                cy = e.touches[0].clientY;
            } else {
                cx = e.clientX;
                cy = e.clientY;
            }

            // Important: Calculation must account for scale to draw accurately
            return {
                x: (cx - rect.left) / state.scale,
                y: (cy - rect.top) / state.scale
            };
        }

        // --- 4. DRAWING ---

        function startAction(e) {
            if (state.currentTool === 'hand') {
                state.isPanning = true;
                let cx = e.touches ? e.touches[0].clientX : e.clientX;
                let cy = e.touches ? e.touches[0].clientY : e.clientY;
                state.startPanX = cx - state.panX;
                state.startPanY = cy - state.panY;
                container.style.cursor = 'grabbing';
            } else {
                state.isDrawing = true;
                draw(e); 
            }
        }

        function moveAction(e) {
            if (e.type === 'touchmove') e.preventDefault(); 

            if (state.isPanning) {
                let cx = e.touches ? e.touches[0].clientX : e.clientX;
                let cy = e.touches ? e.touches[0].clientY : e.clientY;
                state.panX = cx - state.startPanX;
                state.panY = cy - state.startPanY;
                updateTransform();
            } else if (state.isDrawing) {
                draw(e);
            }
        }

        function endAction() {
            if (state.isDrawing) {
                state.isDrawing = false;
                ctx.beginPath(); 
                saveToHistory();
            }
            if (state.isPanning) {
                state.isPanning = false;
                if(state.currentTool === 'hand') container.style.cursor = 'grab';
            }
        }

        function draw(e) {
            if (!state.isDrawing) return;

            const pos = getPos(e);
            
            ctx.lineWidth = brushSizeInput.value;
            
            if (state.currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = brushSizeInput.value * 2; 
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = state.currentColor;
            }

            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        // --- 5. TOOLS ---

        function setTool(tool) {
            state.currentTool = tool;
            
            document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('active'));
            if(tool === 'pen') document.getElementById('btn-pen').classList.add('active');
            if(tool === 'eraser') document.getElementById('btn-eraser').classList.add('active');
            if(tool === 'hand') document.getElementById('btn-hand').classList.add('active');

            if (tool === 'hand') {
                container.style.cursor = 'grab';
                container.classList.remove('cursor-pencil');
            } else {
                container.style.cursor = 'default';
                container.classList.add('cursor-pencil');
            }
        }

        function setColor(color, el) {
            setTool('pen');
            state.currentColor = color;
            document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- 6. HISTORY & ZOOM ---

        function saveToHistory() {
            if (undoIndex < undoStack.length - 1) {
                undoStack = undoStack.slice(0, undoIndex + 1);
            }
            const data = canvas.toDataURL();
            undoStack.push(data);
            undoIndex++;
            if(undoStack.length > 20) { undoStack.shift(); undoIndex--; }
            try { localStorage.setItem(STORAGE_KEY, data); } catch(e) {}
        }

        function undoLast() {
            if (undoIndex <= 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                undoIndex = -1; undoStack = [];
                localStorage.removeItem(STORAGE_KEY);
                return;
            }
            undoIndex--;
            const data = undoStack[undoIndex];
            const img = new Image();
            img.src = data;
            img.onload = function() {
                ctx.globalCompositeOperation = 'source-over';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                localStorage.setItem(STORAGE_KEY, data);
            }
        }

        function changeZoom(delta) {
            let newScale = state.scale + delta;
            newScale = Math.min(Math.max(newScale, 0.5), 3.0);
            state.scale = newScale;
            updateTransform();
        }

        function resetZoom() {
            state.scale = 1;
            state.panX = 0;
            state.panY = 0;
            updateTransform();
        }

        // --- 7. UTILS ---

        function loadLocalData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const img = new Image();
                img.src = saved;
                img.onload = function() {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(img, 0, 0);
                    saveToHistory();
                };
            } else {
                saveToHistory();
            }
        }

        function downloadCanvas() {
            const link = document.createElement('a');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(canvas, 0, 0);

            link.download = `english1-board-${Date.now()}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
        }

        // Modal
        function showClearModal() {
            clearModal.classList.remove('hidden');
            setTimeout(() => {
                clearModal.classList.remove('opacity-0');
                modalBox.classList.remove('scale-90');
                modalBox.classList.add('scale-100');
            }, 10);
        }

        function closeClearModal() {
            clearModal.classList.add('opacity-0');
            modalBox.classList.remove('scale-100');
            modalBox.classList.add('scale-90');
            setTimeout(() => clearModal.classList.add('hidden'), 200);
        }

        function confirmClear() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            closeClearModal();
            undoStack = [];
            undoIndex = -1;
            localStorage.removeItem(STORAGE_KEY);
            saveToHistory();
        }

        // --- INIT ---
        window.onload = () => {
            resizeCanvas();
            setTimeout(loadLocalData, 100);
            initIcons();
        };
        
        window.addEventListener('resize', resizeCanvas);
        
        // Listeners
        canvas.addEventListener('mousedown', startAction);
        canvas.addEventListener('mouseup', endAction);
        canvas.addEventListener('mousemove', moveAction);
        canvas.addEventListener('mouseout', endAction);
        canvas.addEventListener('touchstart', startAction, {passive: false});
        canvas.addEventListener('touchend', endAction);
        canvas.addEventListener('touchmove', moveAction, {passive: false});

    </script>
</body>
</html>