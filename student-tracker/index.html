<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Batam | Skill Tracker Pro</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        e1indigo: '#6366f1',
                        e1violet: '#8b5cf6',
                        e1dark: '#1e293b',
                        e1chalk: '#f8fafc',
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-hover': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(#cbd5e1 1px, transparent 1px),
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .dark body {
            background-color: #0f172a;
            background-image: 
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
        }

        .btn-neo {
            transition: all 0.1s ease;
        }
        .btn-neo:hover {
            transform: translate(-1px, -1px);
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }
        .btn-neo:active {
            transform: translate(3px, 3px);
            box-shadow: 1px 1px 0px 0px rgba(30, 41, 59, 1);
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .legend-chip {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .legend-chip.active {
            transform: scale(1.05);
            background-color: #1e293b !important;
            color: white !important;
            border-color: white !important;
        }

        .student-item.active {
            background-color: #2979FF;
            color: white;
            border-color: #1e293b;
            transform: translateX(6px);
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #1e293b; 
            border-radius: 10px;
            border: 2px solid #f8fafc;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { border-color: #0f172a; }

        @keyframes toastIn {
            from { transform: translateY(100%) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .toast-animation { animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="text-e1dark dark:text-e1chalk min-h-screen transition-colors duration-300">

    <div id="toastContainer" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-3"></div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- SIDEBAR -->
        <aside class="w-full lg:w-80 bg-white dark:bg-slate-900 border-b-4 lg:border-b-0 lg:border-r-4 border-e1dark z-40 p-6 flex flex-col gap-6 sticky top-0 h-auto lg:h-screen shadow-[4px_0px_0px_0px_rgba(30,41,59,0.1)]">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-e1pink rounded-xl border-4 border-e1dark shadow-neo flex items-center justify-center rotate-[-3deg]">
                    <i data-lucide="graduation-cap" class="text-white w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="font-display font-bold text-2xl tracking-tight leading-none">English 1</h1>
                    <p class="text-[10px] font-black uppercase tracking-widest text-e1blue">Skill Dashboard</p>
                </div>
            </div>

            <button onclick="addNewStudent()" class="w-full bg-e1green text-white font-display font-bold py-4 rounded-2xl border-4 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-3 text-lg">
                <i data-lucide="user-plus" class="w-6 h-6"></i> Add Student
            </button>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar" id="studentRoster">
                <!-- Students injected here -->
            </div>

            <div class="pt-6 border-t-4 border-e1dark/10 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportAllData()" class="bg-e1blue text-white font-display font-bold py-2 rounded-xl border-3 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2 text-[10px] uppercase">
                        <i data-lucide="download" class="w-4 h-4"></i> Backup All
                    </button>
                    <button onclick="triggerImport()" class="bg-e1indigo text-white font-display font-bold py-2 rounded-xl border-3 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2 text-[10px] uppercase">
                        <i data-lucide="file-up" class="w-4 h-4"></i> Import
                    </button>
                </div>

                <button id="themeToggle" class="w-full bg-e1orange text-white font-display font-bold py-3 rounded-2xl border-4 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2">
                    <i data-lucide="moon" class="w-5 h-5"></i> <span id="themeLabel" class="font-display">Blackboard Mode</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 lg:p-10 space-y-8 overflow-x-hidden">
            
            <!-- Student Header -->
            <div id="studentHeader" class="bg-white dark:bg-slate-800 p-8 rounded-[2rem] border-4 border-e1dark shadow-neo relative overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 relative z-10">
                    <div class="flex items-center gap-6 w-full max-w-2xl">
                        <div class="w-20 h-20 bg-e1blue rounded-3xl border-4 border-e1dark shadow-neo flex items-center justify-center text-white shrink-0 rotate-[2deg]">
                            <i data-lucide="user-circle" class="w-12 h-12"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" id="studentNameInput" placeholder="Enter student name..." 
                                class="block bg-transparent border-none p-0 font-display font-bold text-4xl focus:ring-0 placeholder-slate-300 dark:placeholder-slate-600 w-full truncate">
                            <div class="flex items-center gap-2 mt-2">
                                <span class="bg-e1orange/10 dark:bg-e1orange/20 text-e1orange text-[10px] font-black px-2 py-0.5 rounded border border-e1orange/30 uppercase tracking-tighter" id="studentMeta">ID: Select Student</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3 shrink-0">
                        <button onclick="exportCurrentStudent()" class="bg-e1green text-white font-display font-bold py-3 px-5 rounded-2xl border-4 border-e1dark shadow-neo btn-neo flex items-center gap-2 text-sm">
                            <i data-lucide="share" class="w-5 h-5"></i> Export
                        </button>
                        <button onclick="clearData()" class="bg-red-500 text-white font-display font-bold py-3 px-5 rounded-2xl border-4 border-e1dark shadow-neo btn-neo flex items-center gap-2 text-sm">
                            <i data-lucide="trash-2" class="w-5 h-5"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <input type="file" id="importInput" accept=".json,.csv" class="hidden" onchange="handleImport(event)">

            <!-- ANALYTICS GRID -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                
                <!-- Chart Main View -->
                <div class="xl:col-span-2 bg-white dark:bg-slate-800 rounded-[2.5rem] border-4 border-e1dark shadow-neo p-8 flex flex-col relative overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6 relative z-10">
                        <div class="space-y-1">
                            <h2 class="font-display font-bold text-3xl flex items-center gap-3">
                                <i data-lucide="line-chart" class="w-8 h-8 text-e1green"></i> 
                                Skill Progress
                            </h2>
                            <div class="flex items-center gap-3 bg-slate-50 dark:bg-slate-900 px-4 py-2 rounded-2xl border-2 border-e1dark w-fit">
                                <select id="categoryFilter" onchange="handleFilterChange()" class="bg-transparent border-none p-0 text-sm font-bold focus:ring-0 cursor-pointer">
                                    <option value="All">All Progression</option>
                                </select>
                            </div>
                        </div>

                        <div id="customLegend" class="flex flex-wrap gap-2 justify-end max-w-xl">
                            <button onclick="toggleHighlight(0, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1indigo"></span> Gram
                            </button>
                            <button onclick="toggleHighlight(1, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1orange"></span> List
                            </button>
                            <button onclick="toggleHighlight(2, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1blue"></span> Read
                            </button>
                            <button onclick="toggleHighlight(3, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1green"></span> Speak
                            </button>
                            <button onclick="toggleHighlight(4, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1violet"></span> Vocab
                            </button>
                            <button onclick="toggleHighlight(5, this)" class="legend-chip flex items-center gap-2 px-2 py-1.5 rounded-xl border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm font-bold text-[10px] uppercase">
                                <span class="w-2 h-2 rounded-full bg-e1pink"></span> Writ
                            </button>
                        </div>
                    </div>
                    <div class="h-[400px] w-full relative bg-slate-50/50 dark:bg-slate-900/20 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-700 p-2">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- Statistics Sidebar -->
                <div class="flex flex-col gap-8">
                    <!-- Radar Profile -->
                    <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-4 border-e1dark shadow-neo p-6 flex flex-col h-[380px] relative">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-display font-bold text-xl flex items-center gap-2">
                                <i data-lucide="target" class="w-5 h-5 text-e1pink"></i>
                                Skill Balance
                            </h3>
                            <div class="flex flex-col items-end">
                                <span class="text-[8px] font-black uppercase text-slate-400">Avg Window</span>
                                <div class="flex items-center gap-1 bg-e1chalk dark:bg-slate-900 border-2 border-e1dark rounded-lg px-2 py-0.5">
                                    <input type="number" id="radarWindow" value="1" min="1" max="20" onchange="updateAnalytics()" 
                                        class="w-8 bg-transparent border-none p-0 text-center font-bold text-sm focus:ring-0">
                                    <span class="text-[10px] font-bold text-slate-400">Units</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 relative">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- Rapid Stats -->
                    <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-4 border-e1dark shadow-neo p-6 grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Recent Avg</p>
                            <p class="text-2xl font-display font-bold text-e1blue" id="statAvg">0%</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Milestones</p>
                            <p class="text-2xl font-display font-bold text-e1dark dark:text-e1chalk" id="statCount">0</p>
                        </div>
                        <div class="col-span-2 pt-2 border-t-2 border-dashed border-slate-100 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Strongest Skill</p>
                                <span id="statBest" class="text-xs font-bold px-2 py-0.5 rounded-full bg-e1green/10 text-e1green border border-e1green/20">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] border-4 border-e1dark shadow-neo overflow-hidden">
                <div class="p-6 bg-e1blue text-white border-b-4 border-e1dark flex justify-between items-center">
                    <h2 class="font-display font-bold text-2xl flex items-center gap-3">
                        <i data-lucide="list-checks" class="w-7 h-7"></i>
                        Data Entry
                    </h2>
                </div>

                <div class="overflow-x-auto">
                    <form id="entryForm">
                        <table class="w-full text-left border-collapse min-w-[1000px]">
                            <thead>
                                <tr class="text-slate-400 text-[10px] font-black uppercase tracking-widest border-b-2 border-e1dark/10">
                                    <th class="p-4">Category</th>
                                    <th class="p-4">Milestone</th>
                                    <th class="p-2 text-center text-e1indigo">Gram</th>
                                    <th class="p-2 text-center text-e1orange">Listen</th>
                                    <th class="p-2 text-center text-e1blue">Read</th>
                                    <th class="p-2 text-center text-e1green">Speak</th>
                                    <th class="p-2 text-center text-e1violet">Vocab</th>
                                    <th class="p-2 text-center text-e1pink">Write</th>
                                    <th class="p-4 text-center w-32">Action</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="font-bold text-e1dark dark:text-e1chalk">
                                <!-- INPUT ROW -->
                                <tr class="bg-e1chalk dark:bg-slate-900/40 border-b-4 border-e1dark/20">
                                    <td class="p-3"><input type="text" id="inCategory" placeholder="e.g. Starter A" required class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl px-4 py-2 font-display text-sm focus:border-e1blue shadow-sm"></td>
                                    <td class="p-3"><input type="text" id="milestone" placeholder="e.g. Unit 1" required class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl px-4 py-2 font-display text-sm focus:border-e1blue shadow-sm"></td>
                                    <td class="p-2"><input type="number" id="inGrammar" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-2"><input type="number" id="inListening" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-2"><input type="number" id="inReading" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-2"><input type="number" id="inSpeaking" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-2"><input type="number" id="inVocab" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-2"><input type="number" id="inWriting" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl py-2"></td>
                                    <td class="p-3">
                                        <button type="submit" class="w-full bg-e1green text-white py-2 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo">
                                            <i data-lucide="save" class="w-6 h-6 mx-auto"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                    <div id="emptyState" class="p-16 text-center text-slate-400 font-display text-xl border-t border-slate-100 dark:border-slate-800">
                        Enter a milestone to see detailed analytics.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = { info: 'bg-e1blue text-white', success: 'bg-e1green text-white', error: 'bg-red-500 text-white', warning: 'bg-e1orange text-white' };
            toast.className = `${colors[type]} px-6 py-4 rounded-2xl border-4 border-e1dark shadow-neo toast-animation flex items-center gap-3 font-bold text-sm min-w-[250px]`;
            toast.innerHTML = `<i data-lucide="info" class="w-5 h-5 shrink-0"></i><span class="flex-1">${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px) scale(0.9)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // State
        let students = []; 
        let currentStudentId = null;
        let appData = []; 
        let lineChart = null;
        let radarChart = null;
        let highlightedDatasetIndex = null;
        let currentlyEditingIndex = null;
        let currentFilter = 'All';

        const form = document.getElementById('entryForm');
        const tableBody = document.getElementById('dataTableBody');
        const emptyState = document.getElementById('emptyState');
        const studentNameInput = document.getElementById('studentNameInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const studentRoster = document.getElementById('studentRoster');

        function incrementMilestone(str) {
            const hasNumber = /\d+/.test(str);
            if (!hasNumber) return str;
            return str.replace(/(\d+)(?!.*\d)/, (match) => parseInt(match) + 1);
        }

        // Charts Init
        function initCharts() {
            const lineCtx = document.getElementById('progressChart').getContext('2d');
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(30, 41, 59, 0.05)';
            const labelColor = isDark ? '#94a3b8' : '#64748b';

            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Grammar', data: [], borderColor: '#6366f1', backgroundColor: '#6366f1', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Listening', data: [], borderColor: '#FF8C42', backgroundColor: '#FF8C42', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Reading', data: [], borderColor: '#2979FF', backgroundColor: '#2979FF', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Speaking', data: [], borderColor: '#00E676', backgroundColor: '#00E676', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Vocabulary', data: [], borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Writing', data: [], borderColor: '#FF6B95', backgroundColor: '#FF6B95', borderWidth: 3, tension: 0.4, pointRadius: 4 },
                        { label: 'Average', data: [], borderColor: isDark ? '#f8fafc' : '#1e293b', borderWidth: 2, borderDash: [6, 4], tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, max: 120, grid: { color: gridColor }, 
                            ticks: { color: labelColor, font: { weight: 'bold' }, callback: (v) => v <= 100 ? v : '' } 
                        },
                        x: { grid: { display: false }, ticks: { color: labelColor, font: { weight: 'bold' } } }
                    }
                }
            });

            radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['Gram', 'Listen', 'Read', 'Speak', 'Vocab', 'Write'],
                    datasets: [{
                        label: 'Skill Level',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(41, 121, 255, 0.2)',
                        borderColor: '#2979FF',
                        borderWidth: 3,
                        pointBackgroundColor: '#2979FF'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true, max: 100, min: 0,
                            grid: { color: gridColor },
                            angleLines: { color: gridColor },
                            pointLabels: { color: labelColor, font: { weight: 'bold', family: 'Fredoka' } },
                            ticks: { display: false, stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateAnalytics() {
            if (!lineChart) return;
            const filtered = currentFilter === 'All' ? appData : appData.filter(d => d.category === currentFilter);
            
            // 1. Line Chart Update - Dynamic Labels
            lineChart.data.labels = filtered.map(d => 
                currentFilter === 'All' ? `${d.category}: ${d.milestone}` : d.milestone
            );

            lineChart.data.datasets[0].data = filtered.map(d => d.gram);
            lineChart.data.datasets[1].data = filtered.map(d => d.listen);
            lineChart.data.datasets[2].data = filtered.map(d => d.read);
            lineChart.data.datasets[3].data = filtered.map(d => d.speak);
            lineChart.data.datasets[4].data = filtered.map(d => d.vocab);
            lineChart.data.datasets[5].data = filtered.map(d => d.write);
            lineChart.data.datasets[6].data = filtered.map(d => (d.gram + d.listen + d.read + d.speak + d.vocab + d.write) / 6);
            lineChart.update();

            // 2. Radar Calculation with Settable Window
            const windowSize = parseInt(document.getElementById('radarWindow').value) || 1;
            
            if (filtered.length > 0) {
                const windowData = filtered.slice(-windowSize);
                const skillTotals = { gram: 0, listen: 0, read: 0, speak: 0, vocab: 0, write: 0 };
                
                windowData.forEach(item => {
                    skillTotals.gram += item.gram;
                    skillTotals.listen += item.listen;
                    skillTotals.read += item.read;
                    skillTotals.speak += item.speak;
                    skillTotals.vocab += item.vocab;
                    skillTotals.write += item.write;
                });

                const count = windowData.length;
                const windowSkills = [
                    skillTotals.gram / count,
                    skillTotals.listen / count,
                    skillTotals.read / count,
                    skillTotals.speak / count,
                    skillTotals.vocab / count,
                    skillTotals.write / count
                ];

                radarChart.data.datasets[0].data = windowSkills;
                radarChart.update();

                const last = filtered[filtered.length - 1];
                const lastSkills = [last.gram, last.listen, last.read, last.speak, last.vocab, last.write];
                const avg = lastSkills.reduce((a,b) => a+b, 0) / 6;
                
                document.getElementById('statAvg').textContent = avg.toFixed(1) + '%';
                document.getElementById('statCount').textContent = filtered.length;
                
                const labels = ['Grammar', 'Listening', 'Reading', 'Speaking', 'Vocabulary', 'Writing'];
                const bestIdx = windowSkills.indexOf(Math.max(...windowSkills));
                document.getElementById('statBest').textContent = labels[bestIdx];
            } else {
                radarChart.data.datasets[0].data = [0,0,0,0,0,0];
                radarChart.update();
                document.getElementById('statAvg').textContent = '0%';
                document.getElementById('statCount').textContent = '0';
                document.getElementById('statBest').textContent = 'N/A';
            }
        }

        function applyOpacity(color, opacity) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color.replace(/[^,]+(?=\))/, opacity);
        }

        function toggleHighlight(idx, el) {
            const chips = document.querySelectorAll('.legend-chip');
            if (highlightedDatasetIndex === idx) {
                highlightedDatasetIndex = null;
                chips.forEach(c => c.classList.remove('active'));
                lineChart.data.datasets.forEach((ds) => {
                    ds.borderWidth = ds.label === 'Average' ? 2 : 3;
                    ds.borderColor = applyOpacity(ds.borderColor, 1);
                });
            } else {
                highlightedDatasetIndex = idx;
                chips.forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                lineChart.data.datasets.forEach((ds, i) => {
                    const isT = i === idx;
                    ds.borderWidth = isT ? 6 : 1;
                    ds.borderColor = applyOpacity(ds.borderColor, isT ? 1 : 0.05);
                });
            }
            lineChart.update();
        }

        function renderRoster() {
            studentRoster.innerHTML = '';
            students.forEach(s => {
                const div = document.createElement('div');
                div.className = `student-item group flex items-center justify-between p-4 rounded-2xl border-4 border-e1dark cursor-pointer transition-all bg-white dark:bg-slate-800 ${currentStudentId === s.id ? 'active' : 'hover:bg-slate-50 dark:hover:bg-slate-700 shadow-neo'}`;
                div.onclick = () => switchStudent(s.id);
                div.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><i data-lucide="user" class="w-4 h-4 shrink-0"></i><span class="font-display font-bold truncate text-sm">${s.name || 'Anonymous'}</span></div><button onclick="event.stopPropagation(); deleteStudent('${s.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500"><i data-lucide="x-circle" class="w-5 h-5"></i></button>`;
                studentRoster.appendChild(div);
            });
            lucide.createIcons();
        }

        function addNewStudent() {
            const id = 's_' + Date.now();
            students.push({ id, name: 'Student ' + (students.length + 1) });
            saveStudents(); switchStudent(id); showToast("New student added!", "success");
        }

        function switchStudent(id) {
            if (currentStudentId) saveStudentData();
            currentStudentId = id;
            const s = students.find(x => x.id === id);
            studentNameInput.value = s ? s.name : '';
            document.getElementById('studentMeta').textContent = `ID: ${id}`;
            loadStudentData();
            renderRoster();
            updateFilters();
            updateAnalytics();
            renderTable();
        }

        function renderTable() {
            const old = document.querySelectorAll('.data-row');
            old.forEach(r => r.remove());
            emptyState.style.display = (!currentStudentId || !appData.length) ? 'block' : 'none';

            appData.forEach((d, idx) => {
                const tr = document.createElement('tr');
                tr.className = "data-row border-b-2 border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/20 group transition-colors";
                if (currentlyEditingIndex === idx) {
                    tr.classList.add('bg-e1orange/10');
                    tr.innerHTML = `
                        <td class="p-2"><input type="text" id="ed-cat" value="${d.category}" class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl px-2 py-2 text-xs font-bold"></td>
                        <td class="p-2"><input type="text" id="ed-mil" value="${d.milestone}" class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-xl px-2 py-2 text-xs font-bold"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-g" value="${d.gram}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-l" value="${d.listen}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-r" value="${d.read}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-s" value="${d.speak}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-v" value="${d.vocab}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-w" value="${d.write}" class="w-full text-center border-2 border-e1dark rounded-xl py-2"></td>
                        <td class="p-3 flex justify-center gap-2">
                            <button onclick="saveEdit(${idx})" class="text-e1green p-1"><i data-lucide="check-circle" class="w-6 h-6"></i></button>
                            <button onclick="cancelEdit()" class="text-slate-400 p-1"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
                        </td>`;
                } else {
                    tr.innerHTML = `
                        <td class="p-4 text-slate-500 dark:text-slate-400 text-xs italic font-black uppercase tracking-tight">${d.category}</td>
                        <td class="p-4 text-lg font-display text-e1dark dark:text-e1chalk">${d.milestone}</td>
                        <td class="p-2 text-center text-e1indigo font-display text-2xl">${d.gram}</td>
                        <td class="p-2 text-center text-e1orange font-display text-2xl">${d.listen}</td>
                        <td class="p-2 text-center text-e1blue font-display text-2xl">${d.read}</td>
                        <td class="p-2 text-center text-e1green font-display text-2xl">${d.speak}</td>
                        <td class="p-2 text-center text-e1violet font-display text-2xl">${d.vocab}</td>
                        <td class="p-2 text-center text-e1pink font-display text-2xl">${d.write}</td>
                        <td class="p-3 text-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex justify-center gap-2">
                                <button onclick="editRow(${idx})" class="text-slate-400 hover:text-e1blue p-2"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button onclick="deleteRow(${idx})" class="text-slate-400 hover:text-red-500 p-2"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </td>`;
                }
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function saveStudents() { localStorage.setItem('e1_v2_students', JSON.stringify(students)); }
        function saveStudentData() {
            if (!currentStudentId) return;
            localStorage.setItem(`e1_v2_scores_${currentStudentId}`, JSON.stringify(appData));
            const s = students.find(x => x.id === currentStudentId);
            if (s) { s.name = studentNameInput.value; saveStudents(); }
        }
        function loadStudentData() {
            const saved = localStorage.getItem(`e1_v2_scores_${currentStudentId}`);
            appData = saved ? JSON.parse(saved) : [];
        }
        function loadAll() {
            const savedList = localStorage.getItem('e1_v2_students');
            students = savedList ? JSON.parse(savedList) : [];
            if (students.length > 0) switchStudent(students[0].id);
            else renderRoster();
        }

        // Action handlers
        studentNameInput.addEventListener('input', () => { saveStudentData(); renderRoster(); });
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentStudentId) return showToast("Select student first.", "warning");
            const get = (id) => { const v = document.getElementById(id).value; return v === '' ? 0 : parseFloat(v); };
            const milField = document.getElementById('milestone');
            appData.push({
                category: document.getElementById('inCategory').value, milestone: milField.value,
                gram: get('inGrammar'), listen: get('inListening'), read: get('inReading'), speak: get('inSpeaking'), vocab: get('inVocab'), write: get('inWriting')
            });
            milField.value = incrementMilestone(milField.value);
            ['inGrammar', 'inListening', 'inReading', 'inSpeaking', 'inVocab', 'inWriting'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('inGrammar').focus();
            saveStudentData(); updateFilters(); updateAnalytics(); renderTable();
            showToast("Milestone saved!", "success");
        });

        window.editRow = (i) => { currentlyEditingIndex = i; renderTable(); };
        window.cancelEdit = () => { currentlyEditingIndex = null; renderTable(); };
        window.saveEdit = (i) => {
            const get = (id) => { const v = document.getElementById(id).value; return v === '' ? 0 : parseFloat(v); };
            appData[i] = { category: document.getElementById('ed-cat').value, milestone: document.getElementById('ed-mil').value, gram: get('ed-g'), listen: get('ed-l'), read: get('ed-r'), speak: get('ed-s'), vocab: get('ed-v'), write: get('ed-w') };
            currentlyEditingIndex = null; saveStudentData(); updateFilters(); updateAnalytics(); renderTable();
        };
        window.deleteRow = (i) => { if(confirm('Delete?')) { appData.splice(i, 1); saveStudentData(); updateAnalytics(); renderTable(); } };
        window.clearData = () => { if(confirm('Clear data?')) { appData = []; saveStudentData(); updateAnalytics(); renderTable(); } };

        function updateFilters() {
            const cats = [...new Set(appData.map(d => d.category))];
            const old = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="All">All Progression</option>';
            cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; categoryFilter.appendChild(o); });
            categoryFilter.value = cats.includes(old) ? old : 'All';
            currentFilter = categoryFilter.value;
        }

        // Fixed: Function name matched to updateAnalytics
        function handleFilterChange() {
            currentFilter = categoryFilter.value;
            updateAnalytics(); 
        }

        function triggerImport() { document.getElementById('importInput').click(); }
        function handleImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.csv')) importCSV(content);
                else { try { 
                    const data = JSON.parse(content); 
                    if (data.type === 'single_student') importSingleStudent(data); 
                    else if (data.type === 'full_database') importFullDatabase(data); 
                } catch(e) { alert("Invalid file"); }}
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        function importCSV(content) { 
            const lines = content.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length < 2) return;
            const headers = lines[0].split(",");
            const accountIdx = headers.indexOf("Account ID");
            const groupIdx = headers.indexOf("Group_Code");
            const skillIdx = headers.indexOf("skill");
            const scoreIdx = headers.indexOf("%PT Completion Current ");
            if (accountIdx === -1 || groupIdx === -1 || skillIdx === -1 || scoreIdx === -1) { showToast("Invalid CSV headers.", "error"); return; }
            const studentMap = {};
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(",");
                const accId = row[accountIdx];
                const groupCode = row[groupIdx];
                const skillName = row[skillIdx];
                const scoreRaw = row[scoreIdx] || "0";
                if (!accId || !groupCode || !skillName) continue;
                const score = parseFloat(scoreRaw.replace("%", "")) || 0;
                if (!studentMap[accId]) studentMap[accId] = { name: accId, milestones: {} };
                if (!studentMap[accId].milestones[groupCode]) studentMap[accId].milestones[groupCode] = { category: "KPI", milestone: groupCode, gram: 0, listen: 0, read: 0, speak: 0, vocab: 0, write: 0 };
                const m = studentMap[accId].milestones[groupCode];
                if (skillName === "Grammar") m.gram = score; else if (skillName === "Listening") m.listen = score; else if (skillName === "Reading") m.read = score; else if (skillName === "Speaking") m.speak = score; else if (skillName === "Vocabulary") m.vocab = score; else if (skillName === "Writing") m.write = score;
            }
            Object.keys(studentMap).forEach(accId => {
                const newId = 's_' + Date.now() + Math.random().toString(36).substr(2, 5);
                students.push({ id: newId, name: studentMap[accId].name });
                localStorage.setItem(`e1_v2_scores_${newId}`, JSON.stringify(Object.values(studentMap[accId].milestones)));
            });
            saveStudents(); loadAll(); showToast("CSV Imported", "success"); 
        }
        function importSingleStudent(d) { const nid = 's_'+Date.now(); students.push({id:nid, name:d.profile.name+" (Import)"}); localStorage.setItem(`e1_v2_scores_${nid}`, JSON.stringify(d.scores)); saveStudents(); switchStudent(nid); }
        function importFullDatabase(d) { d.students.forEach(s => { const nid = 's_'+Date.now()+Math.random(); students.push({id:nid, name:s.name}); localStorage.setItem(`e1_v2_scores_${nid}`, JSON.stringify(d.scores[s.id]||[])); }); saveStudents(); loadAll(); }
        function exportCurrentStudent() { const s = students.find(x=>x.id===currentStudentId); downloadJSON({type:'single_student', profile:s, scores:appData}, `Student_${s.name}.json`); }
        function exportAllData() { const data = {type:'full_database', students, scores: {}}; students.forEach(s=>data.scores[s.id]=JSON.parse(localStorage.getItem(`e1_v2_scores_${s.id}`)||'[]')); downloadJSON(data, "English1_Backup.json"); }
        function downloadJSON(d, f) { const blob = new Blob([JSON.stringify(d,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = f; a.click(); }

        const themeBtn = document.getElementById('themeToggle');
        themeBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            themeBtn.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}" class="w-5 h-5"></i> <span id="themeLabel">${isDark ? 'Whiteboard Mode' : 'Blackboard Mode'}</span>`;
            lineChart.destroy(); radarChart.destroy();
            initCharts(); updateAnalytics(); lucide.createIcons();
        });

        window.onload = () => { initCharts(); loadAll(); };
    </script>
</body>
</html>