<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Batam | Skill Tracker</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        e1indigo: '#6366f1',
                        e1violet: '#8b5cf6',
                        e1dark: '#1e293b',
                        e1chalk: '#f8fafc',
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(#cbd5e1 1px, transparent 1px),
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .dark body {
            background-color: #0f172a;
            background-image: 
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
        }

        .btn-neo {
            transition: all 0.1s ease;
        }
        .btn-neo:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px rgba(30, 41, 59, 1);
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .legend-chip {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .legend-chip.active {
            outline: 3px solid #1e293b;
            background-color: white;
            color: #1e293b;
        }
        .dark .legend-chip.active {
            outline-color: #f8fafc;
            background-color: #1e293b;
            color: white;
        }

        .student-item.active {
            background-color: #2979FF;
            color: white;
            border-color: #1e293b;
            transform: translateX(4px);
        }
    </style>
</head>
<body class="text-e1dark dark:text-e1chalk min-h-screen transition-colors duration-300">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- SIDEBAR -->
        <aside class="w-full lg:w-72 bg-white dark:bg-slate-900 border-b-4 lg:border-b-0 lg:border-r-4 border-e1dark z-40 p-6 flex flex-col gap-6 sticky top-0 h-auto lg:h-screen">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-e1pink rounded-lg border-2 border-e1dark shadow-neo flex items-center justify-center">
                    <i data-lucide="users" class="text-white w-6 h-6"></i>
                </div>
                <h2 class="font-display font-bold text-xl tracking-wide">Class Roster</h2>
            </div>

            <button onclick="addNewStudent()" class="w-full bg-e1green text-white font-display font-bold py-3 rounded-xl border-2 border-e1dark shadow-neo hover:-translate-y-1 btn-neo flex items-center justify-center gap-2">
                <i data-lucide="user-plus" class="w-5 h-5"></i> Add Student
            </button>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2" id="studentRoster">
                <!-- Students injected here -->
            </div>

            <div class="pt-4 border-t-2 border-slate-100 dark:border-slate-800 space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportAllData()" class="bg-e1blue text-white font-display font-bold py-2 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2 text-[10px] uppercase">
                        <i data-lucide="download" class="w-4 h-4"></i> Export All
                    </button>
                    <button onclick="triggerImport()" class="bg-e1indigo text-white font-display font-bold py-2 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2 text-[10px] uppercase">
                        <i data-lucide="upload" class="w-4 h-4"></i> Import File
                    </button>
                </div>

                <button id="themeToggle" class="w-full bg-e1orange text-white font-display font-bold py-2 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-2">
                    <i data-lucide="moon" class="w-5 h-5"></i> <span id="themeLabel">Blackboard Mode</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 lg:p-8 space-y-8 overflow-x-hidden">
            
            <!-- Navbar -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white dark:bg-slate-800 p-6 rounded-2xl border-4 border-e1dark shadow-neo">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-e1blue rounded-full border-4 border-e1dark shadow-neo flex items-center justify-center text-white">
                        <i data-lucide="user" class="w-8 h-8"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <input type="text" id="studentNameInput" placeholder="Enter student name..." class="block bg-transparent border-none p-0 font-display font-bold text-3xl focus:ring-0 placeholder-slate-400 w-full max-w-md">
                        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest" id="studentMeta">ID: Select a student</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="triggerImport()" class="bg-e1indigo text-white font-display font-bold py-2 px-4 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center gap-2 text-sm">
                        <i data-lucide="upload" class="w-4 h-4"></i> Import Student
                    </button>
                     <button onclick="exportCurrentStudent()" class="bg-e1green text-white font-display font-bold py-2 px-4 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center gap-2 text-sm">
                        <i data-lucide="user-down" class="w-4 h-4"></i> Export Student
                    </button>
                     <button onclick="clearData()" class="bg-red-500 text-white font-display font-bold py-2 px-4 rounded-xl border-2 border-e1dark shadow-neo btn-neo flex items-center gap-2 text-sm">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Hidden Global Import Input -->
            <input type="file" id="importInput" accept=".json,.csv" class="hidden" onchange="handleImport(event)">

            <!-- Chart -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl border-4 border-e1dark shadow-neo p-6 h-[480px] flex flex-col relative overflow-hidden">
                 <div class="absolute top-0 right-0 w-32 h-32 bg-e1green/10 rounded-bl-full -mr-4 -mt-4 pointer-events-none"></div>

                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div class="flex flex-col gap-2">
                        <h2 class="font-display font-bold text-2xl flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-6 h-6 text-e1green"></i> 
                            Trend Analysis
                        </h2>
                        <div class="flex items-center gap-2">
                            <label for="categoryFilter" class="text-xs font-bold text-slate-400 uppercase">Filter:</label>
                            <select id="categoryFilter" onchange="handleFilterChange()" class="bg-e1chalk dark:bg-slate-700 border-2 border-e1dark rounded-lg px-3 py-1 text-sm font-bold focus:ring-0">
                                <option value="All">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <!-- Legend Highlighting -->
                    <div id="customLegend" class="flex flex-wrap gap-2 text-xs font-bold justify-end max-w-lg">
                        <button onclick="toggleHighlight(0, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1indigo border border-e1dark"></span> Gram
                        </button>
                        <button onclick="toggleHighlight(1, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1orange border border-e1dark"></span> Listen
                        </button>
                        <button onclick="toggleHighlight(2, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1blue border border-e1dark"></span> Read
                        </button>
                        <button onclick="toggleHighlight(3, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1green border border-e1dark"></span> Speak
                        </button>
                        <button onclick="toggleHighlight(4, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1violet border border-e1dark"></span> Vocab
                        </button>
                        <button onclick="toggleHighlight(5, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-3 h-3 rounded-full bg-e1pink border border-e1dark"></span> Write
                        </button>
                        <button onclick="toggleHighlight(6, this)" class="legend-chip flex items-center gap-1.5 px-2 py-1.5 rounded-lg border-2 border-e1dark bg-white dark:bg-slate-700 shadow-neo-sm">
                            <span class="w-4 h-1 bg-e1dark border-b-2 border-dashed border-slate-500"></span> Avg
                        </button>
                    </div>
                </div>
                <div class="flex-1 w-full relative">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl border-4 border-e1dark shadow-neo overflow-hidden">
                <div class="p-4 bg-slate-50 dark:bg-slate-700/50 border-b-4 border-e1dark flex justify-between items-center">
                    <h2 class="font-display font-bold text-xl flex items-center gap-2">
                        <i data-lucide="table-2" class="w-5 h-5 text-e1blue"></i>
                        Milestone Data
                    </h2>
                </div>

                <div class="overflow-x-auto">
                    <form id="entryForm">
                        <table class="w-full text-left border-collapse min-w-[950px]">
                            <thead>
                                <tr class="text-slate-500 dark:text-slate-400 text-sm border-b-2 border-e1dark/20">
                                    <th class="p-4 font-display w-1/6">Category</th>
                                    <th class="p-4 font-display w-1/6">Milestone</th>
                                    <th class="p-2 text-center text-e1indigo w-20">Gram</th>
                                    <th class="p-2 text-center text-e1orange w-20">Listen</th>
                                    <th class="p-2 text-center text-e1blue w-20">Read</th>
                                    <th class="p-2 text-center text-e1green w-20">Speak</th>
                                    <th class="p-2 text-center text-e1violet w-20">Vocab</th>
                                    <th class="p-2 text-center text-e1pink w-20">Write</th>
                                    <th class="p-4 text-center w-32">Action</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="font-bold text-e1dark dark:text-e1chalk">
                                
                                <!-- INPUT ROW -->
                                <tr class="bg-e1blue/5 dark:bg-e1blue/10 border-b-4 border-e1dark/20">
                                    <td class="p-3">
                                        <input type="text" id="inCategory" placeholder="e.g. Starter A" required 
                                            class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg px-3 py-2 font-display text-sm">
                                    </td>
                                    <td class="p-3">
                                        <input type="text" id="milestone" placeholder="e.g. Unit 1" required 
                                            class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg px-3 py-2 font-display text-sm">
                                    </td>
                                    <td class="p-2"><input type="number" id="inGrammar" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-2"><input type="number" id="inListening" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-2"><input type="number" id="inReading" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-2"><input type="number" id="inSpeaking" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-2"><input type="number" id="inVocab" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-2"><input type="number" id="inWriting" min="0" max="120" step="0.01" class="w-full text-center bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg py-2"></td>
                                    <td class="p-3">
                                        <button type="submit" class="w-full bg-e1green text-white p-2 rounded-lg border-2 border-e1dark shadow-neo-sm btn-neo">
                                            <i data-lucide="plus" class="w-6 h-6 mx-auto"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                    <div id="emptyState" class="p-12 text-center text-slate-400 italic">No milestones yet.</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();

        // State
        let students = []; 
        let currentStudentId = null;
        let appData = []; 
        let chartInstance = null;
        let highlightedDatasetIndex = null;
        let currentlyEditingIndex = null;
        let currentFilter = 'All';

        const form = document.getElementById('entryForm');
        const tableBody = document.getElementById('dataTableBody');
        const emptyState = document.getElementById('emptyState');
        const studentNameInput = document.getElementById('studentNameInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const studentRoster = document.getElementById('studentRoster');

        // Chart Logic
        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            Chart.defaults.font.family = 'Nunito';
            Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Grammar', data: [], borderColor: '#6366f1', backgroundColor: '#6366f1', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Listening', data: [], borderColor: '#FF8C42', backgroundColor: '#FF8C42', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Reading', data: [], borderColor: '#2979FF', backgroundColor: '#2979FF', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Speaking', data: [], borderColor: '#00E676', backgroundColor: '#00E676', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Vocabulary', data: [], borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Writing', data: [], borderColor: '#FF6B95', backgroundColor: '#FF6B95', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointRadius: 5 },
                        { label: 'Average', data: [], borderColor: '#1e293b', backgroundColor: '#1e293b', borderWidth: 2, borderDash: [6, 4], tension: 0.3, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: 'Fredoka', size: 14 },
                            bodyFont: { family: 'Nunito', size: 12 },
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            callbacks: {
                                title: (ctxs) => {
                                    const filtered = getFilteredData();
                                    const item = filtered[ctxs[0].dataIndex];
                                    return `${item.category}: ${item.milestone}`;
                                },
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true, max: 120,
                            grid: { color: document.documentElement.classList.contains('dark') ? '#1e293b' : '#e2e8f0', borderDash: [4, 4] },
                            ticks: { 
                                font: { weight: 'bold' },
                                callback: (v) => v > 100 ? null : v
                            }
                        },
                        x: { grid: { display: false }, ticks: { font: { family: 'Fredoka', weight: 'bold' } } }
                    }
                }
            });
        }

        function getFilteredData() {
            return currentFilter === 'All' ? appData : appData.filter(d => d.category === currentFilter);
        }

        function handleFilterChange() {
            currentFilter = categoryFilter.value;
            updateChart();
        }

        function applyOpacity(color, opacity) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color.replace(/[^,]+(?=\))/, opacity);
        }

        function toggleHighlight(idx, el) {
            const chips = document.querySelectorAll('.legend-chip');
            if (highlightedDatasetIndex === idx) {
                highlightedDatasetIndex = null;
                chips.forEach(c => c.classList.remove('active'));
                chartInstance.data.datasets.forEach((ds) => {
                    ds.borderWidth = ds.label === 'Average' ? 2 : 3;
                    ds.borderColor = applyOpacity(ds.borderColor, 1);
                });
            } else {
                highlightedDatasetIndex = idx;
                chips.forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                chartInstance.data.datasets.forEach((ds, i) => {
                    const isT = i === idx;
                    ds.borderWidth = isT ? 6 : 1.2;
                    ds.borderColor = applyOpacity(ds.borderColor, isT ? 1 : 0.15);
                });
            }
            chartInstance.update();
        }

        function updateChart() {
            const f = getFilteredData();
            chartInstance.data.labels = f.map(d => currentFilter === 'All' ? `${d.category}` : d.milestone);
            const avgs = f.map(d => (d.gram + d.listen + d.read + d.speak + d.vocab + d.write) / 6);

            chartInstance.data.datasets[0].data = f.map(d => d.gram);
            chartInstance.data.datasets[1].data = f.map(d => d.listen);
            chartInstance.data.datasets[2].data = f.map(d => d.read);
            chartInstance.data.datasets[3].data = f.map(d => d.speak);
            chartInstance.data.datasets[4].data = f.map(d => d.vocab);
            chartInstance.data.datasets[5].data = f.map(d => d.write);
            chartInstance.data.datasets[6].data = avgs;

            chartInstance.update();
        }

        function renderRoster() {
            studentRoster.innerHTML = '';
            students.forEach(s => {
                const div = document.createElement('div');
                div.className = `student-item group flex items-center justify-between p-3 rounded-xl border-2 border-transparent cursor-pointer transition-all hover:bg-slate-50 dark:hover:bg-slate-800 ${currentStudentId === s.id ? 'active' : ''}`;
                div.onclick = () => switchStudent(s.id);
                div.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i data-lucide="user-round" class="w-4 h-4 shrink-0"></i>
                        <span class="font-bold truncate text-sm">${s.name || 'Anonymous'}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteStudent('${s.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                studentRoster.appendChild(div);
            });
            lucide.createIcons();
        }

        function addNewStudent() {
            const id = 's_' + Date.now();
            students.push({ id, name: 'Student ' + (students.length + 1) });
            saveStudents();
            switchStudent(id);
        }

        function switchStudent(id) {
            if (currentStudentId) saveStudentData();
            currentStudentId = id;
            const s = students.find(x => x.id === id);
            studentNameInput.value = s ? s.name : '';
            document.getElementById('studentMeta').textContent = `ID: ${id}`;
            loadStudentData();
            renderRoster();
            updateFilters();
            updateChart();
            renderTable();
        }

        function deleteStudent(id) {
            if (confirm('Delete student profile?')) {
                students = students.filter(x => x.id !== id);
                localStorage.removeItem(`e1_v2_scores_${id}`);
                saveStudents();
                if (currentStudentId === id) {
                    if (students.length) switchStudent(students[0].id);
                    else { currentStudentId = null; appData = []; renderRoster(); renderTable(); }
                } else renderRoster();
            }
        }

        function renderTable() {
            const old = document.querySelectorAll('.data-row');
            old.forEach(r => r.remove());
            emptyState.style.display = (!currentStudentId || !appData.length) ? 'block' : 'none';

            appData.forEach((d, idx) => {
                const tr = document.createElement('tr');
                tr.className = "data-row border-b-2 border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/20 group";
                
                if (currentlyEditingIndex === idx) {
                    tr.classList.add('bg-e1orange/5');
                    tr.innerHTML = `
                        <td class="p-2"><input type="text" id="ed-cat" value="${d.category}" class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded px-2 py-1 text-xs"></td>
                        <td class="p-2"><input type="text" id="ed-mil" value="${d.milestone}" class="w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded px-2 py-1 text-xs"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-g" value="${d.gram}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-l" value="${d.listen}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-r" value="${d.read}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-s" value="${d.speak}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-v" value="${d.vocab}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-1"><input type="number" step="0.01" id="ed-w" value="${d.write}" class="w-full text-center border-2 border-e1dark rounded py-1"></td>
                        <td class="p-3 flex justify-center gap-2">
                            <button onclick="saveEdit(${idx})" class="text-e1green border-2 border-e1green p-1.5 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button>
                            <button onclick="cancelEdit()" class="text-slate-400 border-2 border-slate-300 p-1.5 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td class="p-4 font-display text-slate-500 text-sm italic">${d.category}</td>
                        <td class="p-4 font-display font-bold text-lg">${d.milestone}</td>
                        <td class="p-2 text-center text-e1indigo text-lg">${d.gram}</td>
                        <td class="p-2 text-center text-e1orange text-lg">${d.listen}</td>
                        <td class="p-2 text-center text-e1blue text-lg">${d.read}</td>
                        <td class="p-2 text-center text-e1green text-lg">${d.speak}</td>
                        <td class="p-2 text-center text-e1violet text-lg">${d.vocab}</td>
                        <td class="p-2 text-center text-e1pink text-lg">${d.write}</td>
                        <td class="p-3 text-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex justify-center gap-2">
                                <button onclick="editRow(${idx})" class="text-slate-400 hover:text-e1blue p-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteRow(${idx})" class="text-slate-400 hover:text-red-500 p-2"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    `;
                }
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function saveStudents() { localStorage.setItem('e1_v2_students', JSON.stringify(students)); }
        function saveStudentData() {
            if (!currentStudentId) return;
            localStorage.setItem(`e1_v2_scores_${currentStudentId}`, JSON.stringify(appData));
            const s = students.find(x => x.id === currentStudentId);
            if (s) { s.name = studentNameInput.value; saveStudents(); }
        }
        function loadStudentData() {
            const saved = localStorage.getItem(`e1_v2_scores_${currentStudentId}`);
            appData = saved ? JSON.parse(saved) : [];
        }
        function loadAll() {
            const savedList = localStorage.getItem('e1_v2_students');
            students = savedList ? JSON.parse(savedList) : [];
            if (students.length > 0) switchStudent(students[0].id);
            else renderRoster();
        }

        // --- Import/Export ---
        function exportCurrentStudent() {
            if (!currentStudentId) return;
            const s = students.find(x => x.id === currentStudentId);
            const data = { type: 'single_student', profile: s, scores: appData };
            downloadJSON(data, `Student_${s.name.replace(/\s+/g, '_')}.json`);
        }

        function exportAllData() {
            if (!students.length) return;
            const data = { type: 'full_database', students: students, scores: {} };
            students.forEach(s => {
                const stored = localStorage.getItem(`e1_v2_scores_${s.id}`);
                data.scores[s.id] = stored ? JSON.parse(stored) : [];
            });
            downloadJSON(data, `English1_Backup.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function triggerImport() { document.getElementById('importInput').click(); }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if (file.name.endsWith('.csv')) {
                    importCSV(content);
                } else {
                    try {
                        const data = JSON.parse(content);
                        if (data.type === 'single_student') importSingleStudent(data);
                        else if (data.type === 'full_database') importFullDatabase(data);
                        else alert("Unknown JSON format.");
                    } catch (err) { alert("Invalid file."); }
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function importCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length < 2) return;

            const headers = lines[0].split(",");
            const accountIdx = headers.indexOf("Account ID");
            const groupIdx = headers.indexOf("Group_Code");
            const skillIdx = headers.indexOf("skill");
            const scoreIdx = headers.indexOf("%PT Completion Current ");

            if (accountIdx === -1 || groupIdx === -1 || skillIdx === -1 || scoreIdx === -1) {
                alert("CSV format not recognized. Ensure headers match the KPI report.");
                return;
            }

            const studentMap = {};

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(",");
                const accId = row[accountIdx];
                const groupCode = row[groupIdx];
                const skillName = row[skillIdx];
                const scoreRaw = row[scoreIdx] || "0";
                if (!accId || !groupCode || !skillName) continue;

                const score = parseFloat(scoreRaw.replace("%", "")) || 0;

                if (!studentMap[accId]) studentMap[accId] = { name: accId, milestones: {} };
                if (!studentMap[accId].milestones[groupCode]) {
                    studentMap[accId].milestones[groupCode] = { category: "KPI Import", milestone: groupCode, gram: 0, listen: 0, read: 0, speak: 0, vocab: 0, write: 0 };
                }

                const m = studentMap[accId].milestones[groupCode];
                if (skillName === "Grammar") m.gram = score;
                else if (skillName === "Listening") m.listen = score;
                else if (skillName === "Reading") m.read = score;
                else if (skillName === "Speaking") m.speak = score;
                else if (skillName === "Vocabulary") m.vocab = score;
                else if (skillName === "Writing") m.write = score;
            }

            const ids = Object.keys(studentMap);
            ids.forEach(accId => {
                const newId = 's_' + Date.now() + Math.random().toString(36).substr(2, 5);
                const sData = studentMap[accId];
                students.push({ id: newId, name: sData.name });
                const scoresArray = Object.values(sData.milestones);
                localStorage.setItem(`e1_v2_scores_${newId}`, JSON.stringify(scoresArray));
            });

            saveStudents();
            loadAll();
            alert(`Imported ${ids.length} student(s) from CSV.`);
        }

        function importSingleStudent(data) {
            const newId = 's_' + Date.now();
            students.push({ id: newId, name: data.profile.name + " (Imported)" });
            localStorage.setItem(`e1_v2_scores_${newId}`, JSON.stringify(data.scores));
            saveStudents(); switchStudent(newId);
        }

        function importFullDatabase(data) {
            if (!confirm("Merge database?")) return;
            data.students.forEach(s => {
                const nid = 's_' + Date.now() + Math.random().toString(36).substr(2, 5);
                students.push({ id: nid, name: s.name });
                localStorage.setItem(`e1_v2_scores_${nid}`, JSON.stringify(data.scores[s.id] || []));
            });
            saveStudents(); loadAll();
        }

        // Handlers
        studentNameInput.addEventListener('input', () => { saveStudentData(); renderRoster(); });
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentStudentId) return;
            const get = (id) => { const v = document.getElementById(id).value; return v === '' ? 0 : parseFloat(v); };
            appData.push({
                category: document.getElementById('inCategory').value,
                milestone: document.getElementById('milestone').value,
                gram: get('inGrammar'), listen: get('inListening'), read: get('inReading'), speak: get('inSpeaking'), vocab: get('inVocab'), write: get('inWriting')
            });
            form.reset(); document.getElementById('inCategory').focus();
            saveStudentData(); updateFilters(); updateChart(); renderTable();
        });

        window.editRow = (idx) => { currentlyEditingIndex = idx; renderTable(); };
        window.cancelEdit = () => { currentlyEditingIndex = null; renderTable(); };
        window.saveEdit = (idx) => {
            const get = (id) => { const v = document.getElementById(id).value; return v === '' ? 0 : parseFloat(v); };
            appData[idx] = {
                category: document.getElementById('ed-cat').value, milestone: document.getElementById('ed-mil').value,
                gram: get('ed-g'), listen: get('ed-l'), read: get('ed-r'), speak: get('ed-s'), vocab: get('ed-v'), write: get('ed-w')
            };
            currentlyEditingIndex = null; saveStudentData(); updateFilters(); updateChart(); renderTable();
        };
        window.deleteRow = (idx) => { if(confirm('Delete?')) { appData.splice(idx, 1); saveStudentData(); updateChart(); renderTable(); } };
        window.clearData = () => { if(confirm('Clear current student?')) { appData = []; saveStudentData(); updateChart(); renderTable(); } };

        function updateFilters() {
            const cats = [...new Set(appData.map(d => d.category))];
            const old = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="All">All Categories</option>';
            cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; categoryFilter.appendChild(o); });
            categoryFilter.value = cats.includes(old) ? old : 'All';
            currentFilter = categoryFilter.value;
        }

        const themeBtn = document.getElementById('themeToggle');
        themeBtn.addEventListener('click', () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            const labelText = isDark ? 'Whiteboard Mode' : 'Blackboard Mode';
            themeBtn.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}" class="w-5 h-5"></i> <span id="themeLabel">${labelText}</span>`;
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b'; 
            chartInstance.options.scales.y.grid.color = isDark ? '#1e293b' : '#e2e8f0';
            if (chartInstance.data.datasets[6]) {
                const isH = highlightedDatasetIndex === null || highlightedDatasetIndex === 6;
                chartInstance.data.datasets[6].borderColor = isH ? (isDark ? '#f8fafc' : '#1e293b') : applyOpacity(isDark ? '#f8fafc' : '#1e293b', 0.15);
                chartInstance.data.datasets[6].backgroundColor = chartInstance.data.datasets[6].borderColor;
            }
            chartInstance.update();
            lucide.createIcons();
        });

        initChart(); loadAll();
    </script>
</body>
</html>