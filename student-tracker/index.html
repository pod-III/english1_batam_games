<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Batam | Skill Tracker Pro</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        e1pink: '#FF6B95',
                        e1orange: '#FF8C42',
                        e1green: '#00E676',
                        e1blue: '#2979FF',
                        e1indigo: '#6366f1',
                        e1violet: '#8b5cf6',
                        e1dark: '#1e293b',
                        e1chalk: '#f8fafc',
                        e1paper: '#ffffff',
                    },
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-hover': '6px 6px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': '1px 1px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    borderWidth: {
                        '3': '3px',
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Base & Grid Background */
        body {
            background-color: #f8fafc;
            background-image:
                linear-gradient(#cbd5e1 1px, transparent 1px),
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .dark body {
            background-color: #0f172a;
            background-image:
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
        }

        /* Neo-Brutalist Interaction classes */
        .btn-neo {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-neo:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px 0px rgba(30, 41, 59, 1);
        }

        .btn-neo:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px rgba(30, 41, 59, 1);
        }

        /* Form Inputs */
        .input-neo {
            transition: all 0.2s ease;
            outline: none;
        }
        .input-neo:focus {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
            border-color: #2979FF;
        }

        /* Number Inputs Clean up */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }

        /* Animations */
        @keyframes toastIn {
            from { transform: translateY(100%) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .toast-animation {
            animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .student-item {
            transition: all 0.2s ease;
        }
        .student-item.active {
            background-color: #e0f2fe; /* light blue */
            border-color: #2979FF;
            transform: translateX(4px);
            box-shadow: 4px 4px 0px 0px rgba(30, 41, 59, 1);
        }
        .dark .student-item.active {
            background-color: #1e3a8a;
            border-color: #60a5fa;
        }

        /* Sidebar Collapse Styles */
        .sidebar-collapsed .hide-on-collapse {
            display: none !important;
        }
        .sidebar-collapsed .justify-start-important {
            justify-content: center !important;
        }
        .sidebar-collapsed .center-on-collapse {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        .sidebar-collapsed .logo-container {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body class="text-e1dark dark:text-e1chalk min-h-screen transition-colors duration-300 font-sans">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div class="flex flex-col lg:flex-row min-h-screen">

        <!-- SIDEBAR -->
        <aside id="mainSidebar"
            class="w-full lg:w-80 bg-e1paper dark:bg-slate-900 border-b-4 lg:border-b-0 lg:border-r-4 border-e1dark z-40 p-4 lg:p-6 flex flex-col gap-6 sticky top-0 h-auto lg:h-screen transition-all duration-300 ease-in-out relative group/sidebar">
            
            <!-- Toggle Button (Desktop Only) -->
            <button onclick="toggleSidebar()" class="hidden lg:flex absolute -right-[14px] top-9 w-7 h-7 bg-white dark:bg-slate-800 border-2 border-e1dark rounded-full items-center justify-center shadow-sm hover:scale-110 transition z-50">
                <i data-lucide="chevron-left" id="sidebarToggleIcon" class="w-4 h-4 text-e1dark dark:text-white transition-transform duration-300"></i>
            </button>

            <!-- Brand -->
            <div class="flex items-center gap-4 mb-2 select-none justify-start-important transition-all">
                <div class="logo-container w-14 h-14 bg-e1pink rounded-xl border-4 border-e1dark shadow-neo flex items-center justify-center shrink-0 rotate-[-3deg] hover:rotate-0 transition-transform duration-300">
                    <i data-lucide="graduation-cap" class="text-white w-8 h-8"></i>
                </div>
                <div class="hide-on-collapse whitespace-nowrap overflow-hidden">
                    <h1 class="font-display font-bold text-2xl tracking-tight leading-none text-e1dark dark:text-white">English 1</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-e1green animate-pulse"></span>
                        <p class="text-[11px] font-black uppercase tracking-widest text-e1blue">Skill Tracker</p>
                    </div>
                </div>
            </div>

            <!-- Add Student -->
            <button onclick="addNewStudent()" title="New Student"
                class="w-full bg-e1green text-white font-display font-bold py-4 rounded-xl border-4 border-e1dark shadow-neo btn-neo flex items-center justify-center gap-3 text-lg group center-on-collapse">
                <i data-lucide="plus-circle" class="w-6 h-6 group-hover:rotate-90 transition-transform"></i> 
                <span class="hide-on-collapse whitespace-nowrap">New Student</span>
            </button>

            <!-- Student List -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex items-center justify-between mb-2 px-1 hide-on-collapse">
                    <span class="text-xs font-black uppercase text-slate-400 tracking-wider">Class Roster</span>
                    <span id="studentCount" class="bg-e1dark text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <!-- Centered header for collapsed state -->
                <div class="hidden text-center mb-2 px-1 sidebar-collapsed:block">
                     <i data-lucide="users" class="w-4 h-4 mx-auto text-slate-400"></i>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar pb-4" id="studentRoster">
                    <!-- Students injected here -->
                </div>
            </div>

            <!-- Sidebar Footer Actions -->
            <div class="pt-4 border-t-4 border-e1dark/10 space-y-3">
                <div class="grid grid-cols-2 sidebar-collapsed:grid-cols-1 gap-3">
                    <button onclick="exportAllData()" title="Backup Database"
                        class="bg-e1blue text-white font-display font-bold py-3 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-xs uppercase hover:bg-blue-600 center-on-collapse">
                        <i data-lucide="hard-drive-download" class="w-4 h-4 shrink-0"></i> <span class="hide-on-collapse">Backup</span>
                    </button>
                    <!-- Legacy/Global Import Button (Kept as requested) -->
                    <button onclick="triggerImport()" title="Restore DB / Import"
                        class="bg-e1indigo text-white font-display font-bold py-3 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-xs uppercase hover:bg-indigo-600 center-on-collapse">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 shrink-0"></i> <span class="hide-on-collapse">Restore</span>
                    </button>
                </div>

                <button id="themeToggle" title="Toggle Theme"
                    class="w-full bg-e1orange text-white font-display font-bold py-3 rounded-xl border-4 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-sm hover:bg-orange-500 center-on-collapse">
                    <i data-lucide="moon" class="w-5 h-5 shrink-0"></i> 
                    <span id="themeLabel" class="hide-on-collapse whitespace-nowrap">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 lg:p-8 space-y-8 overflow-x-hidden max-w-[1920px] mx-auto w-full">

            <!-- Student Header Profile -->
            <div id="studentHeader"
                class="bg-white dark:bg-slate-800 p-6 lg:p-8 rounded-[2rem] border-4 border-e1dark shadow-neo relative overflow-hidden transition-all duration-300">
                
                <!-- Decorative BG Element -->
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-e1blue/10 rounded-full blur-3xl pointer-events-none"></div>

                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative z-10">
                    <div class="flex items-center gap-6 w-full max-w-3xl">
                        <!-- Avatar -->
                        <div class="w-20 h-20 bg-e1chalk dark:bg-slate-700 rounded-2xl border-4 border-e1dark shadow-neo-sm flex items-center justify-center text-e1dark dark:text-e1chalk shrink-0 group">
                            <i data-lucide="user" class="w-10 h-10 group-hover:scale-110 transition-transform"></i>
                        </div>
                        
                        <!-- Name Input -->
                        <div class="flex-1 min-w-0 space-y-1">
                            <label class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Student Name</label>
                            <input type="text" id="studentNameInput" placeholder="Enter student name..."
                                class="block w-full bg-transparent border-none p-0 font-display font-bold text-3xl lg:text-4xl focus:ring-0 placeholder-slate-300 dark:placeholder-slate-600 text-e1dark dark:text-white truncate focus:text-e1blue transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded border border-slate-200 dark:border-slate-600 uppercase tracking-wider" id="studentMeta">ID: ---</span>
                            </div>
                        </div>
                    </div>

                    <!-- Header Actions -->
                    <div class="flex flex-wrap gap-3 shrink-0 w-full md:w-auto mt-4 md:mt-0">
                        <!-- MOVED IMPORT BUTTON HERE -->
                        <button onclick="triggerImport()" title="Import CSV or JSON"
                            class="flex-1 md:flex-none bg-e1indigo text-white font-display font-bold py-3 px-5 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="file-up" class="w-4 h-4"></i> Import Data
                        </button>
                        
                        <button onclick="exportCurrentStudent()" title="Export Single Profile"
                            class="flex-1 md:flex-none bg-white dark:bg-slate-700 text-e1dark dark:text-white font-display font-bold py-3 px-5 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="share-2" class="w-4 h-4"></i> Export JSON
                        </button>
                        
                        <button onclick="clearData()" title="Reset Student Scores"
                            class="flex-1 md:flex-none bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-display font-bold py-3 px-5 rounded-xl border-3 border-e1dark shadow-neo-sm btn-neo flex items-center justify-center gap-2 text-sm hover:bg-red-200 dark:hover:bg-red-900/50">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <input type="file" id="importInput" accept=".json,.csv,.txt" class="hidden" onchange="handleImport(event)">

            <!-- ANALYTICS GRID -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-8">

                <!-- Main Chart Card -->
                <div class="xl:col-span-2 bg-white dark:bg-slate-800 rounded-[2rem] border-4 border-e1dark shadow-neo p-6 lg:p-8 flex flex-col">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h2 class="font-display font-bold text-2xl flex items-center gap-2">
                                <i data-lucide="activity" class="w-6 h-6 text-e1green"></i>
                                Progression History
                            </h2>
                            <p class="text-xs text-slate-400 font-bold mt-1">Track scores across milestones</p>
                        </div>
                        
                        <div class="bg-slate-100 dark:bg-slate-900 p-1 rounded-xl border-2 border-e1dark flex gap-2">
                            <select id="categoryFilter" onchange="handleFilterChange()"
                                class="bg-transparent border-none py-1 pl-2 pr-8 text-sm font-bold focus:ring-0 cursor-pointer text-e1dark dark:text-white rounded-lg">
                                <option value="All">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div id="customLegend" class="flex flex-wrap gap-2 mb-4">
                        <button onclick="toggleHighlight(0, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1indigo ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Grammar</span>
                        </button>
                        <button onclick="toggleHighlight(1, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1orange ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Listening</span>
                        </button>
                        <button onclick="toggleHighlight(2, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1blue ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Reading</span>
                        </button>
                        <button onclick="toggleHighlight(3, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1green ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Speaking</span>
                        </button>
                        <button onclick="toggleHighlight(4, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1violet ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Vocab</span>
                        </button>
                        <button onclick="toggleHighlight(5, this)" class="legend-chip group flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-e1dark bg-slate-50 dark:bg-slate-900/50 transition-all">
                            <span class="w-2.5 h-2.5 rounded-full bg-e1pink ring-1 ring-inset ring-black/10"></span> <span class="text-[10px] font-bold uppercase tracking-wide">Writing</span>
                        </button>
                    </div>

                    <!-- Chart Area -->
                    <div class="h-[350px] w-full relative bg-slate-50 dark:bg-slate-900/30 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-700 p-2 flex items-center justify-center">
                         <div id="chartPlaceholder" class="absolute text-slate-400 font-display text-sm">Add data to visualize progress</div>
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- Stats Sidebar -->
                <div class="flex flex-col gap-6 lg:gap-8">
                    <!-- Radar -->
                    <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-4 border-e1dark shadow-neo p-6 flex flex-col h-[400px]">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-display font-bold text-xl flex items-center gap-2">
                                    <i data-lucide="crosshair" class="w-5 h-5 text-e1pink"></i>
                                    Skill Shape
                                </h3>
                            </div>
                            <div class="flex flex-col items-end">
                                <label class="text-[8px] font-black uppercase text-slate-400 mb-1">Moving Avg (N)</label>
                                <input type="number" id="radarWindow" value="1" min="1" max="20"
                                    onchange="updateAnalytics()"
                                    class="w-12 bg-slate-100 dark:bg-slate-900 border-2 border-e1dark rounded-lg px-1 py-0.5 text-center font-bold text-xs focus:ring-0">
                            </div>
                        </div>
                        <div class="flex-1 relative flex items-center justify-center">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-e1dark text-white rounded-[2rem] border-4 border-e1dark shadow-neo p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="zap" class="w-24 h-24"></i>
                        </div>
                        <div class="grid grid-cols-2 gap-6 relative z-10">
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Latest Avg</p>
                                <p class="text-3xl font-display font-bold text-e1green" id="statAvg">--%</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Entries</p>
                                <p class="text-3xl font-display font-bold text-white" id="statCount">0</p>
                            </div>
                            <div class="col-span-2 pt-4 border-t border-slate-700">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Top Skill</p>
                                <div id="statBest" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-600 text-xs font-bold text-e1blue">
                                    <span>---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Entry Table -->
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-4 border-e1dark shadow-neo overflow-hidden flex flex-col">
                <div class="p-6 bg-slate-50 dark:bg-slate-900 border-b-4 border-e1dark flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="font-display font-bold text-2xl flex items-center gap-3">
                        <div class="p-2 bg-e1orange rounded-lg border-2 border-e1dark text-white">
                            <i data-lucide="table-2" class="w-5 h-5"></i>
                        </div>
                        Data Log
                    </h2>
                    <p class="text-xs font-bold text-slate-400">Values range: 0 - 120</p>
                </div>

                <div class="overflow-x-auto custom-scrollbar">
                    <form id="entryForm" class="min-w-[1000px]">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-100 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 text-[10px] font-black uppercase tracking-widest border-b-4 border-e1dark">
                                    <th class="p-4 w-48">Category</th>
                                    <th class="p-4 w-32">Milestone</th>
                                    <th class="p-2 text-center text-e1indigo w-24">Gram</th>
                                    <th class="p-2 text-center text-e1orange w-24">List</th>
                                    <th class="p-2 text-center text-e1blue w-24">Read</th>
                                    <th class="p-2 text-center text-e1green w-24">Speak</th>
                                    <th class="p-2 text-center text-e1violet w-24">Vocab</th>
                                    <th class="p-2 text-center text-e1pink w-24">Write</th>
                                    <th class="p-4 text-center w-24">Save</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="font-bold text-e1dark dark:text-e1chalk">
                                <!-- INPUT ROW (Sticky-ish feel) -->
                                <tr class="bg-e1chalk dark:bg-slate-900 border-b-4 border-e1dark relative z-10 shadow-sm">
                                    <td class="p-3 pl-4">
                                        <input type="text" id="inCategory" placeholder="e.g. Starter A" required list="categoryHints"
                                            class="input-neo w-full bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl px-3 py-3 font-display text-sm focus:border-e1blue">
                                        <datalist id="categoryHints">
                                            <option value="Starter A">
                                            <option value="Starter B">
                                            <option value="Mover A">
                                            <option value="Mover B">
                                            <option value="Flyer A">
                                        </datalist>
                                    </td>
                                    <td class="p-3">
                                        <input type="text" id="milestone" placeholder="Unit 1" required
                                            class="input-neo w-full bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl px-3 py-3 font-display text-sm focus:border-e1blue">
                                    </td>
                                    <td class="p-2"><input type="number" id="inGrammar" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-2"><input type="number" id="inListening" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-2"><input type="number" id="inReading" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-2"><input type="number" id="inSpeaking" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-2"><input type="number" id="inVocab" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-2"><input type="number" id="inWriting" min="0" max="120" placeholder="-" class="input-neo w-full text-center bg-white dark:bg-slate-800 border-2 border-e1dark rounded-xl py-3 text-sm"></td>
                                    <td class="p-3 text-center">
                                        <button type="submit"
                                            class="w-12 h-12 bg-e1green text-white rounded-xl border-3 border-e1dark shadow-neo btn-neo flex items-center justify-center mx-auto">
                                            <i data-lucide="plus" class="w-6 h-6"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Data rows will be appended here -->
                            </tbody>
                        </table>
                    </form>
                    
                    <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-center border-t border-slate-100 dark:border-slate-800">
                        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="clipboard-list" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <h3 class="font-display font-bold text-lg text-slate-500">No Records Found</h3>
                        <p class="text-sm text-slate-400 max-w-xs mt-1">Use the input row above to add the first milestone for this student.</p>
                    </div>
                </div>
            </div>
            
            <footer class="text-center py-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">
                English 1 Batam &copy; 2026
            </footer>
        </main>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="fixed inset-0 bg-e1dark/80 backdrop-blur-sm transition-opacity" onclick="closeDeleteModal()"></div>
        <div class="bg-white dark:bg-slate-900 border-4 border-e1dark rounded-[2rem] shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] max-w-sm w-full p-8 relative z-10 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-2xl border-4 border-e1dark shadow-neo flex items-center justify-center text-red-500 mb-6 mx-auto rotate-3">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 class="font-display font-bold text-2xl text-center mb-2 text-e1dark dark:text-white">Delete Student?</h3>
            <p class="text-slate-500 dark:text-slate-400 text-center font-sans font-medium mb-8">This action cannot be undone. All grade history for this student will be lost.</p>
            <div class="flex flex-col gap-3">
                <button id="confirmDeleteBtn" class="w-full bg-red-500 text-white font-display font-bold py-4 rounded-xl border-4 border-e1dark shadow-neo btn-neo text-lg">
                    Delete Permanently
                </button>
                <button onclick="closeDeleteModal()" class="w-full bg-white dark:bg-slate-800 text-e1dark dark:text-white font-display font-bold py-3 rounded-xl border-4 border-e1dark shadow-neo btn-neo">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        // --- Toast System ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const styles = {
                info: 'bg-e1blue border-e1blue', 
                success: 'bg-e1green border-e1green', 
                error: 'bg-red-500 border-red-500', 
                warning: 'bg-e1orange border-e1orange'
            };
            
            toast.className = `${styles[type]} text-white pl-4 pr-6 py-4 rounded-xl border-4 shadow-neo toast-animation flex items-center gap-3 font-bold text-sm min-w-[300px] pointer-events-auto`;
            
            // Icon selection
            let iconName = 'info';
            if(type === 'success') iconName = 'check-circle';
            if(type === 'error') iconName = 'alert-octagon';
            if(type === 'warning') iconName = 'alert-triangle';

            toast.innerHTML = `
                <i data-lucide="${iconName}" class="w-6 h-6 shrink-0"></i>
                <span class="flex-1 font-display tracking-wide">${message}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons({ root: toast });
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px) scale(0.9)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- State Management ---
        let students = [];
        let currentStudentId = null;
        let appData = [];
        let lineChart = null;
        let radarChart = null;
        let highlightedDatasetIndex = null;
        let currentlyEditingIndex = null;
        let currentFilter = 'All';
        let studentToDeleteId = null;
        let isSidebarCollapsed = false;

        const form = document.getElementById('entryForm');
        const tableBody = document.getElementById('dataTableBody');
        const emptyState = document.getElementById('emptyState');
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const studentNameInput = document.getElementById('studentNameInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const studentRoster = document.getElementById('studentRoster');
        const studentCountLabel = document.getElementById('studentCount');

        // --- Helpers ---
        function incrementMilestone(str) {
            const hasNumber = /\d+/.test(str);
            if (!hasNumber) return str;
            return str.replace(/(\d+)(?!.*\d)/, (match) => parseInt(match) + 1);
        }

        function getSafeValue(id) {
            const val = document.getElementById(id).value;
            return val === '' ? 0 : parseFloat(val);
        }

        // --- Charts ---
        function initCharts() {
            // Check if charts exist and destroy (for theme toggle)
            if (lineChart) lineChart.destroy();
            if (radarChart) radarChart.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(30, 41, 59, 0.1)';
            const tickColor = isDark ? '#94a3b8' : '#64748b';
            const fontFamily = "'Fredoka', sans-serif";

            // Line Chart
            const lineCtx = document.getElementById('progressChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Grammar', data: [], borderColor: '#6366f1', backgroundColor: '#6366f1', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Listening', data: [], borderColor: '#FF8C42', backgroundColor: '#FF8C42', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Reading', data: [], borderColor: '#2979FF', backgroundColor: '#2979FF', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Speaking', data: [], borderColor: '#00E676', backgroundColor: '#00E676', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Vocab', data: [], borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Writing', data: [], borderColor: '#FF6B95', backgroundColor: '#FF6B95', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                        { label: 'Average', data: [], borderColor: isDark ? '#f8fafc' : '#1e293b', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0, pointHoverRadius: 0, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: isDark ? '#1e293b' : '#ffffff',
                            titleColor: isDark ? '#fff' : '#1e293b',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: '#1e293b',
                            borderWidth: 2,
                            titleFont: { family: fontFamily, size: 14 },
                            bodyFont: { family: 'Nunito', weight: 'bold' },
                            padding: 12,
                            boxPadding: 4,
                            cornerRadius: 8,
                            displayColors: true,
                            usePointStyle: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true, max: 120, 
                            grid: { color: gridColor, borderDash: [4, 4] },
                            ticks: { color: tickColor, font: { family: 'Nunito', weight: 'bold' } }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: tickColor, font: { family: fontFamily, weight: 'bold' } } 
                        }
                    }
                }
            });

            // Radar Chart
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['Gram', 'Listen', 'Read', 'Speak', 'Vocab', 'Write'],
                    datasets: [{
                        label: 'Skill Shape',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(41, 121, 255, 0.2)',
                        borderColor: '#2979FF',
                        borderWidth: 3,
                        pointBackgroundColor: '#2979FF',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0, max: 100,
                            grid: { color: gridColor, circular: true },
                            angleLines: { color: gridColor },
                            pointLabels: { 
                                color: tickColor, 
                                font: { family: fontFamily, weight: 'bold', size: 11 },
                                backdropColor: 'transparent' // Remove label bg
                            },
                            ticks: { display: false, stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Core Logic ---
        function updateAnalytics() {
            if (!lineChart) return;
            
            const filtered = currentFilter === 'All' ? appData : appData.filter(d => d.category === currentFilter);
            
            // Show/Hide placeholder
            if (filtered.length === 0) {
                chartPlaceholder.style.display = 'block';
            } else {
                chartPlaceholder.style.display = 'none';
            }

            // 1. Line Chart Data
            lineChart.data.labels = filtered.map(d => currentFilter === 'All' ? `${d.category.substring(0,3)} ${d.milestone}` : d.milestone);
            
            const metrics = ['gram', 'listen', 'read', 'speak', 'vocab', 'write'];
            metrics.forEach((m, i) => {
                lineChart.data.datasets[i].data = filtered.map(d => d[m]);
            });
            // Avg line
            lineChart.data.datasets[6].data = filtered.map(d => 
                (d.gram + d.listen + d.read + d.speak + d.vocab + d.write) / 6
            );
            
            lineChart.update();

            // 2. Radar & Stats
            const windowSize = parseInt(document.getElementById('radarWindow').value) || 1;
            
            if (filtered.length > 0) {
                const windowData = filtered.slice(-windowSize);
                const sums = { gram: 0, listen: 0, read: 0, speak: 0, vocab: 0, write: 0 };
                
                windowData.forEach(item => {
                    metrics.forEach(m => sums[m] += item[m]);
                });
                
                const count = windowData.length;
                const avgs = metrics.map(m => sums[m] / count);
                
                radarChart.data.datasets[0].data = avgs;
                radarChart.update();

                // Stats Cards
                const lastEntry = filtered[filtered.length - 1];
                const lastVals = metrics.map(m => lastEntry[m]);
                const overallAvg = lastVals.reduce((a, b) => a + b, 0) / 6;

                document.getElementById('statAvg').textContent = overallAvg.toFixed(1) + '%';
                document.getElementById('statCount').textContent = filtered.length;
                
                const labels = ['Grammar', 'Listening', 'Reading', 'Speaking', 'Vocabulary', 'Writing'];
                const bestIndex = avgs.indexOf(Math.max(...avgs));
                document.getElementById('statBest').textContent = labels[bestIndex];
            } else {
                radarChart.data.datasets[0].data = [0,0,0,0,0,0];
                radarChart.update();
                document.getElementById('statAvg').textContent = '--';
                document.getElementById('statCount').textContent = '0';
                document.getElementById('statBest').textContent = '---';
            }
        }

        function toggleHighlight(idx, el) {
            // Reset others
            const allChips = document.querySelectorAll('.legend-chip');
            
            if (highlightedDatasetIndex === idx) {
                // Deactivate
                highlightedDatasetIndex = null;
                allChips.forEach(c => {
                    c.classList.remove('ring-2', 'ring-e1dark', 'bg-slate-200');
                    c.style.opacity = '1';
                });
                
                lineChart.data.datasets.forEach(ds => {
                    ds.hidden = false;
                    // Restore opacity logic if needed, but simple hide/show is cleaner for users
                    ds.borderColor = ds.borderColor.replace('0.2)', '1)'); 
                });
            } else {
                // Activate
                highlightedDatasetIndex = idx;
                allChips.forEach(c => {
                    c.classList.remove('ring-2', 'ring-e1dark');
                    c.style.opacity = '0.4';
                });
                el.style.opacity = '1';
                el.classList.add('ring-2', 'ring-e1dark');

                lineChart.data.datasets.forEach((ds, i) => {
                    if (i === 6) return; // Keep average always? Maybe not.
                    if (i !== idx) ds.hidden = true;
                    else ds.hidden = false;
                });
            }
            lineChart.update();
        }

        // --- Renderers ---
        function renderRoster() {
            studentRoster.innerHTML = '';
            studentCountLabel.innerText = students.length;
            
            students.forEach(s => {
                const isActive = currentStudentId === s.id;
                const div = document.createElement('div');
                div.className = `student-item group flex items-center p-4 rounded-xl border-2 border-transparent hover:border-slate-200 dark:hover:border-slate-700 cursor-pointer ${isActive ? 'active' : 'hover:bg-white dark:hover:bg-slate-800'}`;
                
                if (isSidebarCollapsed) {
                    div.classList.add('justify-center'); // Center icon
                } else {
                    div.classList.add('justify-between');
                }

                // Color generator based on name (just for fun avatar bg)
                const initials = s.name.substring(0,2).toUpperCase();
                
                div.onclick = () => switchStudent(s.id);
                
                // Smart rendering based on collapse state
                let contentHTML = '';
                if (isSidebarCollapsed) {
                     // Compact View
                     contentHTML = `
                         <div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xs font-black text-slate-500 border-2 border-slate-200 dark:border-slate-600 relative shrink-0">
                            ${initials}
                            ${isActive ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-e1blue rounded-full border-2 border-white dark:border-slate-900"></span>' : ''}
                        </div>
                     `;
                } else {
                    // Full View
                    contentHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-[10px] font-black text-slate-500 border-2 border-slate-200 dark:border-slate-600 shrink-0">
                                ${initials}
                            </div>
                            <span class="font-display font-bold truncate text-sm text-slate-700 dark:text-slate-200">${s.name}</span>
                        </div>
                        <button onclick="event.stopPropagation(); deleteStudent('${s.id}')" class="opacity-0 group-hover:opacity-100 p-1.5 hover:bg-red-100 text-slate-400 hover:text-red-500 rounded-lg transition-all shrink-0">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                }
                
                div.innerHTML = contentHTML;
                studentRoster.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderTable() {
            const old = document.querySelectorAll('.data-row');
            old.forEach(r => r.remove());

            if (!currentStudentId || appData.length === 0) {
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                
                // Render in reverse order (newest top)
                [...appData].reverse().forEach((d, reverseIdx) => {
                    const idx = appData.length - 1 - reverseIdx; // Actual index
                    const tr = document.createElement('tr');
                    tr.className = "data-row border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 group transition-colors";

                    if (currentlyEditingIndex === idx) {
                        tr.classList.add('bg-e1orange/5');
                        tr.innerHTML = `
                            <td class="p-2 pl-4"><input type="text" id="ed-cat" value="${d.category}" class="input-neo w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg px-2 py-2 text-xs font-bold"></td>
                            <td class="p-2"><input type="text" id="ed-mil" value="${d.milestone}" class="input-neo w-full bg-white dark:bg-slate-900 border-2 border-e1dark rounded-lg px-2 py-2 text-xs font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-g" value="${d.gram}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-indigo-600 font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-l" value="${d.listen}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-orange-600 font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-r" value="${d.read}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-blue-600 font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-s" value="${d.speak}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-emerald-600 font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-v" value="${d.vocab}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-violet-600 font-bold"></td>
                            <td class="p-1"><input type="number" id="ed-w" value="${d.write}" class="input-neo w-full text-center border-2 border-e1dark rounded-lg py-2 text-rose-600 font-bold"></td>
                            <td class="p-2 text-center">
                                <div class="flex gap-1 justify-center">
                                    <button onclick="saveEdit(${idx})" class="text-e1green hover:bg-green-100 p-1 rounded"><i data-lucide="check" class="w-5 h-5"></i></button>
                                    <button onclick="cancelEdit()" class="text-slate-400 hover:bg-slate-100 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                            </td>`;
                    } else {
                        tr.innerHTML = `
                            <td class="p-4 pl-4">
                                <span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider">${d.category}</span>
                            </td>
                            <td class="p-4 text-sm font-display font-bold text-slate-700 dark:text-slate-200">${d.milestone}</td>
                            <td class="p-2 text-center text-e1indigo font-display text-lg font-bold">${d.gram}</td>
                            <td class="p-2 text-center text-e1orange font-display text-lg font-bold">${d.listen}</td>
                            <td class="p-2 text-center text-e1blue font-display text-lg font-bold">${d.read}</td>
                            <td class="p-2 text-center text-e1green font-display text-lg font-bold">${d.speak}</td>
                            <td class="p-2 text-center text-e1violet font-display text-lg font-bold">${d.vocab}</td>
                            <td class="p-2 text-center text-e1pink font-display text-lg font-bold">${d.write}</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editRow(${idx})" class="text-slate-400 hover:text-e1blue hover:bg-blue-50 p-2 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="deleteRow(${idx})" class="text-slate-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                </div>
                            </td>`;
                    }
                    tableBody.appendChild(tr);
                });
            }
            lucide.createIcons();
        }

        // --- Data Operations ---
        function addNewStudent() {
            const id = 's_' + Date.now();
            students.push({ id, name: 'Student ' + (students.length + 1) });
            saveStudents(); 
            switchStudent(id); 
            showToast("New student profile created", "success");
        }

        function switchStudent(id) {
            if (currentStudentId) saveStudentData();
            currentStudentId = id;
            
            const s = students.find(x => x.id === id);
            studentNameInput.value = s ? s.name : '';
            document.getElementById('studentMeta').textContent = `ID: ${id.substring(2, 8)}...`;
            
            loadStudentData();
            renderRoster(); // Re-render to update active state
            updateFilters();
            updateAnalytics();
            renderTable();
        }

        function saveStudents() { localStorage.setItem('e1_v2_students', JSON.stringify(students)); }
        function saveStudentData() {
            if (!currentStudentId) return;
            localStorage.setItem(`e1_v2_scores_${currentStudentId}`, JSON.stringify(appData));
            const s = students.find(x => x.id === currentStudentId);
            if (s) { s.name = studentNameInput.value; saveStudents(); }
        }
        function loadStudentData() {
            const saved = localStorage.getItem(`e1_v2_scores_${currentStudentId}`);
            appData = saved ? JSON.parse(saved) : [];
        }
        function loadAll() {
            const savedList = localStorage.getItem('e1_v2_students');
            students = savedList ? JSON.parse(savedList) : [];
            if (students.length > 0) switchStudent(students[0].id);
            else {
                renderRoster();
                updateAnalytics(); // clear charts
            }
        }

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const icon = document.getElementById('sidebarToggleIcon');
            
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (isSidebarCollapsed) {
                // Collapse
                sidebar.classList.remove('lg:w-80');
                sidebar.classList.add('lg:w-24', 'sidebar-collapsed');
                icon.classList.add('rotate-180');
            } else {
                // Expand
                sidebar.classList.remove('lg:w-24', 'sidebar-collapsed');
                sidebar.classList.add('lg:w-80');
                icon.classList.remove('rotate-180');
            }
            
            // Re-render roster to show avatars vs list
            renderRoster();
            lucide.createIcons();
        }

        // --- Event Listeners ---
        studentNameInput.addEventListener('input', () => { 
            saveStudentData(); 
            // Debounce roster update slightly
            clearTimeout(window.nameUpdateTimer);
            window.nameUpdateTimer = setTimeout(renderRoster, 500);
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentStudentId) return showToast("Create or select a student first!", "warning");
            
            const milField = document.getElementById('milestone');
            
            appData.push({
                category: document.getElementById('inCategory').value, 
                milestone: milField.value,
                gram: getSafeValue('inGrammar'), 
                listen: getSafeValue('inListening'), 
                read: getSafeValue('inReading'), 
                speak: getSafeValue('inSpeaking'), 
                vocab: getSafeValue('inVocab'), 
                write: getSafeValue('inWriting')
            });
            
            milField.value = incrementMilestone(milField.value);
            // Clear numbers but keep Category
            ['inGrammar', 'inListening', 'inReading', 'inSpeaking', 'inVocab', 'inWriting'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('inGrammar').focus();
            
            saveStudentData(); 
            updateFilters(); 
            updateAnalytics(); 
            renderTable();
            showToast("Data point added", "success");
        });

        // --- Editing ---
        window.editRow = (i) => { currentlyEditingIndex = i; renderTable(); };
        window.cancelEdit = () => { currentlyEditingIndex = null; renderTable(); };
        window.saveEdit = (i) => {
            const getEdit = (id) => { const v = document.getElementById(id).value; return v === '' ? 0 : parseFloat(v); };
            appData[i] = { 
                category: document.getElementById('ed-cat').value, 
                milestone: document.getElementById('ed-mil').value, 
                gram: getEdit('ed-g'), listen: getEdit('ed-l'), read: getEdit('ed-r'), 
                speak: getEdit('ed-s'), vocab: getEdit('ed-v'), write: getEdit('ed-w') 
            };
            currentlyEditingIndex = null; 
            saveStudentData(); updateFilters(); updateAnalytics(); renderTable();
            showToast("Entry updated", "success");
        };
        window.deleteRow = (i) => { 
            if (confirm('Delete this entry permanently?')) { 
                appData.splice(i, 1); 
                saveStudentData(); updateAnalytics(); renderTable(); 
                showToast("Entry deleted", "info");
            } 
        };
        window.clearData = () => { 
            if (confirm('Clear all score data for this student?')) { 
                appData = []; 
                saveStudentData(); updateAnalytics(); renderTable(); 
                showToast("Data cleared", "info");
            } 
        };

        // --- Filters & Deletion ---
        function updateFilters() {
            const cats = [...new Set(appData.map(d => d.category))];
            const old = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="All">All Categories</option>';
            cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; categoryFilter.appendChild(o); });
            categoryFilter.value = cats.includes(old) ? old : 'All';
            currentFilter = categoryFilter.value;
        }

        window.handleFilterChange = () => {
            currentFilter = categoryFilter.value;
            updateAnalytics();
        }

        window.deleteStudent = (id) => {
            studentToDeleteId = id;
            openDeleteModal();
        };

        function openDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.getElementById('confirmDeleteBtn').onclick = () => {
                executeStudentDeletion();
                closeDeleteModal();
            };
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('modalContent');
            content.classList.add('scale-95', 'opacity-0');
            content.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                studentToDeleteId = null;
            }, 200);
        }

        function executeStudentDeletion() {
            if (!studentToDeleteId) return;
            students = students.filter(s => s.id !== studentToDeleteId);
            localStorage.removeItem(`e1_v2_scores_${studentToDeleteId}`);
            saveStudents();
            if (currentStudentId === studentToDeleteId) {
                if (students.length > 0) switchStudent(students[0].id);
                else {
                    currentStudentId = null;
                    appData = [];
                    studentNameInput.value = '';
                    document.getElementById('studentMeta').textContent = 'ID: ---';
                    renderTable();
                    updateAnalytics();
                    renderRoster();
                }
            } else {
                renderRoster();
            }
            showToast("Student deleted", "error");
        }

        // --- Import/Export ---
        window.triggerImport = () => document.getElementById('importInput').click();
        window.handleImport = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        // Standard JSON Import (Full DB or Single Profile)
                        const data = JSON.parse(content);
                        if (data.type === 'single_student') importSingleStudent(data);
                        else if (data.type === 'full_database') importFullDatabase(data);
                        else throw new Error("Unknown JSON Format");
                    } else {
                        // CSV / TSV Import Logic
                        importCSV(content);
                    }
                } catch (err) {
                    console.error(err);
                    showToast("Import Failed: " + err.message, "error");
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function importCSV(content) {
            // 1. Detect Delimiter (Comma vs Tab)
            const firstLine = content.substring(0, content.indexOf('\n'));
            const isTab = firstLine.includes('\t');
            const delimiter = isTab ? '\t' : ',';
            
            const lines = content.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length < 2) throw new Error("File appears empty");
            
            const headers = lines[0].split(delimiter).map(h => h.trim());
            
            // 2. Identify Logic Branch
            const hasAccountID = headers.findIndex(h => h.toLowerCase().includes("account id")) > -1;
            const hasGroupName = headers.findIndex(h => h.toLowerCase().includes("group name")) > -1;
            const hasUnit = headers.findIndex(h => h.toLowerCase().includes("unit")) > -1;
            
            if (hasGroupName && hasUnit) {
                // LOGIC: Specific TSV Format (Bulk add to current student)
                importBulkTSV(lines, headers, delimiter);
            } else if (hasAccountID) {
                // LOGIC: Legacy CSV (Creates new students)
                importLegacyCSV(lines, headers, delimiter);
            } else {
                throw new Error("Could not identify CSV format. Missing 'Group Name' or 'Account ID' headers.");
            }
        }

        function importBulkTSV(lines, headers, delimiter) {
            // Find Column Indices
            const findCol = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());
            
            const idxGroup = findCol("Group Name"); // Category
            const idxUnit = findCol("Unit");       // Milestone
            
            // Skills
            const idxGram = headers.findIndex(h => h.toLowerCase().includes("grammar"));
            const idxList = headers.findIndex(h => h.toLowerCase().includes("listening"));
            const idxRead = headers.findIndex(h => h.toLowerCase().includes("reading"));
            const idxSpeak = headers.findIndex(h => h.toLowerCase().includes("speaking"));
            const idxVocab = headers.findIndex(h => h.toLowerCase().includes("vocabulary"));
            const idxWrite = headers.findIndex(h => h.toLowerCase().includes("writing"));

            if (idxGroup === -1 || idxUnit === -1) throw new Error("Missing 'Group Name' or 'Unit' columns");

            // Prepare Helper to clean percentage
            const cleanPct = (val) => {
                if(!val) return 0;
                return parseFloat(val.replace('%', '').trim()) || 0;
            };

            // Track seen units to deduplicate WITHIN the import file
            const seenUnitsInImport = new Set();
            let addedCount = 0;
            let skippedCount = 0;

            // Ensure we have a student to add to
            if (!currentStudentId) {
                addNewStudent(); 
                // Wait briefly for state to settle, though sync is immediate in current impl
                const s = students[students.length-1];
                s.name = "Imported Student";
                studentNameInput.value = "Imported Student";
                saveStudents();
            }

            // Existing units for current student (to prevent duplicates)
            const existingUnits = new Set(appData.map(d => d.milestone.toLowerCase()));

            // Parse Rows
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(delimiter);
                if (row.length < headers.length) continue; // Skip malformed rows

                const unit = row[idxUnit].trim();
                const category = row[idxGroup].trim();

                // Skip if we've seen this unit in this file OR in existing data
                if (seenUnitsInImport.has(unit) || existingUnits.has(unit.toLowerCase())) {
                    skippedCount++;
                    continue;
                }

                // Construct Record
                const record = {
                    category: category,
                    milestone: unit,
                    gram: cleanPct(row[idxGram]),
                    listen: cleanPct(row[idxList]),
                    read: cleanPct(row[idxRead]),
                    speak: cleanPct(row[idxSpeak]),
                    vocab: cleanPct(row[idxVocab]),
                    write: cleanPct(row[idxWrite])
                };

                appData.push(record);
                seenUnitsInImport.add(unit);
                addedCount++;
            }

            if (addedCount > 0) {
                saveStudentData();
                updateFilters();
                updateAnalytics();
                renderTable();
                showToast(`Imported ${addedCount} new records (${skippedCount} duplicates skipped)`, "success");
            } else {
                showToast("No new unique records found.", "warning");
            }
        }

        function importLegacyCSV(lines, headers, delimiter) {
             // Loose matching for flexibility
             const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
            
            const accIdIdx = findCol("Account ID");
            const groupIdx = findCol("Group_Code") > -1 ? findCol("Group_Code") : findCol("Category");
            const skillIdx = findCol("skill");
            const scoreIdx = findCol("Completion") > -1 ? findCol("Completion") : findCol("Score");

            if (accIdIdx === -1 || skillIdx === -1) { 
                throw new Error("CSV missing Account ID or Skill columns"); 
            }

            const map = {};
            
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(delimiter);
                const accId = row[accIdIdx];
                const groupCode = groupIdx > -1 ? row[groupIdx] : "Imported";
                const skillName = row[skillIdx];
                const scoreRaw = row[scoreIdx] || "0";
                
                if (!accId || !skillName) continue;
                
                const score = parseFloat(scoreRaw.replace("%", "")) || 0;
                
                if (!map[accId]) map[accId] = { name: accId, milestones: {} };
                if (!map[accId].milestones[groupCode]) {
                    map[accId].milestones[groupCode] = { category: groupCode, milestone: groupCode, gram:0, listen:0, read:0, speak:0, vocab:0, write:0 };
                }
                
                const m = map[accId].milestones[groupCode];
                if (skillName.includes("Grammar")) m.gram = score;
                else if (skillName.includes("Listening")) m.listen = score;
                else if (skillName.includes("Reading")) m.read = score;
                else if (skillName.includes("Speaking")) m.speak = score;
                else if (skillName.includes("Vocabulary")) m.vocab = score;
                else if (skillName.includes("Writing")) m.write = score;
            }

            let newStudentCount = 0;
            Object.keys(map).forEach(accId => {
                const newId = 's_' + Date.now() + Math.random().toString(36).substr(2, 5);
                students.push({ id: newId, name: map[accId].name });
                localStorage.setItem(`e1_v2_scores_${newId}`, JSON.stringify(Object.values(map[accId].milestones)));
                newStudentCount++;
            });
            
            saveStudents(); 
            loadAll(); 
            showToast(`Imported ${newStudentCount} students`, "success");
        }

        function importSingleStudent(d) { 
            const nid = 's_' + Date.now(); 
            students.push({ id: nid, name: d.profile.name + " (Import)" }); 
            localStorage.setItem(`e1_v2_scores_${nid}`, JSON.stringify(d.scores)); 
            saveStudents(); 
            switchStudent(nid); 
            showToast("Student Imported Successfully", "success");
        }
        
        function importFullDatabase(d) { 
            d.students.forEach(s => { 
                const nid = 's_' + Date.now() + Math.floor(Math.random() * 1000); 
                students.push({ id: nid, name: s.name }); 
                localStorage.setItem(`e1_v2_scores_${nid}`, JSON.stringify(d.scores[s.id] || [])); 
            }); 
            saveStudents(); 
            loadAll(); 
            showToast("Database Restored", "success");
        }

        function exportCurrentStudent() { 
            if(!currentStudentId) return;
            const s = students.find(x => x.id === currentStudentId); 
            downloadJSON({ type: 'single_student', profile: s, scores: appData }, `Student_${s.name.replace(/\s+/g,'_')}.json`); 
        }
        
        function exportAllData() { 
            const data = { type: 'full_database', students, scores: {} }; 
            students.forEach(s => data.scores[s.id] = JSON.parse(localStorage.getItem(`e1_v2_scores_${s.id}`) || '[]')); 
            downloadJSON(data, "English1_Backup.json"); 
        }
        
        function downloadJSON(d, f) { 
            const blob = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = f; 
            a.click(); 
        }

        // --- Init ---
        const themeBtn = document.getElementById('themeToggle');
        themeBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            
            const icon = isDark ? 'sun' : 'moon';
            const label = isDark ? 'Light Mode' : 'Dark Mode';
            
            themeBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 shrink-0"></i> <span id="themeLabel" class="hide-on-collapse whitespace-nowrap">${label}</span>`;
            lucide.createIcons({ root: themeBtn });
            
            initCharts(); 
            updateAnalytics();
        });

        window.onload = () => {
            initCharts();
            loadAll();
            // Default focus
            if(students.length === 0) {
               // document.getElementById('studentNameInput').focus();
            }
        };

    </script>
</body>
</html>