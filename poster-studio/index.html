<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 1 Poster Studio v2.4</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF6B95', orange: '#FF8C42', green: '#00E676', blue: '#2979FF',
                            purple: '#A855F7', red: '#EF4444', dark: '#1e293b', chalk: '#f8fafc',
                            yellow: '#FCD34D', surface: '#E2E8F0', teal: '#14b8a6', indigo: '#6366f1'
                        }
                    },
                    fontFamily: { heading: ['Fredoka', 'sans-serif'], body: ['Nunito', 'sans-serif'], hand: ['Patrick Hand', 'cursive'] },
                    boxShadow: { 'neo': '4px 4px 0px 0px #1e293b', 'neo-sm': '2px 2px 0px 0px #1e293b', 'neo-lg': '8px 8px 0px 0px #1e293b' }
                }
            }
        }
    </script>

    <style>
        :root { --neo-dark: #1e293b; }
        body { -webkit-font-smoothing: antialiased; }
        
        /* SCROLLBAR */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 99px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }

        /* PATTERNS */
        .bg-graph-paper { background-color: #f8fafc; background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 32px 32px; }
        .tape-strip { position: absolute; top: -12px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 100px; height: 30px; background-color: rgba(255,255,255,0.4); backdrop-filter: blur(2px); border-left: 2px dashed rgba(0,0,0,0.1); border-right: 2px dashed rgba(0,0,0,0.1); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* UTILS */
        .neo-input { width: 100%; background: white; border: 2px solid #1e293b; border-radius: 0.5rem; padding: 0.35rem 0.5rem; font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 0.875rem; color: #1e293b; transition: all 0.2s; outline: none; }
        .neo-input:focus { box-shadow: 2px 2px 0px 0px #1e293b; background-color: #FEF9C3; transform: translateY(-1px); }
        .neo-btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid #1e293b; border-radius: 0.75rem; transition: all 0.1s; box-shadow: 4px 4px 0px 0px #1e293b; cursor: pointer; }
        .neo-btn:hover { box-shadow: none; transform: translateY(2px); }
        .neo-btn:active { transform: translateY(4px); box-shadow: none; }
        .slide-in-bottom { animation: slideInBottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInBottom { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* DRAG & DROP */
        .draggable-item { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item.dragging { opacity: 0.5; background: #f1f5f9; border-style: dashed; border-color: #94a3b8; transform: scale(0.95); }
        .draggable-item.over { border-top: 4px solid #2979FF; padding-top: 4px; }

        /* MODES */
        body.zen-mode aside { display: none !important; }
        body.zen-mode #poster-viewport { padding: 0; }
        @media print {
            .no-print, aside, button, .zoom-controls { display: none !important; }
            body, html, main, #poster-viewport { margin: 0; padding: 0; background: white; overflow: visible; height: auto; }
            #poster-wrapper { transform: none !important; width: 100%; margin: 0; }
            #poster-area { border: none; box-shadow: none; width: 100% !important; height: 100vh !important; background: white !important; page-break-after: always; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>

<body class="bg-brand-surface h-screen w-screen overflow-hidden text-brand-dark font-body selection:bg-brand-yellow/50">

    <div class="flex h-full">
        <aside class="w-[380px] h-full flex flex-col bg-white border-r-4 border-brand-dark shrink-0 relative z-30 no-print shadow-2xl">
            
            <div class="p-3 border-b-4 border-brand-dark bg-slate-50 relative z-20">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="font-heading font-black text-xl text-brand-dark tracking-tight">POSTER <span class="text-brand-pink">STUDIO</span></h1>
                </div>

                <div class="mb-2 p-1 bg-brand-dark rounded-lg flex gap-1 shadow-neo-sm">
                    <button onclick="App.cyclePoster(-1)" class="p-1.5 bg-slate-700 text-white rounded hover:bg-slate-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <div class="flex-1 relative group">
                        <select id="project-select" onchange="App.switchPoster(this.value)" class="w-full h-full pl-2 pr-6 bg-slate-800 rounded font-heading font-bold text-sm text-white appearance-none cursor-pointer outline-none"></select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                    </div>
                    <button onclick="App.cyclePoster(1)" class="p-1.5 bg-slate-700 text-white rounded hover:bg-slate-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button onclick="App.createNewPoster()" class="p-1.5 bg-brand-green text-brand-dark rounded hover:bg-green-400"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <input type="text" id="global_badge" class="neo-input col-span-1 text-center" placeholder="#">
                    <input type="text" id="global_title" class="neo-input col-span-3" placeholder="TITLE">
                    <input type="text" id="global_subtitle" class="neo-input col-span-4 font-body font-semibold text-xs" placeholder="Subtitle...">
                </div>
            </div>

            <div class="p-3 border-b-4 border-brand-dark bg-white z-10">
                <label class="block font-heading font-bold text-[10px] text-slate-400 mb-2 uppercase tracking-widest">Add Module</label>
                <div class="grid grid-cols-4 gap-2" id="module-toolbox">
                    </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-slate-50 custom-scrollbar relative">
                <div id="editor-container" class="space-y-2 pb-24">
                    </div>
            </div>

            <div class="p-4 border-t-4 border-brand-dark bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 flex gap-2">
                <button onclick="Store.save(true)" id="save-btn" class="flex-1 neo-btn bg-brand-dark text-white py-3 gap-2"><i data-lucide="save" class="w-4 h-4"></i> Save</button>
                <div class="flex border-2 border-brand-dark rounded-xl overflow-hidden shadow-neo bg-white">
                    <button onclick="App.exportPoster()" class="px-4 hover:bg-slate-100 border-r-2 border-brand-dark" title="Export JSON"><i data-lucide="download" class="w-5 h-5"></i></button>
                    <button onclick="document.getElementById('import-file').click()" class="px-4 hover:bg-slate-100" title="Import JSON"><i data-lucide="upload" class="w-5 h-5"></i></button>
                </div>
            </div>
        </aside>

        <main class="flex-1 h-full relative overflow-hidden flex flex-col bg-brand-surface">
            
            <div class="absolute top-4 right-4 z-40 flex gap-2 no-print">
                <div class="bg-white border-2 border-brand-dark rounded-xl shadow-neo flex items-center p-1 gap-1">
                    <button onclick="App.changeZoom(-0.1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="minus" class="w-4 h-4"></i></button>
                    <span id="zoom-display" class="font-heading font-bold text-xs w-10 text-center">50%</span>
                    <button onclick="App.changeZoom(0.1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    <button onclick="App.fitToScreen()" class="px-2 py-1 bg-brand-yellow/30 text-brand-dark rounded text-[10px] font-black uppercase">FIT</button>
                </div>
                <button onclick="App.openLibrary()" class="neo-btn bg-brand-yellow w-10 h-10 p-0"><i data-lucide="folder-open" class="w-5 h-5"></i></button>
                <button onclick="App.toggleFullScreen()" class="neo-btn bg-white w-10 h-10 p-0"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                <button onclick="window.print()" class="neo-btn bg-brand-blue text-white w-10 h-10 p-0"><i data-lucide="printer" class="w-5 h-5"></i></button>
            </div>

            <div id="poster-viewport" class="flex-1 w-full h-full overflow-auto p-8 flex justify-center items-center transition-all duration-300">
                <div id="poster-wrapper">
                    <div id="poster-area" class="w-[2560px] h-[1440px] bg-brand-chalk bg-graph-paper relative shadow-neo-lg overflow-hidden border-4 border-brand-dark"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- LIBRARY MODAL -->
    <div id="library-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-brand-dark/60 backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-3xl max-h-[85vh] flex flex-col rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_#1e293b] overflow-hidden">
            <div class="p-5 border-b-4 border-brand-dark bg-slate-50 flex justify-between items-center">
                <h2 class="font-heading font-black text-2xl">MY PROJECTS</h2>
                <button onclick="document.getElementById('library-modal').classList.add('hidden')"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="library-list" class="flex-1 overflow-y-auto p-5 space-y-3 bg-slate-100 custom-scrollbar"></div>
            <div class="p-4 bg-white border-t-4 border-brand-dark">
                <button onclick="App.createNewPoster()" class="neo-btn w-full bg-brand-green py-3 text-lg">CREATE NEW POSTER</button>
            </div>
        </div>
    </div>

    <!-- IMAGE LIBRARY MODAL -->
    <div id="image-modal" class="fixed inset-0 z-[105] hidden items-center justify-center bg-brand-dark/60 backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-4xl max-h-[85vh] flex flex-col rounded-2xl border-4 border-brand-dark shadow-[8px_8px_0px_0px_#1e293b] overflow-hidden slide-in-bottom">
            <div class="p-5 border-b-4 border-brand-dark bg-brand-teal text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i data-lucide="image" class="w-8 h-8"></i>
                    <h2 class="font-heading font-black text-2xl">IMAGE ASSETS</h2>
                </div>
                <button onclick="App.closeImageLibrary()"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>
            <div class="p-4 bg-slate-50 border-b-4 border-brand-dark flex gap-4 items-center">
                <label class="flex-1 cursor-pointer neo-btn bg-white text-brand-dark py-3 px-4 hover:bg-slate-100 border-dashed border-2">
                    <input type="file" class="hidden" accept="image/*" onchange="App.handleImageUpload(this)">
                    <i data-lucide="upload-cloud" class="w-5 h-5 mr-2 text-brand-purple"></i>
                    <span class="font-bold">Upload New Image</span>
                </label>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Stored locally in Browser</div>
            </div>
            <div id="image-grid" class="flex-1 overflow-y-auto p-5 bg-slate-100 custom-scrollbar grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 content-start">
                <!-- Images rendered here -->
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL v2 -->
    <div id="confirm-modal" class="fixed inset-0 z-[110] hidden items-center justify-center bg-brand-dark/20 backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-md flex flex-col rounded-2xl border-4 border-brand-dark shadow-[12px_12px_0px_0px_#1e293b] overflow-hidden slide-in-bottom">
            <div class="h-4 bg-brand-red border-b-4 border-brand-dark flex gap-2 items-center px-3">
                <div class="w-2 h-2 rounded-full bg-white/50"></div>
                <div class="w-2 h-2 rounded-full bg-white/50"></div>
            </div>
            <div class="p-8">
                <h3 class="font-heading font-black text-3xl text-brand-dark leading-none mb-4">SYSTEM ALERT</h3>
                <p id="confirm-msg" class="font-body font-bold text-xl text-slate-600 leading-relaxed border-l-4 border-brand-yellow pl-4">Are you sure you want to perform this action?</p>
            </div>
            <div class="flex gap-4 p-6 pt-0">
                <button onclick="App.closeConfirm()" class="flex-1 py-3 font-heading font-black rounded-xl border-4 border-brand-dark text-brand-dark hover:bg-slate-100 hover:-translate-y-1 hover:shadow-neo-sm transition-all">CANCEL</button>
                <button onclick="App.handleConfirmYes()" class="flex-1 py-3 font-heading font-black rounded-xl border-4 border-brand-dark bg-brand-red text-white hover:bg-red-500 hover:-translate-y-1 hover:shadow-neo-sm transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">PROCEED</button>
            </div>
        </div>
    </div>

    <input type="file" id="import-file" class="hidden" accept=".json" onchange="App.handleFileImport(this)">

    <script>
        // --- 1. CONFIGURATION & REGISTRY ---
        const CONFIG = {
            colors: ['pink', 'orange', 'green', 'blue', 'purple', 'red', 'teal', 'indigo'],
            sizes: {
                vocab:  { sm: 'text-lg', md: 'text-2xl', lg: 'text-4xl', xl: 'text-6xl' },
                text:   { sm: 'text-lg leading-snug', md: 'text-2xl leading-relaxed', lg: 'text-4xl leading-tight', xl: 'text-6xl leading-none' },
                table:  { sm: 'text-xs', md: 'text-base', lg: 'text-xl', xl: 'text-2xl' },
                note:   { sm: 'text-2xl', md: 'text-4xl', lg: 'text-6xl', xl: 'text-8xl' },
                formula:{ sm: 'text-xl', md: 'text-3xl', lg: 'text-5xl', xl: 'text-7xl' }
            }
        };

        const ModuleRegistry = {
            vocab: {
                icon: 'list', color: 'green', label: 'Vocab',
                default: { list: 'Apple\nBanana\nCherry' },
                inputs: (id, d) => `<label class="l">Items</label><textarea class="inp-area h-32" oninput="Store.updateMod('${id}','data.list',this.value)">${d.list||''}</textarea>`,
                render: (d, c, fs) => `<ul class="p-6 bg-white h-full flex flex-col justify-center">${(d.list||'').split('\n').map(x=>`<li class="flex items-center gap-4 mb-2"><div class="w-4 h-4 bg-brand-${c} border border-brand-dark shadow-[1px_1px_0_0_#1e293b] shrink-0"></div><span class="font-body font-bold text-brand-dark ${CONFIG.sizes.vocab[fs]||CONFIG.sizes.vocab.md}">${x}</span></li>`).join('')}</ul>`
            },
            grammar_structure: {
                icon: 'layers', color: 'blue', label: 'Formula',
                default: { formula: 'S + V + O', example: 'I eat apples.' },
                inputs: (id, d) => `<label class="l">Formula</label><input class="inp font-heading font-black text-xl mb-2" value="${d.formula||''}" oninput="Store.updateMod('${id}','data.formula',this.value)"><label class="l">Example</label><textarea class="inp-area font-hand text-xl h-24" oninput="Store.updateMod('${id}','data.example',this.value)">${d.example||''}</textarea>`,
                render: (d, c, fs) => `<div class="p-8 bg-white text-center h-full flex flex-col justify-center"><div class="mb-4 font-heading font-black text-brand-${c} bg-${c}-50 px-6 py-4 rounded-xl border-2 border-brand-${c} border-dashed ${CONFIG.sizes.formula[fs]||CONFIG.sizes.formula.md}">${d.formula||''}</div><p class="font-hand text-slate-600 opacity-80 ${fs==='sm'?'text-xl':'text-3xl'}">"${d.example||''}"</p></div>`
            },
            text: {
                icon: 'message-square', color: 'orange', label: 'Text',
                default: { text: 'Type your content here...' },
                inputs: (id, d) => `<label class="l">Content</label><textarea class="inp-area h-40" oninput="Store.updateMod('${id}','data.text',this.value)">${d.text||''}</textarea>`,
                render: (d, c, fs) => `<div class="p-6 bg-white font-body whitespace-pre-line text-slate-700 h-full flex flex-col justify-center ${CONFIG.sizes.text[fs]||CONFIG.sizes.text.md}">${d.text||''}</div>`
            },
            dialogue: {
                icon: 'message-circle', color: 'teal', label: 'Dialogue',
                default: { text: "A: Hello!\nB: Hi there!\nA: How are you?" },
                inputs: (id, d) => `<label class="l">Dialogue (Prefix with A: or B:)</label><textarea class="inp-area h-40" oninput="Store.updateMod('${id}','data.text',this.value)">${d.text||''}</textarea>`,
                render: (d, c, fs) => {
                    const lines = (d.text||'').split('\n');
                    const bubbles = lines.map(line => {
                        const isB = line.trim().startsWith('B:');
                        const txt = line.replace(/^[AB]:\s*/, '');
                        if(!txt.trim()) return '';
                        return `<div class="flex w-full mb-3 ${isB?'justify-end':'justify-start'}">
                            <div class="${isB?'bg-brand-blue text-white rounded-br-none':'bg-brand-pink text-brand-dark rounded-bl-none'} px-6 py-3 rounded-3xl border-2 border-brand-dark shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] max-w-[80%] font-body font-bold ${CONFIG.sizes.text[fs]||'text-2xl'}">${txt}</div>
                        </div>`;
                    }).join('');
                    return `<div class="p-6 bg-white h-full flex flex-col justify-center overflow-y-auto custom-scrollbar bg-graph-paper">${bubbles}</div>`
                }
            },
            table: {
                icon: 'grid-3x3', color: 'purple', label: 'Table',
                default: { content: 'Head | Head\nCell | Cell' },
                inputs: (id, d) => `<label class="l">Data (use | for cols)</label><textarea class="inp-area font-mono text-xs h-32" oninput="Store.updateMod('${id}','data.content',this.value)">${d.content||''}</textarea>`,
                render: (d, c, fs) => {
                    const rows = (d.content||'').split('\n').filter(r=>r.trim());
                    const trs = rows.map((r,i) => {
                        const cols = r.split('|');
                        if(i===0) return `<tr class="bg-brand-${c} text-white">${cols.map(x=>`<td class="p-2 border-b-4 border-brand-dark font-heading font-black uppercase ${fs==='xl'?'text-2xl':'text-sm'}">${x}</td>`).join('')}</tr>`;
                        return `<tr class="${i%2===0?'bg-white':`bg-${c}-50`}">${cols.map(x=>`<td class="p-2 border border-${c}-200 font-bold text-slate-700 ${CONFIG.sizes.table[fs]||CONFIG.sizes.table.md}">${x}</td>`).join('')}</tr>`;
                    }).join('');
                    return `<div class="bg-white h-full overflow-hidden"><table class="w-full text-left border-collapse">${trs}</table></div>`;
                }
            },
            note: {
                icon: 'sticky-note', color: 'red', label: 'Note',
                default: { text: 'Reminder!' },
                inputs: (id, d) => `<label class="l">Note Text</label><textarea class="inp-area font-hand text-xl bg-yellow-50 border-none" oninput="Store.updateMod('${id}','data.text',this.value)">${d.text||''}</textarea>`,
                render: (d, c, fs) => `<div class="p-8 bg-yellow-100 h-full flex items-center justify-center relative"><div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-red-500 border-2 border-brand-dark shadow-sm -mt-3 z-10"></div><p class="font-hand text-slate-800 text-center leading-normal rotate-1 ${CONFIG.sizes.note[fs]||CONFIG.sizes.note.md}">${d.text||''}</p></div>`
            },
            image: {
                icon: 'image', color: 'teal', label: 'Image',
                default: { url: '', imageId: null },
                inputs: (id, d) => {
                    const img = Store.imgCache.get(d.imageId) || d.url;
                    return `
                        <label class="l">Image Source</label>
                        <div class="mb-2 relative w-full h-32 border-2 border-dashed border-brand-dark rounded-xl bg-slate-50 flex flex-col items-center justify-center overflow-hidden">
                            ${img ? `<img src="${img}" class="absolute inset-0 w-full h-full object-cover opacity-50">` : ''}
                            <div class="relative z-10 flex flex-col items-center gap-2">
                                <button onclick="App.openImageSelector('${id}')" class="neo-btn bg-white text-xs px-3 py-2 text-brand-dark hover:bg-brand-teal hover:text-white transition-colors">
                                    <i data-lucide="image" class="w-4 h-4 mr-1"></i> ${img ? 'Change Image' : 'Select Image'}
                                </button>
                            </div>
                        </div>
                        <label class="l">Or External URL</label>
                        <input class="inp text-xs" value="${d.url||''}" oninput="Store.updateMod('${id}','data.url',this.value); Store.updateMod('${id}','data.imageId',null);">
                    `;
                },
                render: (d, c, fs) => {
                    if(d.imageId) return `<div class="w-full h-full bg-slate-100 flex items-center justify-center overflow-hidden"><img data-idb-id="${d.imageId}" src="${Store.imgCache.get(d.imageId)||''}" class="w-full h-full object-cover"></div>`;
                    return `<div class="w-full h-full bg-slate-100 flex items-center justify-center overflow-hidden"><img src="${d.url}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400?text=Select+Image'"></div>`;
                }
            }
        };

        // --- 2. DATA STORE (DB & STATE) ---
        const Store = {
            state: { posters: [], currentId: 'default', theme: 'light' },
            current: null,
            imgCache: new Map(),
            db: null,
            debounce: null,

            async init() {
                // IDB
                Store.db = await new Promise((res, rej) => {
                    const req = indexedDB.open('PosterStudioDB', 1);
                    req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains('imgs')) e.target.result.createObjectStore('imgs'); };
                    req.onsuccess = e => res(e.target.result);
                    req.onerror = rej;
                });

                // LocalStorage
                const local = localStorage.getItem('poster-studio-v2');
                if(local) Store.state = JSON.parse(local);
                if(!Store.state.posters.length) App.createNewPoster();
                
                Store.loadCurrent();
            },

            loadCurrent() {
                Store.current = Store.state.posters.find(p => p.id === Store.state.currentId) || Store.state.posters[0];
            },

            save(visual = false) {
                Store.current.lastModified = Date.now();
                const idx = Store.state.posters.findIndex(p => p.id === Store.current.id);
                Store.state.posters[idx] = Store.current;
                localStorage.setItem('poster-studio-v2', JSON.stringify(Store.state));
                if(visual) {
                    const btn = document.getElementById('save-btn');
                    btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Saved!`;
                    btn.classList.add('bg-brand-green', 'text-brand-dark'); btn.classList.remove('bg-brand-dark', 'text-white');
                    setTimeout(() => {
                        btn.innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save`;
                        btn.classList.remove('bg-brand-green', 'text-brand-dark'); btn.classList.add('bg-brand-dark', 'text-white');
                        lucide.createIcons();
                    }, 1000);
                }
            },

            triggerSave() {
                clearTimeout(Store.debounce);
                Store.debounce = setTimeout(() => Store.save(false), 500);
            },

            // Updates
            updateGlobal(key, val) { Store.current.global[key] = val; Renderer.renderPoster(); App.updateUI(); Store.triggerSave(); },
            updateMod(id, key, val) {
                const m = Store.current.modules.find(x => x.id === id);
                if(!m) return;
                if(key.includes('.')) { const [p, c] = key.split('.'); m[p][c] = val; } 
                else { m[key] = val; }
                Renderer.renderPoster(); Store.triggerSave();
            },
            
            async uploadImage(input) {
                const file = input.files[0]; if(!file) return;
                const imgId = crypto.randomUUID();
                const blob = new Blob([file], {type: file.type});
                
                // Cache
                Store.imgCache.set(imgId, URL.createObjectURL(blob));
                
                // DB
                const tx = Store.db.transaction('imgs', 'readwrite');
                tx.objectStore('imgs').put(blob, imgId);
                
                // If waiting for selection, auto select
                if(App.currentImageModId) {
                    Store.updateMod(App.currentImageModId, 'data.imageId', imgId);
                    Store.updateMod(App.currentImageModId, 'data.url', null);
                    Editor.render(App.currentImageModId);
                    App.closeImageLibrary();
                } else {
                    App.refreshImageLibrary(); // Just uploaded via manager
                }
            },

            async deleteImage(id) {
                return new Promise(res => {
                    const tx = Store.db.transaction('imgs', 'readwrite');
                    tx.objectStore('imgs').delete(id);
                    tx.oncomplete = () => {
                        Store.imgCache.delete(id);
                        res();
                    }
                });
            },

            async getAllImages() {
                return new Promise(res => {
                    const tx = Store.db.transaction('imgs', 'readonly');
                    const req = tx.objectStore('imgs').getAllKeys();
                    req.onsuccess = async () => {
                        const keys = req.result;
                        const images = [];
                        for(const k of keys) {
                            const url = await Store.getImage(k);
                            images.push({id: k, url});
                        }
                        res(images);
                    };
                });
            },

            async getImage(id) {
                if(Store.imgCache.has(id)) return Store.imgCache.get(id);
                return new Promise(res => {
                    const tx = Store.db.transaction('imgs', 'readonly');
                    const req = tx.objectStore('imgs').get(id);
                    req.onsuccess = () => {
                        if(req.result) {
                            const url = URL.createObjectURL(req.result);
                            Store.imgCache.set(id, url);
                            res(url);
                        } else res(null);
                    }
                });
            }
        };

        // --- 3. APP CONTROLLER ---
        const App = {
            confirmCallback: null,
            currentImageModId: null,

            init() {
                Store.init().then(() => {
                    App.updateUI();
                    Renderer.renderPoster();
                    App.renderToolbox();
                    App.fitToScreen();
                    lucide.createIcons();
                });

                // Listeners
                ['title','subtitle','badge'].forEach(k => {
                    document.getElementById(`global_${k}`).addEventListener('input', e => Store.updateGlobal(k, e.target.value));
                });
            },

            renderToolbox() {
                const box = document.getElementById('module-toolbox');
                box.innerHTML = Object.entries(ModuleRegistry).map(([k, v]) => `
                    <button onclick="App.addModule('${k}')" class="flex flex-col items-center justify-center p-2 bg-white border-2 border-brand-dark rounded-xl shadow-[2px_2px_0px_0px_rgba(30,41,59,1)] hover:shadow-none hover:translate-y-0.5 hover:bg-slate-50 transition-all">
                        <i data-lucide="${v.icon}" class="w-5 h-5 text-brand-${v.color} mb-1"></i>
                        <span class="font-heading font-bold text-[10px] text-slate-600 uppercase leading-none">${v.label}</span>
                    </button>
                `).join('');

                lucide.createIcons();
            },

            updateUI() {
                const g = Store.current.global;
                document.getElementById('global_title').value = g.title;
                document.getElementById('global_subtitle').value = g.subtitle;
                document.getElementById('global_badge').value = g.badge;
                
                const sel = document.getElementById('project-select');
                sel.innerHTML = Store.state.posters.map(p => `<option value="${p.id}" ${p.id===Store.current.id?'selected':''}>${p.global.title}</option>`).join('');
            },

            // Logic
            addModule(type) {
                const cfg = ModuleRegistry[type];
                const mod = {
                    id: crypto.randomUUID(), type, title: cfg.label,
                    color: cfg.color, size: 'md', height: 'auto', fontSize: 'md',
                    data: JSON.parse(JSON.stringify(cfg.default))
                };
                Store.current.modules.push(mod);
                Store.save();
                Editor.renderList();
                Renderer.renderPoster();
                // Scroll to bottom
                setTimeout(() => document.getElementById('editor-container').lastElementChild?.scrollIntoView({behavior:'smooth'}), 100);
            },

            deleteModule(id) {
                App.showConfirm('Are you sure you want to delete this layer? The content will be lost.', () => {
                    Store.current.modules = Store.current.modules.filter(m => m.id !== id);
                    if(Editor.editingId === id) Editor.editingId = null;
                    Store.save();
                    Editor.renderList();
                    Renderer.renderPoster();
                });
            },

            // Confirmation Logic
            showConfirm(msg, callback) {
                document.getElementById('confirm-msg').innerText = msg;
                App.confirmCallback = callback;
                document.getElementById('confirm-modal').classList.remove('hidden');
                document.getElementById('confirm-modal').classList.add('flex');
            },
            closeConfirm() {
                document.getElementById('confirm-modal').classList.add('hidden');
                document.getElementById('confirm-modal').classList.remove('flex');
                App.confirmCallback = null;
            },
            handleConfirmYes() {
                if (App.confirmCallback) App.confirmCallback();
                App.closeConfirm();
            },

            // Image Library Logic
            openImageSelector(modId) {
                App.currentImageModId = modId;
                document.getElementById('image-modal').classList.remove('hidden');
                App.refreshImageLibrary();
            },
            closeImageLibrary() {
                document.getElementById('image-modal').classList.add('hidden');
                App.currentImageModId = null;
            },
            handleImageUpload(input) {
                Store.uploadImage(input);
                input.value = ''; // Reset
            },
            async refreshImageLibrary() {
                const grid = document.getElementById('image-grid');
                grid.innerHTML = '<div class="col-span-full text-center p-4 text-slate-400 font-bold">Loading images...</div>';
                
                const images = await Store.getAllImages();
                if(images.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400 font-bold border-2 border-dashed border-slate-300 rounded-xl">No images in library</div>';
                    return;
                }
                
                grid.innerHTML = images.map(img => `
                    <div class="relative group aspect-square bg-slate-200 rounded-xl border-2 border-brand-dark overflow-hidden cursor-pointer shadow-sm hover:shadow-neo-sm transition-all" onclick="App.selectImage('${img.id}')">
                        <img src="${img.url}" class="w-full h-full object-cover">
                        <button onclick="event.stopPropagation(); App.deleteImageAsset('${img.id}')" class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded border border-brand-dark opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
                lucide.createIcons();
            },
            selectImage(imgId) {
                if(App.currentImageModId) {
                    Store.updateMod(App.currentImageModId, 'data.imageId', imgId);
                    Store.updateMod(App.currentImageModId, 'data.url', null);
                    Editor.render(App.currentImageModId);
                    App.closeImageLibrary();
                }
            },
            deleteImageAsset(id) {
                if(confirm('Delete this image permanently?')) {
                    Store.deleteImage(id).then(App.refreshImageLibrary);
                }
            },

            // Nav
            switchPoster(id) {
                Store.state.currentId = id;
                Store.loadCurrent();
                Editor.editingId = null;
                App.updateUI();
                Editor.renderList();
                Renderer.renderPoster();
                App.fitToScreen();
            },
            createNewPoster() {
                const newP = { id: crypto.randomUUID(), lastModified: Date.now(), zoom: 0.5, global: { title: 'UNTITLED', subtitle: 'New Project', badge: '1' }, modules: [] };
                Store.state.posters.push(newP);
                App.switchPoster(newP.id);
            },
            cyclePoster(dir) {
                const idx = Store.state.posters.findIndex(p => p.id === Store.current.id);
                let next = idx + dir;
                if(next >= Store.state.posters.length) next = 0;
                if(next < 0) next = Store.state.posters.length - 1;
                App.switchPoster(Store.state.posters[next].id);
            },

            // View
            toggleFullScreen() { document.body.classList.toggle('zen-mode'); setTimeout(App.fitToScreen, 300); },
            changeZoom(d) { Store.current.zoom = Math.max(0.1, Math.min(2, (Store.current.zoom||0.5)+d)); Renderer.applyZoom(); },
            fitToScreen() {
                const vp = document.getElementById('poster-viewport');
                const scale = Math.min((vp.clientWidth-60)/2560, (vp.clientHeight-60)/1440);
                Store.current.zoom = scale;
                Renderer.applyZoom();
            },

            // Library
            openLibrary() {
                const list = document.getElementById('library-list');
                list.innerHTML = Store.state.posters.sort((a,b)=>b.lastModified-a.lastModified).map(p => `
                    <div class="p-3 border-2 ${p.id===Store.current.id?'border-brand-blue bg-blue-50':'border-slate-200 bg-white hover:border-slate-400'} rounded-xl flex justify-between items-center cursor-pointer" onclick="App.switchPoster('${p.id}'); document.getElementById('library-modal').classList.add('hidden')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-brand-dark text-white font-black flex items-center justify-center">${p.global.badge}</div>
                            <div><h4 class="font-heading font-bold text-sm text-brand-dark">${p.global.title}</h4><span class="text-xs text-slate-500">${p.modules.length} modules</span></div>
                        </div>
                        ${Store.state.posters.length>1 ? `<button onclick="event.stopPropagation(); App.deletePoster('${p.id}')" class="p-2 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}
                    </div>
                `).join('');
                lucide.createIcons();
                document.getElementById('library-modal').classList.remove('hidden');
            },
            deletePoster(id) {
                App.showConfirm('Are you sure you want to delete this project?', () => {
                    Store.state.posters = Store.state.posters.filter(p => p.id !== id);
                    if(id === Store.current.id) App.switchPoster(Store.state.posters[0].id);
                    else { Store.save(); App.openLibrary(); }
                });
            },
            exportPoster() {
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(Store.current));
                a.download = `Poster_${Store.current.global.title}.json`;
                a.click();
            },
            handleFileImport(input) {
                const f = input.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = e => {
                    try {
                        const j = JSON.parse(e.target.result);
                        j.id = crypto.randomUUID();
                        Store.state.posters.push(j);
                        App.switchPoster(j.id);
                    } catch(err) { alert('Invalid file'); }
                };
                r.readAsText(f);
            }
        };

        // --- 4. RENDERER (Canvas) ---
        const Renderer = {
            renderPoster() {
                const g = Store.current.global;
                const area = document.getElementById('poster-area');
                
                // Header
                const header = `
                    <div class="col-span-12 row-span-2 flex items-start justify-between border-b-4 border-brand-dark pb-4">
                        <div><h1 class="font-heading font-black text-8xl text-brand-dark leading-none mb-4">${g.title}</h1><p class="font-body font-bold text-4xl text-slate-500">${g.subtitle}</p></div>
                        <div class="h-32 min-w-[180px] px-10 flex items-center justify-center bg-brand-yellow border-4 border-brand-dark rounded-full shadow-neo transform rotate-2">
                            <span class="font-heading font-black text-6xl text-brand-dark">${g.badge}</span>
                        </div>
                    </div>`;
                
                // Grid
                const mods = Store.current.modules.map(m => {
                    const cfg = ModuleRegistry[m.type];
                    // SAFEGUARD: If module type was removed (e.g. logic/qa), skip rendering to prevent crash
                    if (!cfg) return ''; 

                    // Classes - Expanded Options
                    const spans = {
                        size: { xs: 'col-span-2', sm: 'col-span-4', md: 'col-span-6', lg: 'col-span-8', xl: 'col-span-10', full: 'col-span-12' },
                        height: { mini: 'row-span-1', short: 'row-span-2', auto: 'row-span-3', tall: 'row-span-6', grand: 'row-span-9', full: 'row-span-12' }
                    };
                    const inner = cfg.render(m.data, m.color, m.fontSize||'md');
                    
                    return `
                        <div class="${spans.size[m.size]||'col-span-6'} ${spans.height[m.height]||'row-span-3'} bg-white border-4 border-brand-dark rounded-2xl overflow-hidden shadow-neo relative flex flex-col group">
                            <div class="bg-brand-${m.color} px-6 py-3 border-b-4 border-brand-dark flex justify-between items-center relative z-10 shrink-0">
                                <h3 class="font-heading font-black text-white text-2xl uppercase tracking-wide truncate">${m.title}</h3>
                            </div>
                            <div class="flex-1 overflow-hidden relative">${inner}</div>
                            <div class="tape-strip"></div>
                        </div>`;
                }).join('');

                area.innerHTML = `<div class="p-16 h-full flex flex-col">${header}<div class="flex-1 grid grid-cols-12 grid-rows-12 gap-8 grid-flow-dense pt-6 min-h-0">${mods}</div><div class="mt-auto pt-8 text-center opacity-40 font-heading font-bold text-xl uppercase tracking-[0.3em]">English 1 Batam â€¢ Educational Resource</div></div>`;
                
                Renderer.applyZoom();
                Renderer.hydrateImages();
            },
            applyZoom() {
                const z = Store.current.zoom || 0.5;
                document.getElementById('poster-wrapper').style.transform = `scale(${z})`;
                document.getElementById('zoom-display').innerText = `${Math.round(z*100)}%`;
            },
            async hydrateImages() {
                const imgs = document.querySelectorAll('img[data-idb-id]');
                for(const img of imgs) {
                    const src = await Store.getImage(img.dataset.idbId);
                    if(src) img.src = src;
                }
            }
        };

        // --- 5. EDITOR (Sidebar) ---
        const Editor = {
            editingId: null,

            renderList() {
                const con = document.getElementById('editor-container');
                con.innerHTML = '';
                
                if(Editor.editingId) return Editor.render(Editor.editingId);

                if(!Store.current.modules.length) {
                    con.innerHTML = `<div class="text-center p-8 border-2 border-dashed border-slate-300 rounded-xl mt-4 opacity-50"><i data-lucide="layers" class="w-8 h-8 mx-auto mb-2 text-slate-400"></i><p class="text-xs font-bold text-slate-400 uppercase">No layers yet</p></div>`;
                    lucide.createIcons(); return;
                }

                Store.current.modules.forEach((mod, idx) => {
                    const el = document.createElement('div');
                    el.className = 'draggable-item relative group flex items-center gap-3 p-3 rounded-xl border-2 bg-white border-slate-200 hover:border-brand-dark mb-2 select-none';
                    el.draggable = true;
                    // DnD Events
                    el.ondragstart = e => { e.dataTransfer.setData('text/plain', idx); e.target.classList.add('dragging'); };
                    el.ondragend = e => { e.target.classList.remove('dragging'); document.querySelectorAll('.draggable-item').forEach(x=>x.classList.remove('over')); };
                    el.ondragover = e => { e.preventDefault(); };
                    el.ondragenter = e => e.currentTarget.classList.add('over');
                    el.ondragleave = e => e.currentTarget.classList.remove('over');
                    el.ondrop = e => {
                        e.preventDefault();
                        const from = parseInt(e.dataTransfer.getData('text/plain'));
                        const to = idx;
                        if(from !== to) {
                            const item = Store.current.modules.splice(from, 1)[0];
                            Store.current.modules.splice(to, 0, item);
                            Store.save();
                            Editor.renderList();
                            Renderer.renderPoster();
                        }
                    };

                    el.innerHTML = `
                        <div class="cursor-grab text-slate-300 group-hover:text-slate-500"><i data-lucide="grip-vertical" class="w-4 h-4"></i></div>
                        <div class="w-2 h-8 rounded-full bg-brand-${mod.color}"></div>
                        <div class="flex-1 min-w-0 cursor-pointer" onclick="Editor.editingId='${mod.id}'; Editor.renderList()">
                            <div class="flex items-center gap-2"><span class="text-[9px] font-black uppercase text-slate-400">${mod.type}</span></div>
                            <h4 class="font-heading font-bold text-brand-dark text-sm truncate">${mod.title}</h4>
                        </div>
                        <button onclick="App.deleteModule('${mod.id}')" class="p-2 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    `;
                    con.appendChild(el);
                });
                lucide.createIcons();
            },

            render(id) {
                const m = Store.current.modules.find(x => x.id === id);
                if(!m) { Editor.editingId = null; return Editor.renderList(); }
                const cfg = ModuleRegistry[m.type];
                
                // SAFEGUARD: If editing a removed module type, go back to list
                if (!cfg) { Editor.editingId = null; return Editor.renderList(); }

                const con = document.getElementById('editor-container');

                // Color Picker
                const colors = CONFIG.colors.map(c => `<button onclick="Store.updateMod('${id}','color','${c}'); Editor.render('${id}')" class="w-6 h-6 rounded-full bg-brand-${c} ${m.color===c?'border-2 border-brand-dark scale-110':'border border-white opacity-50'}"></button>`).join('');
                
                // Segments Helper - EXPANDED for rows
                const mkSeg = (lbl, key, opts) => `
                    <div class="mb-3"><label class="lbl">${lbl}</label><div class="grid grid-cols-3 gap-1 bg-slate-100 p-1 rounded-xl border-2 border-slate-200">
                    ${opts.map((o,i) => `<button onclick="Store.updateMod('${id}','${key}','${o.v}'); Editor.render('${id}')" class="py-1.5 text-[9px] font-black uppercase rounded-lg border-2 transition-all ${(m[key]||o.def)===o.v ? 'bg-brand-dark text-white border-brand-dark shadow-sm':'bg-white text-slate-500 border-transparent hover:border-slate-300'}">${o.l}</button>`).join('')}
                    </div></div>`;

                con.innerHTML = `
                    <div class="h-full flex flex-col slide-in-bottom -m-2">
                        <div class="bg-brand-${m.color} bg-opacity-10 border-b-4 border-brand-${m.color} p-4 flex justify-between items-start">
                            <div class="flex-1 mr-4">
                                <span class="text-[9px] font-black uppercase opacity-50 flex items-center gap-1"><i data-lucide="pen-tool" class="w-3 h-3"></i> ${cfg.label} Layer</span>
                                <input type="text" value="${m.title}" class="w-full font-heading font-black text-2xl text-brand-dark bg-transparent border-b-2 border-transparent hover:border-slate-300 focus:border-brand-dark outline-none" oninput="Store.updateMod('${id}','title',this.value)">
                            </div>
                            <button onclick="Editor.editingId=null; Editor.renderList()" class="w-8 h-8 rounded bg-white border-2 border-brand-dark flex items-center justify-center hover:bg-slate-100"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            <div class="bg-white p-3 rounded-xl border-2 border-brand-dark shadow-sm mb-4">
                                <label class="lbl">Color Theme</label><div class="flex gap-2 mb-4 overflow-x-auto pb-2">${colors}</div>
                                
                                ${mkSeg('Width', 'size', [
                                    {v:'xs',l:'XS'}, {v:'sm',l:'SM'}, {v:'md',l:'MD',def:true},
                                    {v:'lg',l:'LG'}, {v:'xl',l:'XL'}, {v:'full',l:'FULL'}
                                ])}
                                ${mkSeg('Height', 'height', [
                                    {v:'mini',l:'XS'}, {v:'short',l:'SM'}, {v:'auto',l:'MD',def:true},
                                    {v:'tall',l:'LG'}, {v:'grand',l:'XL'}, {v:'full',l:'MAX'}
                                ])}
                                
                                ${mkSeg('Text Size', 'fontSize', [{v:'sm',l:'Small'},{v:'md',l:'Normal',def:true},{v:'lg',l:'Large'}])}
                            </div>
                            
                            <div class="bg-white p-3 rounded-xl border-2 border-brand-dark shadow-sm">
                                ${cfg.inputs(id, m.data)}
                            </div>
                            
                            <button onclick="App.deleteModule('${id}')" class="mt-8 mx-auto flex items-center gap-1 text-xs font-bold text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i> Delete Layer</button>
                        </div>
                    </div>`;
                
                // Style fix helper
                const style = document.createElement('style');
                style.innerHTML = `.lbl { display:block; font-weight:900; font-size:10px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px; } .inp { width:100%; background:transparent; border-bottom:2px dashed #cbd5e1; outline:none; padding:4px 0; } .inp:focus { border-color:#1e293b; } .inp-area { width:100%; background:#f8fafc; border:2px solid #e2e8f0; border-radius:8px; padding:8px; font-size:14px; outline:none; resize:none; } .inp-area:focus { border-color:#1e293b; background:white; }`;
                con.appendChild(style);
                lucide.createIcons();
            }
        };

        // BOOT
        window.onload = App.init;

    </script>
</body>
</html>