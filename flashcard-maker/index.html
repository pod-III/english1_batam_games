<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Maker - English 1 Batam</title>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pink: '#FF6B95',
                        orange: '#FF8C42',
                        green: '#00E676',
                        blue: '#2979FF',
                        dark: '#1e293b', 
                        chalk: '#f8fafc',
                    },
                    fontFamily: {
                        heading: ['Fredoka', 'sans-serif'], 
                        body: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'hard-lg': '8px 8px 0px 0px rgba(30, 41, 59, 1)',
                    }
                }
            }
        }
    </script>

    <style id="printOrientationStyle">
        @page { size: portrait; margin: 0; }
    </style>
    
    <style>
        :root {
            --color-pink: #FF6B95;
            --color-orange: #FF8C42;
            --color-green: #00E676;
            --color-blue: #2979FF;
            --color-dark: #1e293b;
        }

        body { 
            font-family: 'Nunito', sans-serif;
            background-color: #F8FAFC;
            color: #1e293b;
        }

        .preview-area {
            background-image: radial-gradient(#E2E8F0 2px, transparent 2px);
            background-size: 24px 24px;
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 40px;
            overflow-y: auto;
        }

        .sidebar {
            width: 380px;
            background: white;
            border-right: 5px solid #1e293b;
            padding: 1.5rem;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .a4-page {
            background: white;
            display: grid;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            border: 5px solid #1e293b;
            box-shadow: 12px 12px 0px rgba(30, 41, 59, 0.15);
        }

        .a4-portrait { width: 210mm; height: 297mm; }
        .a4-landscape { width: 297mm; height: 210mm; }

        @media print {
            @page { size: auto; margin: 0; }
            body, html { background: white !important; margin: 0 !important; padding: 0 !important; display: block !important; }
            .no-print { display: none !important; }
            .preview-area { padding: 0 !important; display: block !important; background: none !important; }
            .a4-page { margin: 0 !important; box-shadow: none !important; border: none !important; position: absolute; top: 0; left: 0; }
            [contenteditable]:empty:before { content: "" !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        .brutalist-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
            background: white;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .guide-line {
            position: absolute;
            background: transparent;
            border: 0.5pt dashed rgba(30, 41, 59, 0.3);
            pointer-events: none;
            z-index: 100;
        }
        .guide-h { width: 100%; height: 0; left: 0; border-bottom-width: 0.5pt; }
        .guide-v { width: 0; height: 100%; top: 0; border-right-width: 0.5pt; }

        .btn-chunky {
            @apply border-2 border-dark font-heading font-bold uppercase transition-all duration-75 text-sm;
            box-shadow: 3px 3px 0px #1e293b;
        }
        .btn-chunky:active { transform: translate(1px, 1px); box-shadow: 0px 0px 0px #1e293b; }
        .btn-chunky.active { @apply bg-dark text-white shadow-none translate-x-[1px] translate-y-[1px]; }

        [contenteditable] { 
            outline: none; 
            font-family: 'Fredoka', sans-serif; 
            font-weight: 700; 
            text-transform: uppercase; 
            width: 100%; 
            padding: 0 0.5rem; 
            word-break: break-word;
            line-height: 1.1;
        }
        [contenteditable]:empty:before { content: "TEXT"; color: #cbd5e1; }

        .image-container { width: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .text-container { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            position: relative;
        }
        .image-preview { width: 100%; height: 100%; }
        .image-preview.contain { object-fit: contain; }
        .image-preview.cover { object-fit: cover; }

        /* Custom Toggle Switch Style */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f1f5f9;
            padding: 0.75rem 1rem;
            border: 2px solid #1e293b;
            border-radius: 12px;
            cursor: pointer;
        }
        .toggle-switch {
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            position: relative;
            transition: background 0.2s;
            border: 2px solid #1e293b;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            border: 2px solid #1e293b;
        }
        .toggle-container.active .toggle-switch { background: #00E676; }
        .toggle-container.active .toggle-switch::after { transform: translateX(20px); }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="sidebar no-print flex flex-col">
        <div class="mb-6">
            <h1 class="text-3xl font-heading text-dark tracking-tight leading-none">
                FLASHCARD<span class="text-blue">MAKER</span>
            </h1>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-2">English 1 Batam Edition</p>
        </div>

        <div class="space-y-5 flex-1 overflow-y-auto pr-1">
            <section>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">Orientation</label>
                <div class="flex gap-2">
                    <button id="btnPortrait" onclick="setOrientation('portrait')" class="flex-1 btn-chunky py-2 rounded-xl bg-white active">Portrait</button>
                    <button id="btnLandscape" onclick="setOrientation('landscape')" class="flex-1 btn-chunky py-2 rounded-xl bg-white">Landscape</button>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Grid Layout</label>
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold text-slate-500 uppercase">Custom</span>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400 uppercase">Cols</span>
                        <input type="number" id="inputCols" value="3" min="1" max="10" oninput="handleCustomGrid()" class="w-full border-2 border-dark rounded-xl p-3 pl-12 font-bold bg-white outline-none shadow-hard focus:bg-blue focus:text-white transition-colors">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400 uppercase">Rows</span>
                        <input type="number" id="inputRows" value="3" min="1" max="10" oninput="handleCustomGrid()" class="w-full border-2 border-dark rounded-xl p-3 pl-12 font-bold bg-white outline-none shadow-hard focus:bg-orange focus:text-white transition-colors">
                    </div>
                </div>
                <select id="gridSelect" onchange="syncFromPreset()" class="w-full border-2 border-dark rounded-xl p-3 font-bold bg-yellow-300 outline-none shadow-hard text-sm">
                    <option value="" disabled selected>-- Select Preset --</option>
                    <option value="2,2">Large (2 x 2)</option>
                    <option value="3,3">Standard (3 x 3)</option>
                    <option value="4,4">Small (4 x 4)</option>
                    <option value="2,4">Flashcards (2 x 4)</option>
                    <option value="1,1">Full Page (1 x 1)</option>
                </select>
            </section>

            <section>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">Image Height</label>
                <div class="grid grid-cols-5 gap-1.5">
                    <button id="img-0" onclick="setImageSize(0)" class="btn-chunky py-2 rounded-xl bg-white text-[10px]">0%</button>
                    <button id="img-25" onclick="setImageSize(25)" class="btn-chunky py-2 rounded-xl bg-white text-[10px]">25%</button>
                    <button id="img-50" onclick="setImageSize(50)" class="btn-chunky py-2 rounded-xl bg-white text-[10px]">50%</button>
                    <button id="img-75" onclick="setImageSize(75)" class="btn-chunky py-2 rounded-xl bg-white text-[10px]">75%</button>
                    <button id="img-100" onclick="setImageSize(100)" class="btn-chunky py-2 rounded-xl bg-white text-[10px]">100%</button>
                </div>
            </section>

            <section>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">Font Size</label>
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button id="font-1.2" onclick="setFontSize(1.2)" class="btn-chunky py-2 rounded-xl bg-white">S</button>
                    <button id="font-2" onclick="setFontSize(2)" class="btn-chunky py-2 rounded-xl bg-white">M</button>
                    <button id="font-3.5" onclick="setFontSize(3.5)" class="btn-chunky py-2 rounded-xl bg-white">L</button>
                    <button id="font-5" onclick="setFontSize(5)" class="btn-chunky py-2 rounded-xl bg-white">XL</button>
                </div>
                
                <div id="toggleAutoFit" onclick="toggleAutoFit()" class="toggle-container group">
                    <span class="text-xs font-bold text-dark uppercase tracking-tight">Auto-Fit Text</span>
                    <div class="toggle-switch"></div>
                </div>
            </section>

            <section>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">Card Theme</label>
                <div class="flex justify-between p-3 bg-slate-50 border-2 border-dark rounded-xl shadow-inner">
                    <button onclick="setGlobalColor('#FF6B95')" class="w-8 h-8 rounded-full border-2 border-dark shadow-sm bg-pink hover:scale-110 transition-transform"></button>
                    <button onclick="setGlobalColor('#FF8C42')" class="w-8 h-8 rounded-full border-2 border-dark shadow-sm bg-orange hover:scale-110 transition-transform"></button>
                    <button onclick="setGlobalColor('#00E676')" class="w-8 h-8 rounded-full border-2 border-dark shadow-sm bg-green hover:scale-110 transition-transform"></button>
                    <button onclick="setGlobalColor('#2979FF')" class="w-8 h-8 rounded-full border-2 border-dark shadow-sm bg-blue hover:scale-110 transition-transform"></button>
                    <button onclick="setGlobalColor('#FFFFFF')" class="w-8 h-8 rounded-full border-2 border-dark shadow-sm bg-white hover:scale-110 transition-transform"></button>
                </div>
            </section>
        </div>

        <div class="mt-4 space-y-2">
            <button onclick="window.print()" class="w-full btn-chunky bg-green py-3 rounded-2xl text-lg flex items-center justify-center gap-2">
                <i data-lucide="printer"></i> PRINT TO A4
            </button>
            <button onclick="resetTool()" class="w-full py-1 text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors flex items-center justify-center gap-2 uppercase tracking-tighter">
                <i data-lucide="trash-2" class="w-3 h-3"></i> Clear Workspace
            </button>
        </div>
    </aside>

    <main class="preview-area">
        <div id="a4Page" class="a4-page a4-portrait"></div>
    </main>

    <script>
        const a4Page = document.getElementById('a4Page');
        const gridSelect = document.getElementById('gridSelect');
        const inputCols = document.getElementById('inputCols');
        const inputRows = document.getElementById('inputRows');
        const printStyle = document.getElementById('printOrientationStyle');
        
        let state = {
            orientation: 'portrait',
            gridCols: 3,
            gridRows: 3,
            color: '#FFFFFF',
            imgHeight: 50,
            fontSize: 2,
            autoFit: false,
            cards: []
        };

        function loadState() {
            const saved = localStorage.getItem('flashcard_batam_state_v2');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                    inputCols.value = state.gridCols || 3;
                    inputRows.value = state.gridRows || 3;
                    setOrientation(state.orientation, false);
                    setGlobalColor(state.color, false);
                    setImageSize(state.imgHeight ?? 50, false);
                    setFontSize(state.fontSize || 2, false);
                    updateAutoFitUI();
                } catch (e) { console.error(e); }
            }
            updateGrid(false);
            lucide.createIcons();
        }

        function saveState() {
            const cardElements = document.querySelectorAll('.brutalist-card');
            cardElements.forEach((card, i) => {
                const textElement = card.querySelector('[contenteditable]');
                const text = textElement ? textElement.innerText : '';
                const imgElement = card.querySelector('.image-preview');
                const imgSrc = imgElement ? imgElement.src : '';
                const isHidden = imgElement ? imgElement.classList.contains('hidden') : true;
                state.cards[i] = { text: text, img: isHidden ? '' : imgSrc };
            });
            localStorage.setItem('flashcard_batam_state_v2', JSON.stringify(state));
        }

        function setImageSize(size, shouldSave = true) {
            state.imgHeight = size;
            [0, 25, 50, 75, 100].forEach(b => {
                const btn = document.getElementById(`img-${b}`);
                if (btn) btn.classList.toggle('active', b === size);
            });
            updateCardDisplay();
            if (shouldSave) saveState();
        }

        function setFontSize(size, shouldSave = true) {
            state.fontSize = size;
            const sizes = [1.2, 2, 3.5, 5];
            sizes.forEach(s => {
                const btn = document.getElementById(`font-${s}`);
                if (btn) btn.classList.toggle('active', s === parseFloat(size));
            });
            updateCardDisplay();
            if (shouldSave) saveState();
        }

        function toggleAutoFit() {
            state.autoFit = !state.autoFit;
            updateAutoFitUI();
            updateCardDisplay();
            saveState();
        }

        function updateAutoFitUI() {
            const container = document.getElementById('toggleAutoFit');
            container.classList.toggle('active', state.autoFit);
        }

        function autoFitText(element) {
            if (!state.autoFit) return;
            
            const container = element.parentElement;
            if (!container || container.clientHeight === 0) return;

            let minSize = 0.5;
            let maxSize = 15; 
            let fontSize = maxSize;
            
            // Binary search for perfect fit within container limits
            while (maxSize - minSize > 0.05) {
                fontSize = (minSize + maxSize) / 2;
                element.style.fontSize = fontSize + 'rem';
                
                if (element.scrollHeight > container.clientHeight || element.scrollWidth > container.clientWidth) {
                    maxSize = fontSize;
                } else {
                    minSize = fontSize;
                }
            }
            element.style.fontSize = minSize + 'rem';
        }

        function updateCardDisplay() {
            const isFullImg = state.imgHeight === 100;
            const isNoImg = state.imgHeight === 0;

            document.querySelectorAll('.image-container').forEach(c => {
                c.style.height = `${state.imgHeight}%`;
                c.style.display = isNoImg ? 'none' : 'flex';
            });
            
            document.querySelectorAll('.text-container').forEach(c => {
                c.style.height = `${100 - state.imgHeight}%`;
                c.style.display = isFullImg ? 'none' : 'flex';
            });

            document.querySelectorAll('[contenteditable]').forEach(t => {
                if (state.autoFit) {
                    autoFitText(t);
                } else {
                    t.style.fontSize = `${state.fontSize}rem`;
                }
            });

            document.querySelectorAll('.brutalist-card').forEach(card => {
                card.style.padding = (isFullImg || isNoImg) ? '0' : '10px';
            });

            document.querySelectorAll('.image-preview').forEach(img => {
                if (isFullImg) {
                    img.classList.remove('contain');
                    img.classList.add('cover');
                } else {
                    img.classList.remove('cover');
                    img.classList.add('contain');
                }
            });
        }

        function setOrientation(type, shouldSave = true) {
            state.orientation = type;
            const isP = type === 'portrait';
            document.getElementById('btnPortrait').classList.toggle('active', isP);
            document.getElementById('btnLandscape').classList.toggle('active', !isP);
            a4Page.className = `a4-page a4-${type}`;
            printStyle.innerHTML = `@page { size: ${type}; margin: 0; }`;
            if (shouldSave) { saveState(); updateGrid(false); }
        }

        function setGlobalColor(color, shouldSave = true) {
            state.color = color;
            document.querySelectorAll('.brutalist-card').forEach(c => c.style.backgroundColor = color);
            if (shouldSave) saveState();
        }

        function handleCustomGrid() {
            state.gridCols = parseInt(inputCols.value) || 1;
            state.gridRows = parseInt(inputRows.value) || 1;
            gridSelect.value = ""; 
            updateGrid();
        }

        function syncFromPreset() {
            const [cols, rows] = gridSelect.value.split(',').map(Number);
            inputCols.value = cols;
            inputRows.value = rows;
            state.gridCols = cols;
            state.gridRows = rows;
            updateGrid();
        }

        function removeImage(index) {
            const img = document.getElementById(`img-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const delBtn = document.getElementById(`del-${index}`);
            if (img) {
                img.src = '';
                img.classList.add('hidden');
            }
            if(icon) icon.classList.remove('hidden');
            if(delBtn) delBtn.classList.add('hidden');
            saveState();
        }

        function updateGrid(shouldSave = true) {
            const cols = state.gridCols;
            const rows = state.gridRows;
            a4Page.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            a4Page.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            generateContent(cols, rows);
            if (shouldSave) saveState();
        }

        function generateContent(cols, rows) {
            a4Page.innerHTML = '';
            const totalCards = cols * rows;

            for (let i = 0; i < totalCards; i++) {
                const card = document.createElement('div');
                card.className = 'brutalist-card group';
                card.style.backgroundColor = state.color;
                
                const isFullImg = state.imgHeight === 100;
                const isNoImg = state.imgHeight === 0;
                card.style.padding = (isFullImg || isNoImg) ? '0' : '10px';

                const savedCard = state.cards[i] || { text: '', img: '' };

                const delBtn = document.createElement('button');
                delBtn.id = `del-${i}`;
                delBtn.className = `no-print absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 border-2 border-dark shadow-sm z-50 hover:scale-110 transition-transform ${savedCard.img ? '' : 'hidden'}`;
                delBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
                delBtn.onclick = (e) => { e.stopPropagation(); removeImage(i); };

                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container cursor-pointer';
                imgContainer.style.height = `${state.imgHeight}%`;
                imgContainer.style.display = isNoImg ? 'none' : 'flex';
                imgContainer.onclick = (e) => { if (e.target.tagName !== 'INPUT') document.getElementById(`file-${i}`).click(); };

                const img = document.createElement('img');
                img.className = `image-preview ${isFullImg ? 'cover' : 'contain'} ${savedCard.img ? '' : 'hidden'}`;
                img.id = `img-${i}`;
                img.src = savedCard.img || '';

                const icon = document.createElement('div');
                icon.className = `no-print opacity-20 group-hover:opacity-100 ${savedCard.img ? 'hidden' : ''}`;
                icon.id = `icon-${i}`;
                icon.innerHTML = `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`;

                const textContainer = document.createElement('div');
                textContainer.className = 'text-container';
                textContainer.style.height = `${100 - state.imgHeight}%`;
                textContainer.style.display = isFullImg ? 'none' : 'flex';

                const text = document.createElement('div');
                text.contentEditable = true;
                text.className = 'outline-none text-dark';
                text.innerText = savedCard.text || '';
                
                // Use a small delay for auto-fit to ensure the container height is calculated by the browser
                setTimeout(() => {
                    if (state.autoFit) {
                        autoFitText(text);
                    } else {
                        text.style.fontSize = `${state.fontSize}rem`;
                    }
                }, 0);

                text.oninput = () => {
                    if (state.autoFit) autoFitText(text);
                    saveState();
                };

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = `file-${i}`;
                fileInput.className = 'hidden';
                fileInput.accept = 'image/*';
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (re) => {
                            img.src = re.target.result;
                            img.classList.remove('hidden');
                            icon.classList.add('hidden');
                            delBtn.classList.remove('hidden');
                            saveState();
                        };
                        reader.readAsDataURL(file);
                    }
                };

                imgContainer.append(img, icon);
                textContainer.append(text);
                card.append(delBtn, imgContainer, textContainer, fileInput);
                a4Page.appendChild(card);
            }

            // Cutting Guides
            for (let i = 1; i < cols; i++) {
                const line = document.createElement('div');
                line.className = 'guide-line guide-v';
                line.style.left = `${(i / cols) * 100}%`;
                a4Page.appendChild(line);
            }
            for (let i = 1; i < rows; i++) {
                const line = document.createElement('div');
                line.className = 'guide-line guide-h';
                line.style.top = `${(i / rows) * 100}%`;
                a4Page.appendChild(line);
            }
        }

        function resetTool() {
            if(confirm("Clear current workspace?")) {
                localStorage.removeItem('flashcard_batam_state_v2');
                location.reload();
            }
        }

        window.onload = loadState;
        window.onresize = () => {
            if (state.autoFit) {
                document.querySelectorAll('[contenteditable]').forEach(autoFitText);
            }
        };
    </script>
</body>
</html>
